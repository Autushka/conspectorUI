/*! conspector 28-04-2015 */

app.factory("cacheProvider",["TYPES",function(a){return{oEntitiesCache:{oDeficiencyEntity:angular.copy(a.oEntityCacheStructure),oAccountEntity:angular.copy(a.oEntityCacheStructure),oUnitEntity:angular.copy(a.oEntityCacheStructure),oCompanyEntity:angular.copy(a.oEntityCacheStructure),oUserEntity:angular.copy(a.oEntityCacheStructure),oRoleEntity:angular.copy(a.oEntityCacheStructure),oProjectEntity:angular.copy(a.oEntityCacheStructure),oPhaseEntity:angular.copy(a.oEntityCacheStructure),oRoleEntity:angular.copy(a.oEntityCacheStructure),oOperationLogEntity:angular.copy(a.oEntityCacheStructure),oTaskStatusEntity:angular.copy(a.oEntityCacheStructure),oTaskPriorityEntity:angular.copy(a.oEntityCacheStructure),oPriorityEntity:angular.copy(a.oEntityCacheStructure),oAccountTypeEntity:angular.copy(a.oEntityCacheStructure),oContactTypeEntity:angular.copy(a.oEntityCacheStructure),oActivityTypeEntity:angular.copy(a.oEntityCacheStructure),oCountryEntity:angular.copy(a.oEntityCacheStructure),oContactEntity:angular.copy(a.oEntityCacheStructure),oActivityEntity:angular.copy(a.oEntityCacheStructure),oUnitOptionSetEntity:angular.copy(a.oEntityCacheStructure),oUnitOptionValueEntity:angular.copy(a.oEntityCacheStructure),oTaskTypeEntity:angular.copy(a.oEntityCacheStructure),oFileMetadataEntity:angular.copy(a.oEntityCacheStructure)},oUserProfile:{},oListViewScrollPosition:{deficienciesList:0,contactsList:0,unitsList:0,clientsList:0,contractorsList:0,activitiesList:0},putListViewScrollPosition:function(a,b){this.oListViewScrollPosition[a]=b},getListViewScrollPosition:function(a){return this.oListViewScrollPosition[a]},clearOtherViewsScrollPosition:function(a){for(var b in this.oListViewScrollPosition)this.oListViewScrollPosition.hasOwnProperty(b)&&b!==a&&(this.oListViewScrollPosition[b]=0)},oTableStatus:{deficienciesList:[{sStateName:"app.deficienciesList",aGroups:[],oFilter:{},oSorting:{}}],notificationsList:[{sStateName:"app.notificationsList",aGroups:[],oFilter:{},oSorting:{}}],contactsList:[{sStateName:"app.contactsList",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}},{sStateName:"app.clientDetailsWrapper.clientDetails",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}},{sStateName:"app.contractorDetailsWrapper.contractorDetails",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}}],clientsList:[{sStateName:"app.clientsList",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0,bIsProspect:!0}}],contractorsList:[{sStateName:"app.contractorsList",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}}],activitiesList:[{sStateName:"app.activitiesList",aGroups:[],oFilter:{},oSorting:{}}],unitsList:[{sStateName:"app.unitsList",aGroups:[],oFilter:{},oSorting:{}}]},getTableStatusFromCache:function(a){for(var b=0;b<this.oTableStatus[a.sTableName].length;b++)if(this.oTableStatus[a.sTableName][b].sStateName===a.sStateName)return{aGroups:angular.copy(this.oTableStatus[a.sTableName][b].aGroups),oSorting:angular.copy(this.oTableStatus[a.sTableName][b].oSorting),oFilter:angular.copy(this.oTableStatus[a.sTableName][b].oFilter),oListSettings:angular.copy(this.oTableStatus[a.sTableName][b].oListSettings)}},putTableStatusToCache:function(a){for(var b={},c=0;c<this.oTableStatus[a.sTableName].length;c++)if(this.oTableStatus[a.sTableName][c].sStateName===a.sStateName){this.oTableStatus[a.sTableName][c].oFilter=angular.copy(a.oFilter),this.oTableStatus[a.sTableName][c].oSorting=angular.copy(a.oSorting),this.oTableStatus[a.sTableName][c].oListSettings=angular.copy(a.oListSettings),this.oTableStatus[a.sTableName][c].aGroups=angular.copy([]);for(var d=0;d<a.aGroups.length;d++)b=angular.copy({}),b.value=a.aGroups[d].value,a.aGroups[d].$hideRows&&(b.$hideRows=!0),this.oTableStatus[a.sTableName][c].aGroups.push(b)}},getFromCache:function(a,b){for(var c=0;c<this.oEntitiesCache[a].aCachedRequests.length;c++)if(this.oEntitiesCache[a].aCachedRequests[c].sRequestSettings===b)return this.oEntitiesCache[a].aCachedRequests[c].aEntitiesArray;return[]},putToCache:function(a,b,c){this.oEntitiesCache[a].aCachedRequests.push({sRequestSettings:b,aEntitiesArray:c})},cleanEntitiesCache:function(b,c){if(b&&!c)return void(this.oEntitiesCache[b]=angular.copy(a.oEntityCacheStructure));if(b&&c){for(var d=0;d<this.oEntitiesCache[b].aCachedRequests.length;d++)if(this.oEntitiesCache[b].aCachedRequests[d].sRequestSettings===c){this.oEntitiesCache[b].aCachedRequests.splice(d,1);break}}else for(var e in this.oEntitiesCache)this.oEntitiesCache[e]=angular.copy(a.oEntityCacheStructure)},cleanProfileCache:function(){this.oUserProfile={}},cleanAllCache:function(){this.cleanEntitiesCache(),this.cleanProfileCache(),this.clearOtherViewsScrollPosition("")},getEntityDetails:function(a){for(var b={},c=0;c<this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests.length;c++)if(this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].sRequestSettings===a.sRequestSettings){for(var d=0;d<this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].aEntitiesArray.length;d++)if(this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].aEntitiesArray[d][a.sKeyName]===a.sKeyValue){b=angular.copy(this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].aEntitiesArray[d]),console.log("Entitiy: "+a.sCacheProviderAttribute+" retrieved from cache...");break}break}return b}}}]),app.factory("genericODataFactory",["$resource","CONSTANTS",function(a,b){var c=b.sServicePath;return a("",{},{getEntitySetWithFilterAndExpand:{method:"GET",url:c+":path?$filter=:filter&$expand=:expand&$format=json"},getEntitySetWithFilter:{method:"GET",url:c+":path?$filter=:filter&$format=json"},getEntitySetWithExpand:{method:"GET",url:c+":path?$expand=:expand&$format=json"},getEntitySet:{method:"GET",url:c+":path?$format=json"},getLinks:{method:"GET",url:c+":sParentEntityWithKey/$links/:sRelationName"},post:{method:"POST",url:c+":path"},put:{method:"PUT",params:{key:"@key"},url:c+":path(':key')"},getEntity:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$format=json"},getEntityWithFilter:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$filter=:filter&$format=json"},getEntityWithExpand:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$expand=:expand&$format=json"},getEntityWithFilterAndExpand:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$filter=:filter&$expand=:expand&$format=json"},"delete":{method:"DELETE",params:{key:"@key"},url:c+":path(':key')"}})}]),app.factory("dataProvider",["genericODataFactory","utilsProvider","$q","$rootScope","$http","$translate","cacheProvider","$window","CONSTANTS","$timeout",function(a,b,c,d,e,f,g,h,i,j){return{commonOnSuccess:function(a){a.bShowSpinner&&d.$emit("UNLOAD"),a.bShowSuccessMessage&&j(function(){b.displayMessage({sText:f.instant("global_successOperation"),sType:"success"})},1e3)},commonOnError:function(a,c,e){a.bShowSpinner&&d.$emit("UNLOAD"),a.bShowErrorMessage&&(e?j(function(){b.displayMessage({sText:f.instant(e),sType:"error"})},1e3):j(function(){b.displayMessage({sText:f.instant("global_errorOperation"),sType:"error"})},1e3)),c&&c.reject()},getEntitySet:function(b){var e={},f=c.defer(),g=[],h="";return b.sKey&&(h=b.sKey),b.sFilter&&(h+=b.sFilter),b.sExpand&&(h+=b.sExpand),h||(h=""),b.oCacheProvider&&b.sCacheProviderAttribute&&(g=b.oCacheProvider.getFromCache(b.sCacheProviderAttribute,h),g.length)?(console.log("Entities: "+b.sCacheProviderAttribute+" retrieved from cache..."),g):(b.bShowSpinner&&d.$emit("LOAD"),b.sFilter&&b.sExpand&&(e=(new a).$getEntitySetWithFilterAndExpand({path:b.sPath,expand:b.sExpand,filter:b.sFilter})),b.sFilter&&!b.sExpand&&(e=(new a).$getEntitySetWithFilter({path:b.sPath,filter:b.sFilter})),!b.sFilter&&b.sExpand&&(e=(new a).$getEntitySetWithExpand({path:b.sPath,expand:b.sExpand})),b.sFilter||b.sExpand||(e=(new a).$getEntitySet({path:b.sPath})),e.then($.proxy(function(a){b.oCacheProvider&&b.sCacheProviderAttribute&&a.d.results.length&&b.oCacheProvider.putToCache(b.sCacheProviderAttribute,h,a.d.results),this.commonOnSuccess(b),f.resolve(a.d.results)},this),$.proxy(function(){this.commonOnError(b,f)},this)),f.promise)},getEntity:function(b){var e={},f=c.defer();return b.bShowSpinner&&d.$emit("LOAD"),b.sFilter&&!b.sExpand&&(e=(new a).$getEntityWithFilter({path:b.sPath,key:b.sKey,filter:b.sFilter})),!b.sFilter&&b.sExpand&&(e=(new a).$getEntityWithExpand({path:b.sPath,key:b.sKey,expand:b.sExpand})),b.sFilter&&b.sExpand&&(e=(new a).$getEntityWithFilterAndExpand({path:b.sPath,filter:b.sFilter,key:b.sKey,expand:b.sExpand})),b.sFilter||b.sExpand||(e=(new a).$getEntity({path:b.sPath,key:b.sKey})),e.then($.proxy(function(a){this.commonOnSuccess(b),f.resolve(a.d)},this),$.proxy(function(){this.commonOnError(b,f)},this)),f.promise},getLinks:function(b){var d={},e=c.defer(),f="";return f=b.sParentEntity+"('"+b.sParentKey+"')",d=(new a).$getLinks({path:b.sParentEntity,sParentEntity:f,sRelationName:b.sRelationName}),d.then(function(a){e.resolve(a.d)}),e.promise},updateLinks:function(a){for(var b={__batchRequests:[]},c={},d={},e=[],f="",h="",j=!1,k=function(a){a.d.CompanyName===g.oUserProfile.sCurrentCompany&&g.oUserProfile.sCurrentCompany&&a.d.CompanyName||(j=!0)},l=0;l<a.aLinks.length;l++)c={},c.requestUri=a.sParentEntityWithKey+"/$links/"+a.aLinks[l].sRelationName,c.method="GET",b.__batchRequests.push(c);d=this.batchRequest({oRequestData:b,bShowSpinner:a.bShowSpinner}),d.then($.proxy(function(g){b={__batchRequests:[]};for(var l=0;l<g.length;l++){e=[];for(var m=0;m<g[l].data.results.length;m++)j=!1,c={},h=g[l].data.results[m].uri.substring(g[l].data.results[m].uri.indexOf("'")+1,g[l].data.results[m].uri.lastIndexOf("'")),a.aLinks[l].bKeepCompanyDependentLinks&&this.ajaxRequest({bAsync:!1,oData:{},sRequestType:"GET",sDataType:"json",sPath:i.sServicePath+a.aLinks[l].sRelationName.substring(0,a.aLinks[l].sRelationName.length-7)+"s('"+h+"')",oEventHandlers:{onSuccess:k}}),j||(f=a.aLinks[l].sRelationName+"('"+h+"')",c.requestUri=a.sParentEntityWithKey+"/$links/"+f,c.method="DELETE",e.push(c));e.length&&this.constructChangeBlockForBatch({oRequestData:b,aData:e})}b.__batchRequests.length?(d=this.batchRequest({oRequestData:b}),d.then($.proxy(function(){this.createLinks(a)},this))):this.createLinks(a)},this))},updateEntity:function(e){var f={},h={},i=c.defer();e.bShowSpinner&&d.$emit("LOAD");var h=this.getEntity({sKey:e.sKey,sPath:e.sPath});return h.then($.proxy(function(c){var d={};d=angular.copy(e.oData),e.bIgnoreLastModifiedAtValidation&&(d.LastModifiedAt=c.LastModifiedAt),c.LastModifiedAt===d.LastModifiedAt?(d.LastModifiedAt=b.dateToDBDate(new Date),d.GeneralAttributes||(d.GeneralAttributes=c.GeneralAttributes),d.GeneralAttributes.LastModifiedBy=g.oUserProfile.sUserName,d.GeneralAttributes.IsDeleted||(d.GeneralAttributes.IsDeleted=!1),d.GeneralAttributes.IsArchived||(d.GeneralAttributes.IsArchived=!1),d.GeneralAttributes.SortingSequence||(d.GeneralAttributes.SortingSequence=0),f=new a(d).$put({path:e.sPath,key:e.sKey}),f.then($.proxy(function(a){if(e.aLinks&&e.aLinks.length){var b=e.sPath+"('"+a[e.sKeyAttribute]+"')";this.updateLinks({aLinks:e.aLinks,bShowSpinner:e.bShowSpinner,sParentEntityWithKey:b,onSuccess:$.proxy(function(){this.commonOnSuccess(e),i.resolve(a)},this)})}else this.commonOnSuccess(e),i.resolve(a)},this),$.proxy(function(){this.commonOnError(e,i)},this))):this.commonOnError(e,i,"global_errorEntityWasUpdatedBefore")},this)),i.promise},createLinks:function(a){for(var b={__batchRequests:[]},c=[],d={},e={},f=0;f<a.aLinks.length;f++){c=[];for(var g=0;g<a.aLinks[f].aUri.length;g++)d={},d.requestUri=a.sParentEntityWithKey+"/$links/"+a.aLinks[f].sRelationName,d.method="POST",d.data={uri:a.aLinks[f].aUri[g]},c.push(d);c.length&&this.constructChangeBlockForBatch({oRequestData:b,aData:c})}e=this.batchRequest({oRequestData:b,bShowSpinner:a.bShowSpinner}),e.then(function(b){a.onSuccess&&a.onSuccess()})},createEntity:function(e){var f={},h={},i=c.defer();return e.bShowSpinner&&d.$emit("LOAD"),h=angular.copy(e.oData),e.bGuidNeeded&&(h.Guid=b.generateGUID()),e.bCompanyNeeded&&!h.CompanyName&&(h.CompanyName=g.oUserProfile.sCurrentCompany),h.CreatedAt=b.dateToDBDate(new Date),h.LastModifiedAt=h.CreatedAt,h.GeneralAttributes||(h.GeneralAttributes={}),h.GeneralAttributes.CreatedBy=g.oUserProfile.sUserName,h.GeneralAttributes.LastModifiedBy=g.oUserProfile.sUserName,h.GeneralAttributes.IsDeleted=!1,h.GeneralAttributes.IsArchived=!1,h.GeneralAttributes.SortingSequence||(h.GeneralAttributes.SortingSequence=0),f=new a(h).$post({path:e.sPath}),f.then($.proxy(function(a){if(e.aLinks&&e.aLinks.length){var b=e.sPath+"('"+a.d[e.sKeyAttribute]+"')";this.createLinks({aLinks:e.aLinks,sParentEntityWithKey:b,sShowSpinner:e.bShowSpinner,onSuccess:$.proxy(function(){this.commonOnSuccess(e),i.resolve(a.d)},this)})}else this.commonOnSuccess(e),i.resolve(a.d)},this),$.proxy(function(){this.commonOnError(e,i)},this)),i.promise},deleteEntity:function(b){var e={},f=c.defer();return b.bShowSpinner&&d.$emit("LOAD"),e=(new a).$delete({path:b.sPath,key:b.sKey}),e.then($.proxy(function(a){this.commonOnSuccess(b),f.resolve()},this),$.proxy(function(){this.commonOnError(b,f)},this)),f.promise},httpRequest:function(a){var b="",f="application/x-www-form-urlencoded",g=[],h={},i={};a.sRequestType||(a.sRequestType="GET");for(var j in a.oUrlParameters)g.push(j+"="+a.oUrlParameters[j]);for(var k=0;k<g.length;k++)b+=g[k],k!==g.length-1&&(b+="&");return h=c.defer(),a.bShowSpinner&&d.$emit("LOAD"),console.log(a.sPath),i=e({url:a.sPath,method:a.sRequestType,headers:{"Content-Type":f},data:b}),i.success($.proxy(function(b,c,d,e){this.commonOnSuccess(a),h.resolve(b)},this)),i.error($.proxy(function(b,c,d,e){this.commonOnError(a,h)},this)),h.promise},constructChangeBlockForBatch:function(a){for(var b={__changeRequests:[]},c=0;c<a.aData.length;c++)b.__changeRequests.push(a.aData[c]);a.oRequestData.__batchRequests.push(b)},batchRequest:function(a){var b=c.defer();return a.oRequestData&&a.oRequestData.__batchRequests&&a.oRequestData.__batchRequests.length?(a.bShowSpinner&&d.$emit("LOAD"),OData.request({requestUri:i.sServicePath+"$batch",method:"POST",data:a.oRequestData},$.proxy(function(c){for(var d=0;d<c.__batchResponses.length;d++)if("HTTP request failed"===c.__batchResponses[d].message)return void this.commonOnError(a);this.commonOnSuccess(a),b.resolve(c.__batchResponses)},this),$.proxy(function(b){this.commonOnError(a)},this),OData.batchHandler)):(this.commonOnSuccess(a),b.resolve([])),b.promise},ajaxRequest:function(a){a.sRequestType||(a.sRequestType="POST"),a.bShowSpinner&&d.$emit("LOAD"),$.ajax({type:a.sRequestType,async:a.bAsync,url:a.sPath,data:a.oData,dataType:a.sDataType,beforeSend:function(){},success:$.proxy(function(b,c){this.commonOnSuccess(a),a.oEventHandlers&&a.oEventHandlers.onSuccess&&a.oEventHandlers.onSuccess(b)},this),error:$.proxy(function(b){this.commonOnError(a),a.oEventHandlers&&a.oEventHandlers.onError&&a.oEventHandlers.onError(b)},this)})}}}]),app.factory("apiProvider",["$rootScope","dataProvider","CONSTANTS","$q","utilsProvider","cacheProvider","PubNub","$timeout",function(a,b,c,d,e,f,g,h){return{getUserProfile:function(a){var d=c.sServicePath+"Users('"+a+"')?$expand=CompanyDetails,RoleDetails,PhaseDetails/ProjectDetails,ContactDetails/AccountDetails&$format=json",e=[],f=[],g=[],h=[],i="",j="",k="",l=!1,m=function(a){l=a.d.IsPasswordInitial,k=a.d.LastModifiedAt,i=a.d.EMail,j=a.d.AvatarFileGuid;for(var b=0;b<a.d.CompanyDetails.results.length;b++)a.d.CompanyDetails.results[b].GeneralAttributes.IsDeleted||e.push(a.d.CompanyDetails.results[b]);for(var b=0;b<a.d.RoleDetails.results.length;b++)a.d.RoleDetails.results[b].GeneralAttributes.IsDeleted||f.push(a.d.RoleDetails.results[b]);for(var b=0;b<a.d.PhaseDetails.results.length;b++)a.d.PhaseDetails.results[b].GeneralAttributes.IsDeleted||(a.d.PhaseDetails.results[b]._sortingSequence=a.d.PhaseDetails.results[b].GeneralAttributes.SortingSequence,a.d.PhaseDetails.results[b].ProjectDetails._sortingSequence=a.d.PhaseDetails.results[b].ProjectDetails.GeneralAttributes.SortingSequence,g.push(a.d.PhaseDetails.results[b]));for(var b=0;b<a.d.ContactDetails.results.length;b++)a.d.ContactDetails.results[b].GeneralAttributes.IsDeleted||h.push(a.d.ContactDetails.results[b])};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:m}}),{sUserName:a,sEmail:i,sAvatarFileGuid:j,aUserRoles:f,aAllUserRoles:f,aUserPhases:g,aAllUserPhases:g,aUserCompanies:e,bIsInitialPassword:l,sLastModifiedAt:k,aGloballySelectedPhasesGuids:[],aAllUserContacts:h}},getCurrentUserName:function(){var a,d=c.sAppAbsolutePath+"rest/account/getCurrentUserName",e=function(b){a=b};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:e}}),a},getCurrentCompany:function(){var a,d=c.sAppAbsolutePath+"rest/account/getCurrentCompany",e=function(b){a=b};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:e}}),a},setCurrentCompany:function(a){b.ajaxRequest({sPath:c.sAppAbsolutePath+"rest/account/setCurrentCompany/"+a,bAsync:!1,sRequestType:"GET"})},getCurrentRole:function(){var a,d=c.sAppAbsolutePath+"rest/account/getCurrentRole",e=function(b){a=b};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:e}}),a},setCurrentRole:function(a){b.ajaxRequest({sPath:c.sAppAbsolutePath+"rest/account/setCurrentRole/"+a,bAsync:!1,sRequestType:"GET"})},resetPasswordWithPRCode:function(a){var d=b.httpRequest({sPath:c.sAppAbsolutePath+"rest/account/passwordRecovery/PRCode/"+a.oData.passwordRecoveryCode+"/newPassword/"+a.oData.newPassword,sRequestType:"GET",bShowSpinner:!0});d.then(function(b){a.onSuccess(b)})},resetPassword:function(a){var d={},e="";e=a.oData.userName?c.sAppAbsolutePath+"rest/account/passwordRecovery/userName/"+a.oData.userName:c.sAppAbsolutePath+"rest/account/passwordRecovery/email/"+a.oData.email,d=b.httpRequest({sPath:e,sRequestType:"GET",bShowSpinner:!0}),d.then(function(b){a.onSuccess(b)})},hashPassword:function(a){var d="",e=c.sAppAbsolutePath+"rest/account/hashPassword/"+a,f=function(a){d=a};return b.ajaxRequest({sPath:e,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:f}}),d},getAttachments:function(a){var c=a.sPath,d=b.httpRequest({sPath:c});d.then(function(b){a.onSuccess(b)})},getUsers:function(a){var c=b.getEntitySet({sPath:"Users",sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUserEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getUserWithCompaniesPhasesAndRoles:function(a){var c=b.getEntity({sPath:"Users",sKey:a.sKey,sExpand:"CompanyDetails,PhaseDetails/ProjectDetails,RoleDetails,ContactDetails",sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},createUser:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUserEntity"),a.onSuccess&&a.onSuccess(b)},this),d=b.createEntity({sPath:"Users",sKeyAttribute:"UserName",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!1});d.then(c)},updateUser:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUserEntity"),a.onSuccess&&a.onSuccess(b)},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Users",sKeyAttribute:"UserName",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},initializePubNub:function(){a.sSessionGuid=e.generateGUID();var b="";g.init({publish_key:"pub-c-ca905ca3-be6e-4a5b-96cd-49dc2312a4e6",subscribe_key:"sub-c-8b324682-73df-11e3-9291-02ee2ddab7fe"}),b="conspectorPubNub"+f.oUserProfile.sCurrentCompany,g.ngSubscribe({channel:b}),a.$on(g.ngMsgEv(b),function(b,c){if(c.message.sSessionGuid!==a.sSessionGuid)switch(f.cleanEntitiesCache(c.message.sEntityName),"oAccountEntity"===c.message.sEntityName&&f.cleanEntitiesCache("oAccountTypeEntity"),c.message.sEntityName){case"oAccountEntity":a.$broadcast("accountsShouldBeRefreshed");break;case"oContactEntity":a.$broadcast("contactsShouldBeRefreshed");break;case"oDeficiencyEntity":a.$broadcast("deficienciesShouldBeRefreshed");break;case"oUnitEntity":a.$broadcast("unitsShouldBeRefreshed");break;case"oActivityEntity":a.$broadcast("activitiesShouldBeRefreshed");break;case"oOperationLogEntity":a.$broadcast("notificationsShouldBeRefreshed"),a.getNotificationsNumber()}})},pubNubMessage:function(b){g.ngPublish({channel:"conspectorPubNub"+f.oUserProfile.sCurrentCompany,message:{sEntityName:b.sEntityName,sText:b.sText,sUserName:f.oUserProfile.sUserName,sSessionGuid:a.sSessionGuid}})},logEvent:function(c){for(var d={},g={__batchRequests:[]},h=[],i={},j=0;j<c.aUsers.length;j++)i={requestUri:"OperationLogs",method:"POST",data:{Guid:e.generateGUID(),CompanyName:f.oUserProfile.sCurrentCompany,UserName:c.aUsers[j],Status:"not read",EntityName:c.sEntityName,EntityGuid:c.sEntityGuid,OperationNameEN:c.sOperationNameEN,OperationNameFR:c.sOperationNameFR,PhaseGuid:c.sPhaseGuid,CreatedAt:e.dateToDBDate(new Date),GeneralAttributes:{CreatedBy:f.oUserProfile.sUserName,IsDeleted:!1},ContactGuid:f.oUserProfile.oUserContact.Guid}},h.push(i);b.constructChangeBlockForBatch({oRequestData:g,aData:h}),d=b.batchRequest({oRequestData:g,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(b){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),this.pubNubMessage({sEntityName:"oOperationLogEntity",sText:"New Operation Log..."})},this))},logEvents:function(c){for(var d={},g={__batchRequests:[]},h=[],i={},j=0;j<c.aData.length;j++)for(var k=0;k<c.aData[j].aUsers.length;k++)i={requestUri:"OperationLogs",method:"POST",data:{Guid:e.generateGUID(),CompanyName:f.oUserProfile.sCurrentCompany,UserName:c.aData[j].aUsers[k],Status:"not read",EntityName:c.aData[j].sEntityName,EntityGuid:c.aData[j].sGuid,OperationNameEN:c.aData[j].sOperationNameEN,OperationNameFR:c.aData[j].sOperationNameFR,PhaseGuid:c.aData[j].sPhaseGuid,CreatedAt:e.dateToDBDate(new Date),GeneralAttributes:{CreatedBy:f.oUserProfile.sUserName,IsDeleted:!1},ContactGuid:f.oUserProfile.oUserContact.Guid}},h.push(i);b.constructChangeBlockForBatch({oRequestData:g,aData:h}),d=b.batchRequest({oRequestData:g,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(b){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),this.pubNubMessage({sEntityName:"oOperationLogEntity",sText:"New Operation Log..."})},this)),this.sendPushNotifications(c)},sendPushNotifications:function(a){for(var c={},d={__batchRequests:[]},e={},f=0;f<a.aData.length;f++)for(var g=0;g<a.aData[f].aUsers.length;g++)e={requestUri:"Users('"+a.aData[f].aUsers[g]+"')?$expand=UserDeviceDetails",method:"GET"},d.__batchRequests.push(e);c=b.batchRequest({oRequestData:d,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),c.then($.proxy(function(b){for(var c=[],d=b.length-1;d>=0;d--){for(var e=b[d].data.UserDeviceDetails.results.length-1;e>=0;e--)-1===$.inArray(b[d].data.UserDeviceDetails.results[e].DeviceToken,c)&&(c.push(b[d].data.UserDeviceDetails.results[e].DeviceToken),pubnub.mobile_gw_provision({device_id:b[d].data.UserDeviceDetails.results[e].DeviceToken,channel:"pushNotifications",op:"add",gw_type:"apns",error:function(a){console.log(a)}}));h(function(){for(var c=b.length-1;c>=0;c--)for(var d=b[c].data.UserDeviceDetails.results.length-1;d>=0;d--){var e=PNmessage();e.pubnub=pubnub;var f="en"===b[c].data.Language?a.aData[0].sOperationNameEN:a.aData[0].sOperationNameFR;e.channel="pushNotifications",e.apns={alert:f,badge:1,sound:"notification-beep.wav"},e.publish()}},1e3)}},this))},getOperationLogs:function(a){var b=c.sServicePath+"OperationLogs";a.bAddCountUrlParam&&(b+="/$count/"),a.sFilter&&(b=b+"?$filter="+a.sFilter),a.sExpand&&(b=a.sFilter?b+"&$expand="+a.sExpand:b+"?$expand="+a.sExpand),a.sOtherUrlParams&&(b=a.sFilter||a.sExpand?b+"&"+a.sOtherUrlParams:b+"?"+a.sOtherUrlParams),OData.request({requestUri:b,method:"GET"},$.proxy(function(b){b&&a.onSuccess(b)},this),$.proxy(function(a){},this))},updateOperationLog:function(c){var d=function(b){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),c.onSuccess&&c.onSuccess(b)},e=b.updateEntity({bShowSpinner:c.bShowSpinner,sPath:"OperationLogs",sKey:c.sKey,oData:c.oData,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});e.then(d)},updateOperationLogs:function(c){for(var d={},e={__batchRequests:[]},g=[],h={},i=0;i<c.aData.length;i++)h={requestUri:"OperationLogs('"+c.aData[i].Guid+"')",method:"PUT",data:c.aData[i]},g.push(h);b.constructChangeBlockForBatch({oRequestData:e,aData:g}),d=b.batchRequest({oRequestData:e,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(b){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),c.onSuccess&&c.onSuccess(h)},this))},deleteOperationLogs:function(c){for(var d={},e={__batchRequests:[]},g=[],h={},i=0;i<c.aData.length;i++)h={requestUri:"OperationLogs('"+c.aData[i].Guid+"')",method:"DELETE"},g.push(h);b.constructChangeBlockForBatch({oRequestData:e,aData:g}),d=b.batchRequest({oRequestData:e,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(b){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),c.onSuccess&&c.onSuccess(h)},this))},getProjects:function(a){var c=b.getEntitySet({sPath:"Projects",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oProjectEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getProjectsWithPhases:function(a){var c=b.getEntitySet({sPath:"Projects",sExpand:"PhaseDetails",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oProjectEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createProject:function(a){var c=function(b){f.cleanEntitiesCache("oProjectEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"Projects",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateProject:function(a){var c=function(b){f.cleanEntitiesCache("oProjectEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Projects",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getPhases:function(a){var c=b.getEntitySet({sPath:"Phases",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oPhaseEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getPhase:function(a){var c=b.getEntity({sPath:"Phases",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},createPhase:function(a){var c=function(b){f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"Phases",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updatePhase:function(a){var c=function(b){f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Phases",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getCompany:function(a){var c=b.getEntity({sPath:"Companies",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},getCompanies:function(a){var c=b.getEntitySet({sPath:"Companys",sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oCompanyEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createCompany:function(a){var d={},g={__batchRequests:[]},h=[],i=angular.copy(a.oData),j={};i.GeneralAttributes||(i.GeneralAttributes={}),i.GeneralAttributes.CreatedBy=f.oUserProfile.sUserName,i.GeneralAttributes.LastModifiedBy=f.oUserProfile.sUserName,i.GeneralAttributes.IsDeleted=!1,i.GeneralAttributes.IsArchived=!1,i.GeneralAttributes.SortingSequence||(i.GeneralAttributes.SortingSequence=0),i.CreatedAt=e.dateToDBDate(new Date),i.LastModifiedAt=i.CreatedAt;var k={requestUri:"Companys",method:"POST",data:i};h.push(k),j.Guid=e.generateGUID(),j.RoleName=c.sDefaultRoleNameForNewCompany,j.CompanyName=a.oData.CompanyName,j.CreatedAt=i.CreatedAt,j.LastModifiedAt=i.LastModifiedAt,j.GeneralAttributes=angular.copy(i.GeneralAttributes),j.GeneralAttributes.SortingSequence=0,k={requestUri:"Roles",method:"POST",data:j},h.push(k),b.constructChangeBlockForBatch({oRequestData:g,aData:h}),h=[],k={requestUri:"Users('"+f.oUserProfile.sUserName+"')/$links/CompanyDetails",method:"POST",data:{uri:"Companys('"+a.oData.CompanyName+"')"}},h.push(k),k={requestUri:"Users('"+f.oUserProfile.sUserName+"')/$links/RoleDetails",method:"POST",data:{uri:"Roles('"+j.Guid+"')"}},h.push(k),b.constructChangeBlockForBatch({oRequestData:g,aData:h}),d=b.batchRequest({oRequestData:g,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),d.then(function(b){f.cleanEntitiesCache("oCompanyEntity"),a.onSuccess&&a.onSuccess(b)})},updateCompany:function(a){var c=function(b){f.cleanEntitiesCache("oCompanyEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Companys",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getRoles:function(a){var c=b.getEntitySet({sPath:"Roles",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oRoleEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createRole:function(a){var c=function(b){f.cleanEntitiesCache("oRoleEntity"),a.onSuccess(b)},d=b.createEntity({sPath:"Roles",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateRole:function(a){var c=function(b){f.cleanEntitiesCache("oRoleEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Roles",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getDeficiencyStatuses:function(a){var c=b.getEntitySet({sPath:"TaskStatuss",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskStatusEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createDeficiencyStatus:function(a){var c=function(b){f.cleanEntitiesCache("oTaskStatusEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"TaskStatuss",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateDeficiencyStatus:function(a){var c=function(b){f.cleanEntitiesCache("oTaskStatusEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"TaskStatuss",sKey:a.sKey,
oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getDeficiencyTaskType:function(a){var c=b.getEntitySet({sPath:"TaskTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Deficiency'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getHealthAndSafetyTaskType:function(a){var c=b.getEntitySet({sPath:"TaskTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Health and Safety'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getContractorAccountType:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Contractor'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getClientAccountType:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Client'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getAccountTypes:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getAccountTypesWithAccounts:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:"AccountDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(function(b){for(var c=[],d=0;d<b.length;d++){c=[];for(var e=0;e<b[d].AccountDetails.results.length;e++)b[d].AccountDetails.results[e].GeneralAttributes.IsDeleted||c.push(b[d].AccountDetails.results[e]);b[d].AccountDetails.results=angular.copy(c)}a.onSuccess(b)})},createAccountType:function(a){var c=function(b){f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"AccountTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateAccountType:function(a){var c=function(b){f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"AccountTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getContactTypes:function(a){var c=b.getEntitySet({sPath:"ContactTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oContactTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createContactType:function(a){var c=function(b){f.cleanEntitiesCache("oContactTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"ContactTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateContactType:function(a){var c=function(b){f.cleanEntitiesCache("oContactTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"ContactTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getActivityTypes:function(a){var c=b.getEntitySet({sPath:"ActivityTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oActivityTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createActivityType:function(a){var c=function(b){f.cleanEntitiesCache("oActivityTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"ActivityTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateActivityType:function(a){var c=function(b){f.cleanEntitiesCache("oActivityTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"ActivityTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getDeficiencyPriorities:function(a){var c=b.getEntitySet({sPath:"TaskPrioritys",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskPriorityEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createDeficiencyPriority:function(a){var c=function(b){f.cleanEntitiesCache("oTaskPriorityEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"TaskPrioritys",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateDeficiencyPriority:function(a){var c=function(b){f.cleanEntitiesCache("oTaskPriorityEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"TaskPrioritys",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getContractors:function(a){var c=b.getEntitySet({sPath:"Accounts",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:a.sExpand,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountEntity"});if(c instanceof Array){for(var d=[],e=0;e<c.length;e++)"Contractor"===c[e].AccountTypeDetails.NameEN&&d.push(c[e]);a.onSuccess(d)}else c.then(function(b){for(var c=[],d=0;d<b.length;d++)"Contractor"===b[d].AccountTypeDetails.NameEN&&c.push(b[d]);a.onSuccess(c)})},getClients:function(a){var c=b.getEntitySet({sPath:"Accounts",sFilter:a.sFilter,sExpand:a.sExpand,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountEntity"});if(c instanceof Array){for(var d=[],e=0;e<c.length;e++)"Client"===c[e].AccountTypeDetails.NameEN&&d.push(c[e]);a.onSuccess(d)}else c.then(function(b){for(var c=[],d=0;d<b.length;d++)"Client"===b[d].AccountTypeDetails.NameEN&&c.push(b[d]);a.onSuccess(c)})},getAccount:function(a){var c=b.getEntity({sPath:"Accounts",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},getAccounts:function(a){var c=b.getEntitySet({sPath:"Accounts",sExpand:a.sExpand,sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createAccount:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oAccountEntity"),f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oAccountEntity",sText:"Account has been created..."})},this),d=b.createEntity({sPath:"Accounts",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateAccount:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oAccountEntity"),f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oAccountEntity",sText:"Account has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Accounts",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getCountriesWithProvinces:function(a){var c=b.getEntitySet({sPath:"Countrys",sFilter:"GeneralAttributes/IsDeleted eq false",sExpand:"ProvinceDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oCountryEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getContacts:function(a){var c=b.getEntitySet({sPath:"Contacts",sExpand:a.sExpand,sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oContactEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getContact:function(a){var c=b.getEntity({sPath:"Contacts",sKey:a.sKey,sExpand:"UserDetails,ContactTypeDetails,AccountDetails/AccountTypeDetails,PhaseDetails/ProjectDetails",sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},updateContact:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oContactEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oContactEntity",sText:"Contact has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Contacts",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});d.then(c)},createContact:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oContactEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oContactEntity",sText:"Contact has been created..."})},this),d=b.createEntity({sPath:"Contacts",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},getContactsForAccount:function(a){var c=b.getEntitySet({sPath:"Contacts",sFilter:"GeneralAttributes/IsDeleted eq false and AccountGuid eq '"+a.sAccountGuid+"'",sExpand:"UserDetails,ContactTypeDetails,AccountDetails,PhaseDetails/ProjectDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oContactEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getUnitOptionSets:function(a){var c=b.getEntitySet({sPath:"UnitOptionSets",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:"PhaseDetails/ProjectDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUnitOptionSetEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createUnitOptionSet:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionSetEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"UnitOptionSets",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0,aLinks:a.aLinks,sKeyAttribute:"Guid"});d.then(c)},updateUnitOptionSet:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionSetEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"UnitOptionSets",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,aLinks:a.aLinks,sKeyAttribute:"Guid"});d.then(c)},getUnitOptionValues:function(a){var c=b.getEntitySet({sPath:"UnitOptions",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:"UnitOptionSetDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUnitOptionValueEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createUnitOptionValue:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionValueEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"UnitOptions",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateUnitOptionValue:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionValueEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"UnitOptions",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getTaskTypes:function(a){var c=b.getEntitySet({sPath:"TaskTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createTaskType:function(a){var c=function(b){f.cleanEntitiesCache("oTaskTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"TaskTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateTaskType:function(a){var c=function(b){f.cleanEntitiesCache("oTaskTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"TaskTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getActivities:function(a){var c=b.getEntitySet({sPath:"Activitys",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oActivityEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getActivity:function(a){var c=b.getEntity({sPath:"Activitys",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},updateActivity:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oActivityEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oActivityEntity",sText:"Activity has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Activitys",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},createActivity:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oActivityEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oActivityEntity",sText:"Activity has been created..."})},this),d=b.createEntity({sPath:"Activitys",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},getMobileDeficiencies:function(a){var b=c.sServicePath+"Tasks";a.bAddCountUrlParam&&(b+="/$count/"),a.sFilter&&(b=b+"?$filter="+a.sFilter),a.sExpand&&(b=a.sFilter?b+"&$expand="+a.sExpand:b+"?$expand="+a.sExpand),a.sOtherUrlParams&&(b=a.sFilter||a.sExpand?b+"&"+a.sOtherUrlParams:b+"?"+a.sOtherUrlParams),OData.request({requestUri:b,method:"GET"},$.proxy(function(b){b&&a.onSuccess(b)},this),$.proxy(function(a){},this))},getDeficiencies:function(a){var c={};c=b.getEntitySet(a.bNoCaching?{sPath:"Tasks",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner}:{sPath:"Tasks",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oDeficiencyEntity"}),c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getDeficiency:function(a){var c=b.getEntity({sPath:"Tasks",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},onSuccessUpdateDeficiency:function(a,b){f.cleanEntitiesCache("oDeficiencyEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oDeficiencyEntity",sText:"Deficiency has been updated..."})},updateDeficiency:function(a){var c=$.proxy(function(b){this.onSuccessUpdateDeficiency(a,b)},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Tasks",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getInterestedUsers:function(a){for(var c={},d={__batchRequests:[]},e={},g=0;g<a.aData.length;g++)e={requestUri:"Tasks('"+a.aData[g].Guid+"')?$expand=AccountDetails/ContactDetails/UserDetails/PhaseDetails",method:"GET"},d.__batchRequests.push(e);c=b.batchRequest({oRequestData:d,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),c.then($.proxy(function(b){for(var c=[],d=[],e=!1,g=!1,h="",i=0;i<b.length;i++){d=[],h=b[i].data.PhaseGuid;for(var j=b[i].data.AccountDetails.results.length-1;j>=0;j--)for(var k=b[i].data.AccountDetails.results[j].ContactDetails.results.length-1;k>=0;k--)for(var l=b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results.length-1;l>=0;l--)if(b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName===b[i].data.UserName&&(e=!0),b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName!==f.oUserProfile.sUserName){b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName===b[i].data.GeneralAttributes.CreatedBy&&(g=!0);for(var m=b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].PhaseDetails.results.length-1;m>=0;m--)if(b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].PhaseDetails.results[m].Guid===h){d.push(b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName);break}}b[i].data.UserName==f.oUserProfile.sUserName||e||d.push(b[i].data.UserName),b[i].data.GeneralAttributes.CreatedBy==f.oUserProfile.sUserName||g||b[i].data.GeneralAttributes.CreatedBy==b[i].data.UserName||null!=b[i].data.GeneralAttributes.CreatedBy&&void 0!=b[i].data.GeneralAttributes.CreatedBy&&d.push(b[i].data.CreatedBy),d.push("GeneralAdmin");var n=[];$.each(d,function(a,b){-1===$.inArray(b,n)&&n.push(b)}),c.push({aUsers:n,sGuid:b[i].data.Guid,sPhaseGuid:h,sEntityName:a.sEntityName,sOperationNameEN:a.sOperationNameEN,sOperationNameFR:a.sOperationNameFR})}a.onSuccess(c)},this))},updateDeficiencies:function(a){for(var c={},d={__batchRequests:[]},e=[],f={},g=0;g<a.aData.length;g++)f={requestUri:"Tasks('"+a.aData[g].Guid+"')",method:"PUT",data:a.aData[g]},e.push(f);b.constructChangeBlockForBatch({oRequestData:d,aData:e}),c=b.batchRequest({oRequestData:d,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),c.then($.proxy(function(b){this.onSuccessUpdateDeficiency(a);var c=$.proxy(function(a){this.logEvents({aData:a})},this);this.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:"notificationsList_updatedDeficiency",sOperationNameFR:"",aData:a.aData,onSuccess:c})},this))},createDeficiency:function(a){var c=$.proxy(function(b){this.onSuccessUpdateDeficiency(a,b)},this),d=b.createEntity({sPath:"Tasks",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},getUnits:function(a){var c=b.getEntitySet({sPath:"Units",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUnitEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getUnit:function(a){var c=b.getEntity({sPath:"Units",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},updateUnit:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUnitEntity"),f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oUnitEntity",sText:"Unit has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Units",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},createUnit:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUnitEntity"),f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oUnitEntity",sText:"Unit has been created..."})},this),d=b.createEntity({sPath:"Units",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateFileMetadataSet:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"FileMetadataSets",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getFileMetadatas:function(a){var c=b.getEntitySet({sPath:"FileMetadatas",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},updateFileMetadata:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"FileMetadatas",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});d.then(c)},getEntityComments:function(a){var c=b.getEntity({sPath:"CommentSets",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(function(b){for(var c=[],d=0;d<b.CommentDetails.results.length;d++)b.CommentDetails.results[d].GeneralAttributes.IsDeleted||c.push(b.CommentDetails.results[d]);b.CommentDetails.results=angular.copy(c),a.onSuccess(b)})},getEntityAttachments:function(a){var c=b.getEntity({sPath:"FileMetadataSets",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(function(b){for(var c=[],d=0;d<b.FileMetadataDetails.results.length;d++)b.FileMetadataDetails.results[d].GeneralAttributes.IsDeleted||c.push(b.FileMetadataDetails.results[d]);b.FileMetadataDetails.results=angular.copy(c),a.onSuccess(b)})},updateEntityAttachment:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"FileMetadatas",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},updateComment:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Comments",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});d.then(c)},createComment:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"Comments",sKeyAttribute:"Guid",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!1});d.then(c)},getUserDevices:function(a){var c=b.getEntitySet({sPath:"UserDevices",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createUserDevice:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"UserDevices",sKeyAttribute:"Guid",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!1});d.then(c)},generateReport:function(a){$.download("xdocReportsService",a.oReportParameters,"post")}}}]),app.factory("rolesSettings",["cacheProvider","utilsProvider","apiProvider","$translate","CONSTANTS",function(a,b,c,d,e){return{setCurrentRole:function(e){return this[e]&&this[e].sInitialState?(a.oUserProfile.sCurrentRole=e,a.oUserProfile.oCurrentRoleSettings=angular.copy(this[e]),c.setCurrentRole(e),!0):(b.displayMessage({sText:d.instant("global_noDefaultViewForTheRole"),sType:"error"}),!1)},getRolesInitialState:function(a){return bMobileMode?this[a].sInitialStateMobile:this[a].sInitialState},getRolesMainMenuItemSettings:function(a){return this[a.sRole].oMainMenu[a.sMenuItem]},getRolesAdminPanelMenuItemSettings:function(a){return this[a.sRole].oAdminPanelMenu[a.sMenuItem]},getRolesSettingsForEntityAndOperation:function(a){return this[a.sRole].oAuthorizationsPerEntity[a.sEntityName][a.sOperation]},getRolesProfileMenuItemSettings:function(a){return this[a.sRole].oProfileMenu[a.sMenuItem]},getRolesHybridMainMenuItemSettings:function(a){return this[a.sRole].oHybridMainMenu[a.sMenuItem]},globalAdministrator:{sInitialState:"app.deficienciesList",sInitialStateMobile:"app.deficienciesList",bIsGlobalUserAdministrator:!0,oMainMenu:{bShowDeficiencies:!0,bShowUnits:!0,bShowContractors:!0,bShowClients:!0,bShowContacts:!0,bShowActivities:!0,bShowAdminPanel:!0,bShowProfileSettings:!0,bShowNotifications:!0},oAdminPanelMenu:{bShowCompaniesManagement:!0,bShowUsersManagement:!0,bShowRolesManagement:!0,bShowProjectsManagement:!0,bShowPhasesManagement:!0,bShowDeficiencyStatusesManagement:!0,bShowDeficiencyPrioritiesManagement:!0,bShowSystemFilesManagement:!0,bShowAccountTypesManagement:!0,bShowContactTypesManagement:!0,bShowUnitOptionSetManagement:!0,bShowUnitOptionValueManagement:!0,bShowTaskTypeManagement:!0,bShowActivityTypesManagement:!0},oProfileMenu:{bShowContactDetails:!0,bShowProfileDetails:!0,bShowChangePassword:!0},oHybridMainMenu:{bShowQuickAdd:!0,bShowDeficienciesList:!0},oAuthorizationsPerEntity:{oDeficiency:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oUnit:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oContractor:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oClient:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oContact:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oActivity:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oUser:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0}}},systemAdministrator:{sInitialState:"app.deficienciesList",sInitialStateMobile:"deficiencyQuickAddWrapper.quickAdd",bIsGlobalUserAdministrator:!1,oMainMenu:{bShowDeficiencies:!0,bShowUnits:!0,bShowContractors:!0,bShowClients:!0,bShowContacts:!0,bShowActivities:!0,bShowAdminPanel:!0,bShowProfileSettings:!0,bShowNotifications:!0},oAdminPanelMenu:{bShowCompaniesManagement:!1,bShowUsersManagement:!0,bShowRolesManagement:!0,bShowProjectsManagement:!0,bShowPhasesManagement:!0,bShowDeficiencyStatusesManagement:!0,bShowDeficiencyPrioritiesManagement:!0,bShowSystemFilesManagement:!0,bShowAccountTypesManagement:!0,bShowContactTypesManagement:!0,bShowUnitOptionSetManagement:!0,bShowUnitOptionValueManagement:!0,bShowTaskTypeManagement:!0,bShowActivityTypesManagement:!0},oProfileMenu:{bShowContactDetails:!0,bShowProfileDetails:!0,bShowChangePassword:!0},oHybridMainMenu:{bShowQuickAdd:!0,bShowDeficienciesList:!0},oAuthorizationsPerEntity:{oDeficiency:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oUnit:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oContractor:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oClient:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oContact:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oActivity:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oUser:{bDisplay:!0,bUpdate:!0,bCreate:!1,bDelete:!1}}},contactManagementUser:{sInitialState:"app.contactsList",sInitialStateMobile:"deficiencyQuickAddWrapper.quickAdd",bIsGlobalUserAdministrator:!1,oMainMenu:{bShowDeficiencies:!1,bShowUnits:!1,bShowContractors:!0,bShowClients:!0,bShowContacts:!0,bShowActivities:!1,bShowAdminPanel:!1,bShowProfileSettings:!0,bShowNotifications:!0},oAdminPanelMenu:{bShowCompaniesManagement:!1,bShowUsersManagement:!1,bShowRolesManagement:!1,bShowProjectsManagement:!1,bShowPhasesManagement:!1,bShowDeficiencyStatusesManagement:!1,bShowDeficiencyPrioritiesManagement:!1,bShowSystemFilesManagement:!1,bShowAccountTypesManagement:!1,bShowContactTypesManagement:!1,bShowUnitOptionSetManagement:!1,bShowUnitOptionValueManagement:!1,bShowTaskTypeManagement:!1,bShowActivityTypesManagement:!1},oProfileMenu:{bShowContactDetails:!0,bShowProfileDetails:!0,bShowChangePassword:!0},oHybridMainMenu:{bShowQuickAdd:!0,bShowDeficienciesList:!0},oAuthorizationsPerEntity:{oDeficiency:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oUnit:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oContractor:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oClient:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oContact:{bDisplay:!0,bUpdate:!0,bCreate:!0,bDelete:!0},oActivity:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oUser:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1}}},contactViewerUser:{sInitialState:"app.contactsList",sInitialStateMobile:"deficiencyQuickAddWrapper.quickAdd",bIsGlobalUserAdministrator:!1,oMainMenu:{bShowDeficiencies:!1,bShowUnits:!1,bShowContractors:!0,bShowClients:!0,bShowContacts:!0,bShowActivities:!1,bShowAdminPanel:!1,bShowProfileSettings:!0,bShowNotifications:!0},oAdminPanelMenu:{bShowCompaniesManagement:!1,bShowUsersManagement:!1,bShowRolesManagement:!1,bShowProjectsManagement:!1,bShowPhasesManagement:!1,bShowDeficiencyStatusesManagement:!1,bShowDeficiencyPrioritiesManagement:!1,bShowSystemFilesManagement:!1,bShowAccountTypesManagement:!1,bShowContactTypesManagement:!1,bShowUnitOptionSetManagement:!1,bShowUnitOptionValueManagement:!1,bShowTaskTypeManagement:!1,bShowActivityTypesManagement:!1},oProfileMenu:{bShowContactDetails:!0,bShowProfileDetails:!0,bShowChangePassword:!0},oHybridMainMenu:{bShowQuickAdd:!0,bShowDeficienciesList:!0},oAuthorizationsPerEntity:{oDeficiency:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oUnit:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oContractor:{bDisplay:!0,bUpdate:!1,bCreate:!1,bDelete:!1},oClient:{bDisplay:!0,bUpdate:!1,bCreate:!1,bDelete:!1},oContact:{bDisplay:!0,bUpdate:!0,bCreate:!1,bDelete:!1},oActivity:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oUser:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1}}},contractor:{sInitialState:"app.deficienciesList",sInitialStateMobile:"app.deficienciesList",bIsGlobalUserAdministrator:!1,oMainMenu:{bShowDeficiencies:!0,bShowUnits:!1,bShowContractors:!1,bShowClients:!1,bShowContacts:!1,bShowActivities:!1,bShowAdminPanel:!1,bShowProfileSettings:!0,bShowNotifications:!0},oAdminPanelMenu:{bShowCompaniesManagement:!1,bShowUsersManagement:!1,bShowRolesManagement:!1,bShowProjectsManagement:!1,bShowPhasesManagement:!1,bShowDeficiencyStatusesManagement:!1,bShowDeficiencyPrioritiesManagement:!1,bShowSystemFilesManagement:!1,bShowAccountTypesManagement:!1,bShowContactTypesManagement:!1,bShowUnitOptionSetManagement:!1,bShowUnitOptionValueManagement:!1,bShowTaskTypeManagement:!1,bShowActivityTypesManagement:!1},oProfileMenu:{bShowContactDetails:!0,bShowProfileDetails:!0,bShowChangePassword:!0},oHybridMainMenu:{bShowQuickAdd:!1,bShowDeficienciesList:!0},oAuthorizationsPerEntity:{oDeficiency:{bDisplay:!0,bUpdate:!0,bCreate:!1,bDelete:!1},oUnit:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oContractor:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oClient:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oContact:{bDisplay:!0,bUpdate:!0,bCreate:!1,bDelete:!1},oActivity:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1},oUser:{bDisplay:!1,bUpdate:!1,bCreate:!1,bDelete:!1}}}}}]),app.factory("servicesProvider",["$rootScope","$state","ngTableParams","$translate","tmhDynamicLocale","utilsProvider","cacheProvider","apiProvider","dataProvider","rolesSettings","$cookieStore","$window","$filter","$mdDialog","$upload","CONSTANTS","$cordovaKeyboard","$rootScope",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,a){return{changeLanguage:function(){
var b=d.use();switch(b){case"en":d.use("fr"),e.set("fr");break;case"fr":d.use("en"),e.set("en")}a.$emit("languageChanged")},logIn:function(a){var b={},c=new Hashes.SHA512,d=p.sAppAbsolutePath+"rest/account/login/"+a.oData.userName+"/"+c.hex(a.oData.password),e=$.proxy(function(b){var c=this.messagesHandler(b.messages);c&&(a.onSuccess&&a.onSuccess(),this.onLogInSuccessHandler(a.oData.userName))},this);b=i.httpRequest({sPath:d,bShowSpinner:!0,sRequestType:"GET"}),b.then(function(a){e(a)})},logOut:function(){var a=p.sAppAbsolutePath+"rest/system/initializeSessionVariables",c=$.proxy(function(){g.oUserProfile.sUserName&&this.logLogOut(),g.cleanAllCache(),b.go("signIn")},this);i.ajaxRequest({sPath:a,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:c}})},logSuccessLogIn:function(){var a="Log In";p.bIsHybridApplication&&(a="Log In (mobile)"),h.logEvent({aUsers:["GeneralAdmin"],sEntityName:"",sEntityGuid:"",sOperationNameEN:a})},logLogOut:function(){var a="Log Out";p.bIsHybridApplication&&(a="Log Out (mobile)"),h.logEvent({aUsers:["GeneralAdmin"],sEntityName:"",sEntityGuid:"",sOperationNameEN:a})},onNoDefaultViewForTheRole:function(){this.logOut(),f.displayMessage({sText:d.instant("global_noDefaultViewForTheRole"),sType:"error"})},setUserPhasesForCurrentCompany:function(a){var b=[];g.oUserProfile.aUserPhases=angular.copy(g.oUserProfile.aAllUserPhases);for(var c=0;c<g.oUserProfile.aUserPhases.length;c++)g.oUserProfile.aUserPhases[c].ProjectDetails.CompanyName===a&&b.push(g.oUserProfile.aUserPhases[c]);g.oUserProfile.aAllUserPhases=angular.copy(g.oUserProfile.aUserPhases),g.oUserProfile.aUserPhases=angular.copy(b)},setUserContactForCurrentCompany:function(a){for(var b=[],c=0;c<g.oUserProfile.aAllUserContacts.length;c++)g.oUserProfile.aAllUserContacts[c].CompanyName===a&&(b=g.oUserProfile.aAllUserContacts[c]);g.oUserProfile.oUserContact=angular.copy(b)},checkUserRolesAssignment:function(c){var e=[],i=!1;g.oUserProfile.aUserRoles=angular.copy(g.oUserProfile.aAllUserRoles);for(var k=0;k<g.oUserProfile.aUserRoles.length;k++)g.oUserProfile.aUserRoles[k].CompanyName===c&&e.push(g.oUserProfile.aUserRoles[k]);return g.oUserProfile.aAllUserRoles=angular.copy(g.oUserProfile.aUserRoles),g.oUserProfile.aUserRoles=angular.copy(e),g.oUserProfile.aUserRoles.length?1===g.oUserProfile.aUserRoles.length?(sCurrentRole=g.oUserProfile.aUserRoles[0].RoleName,(i=j.setCurrentRole(sCurrentRole))?(this.logSuccessLogIn(),h.initializePubNub(),this.initializeGetNotificationsFunction(),a.getNotificationsNumber(),void b.go(j.getRolesInitialState(sCurrentRole))):void this.logOut()):void b.go("roleSelection"):(this.logOut(),void f.displayMessage({sText:d.instant("global_noRoleAssignment"),sType:"error"}))},onLogInSuccessHandler:function(a){var c="";if(p.bIsHybridApplication&&oDeviceInfo&&oDeviceInfo.sDeviceToken){var e=function(b){b.length?oDeviceInfo.sGuid=b[0].Guid:h.createUserDevice({oData:{UserName:a,DeviceToken:oDeviceInfo.sDeviceToken,BadgeNumber:0}})};h.getUserDevices({sFilter:"DeviceToken eq '"+oDeviceInfo.sDeviceToken+"' and UserName eq '"+a+"'",onSuccess:e})}return g.oUserProfile=h.getUserProfile(a),g.oUserProfile.bIsInitialPassword?void b.go("initialPasswordReset"):(g.oUserProfile.sPassword="",g.oUserProfile.aUserCompanies.length?1!==g.oUserProfile.aUserCompanies.length?void b.go("companySelection"):(c=g.oUserProfile.aUserCompanies[0].CompanyName,g.oUserProfile.sCurrentCompany=c,h.setCurrentCompany(c),this.setUserPhasesForCurrentCompany(c),this.setUserContactForCurrentCompany(c),this.checkUserRolesAssignment(c),void 0):(this.logOut(),void f.displayMessage({sText:d.instant("global_noCompanyAssignment"),sType:"error"})))},onF5WithCurrentUserHandler:function(c){var e="",i="";return g.oUserProfile=h.getUserProfile(c),g.oUserProfile.bIsInitialPassword?void b.go("signIn"):g.oUserProfile.aUserCompanies.length?(e=h.getCurrentCompany())?(g.oUserProfile.sCurrentCompany=e,this.setUserPhasesForCurrentCompany(e),this.setUserContactForCurrentCompany(e),(i=h.getCurrentRole())?(h.initializePubNub(),this.initializeGetNotificationsFunction(),a.getNotificationsNumber(),j.setCurrentRole(i),void 0):void b.go("roleSelection")):void b.go("companySelection"):(this.logOut(),void f.displayMessage({sText:d.instant("global_noCompanyAssignment"),sType:"error"}))},messagesHandler:function(a){var b=!0;p.bIsHybridApplication&&"ios"===p.sMobileType&&q.close();for(var c=0;c<a.length;c++){var e=a[c].messageCode.toString(),g=d.instant("m"+a[c].messageCode);switch(e[c].substring(0,1)){case"1":f.displayMessage({sText:g,sType:"success"});break;case"2":f.displayMessage({sText:g,sType:"error"}),b=!1;break;case"3":f.displayMessage({sText:g,sType:"warning"})}}return b},costructUploadUrl:function(a){var b="",c=function(a){b=a};return i.ajaxRequest({sPath:a.sPath,sRequestType:"GET",bAsync:!1,oData:{},oEventHandlers:{onSuccess:function(a){c(a)}}}),b},addCommentForEntity:function(b){var c={__batchRequests:[]},d=[],e={},g="",j={},k=function(a){onSuccess=function(){b.onSuccess()},h.createComment({oData:a,bShowSpinner:!0,bShowErrorMessage:!0,onSuccess:onSuccess})};if(b.sParentEntityCommentSetGuid)b.oData.CommentSetGuid=b.sParentEntityCommentSetGuid,k(b.oData);else{g=f.generateGUID(),e={requestUri:"CommentSets",method:"POST",data:{Guid:g,GeneralAttributes:{IsDeleted:!1},LastModifiedAt:f.dateToDBDate(new Date)}},d.push(e),b.sParentEntityGuid&&(e={requestUri:b.sPath+"('"+b.sParentEntityGuid+"')",method:"PUT",data:{CommentSetGuid:g}},d.push(e)),i.constructChangeBlockForBatch({oRequestData:c,aData:d}),j=i.batchRequest({oRequestData:c});var l=function(c){a.sCommentSetGuid=c.Guid,a.sCommentSetLastModifiedAt=c.LastModifiedAt,b.oData.CommentSetGuid=c.Guid,k(b.oData)};j.then(function(a){l(a[0].__changeResponses[0].data)})}},uploadAttachmentsForEntity:function(b){var c={__batchRequests:[]},d=[],e={},g="",j={},k="",l=$.proxy(function(c){var d=0;b.sParentEntityGuid||(p.bIsHybridApplication?b.sParentEntityGuid="quickAddApp":b.sParentEntityGuid="attachmentsBeforeSave");for(var e=0;e<b.aFiles.length;e++){var f=b.aFiles[e],g=this.costructUploadUrl({sPath:p.sAppAbsolutePath+"rest/file/v1v2/createUploadUrlWithFileMetadataSetGuid/Deficiency/"+b.sParentEntityGuid+"/_attachments_/"+c}),i={};p.bIsHybridApplication?(a.$emit("LOAD"),$.ajax({url:g,data:f,cache:!1,contentType:!1,processData:!1,type:"POST",success:$.proxy(function(a){if(d++,d===b.aFiles.length){switch(b.onSuccess(),b.sPath){case"Tasks":k="oDeficiencyEntity"}h.pubNubMessage({sEntityName:k,sText:"New attachemnts added..."})}},this)})):(i=o.upload({url:g,file:f}),i.progress(function(a){b.onProgress&&b.onProgress(a)}),i.success($.proxy(function(){if(d++,d===b.aFiles.length){switch(b.onSuccess(),b.sPath){case"Tasks":k="oDeficiencyEntity"}h.pubNubMessage({sEntityName:k,sText:"New attachemnts added..."})}},this)))}},this);if(b.sParentEntityFileMetadataSetGuid)l(b.sParentEntityFileMetadataSetGuid);else{g=f.generateGUID(),e={requestUri:"FileMetadataSets",method:"POST",data:{Guid:g,GeneralAttributes:{IsDeleted:!1},LastModifiedAt:f.dateToDBDate(new Date)}},d.push(e),b.sParentEntityGuid&&(e={requestUri:b.sPath+"('"+b.sParentEntityGuid+"')",method:"PUT",data:{FileMetadataSetGuid:g}},d.push(e)),i.constructChangeBlockForBatch({oRequestData:c,aData:d}),j=i.batchRequest({oRequestData:c});var m=function(b){a.sFileMetadataSetGuid=b.Guid,a.sFileMetadataSetLastModifiedAt=b.LastModifiedAt,l(g)};j.then(function(a){m(a[0].__changeResponses[0].data)})}},deleteFileAttachment:function(a){var b="rest/file/v2/delete/"+a;i.ajaxRequest({sPath:b,sRequestType:"GET",bAsync:!1,oData:{},oEventHandlers:{onSuccess:function(a){f.displayMessage({sText:d.instant("global_successOperation"),sType:"success"})}}})},getUserPhasesGuids:function(){for(var a=[],b=0;b<g.oUserProfile.aUserPhases.length;b++)a.push(g.oUserProfile.aUserPhases[b].Guid);return a},constructUserProjectsPhases:function(){for(var a=[],b=!1,c=0,d=angular.copy(g.oUserProfile.aUserPhases),e=0;e<d.length;e++){b=!1,c=0;for(var f=0;f<a.length;f++)if(a[f].Guid===d[e].ProjectDetails.Guid){b=!0,c=f;break}b?a[c].PhaseDetails.results.push(d[e]):(d[e].ProjectDetails.PhaseDetails={results:[]},d[e].ProjectDetails.PhaseDetails.results.push(d[e]),a.push(d[e].ProjectDetails))}a=m("orderBy")(a,["_sortingSequence"]);for(var e=0;e<a.length;e++)a[e].PhaseDetails.results=m("orderBy")(a[e].PhaseDetails.results,["_sortingSequence"]);return a},constructUserProjectsPhasesForMultiSelect:function(a){var b=[];b=angular.copy(g.oUserProfile.aUserPhases);var c={aData:b,aPhases:[]},d=[];d=this.constructUserProjectsPhases();var e=a.aSelectedPhases;return this.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:d},sSecondLevelAttribute:"PhaseDetails",sSecondLevelNameEN:"NameEN",sSecondLevelNameFR:"NameFR",oParentArrayWrapper:c,oNewParentItemArrayWrapper:{aData:[]},sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",aParentKeys:e,sTargetArrayNameInParent:"aPhases"}),c.aData[0]?c.aData[0].aPhases:[]},constructImageUrl:function(a){return p.sAppAbsolutePath+"rest/file/v2/get/"+a},constructUserAvatarUrl:function(a){var b=new Hashes.MD5;return""===a&&(a="deficien@cyDetails.com"),sAvatarUrl="http://www.gravatar.com/avatar/"+b.hex(a)+".png?d=identicon"},constructLogoUrl:function(){var b=p.sAppAbsolutePath+"rest/file/v1/list/companyDependentSettings/"+g.oUserProfile.sCurrentCompany+"/_logo_",c=i.httpRequest({sPath:b});c.then(function(b){b[0]?a.sLogoUrl=p.sAppAbsolutePath+"rest/file/v2/get/"+b[0].guid:a.sLogoUrl=p.sAppAbsolutePath+"apps/conspector/img/logo_conspector.png"})},constructMenuIconUrl:function(){a.sMenuIconUrl=p.sAppAbsolutePath+"apps/conspector/img/mobileMenuIcon_tiny.svg"},processListOfComments:function(b){var c="",d="",e="",h=!1,i=[],j=angular.copy(b.oData);if(!j.CommentDetails)return[];for(var k=0;k<j.CommentDetails.results.length;k++)if(c="",d="",e="",!j.CommentDetails.results[k].GeneralAttributes.IsDeleted){j.CommentDetails.results[k].ContactDetails&&(j.CommentDetails.results[k].ContactDetails.FirstName&&(c=j.CommentDetails.results[k].ContactDetails.FirstName+" "),j.CommentDetails.results[k].ContactDetails.LastName&&(c+=j.CommentDetails.results[k].ContactDetails.LastName));var l=new Hashes.MD5;if(j.CommentDetails.results[k].ContactDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails.results[0])var m=l.hex(j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].EMail);else var m=l.hex("deficien@cyDetails.com");d="http://www.gravatar.com/avatar/"+m+".png?d=identicon&s=60",j.CommentDetails.results[k].ContactDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails.results&&j.CommentDetails.results[k].ContactDetails.UserDetails.results.length&&(j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].AvatarFileGuid&&(d=this.constructImageUrl(j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].AvatarFileGuid)),e=j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].UserName),h=e===g.oUserProfile.sUserName?!0:!1,i.push({_guid:j.CommentDetails.results[k].Guid,_lastModifiedAt:j.CommentDetails.results[k].LastModifiedAt,_createdAt:j.CommentDetails.results[k].CreatedAt,sCreatedAt:f.dBDateToSting(j.CommentDetails.results[k].CreatedAt),sText:j.CommentDetails.results[k].Text,sAuthor:c,sAvatarUrl:d,_editMode:!1,_allowEditMode:h,_userName:e})}return a.iCommentsNumber=i.length,i},getSeletedItemsKeysInMultiSelect:function(a){for(var b=[],c=0;c<a.aData.length;c++)a.aData[c].ticked===!0&&b.push(a.aData[c][a.sKey]);return b},constructDependentMultiSelectArray:function(a){for(var b=[],c={},e=0;e<a.oDependentArrayWrapper.aData.length;e++)if(a.sSecondLevelAttribute){c={},c.multiSelectGroup=!0;var f="";(a.oDependentArrayWrapper.aData[e][a.sNameEN]||a.oDependentArrayWrapper.aData[e][a.sNameFR])&&(f="en"===d.use()?a.oDependentArrayWrapper.aData[e][a.sNameEN]:a.oDependentArrayWrapper.aData[e][a.sNameFR],f||(f=a.oDependentArrayWrapper.aData[e][a.sNameEN])),c.name='<div class="cnpButtonLabelChild">'+f+"</div>",b.push(c);for(var g=0;g<a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results.length;g++)c={},(a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameEN]||a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameFR])&&(c.name="en"===d.use()?a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameEN]:a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameFR],c.name||(c.name=a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameEN]),c.fullName='<div class="cnpButtonLabelParent">'+f+'</div><div class="cnpButtonLabelSeparator">&nbsp;-&nbsp;</div><div class="cnpButtonLabelChild">'+c.name+"</div>"),c[a.sDependentKey]=a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sDependentKey],b.push(c);c={},c.multiSelectGroup=!1,b.push(c)}else c={},(a.oDependentArrayWrapper.aData[e][a.sNameEN]||a.oDependentArrayWrapper.aData[e][a.sNameFR])&&(c.name="en"===d.use()?a.oDependentArrayWrapper.aData[e][a.sNameEN]:a.oDependentArrayWrapper.aData[e][a.sNameFR],c.name||(c.name=a.oDependentArrayWrapper.aData[e][a.sNameEN])),a.oDependentArrayWrapper.aData[e][a.sDependentIconKey]&&(c.icon="<img src='"+l.location.origin+l.location.pathname+"rest/file/v2/get/",c.icon=c.icon+a.oDependentArrayWrapper.aData[e][a.sDependentIconKey]+"' class='cnpMultiSelectIcon'/>"),c[a.sDependentKey]=a.oDependentArrayWrapper.aData[e][a.sDependentKey],b.push(c);a.oNewParentItemArrayWrapper&&(a.oNewParentItemArrayWrapper.aData=angular.copy(b));for(var e=0;e<a.oParentArrayWrapper.aData.length;e++){for(var h=[],i={},j=!1,g=0;g<b.length;g++){if(i={},angular.copy(b[g],i),void 0===i.multiSelectGroup&&(i.ticked=!1),a.sParentKey&&a.oParentArrayWrapper.aData[e][a.sParentKey]===b[g][a.sDependentKey]&&(i.ticked=!0,j=!0),a.sParentKeys)for(var k=0;k<a.oParentArrayWrapper.aData[e][a.sParentKeys].length;k++)b[g][a.sDependentKey]===a.oParentArrayWrapper.aData[e][a.sParentKeys][k]&&(i.ticked=!0,j=!0);if(a.aParentKeys)for(var k=0;k<a.aParentKeys.length;k++)b[g][a.sDependentKey]===a.aParentKeys[k]&&(i.ticked=!0,j=!0);h.push(i)}a.oParentArrayWrapper.aData[e][a.sTargetArrayNameInParent]=h}},initializeGetNotificationsFunction:function(){a.getNotificationsNumber=function(){var b=function(b){a.iNotificationsNumber=b};h.getOperationLogs({sFilter:"CompanyName eq '"+g.oUserProfile.sCurrentCompany+"' and UserName eq '"+g.oUserProfile.sUserName+"' and Status eq 'not read' and GeneralAttributes/IsDeleted eq false",bAddCountUrlParam:!0,onSuccess:b})}},createNgTable:function(a){var b=new c({page:1,count:1e4,filterDelay:10,sorting:a.oInitialSorting,filter:a.oInitialFilter,groupsSettings:a.aInitialGroupsSettings},{groupBy:a.sGroupBy,total:a.oInitialDataArrayWrapper.aData.length,sDisplayedDataArrayName:a.sDisplayedDataArrayName,getData:function(b,c){var d=a.oInitialDataArrayWrapper.aData,e=angular.copy(c.filter());for(var g in e)e.hasOwnProperty(g)&&(e[g]=f.replaceSpecialChars(e[g]));var h=e?m("filter")(d,e):d,i=[],j=angular.copy(c.orderBy());a.sGroupsSortingAttribue&&j.unshift(a.sGroupsSortingAttribue),i=void 0===j||angular.equals(j,{})?h:m("orderBy")(h,j),b.resolve(i.slice((c.page()-1)*c.count(),c.page()*c.count()))},counts:[]});return b},setUpPhotoGallery:function(b){a.sGalleryPhotosLocation=l.location.origin+l.location.pathname+"rest/file/v2/get/",a.aGalleryData=[];for(var c=0;c<b.length;c++)a.aGalleryData.push({sGuid:b[c].Guid});a.oSelectedPhoto=a.aGalleryData[0],a.aGalleryData[0]&&(a.sSelectedPhotoID=a.aGalleryData[0].sGuid),a.oGalleryListPosition={left:"0px"},a.bIsGalleryHidden=!1},showConfirmationPopup:function(a){var b=n.confirm().title(a.sHeader).content(a.sContent).ok(a.sOk).cancel(a.sCancel).targetEvent(a.event);n.show(b).then(function(){a.onOk()},function(){a.onCancel&&a.onCancel()})},refreshUserProfile:function(){var a=g.oUserProfile.sCurrentCompany,b=g.oUserProfile.sCurrentRole,c=angular.copy(g.oUserProfile.aGloballySelectedPhasesGuids);g.oUserProfile=h.getUserProfile(g.oUserProfile.sUserName),g.oUserProfile.sCurrentCompany=a,g.oUserProfile.sCurrentRole=b,g.oUserProfile.aGloballySelectedPhasesGuids=c,this.setUserPhasesForCurrentCompany(a),this.setUserContactForCurrentCompany(a),this.setUserContactForCurrentCompany(a)}}}]),app.factory("historyProvider",[function(){return{aHistoryStates:[],bBackNavigationFlag:!1,addStateToHistory:function(a){this.bBackNavigationFlag||this.aHistoryStates.push(a),this.bBackNavigationFlag=!1},navigateBack:function(a){this.bBackNavigationFlag=!0;var b=this.aHistoryStates[this.aHistoryStates.length-1];this.aHistoryStates.pop(),a.oState.go(b.sStateName,b.oStateParams)},removeHistory:function(){this.aHistoryStates=[]},getPreviousStateName:function(){var a="";return this.aHistoryStates.length&&this.aHistoryStates[this.aHistoryStates.length-1]&&(a=this.aHistoryStates[this.aHistoryStates.length-1].sStateName),a}}}]),angular.module("filtersProvider",[]).filter("phoneFormatter",function(){return function(a){if(!a)return"";var b=a.toString().trim().replace(/^\+/,"");if(b.match(/[^0-9]/))return a;var c,d,e;switch(b.length){case 10:c=0,d=b.slice(0,3),e=b.slice(3);break;case 11:c=1,d=b.slice(1,4),e=b.slice(4);break;default:return a}return 1==c&&(c="1"),0==c&&(c=""),e=e.slice(0,3)+"-"+e.slice(3),(c+" ("+d+") "+e).trim()}}).filter("searchInMultiSelect",function(){return function(a,b){for(var c=[],d=!1,e=0;e<a.length;e++)if(d=!1,-1!==a[e].sName.toString().toLowerCase().indexOf(b.sName.toString().toLowerCase())||-1!==a[e].sCleanedName.toString().toLowerCase().indexOf(b.sName.toString().toLowerCase())){for(var f=0;f<b.aSelectedItems.length;f++)a[e].sGuid===b.aSelectedItems[f].sGuid&&(d=!0);d||c.push(a[e])}return c}}),angular.module("controlsProvider",[]).directive("cnpPhotoGallery",[function(){return{restrict:"E",scope:!0,controller:["$scope","$rootScope",function(a,b){var c=400;a.stopPropagation=function(a){a.stopPropagation()},a.scrollTo=function(a,d){b.oGalleryListPosition={left:c*d*-1+"px"},b.sSelectedPhotoID=a.sGuid,b.oSelectedPhoto=a}}],templateUrl:"apps/conspector/js/templates/photoGallery.html"}}]),app.controller("mainController",["$scope","$rootScope","$state","apiProvider","servicesProvider","cacheProvider","CONSTANTS","utilsProvider","cfpLoadingBar",function(a,b,c,d,e,f,g,h,i){var j=d.getCurrentUserName();j&&e.onF5WithCurrentUserHandler(j),b.$on("LOAD",function(){i.start(),b.showSpinner=!0}),b.$on("UNLOAD",function(){i.complete(),b.showSpinner=!1}),b.bIsGalleryHidden=!0,b.hideGallery=function(){b.bIsGalleryHidden=!0}}]),viewControllers.controller("companySelectionView",["$scope","$rootScope","$state","$translate","utilsProvider","dataProvider","cacheProvider","$filter","rolesSettings","servicesProvider","apiProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=[];b.sCurrentStateName=c.current.name,g.clearOtherViewsScrollPosition(""),b.oStateParams={},a.sLanguage=d.use(),b.$on("languageChanged",function(){a.sLanguage=d.use()});for(var n=0;n<g.oUserProfile.aUserCompanies.length;n++){var o={};o.CompanyName=g.oUserProfile.aUserCompanies[n].CompanyName,o.DescriptionEN=g.oUserProfile.aUserCompanies[n].DescriptionEN,o.DescriptionFR=g.oUserProfile.aUserCompanies[n].DescriptionFR,o.DescriptionFR||(o.DescriptionFR=o.DescriptionEN),o._sortingSequence=g.oUserProfile.aUserCompanies[n].GeneralAttributes.SortingSequence,m.push(o)}if(a.aUserCompanies=h("orderBy")(m,["_sortingSequence"]),g.oUserProfile.sCurrentCompany){for(var n=0;n<a.aUserCompanies.length;n++)if(a.aUserCompanies[n].CompanyName===g.oUserProfile.sCurrentCompany){a.sSelectedCompanyName=a.aUserCompanies[n].CompanyName;break}}else a.sSelectedCompanyName=a.aUserCompanies[0].CompanyName;a.onContinue=function(){var b=a.sSelectedCompanyName;g.oUserProfile.sCurrentCompany=b,k.setCurrentCompany(b),g.oUserProfile.aUserRoles=angular.copy(g.oUserProfile.aAllUserRoles),j.setUserPhasesForCurrentCompany(b),j.setUserContactForCurrentCompany(b),j.checkUserRolesAssignment(b)},a.onChangeLanguage=function(){j.changeLanguage()},a.onBack=function(){l.aHistoryStates.length||c.go("signIn"),l.navigateBack({oState:c})},a.$on("$destroy",function(){l.addStateToHistory({sStateName:b.sCurrentStateName})})}]),viewControllers.controller("forgotPasswordView",["$scope","$rootScope","$state","$stateParams","utilsProvider","dataProvider","servicesProvider","apiProvider","$translate","historyProvider",function(a,b,c,d,e,f,g,h,i,j){a.oForms={},a.sSelectedResetType="userName",a.resetData={sUserName:"",sEmail:""},a.onChangeLanguage=function(){g.changeLanguage()},a.onReset=function(){var b={userName:"",email:""};if("userName"===a.sSelectedResetType?b.userName=a.resetData.sUserName:b.email=a.resetData.sEmail,!b.userName&&!b.email)return void e.displayMessage({sText:i.instant("global_emptyFields"),sType:"error"});var c=function(a){g.messagesHandler(a.messages)};h.resetPassword({oData:b,onSuccess:c})},a.onResetTypeChange=function(){"userName"===a.sSelectedResetType?a.resetData.sEmail="":a.resetData.sUserName=""},a.onBack=function(){j.aHistoryStates.length||c.go("signIn"),j.navigateBack({oState:c})}}]),viewControllers.controller("initialPasswordResetView",["$scope","$rootScope","$state","dataProvider","$translate","servicesProvider","utilsProvider","cacheProvider","apiProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j){a.oForms={},a.resetPasswordData={sNewPassword:"",sNewPasswordConfirmation:""},b.sCurrentStateName=c.current.name,b.oStateParams={},a.onChangeLanguage=function(){f.changeLanguage()};var k=function(a){h.oUserProfile.sLastModifiedAt=a.LastModifiedAt,f.onLogInSuccessHandler(h.oUserProfile.sUserName,"")};a.resetPassword=function(){a.oForms.initialPasswordResetForm.password.$setDirty(),a.oForms.initialPasswordResetForm.passwordConfirmation.$setDirty();var b=new Hashes.SHA512,c={};return a.resetPasswordData.sNewPassword&&a.resetPasswordData.sNewPasswordConfirmation?a.resetPasswordData.sNewPassword!==a.resetPasswordData.sNewPasswordConfirmation?void g.displayMessage({sText:e.instant("global_passwordsDontMatch"),sType:"error"}):(c.UserName=h.oUserProfile.sUserName,c.Password=i.hashPassword(b.hex(a.resetPasswordData.sNewPassword)),c.IsPasswordInitial=!1,c.LastModifiedAt=h.oUserProfile.sLastModifiedAt,void i.updateUser({bShowSpinner:!0,sKey:c.UserName,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:k})):void g.displayMessage({sText:e.instant("global_emptyFields"),sType:"error"})},a.onBack=function(){j.aHistoryStates.length||c.go("signIn"),j.navigateBack({oState:c})},a.$on("$destroy",function(){j.addStateToHistory({sStateName:b.sCurrentStateName})})}]),viewControllers.controller("passwordResetView",["$scope","$rootScope","$state","dataProvider","$translate","servicesProvider","utilsProvider","cacheProvider","apiProvider","$stateParams","historyProvider",function(a,b,c,d,e,f,g,h,i,j,k){a.oForms={},a.resetPasswordData={sNewPassword:"",sNewPasswordConfirmation:""},b.sCurrentStateName=c.current.name,b.oStateParams={},a.onChangeLanguage=function(){f.changeLanguage()},a.resetPassword=function(){a.oForms.passwordResetForm.password.$setDirty(),a.oForms.passwordResetForm.passwordConfirmation.$setDirty();var b=new Hashes.SHA512,d={};if(!a.resetPasswordData.sNewPassword||!a.resetPasswordData.sNewPasswordConfirmation)return void g.displayMessage({sText:e.instant("global_emptyFields"),sType:"error"});if(a.resetPasswordData.sNewPassword!==a.resetPasswordData.sNewPasswordConfirmation)return void g.displayMessage({sText:e.instant("passwordReset_passwordsDontMatch"),sType:"error"});d.newPassword=b.hex(a.resetPasswordData.sNewPassword),d.passwordRecoveryCode=j.pr;{var h=function(a){var b=f.messagesHandler(a.messages);b&&c.go("signIn")};i.resetPasswordWithPRCode({oData:d,onSuccess:h})}},a.onBack=function(){k.aHistoryStates.length||c.go("signIn"),k.navigateBack({oState:c})},a.$on("$destroy",function(){k.addStateToHistory({sStateName:b.sCurrentStateName})})}]),viewControllers.controller("roleSelectionView",["$scope","$rootScope","$state","$translate","utilsProvider","dataProvider","cacheProvider","$filter","rolesSettings","servicesProvider","apiProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=[];g.clearOtherViewsScrollPosition(""),b.sCurrentStateName=c.current.name,b.oStateParams={},a.sLanguage=d.use(),b.$on("languageChanged",function(){a.sLanguage=d.use()});for(var n=0;n<g.oUserProfile.aUserRoles.length;n++){var o={};o.RoleName=g.oUserProfile.aUserRoles[n].RoleName,o.DescriptionEN=g.oUserProfile.aUserRoles[n].DescriptionEN,o.DescriptionFR=g.oUserProfile.aUserRoles[n].DescriptionFR,o.CompanyName=g.oUserProfile.aUserRoles[n].CompanyName,o.DescriptionFR||(o.DescriptionFR=o.DescriptionEN),o._sortingSequence=g.oUserProfile.aUserRoles[n].GeneralAttributes.SortingSequence,o.CompanyName===g.oUserProfile.sCurrentCompany&&m.push(o)}if(a.aUserRoles=h("orderBy")(m,["_sortingSequence"]),g.oUserProfile.sCurrentRole){for(var p=!1,n=0;n<a.aUserRoles.length;n++)if(a.aUserRoles[n].RoleName===g.oUserProfile.sCurrentRole){a.sSelectedRoleName=a.aUserRoles[n].RoleName,p=!0;break}p||(a.sSelectedRoleName=a.aUserRoles[0].RoleName)}else a.sSelectedRoleName=a.aUserRoles[0].RoleName;a.onContinue=function(){var d=a.sSelectedRoleName,e=!1;return(e=i.setCurrentRole(d))?(j.logSuccessLogIn(),k.initializePubNub(),j.initializeGetNotificationsFunction(),b.getNotificationsNumber(),void c.go(i.getRolesInitialState(d))):void j.logOut()},a.onChangeLanguage=function(){j.changeLanguage()},a.onBack=function(){l.aHistoryStates.length||c.go("signIn"),l.navigateBack({oState:c})},a.$on("$destroy",function(){l.addStateToHistory({sStateName:b.sCurrentStateName})})}]),viewControllers.controller("signInView",["$scope","$rootScope","$state","servicesProvider","dataProvider","$cookieStore","utilsProvider","$translate","historyProvider","CONSTANTS","$localStorage",function(a,b,c,d,e,f,g,h,i,j,k){b.sCurrentStateName=c.current.name,a.oForms={};var l={};a.bRememberUserName=!0,a.onChangeLanguage=function(){d.changeLanguage()},a.$storage=k,a.login=function(){if(a.oForms.signInForm.password.$setDirty(),a.oForms.signInForm.userName.$setDirty(),a.oForms.signInForm.$valid){var b={userName:a.$storage.sUserName,password:a.$storage.sPassword},c=function(){a.bRememberUserName||(delete k.sUserName,delete k.sPassword)};d.logIn({oData:b,onSuccess:c})}},a.passwordFldKeyDown=function(a){13===a.keyCode&&this.login()},a.onSignInClick=function(){a.bSubmitted=!0,this.login()},a.onSwitchLanguage=function(){g.switchLanguage()},a.onForgotPassword=function(){c.go("forgotPassword")},a.$on("$destroy",function(){i.addStateToHistory({sStateName:b.sCurrentStateName})}),a.setForm=function(a){l=angular.copy(a)}}]),viewControllers.controller("appView",["$scope","$rootScope","$state","$mdSidenav","$window","servicesProvider","notificationsProvider","$translate","cacheProvider","rolesSettings","$cookieStore","historyProvider","apiProvider","utilsProvider","$filter","$timeout","CONSTANTS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){b.sCurrentStateName=c.current.name,b.oStateParams={},a.bMobileMode=bMobileMode,a.oUserProfile=i.oUserProfile,a.sCurrentLanguage=h.use(),a.iDisplayedNotificationsNumber=0;var r=a.oUserProfile.sUserName,s=a.oUserProfile.sCurrentCompany,t=a.oUserProfile.sCurrentRole,u=[],v=1;if(r||f.logOut(),f.constructLogoUrl(),bMobileMode||(u=k.get("globallySelectedPhasesGuids"+r+s)&&k.get("globallySelectedPhasesGuids"+r+s).aPhasesGuids?angular.copy(k.get("globallySelectedPhasesGuids"+r+s).aPhasesGuids):[],a.onGlobalUserPhasesChanged=function(){var b=[];b=f.getSeletedItemsKeysInMultiSelect({sKey:"Guid",aData:a.globalProjectsWithPhases}),k.put("globallySelectedPhasesGuids"+r+s,{aPhasesGuids:b}),i.oUserProfile.aGloballySelectedPhasesGuids=b,a.globalSelectedPhases=b,a.$broadcast("globalUserPhasesHaveBeenChanged")}),i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowAdminPanel"})&&(a.bDisplayAdminPanel=!0),i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowProfileSettings"})&&(a.bDisplayProfileSettings=!0),i.oUserProfile.aUserCompanies&&i.oUserProfile.aUserCompanies.length>1&&(a.bDisplaySwitchCompanies=!0),i.oUserProfile.aUserRoles&&i.oUserProfile.aUserRoles.length>1&&(a.bDisplaySwitchRoles=!0),a.selectedTabIndex,a.aSideMenuItems=[],a.aTabs=[],i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowDeficiencies"})&&(a.aTabs.push({sTitle:"app_deficienciesTab",sState:"app.deficienciesList"}),a.aSideMenuItems.push({sTitle:"app_deficienciesTab",sState:"app.deficienciesList"})),i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowUnits"})&&(a.aTabs.push({sTitle:"app_unitsTab",sState:"app.unitsList"}),a.aSideMenuItems.push({sTitle:"app_unitsTab",sState:"app.unitsList"})),i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowContractors"})&&(a.aTabs.push({sTitle:"app_contractorsTab",sState:"app.contractorsList"}),a.aSideMenuItems.push({sTitle:"app_contractorsTab",sState:"app.contractorsList"})),i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowClients"})&&(a.aTabs.push({sTitle:"app_clientsTab",sState:"app.clientsList"}),a.aSideMenuItems.push({sTitle:"app_clientsTab",sState:"app.clientsList"})),i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowContacts"})&&(a.aTabs.push({sTitle:"app_contactsTab",sState:"app.contactsList"}),a.aSideMenuItems.push({sTitle:"app_contactsTab",sState:"app.contactsList"})),i.oUserProfile.oCurrentRoleSettings&&j.getRolesMainMenuItemSettings({sRole:t,sMenuItem:"bShowActivities"})&&a.aTabs.push({sTitle:"app_activitiesTab",sState:"app.activitiesList"}),!bMobileMode){i.oUserProfile.aGloballySelectedPhasesGuids=u,a.globalSelectedPhases=u,a.globalProjectsWithPhases=f.constructUserProjectsPhasesForMultiSelect({aSelectedPhases:u});var w=function(b){for(var c=0;c<a.aTabs.length;c++)if(a.aTabs[c].sState===b)return c},x=function(){return e.location.hash.indexOf("#/app/adminPanel")>-1||e.location.hash.indexOf("#/app/profileSettings")>-1||e.location.hash.indexOf("#/app/clientDetails")>-1||e.location.hash.indexOf("#/app/contractorDetails")>-1||e.location.hash.indexOf("#/app/contactDetails")>-1||e.location.hash.indexOf("#/app/deficiencyDetails")>-1||e.location.hash.indexOf("#/app/activityDetails")>-1||e.location.hash.indexOf("#/app/unitDetails")>-1||e.location.hash.indexOf("#/app/notificationsList")>-1?(a.selectedTabIndex=-1,void a.$broadcast("$mdTabsPaginationChanged")):e.location.hash.indexOf("deficienc")>-1?void(a.selectedTabIndex=w("app.deficienciesList")):e.location.hash.indexOf("unit")>-1?void(a.selectedTabIndex=w("app.unitsList")):e.location.hash.indexOf("contractor")>-1?void(a.selectedTabIndex=w("app.contractorsList")):e.location.hash.indexOf("client")>-1?void(a.selectedTabIndex=w("app.clientsList")):e.location.hash.indexOf("contact")>-1?void(a.selectedTabIndex=w("app.contactsList")):e.location.hash.indexOf("activit")>-1?void(a.selectedTabIndex=w("app.activitiesList")):void 0};p(x,100),a.onTabSelect=function(b){var d="";e.location.hash.indexOf("deficienc")>-1&&(d="Deficiencies"),e.location.hash.indexOf("unit")>-1&&(d="Units"),e.location.hash.indexOf("contractor")>-1&&(d="Contractors"),e.location.hash.indexOf("client")>-1&&(d="Clients"),e.location.hash.indexOf("contact")>-1&&(d="Contacts"),e.location.hash.indexOf("activit")>-1&&(d="Activities"),void 0!==a.selectedTabIndex&&c.go(b.sState)},a.$on("$stateChangeSuccess",function(a,b,c,d,e){p(x,100)})}a.aNotifications=[];var y=function(b){b.results.length>0&&a.$evalAsync(function(){a.aNotifications=a.aNotifications.concat(b.results),a.iTotalNotificationsNumber=b.__count,a.iDisplayedNotificationsNumber=a.aNotifications.length})},z=function(a){var b="$top=5&$orderby=CreatedAt desc&$inlinecount=allpages";a>1&&(b=b+"&$skip="+5*(a-1)),
m.getOperationLogs({sExpand:"PhaseDetails/ProjectDetails,ContactDetails/UserDetails",sFilter:"CompanyName eq '"+i.oUserProfile.sCurrentCompany+"' and UserName eq '"+i.oUserProfile.sUserName+"' and GeneralAttributes/IsDeleted eq false",sOtherUrlParams:b,onSuccess:y})};a.onDisplay=function(b,d){switch(i.putListViewScrollPosition("deficienciesList",$(".cnpContentWrapper")[0].scrollTop),b.EntityName){case"deficiency":c.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"display",sDeficiencyGuid:b.EntityGuid}),a.onCloseNotificationsMenu()}m.updateOperationLog({sKey:b.Guid,oData:{Status:"read"}})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.$on("notificationsShouldBeRefreshed",function(b){i.putListViewScrollPosition("deficienciesList",$(".cnpContentWrapper")[0].scrollTop),a.aNotifications=[],v=1,z(v)}),a.onMarkAllAsRead=function(){for(var b=[],c=function(){v=1,y()},d=0;d<a.aNotifications.length;d++)"not read"===a.aNotifications[d].Status&&(b.push({Guid:a.aNotifications[d].Guid,Status:"read"}),a.aNotifications[d].Status="read");b.length&&m.updateOperationLogs({aData:b,onSuccess:c})},a.onDismissAll=function(){var b=function(){a.aNotifications=[],v=1,z(v)};a.aNotifications.length&&m.deleteOperationLogs({aData:a.aNotifications,onSuccess:b})},a.onSideMenuItemClicked=function(b){a.selectedTabIndex=-1,a.$broadcast("$mdTabsPaginationChanged"),c.go(b.sState),a.onCloseMenu()},a.onAdminPanel=function(){a.selectedTabIndex=-1,a.$broadcast("$mdTabsPaginationChanged"),c.go("app.adminPanel.usersList")},a.onProfileSettings=function(){a.selectedTabIndex=-1,a.$broadcast("$mdTabsPaginationChanged"),c.go("app.profileSettings.profileDetails")},a.onOpenNotificationsMenu=function(){a.aNotifications=[],v=1,z(v),p(d("globalRight").open,300)},a.onCloseNotificationsMenu=function(){p(d("globalRight").close,300)},a.onShowMore=function(){v++,z(v)},a.onOpenMenu=function(){p(d("leftMenu").open,300)},a.onCloseMenu=function(){p(d("leftMenu").close,300)},a.hoverIn=function(){a.bDisplayUserDropdownMenu=!0},a.hoverOut=function(){a.bDisplayUserDropdownMenu=!1},a.onChangeLanguage=function(){f.changeLanguage()},a.onSwitchCompanies=function(){c.go("companySelection")},a.onSwitchRoles=function(){c.go("roleSelection")},a.onLogOut=function(){f.logOut()},a.$on("$destroy",function(){l.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams})})}]),viewControllers.controller("mainMenuHybridView",["$scope","$rootScope","$state","$stateParams","$window","servicesProvider","$translate","$timeout","cacheProvider","rolesSettings","$cookieStore","historyProvider",function(a,b,c,d,e,f,g,h,i,j,k,l){b.sCurrentStateName=c.current.name,b.oStateParams=angular.copy(d);var m=i.oUserProfile.sCurrentRole;a.aMenuItems=[],a.aMenuItems.push({bShouldBeDisplayed:j.getRolesHybridMainMenuItemSettings({sRole:m,sMenuItem:"bShowQuickAdd"}),sStateName:"deficiencyQuickAddWrapper.quickAdd",sMenuLabel:"hybrid_quickAddMenuItem"}),a.aMenuItems.push({bShouldBeDisplayed:j.getRolesHybridMainMenuItemSettings({sRole:m,sMenuItem:"bShowDeficienciesList"}),sStateName:"deficienciesListHybridWrapper.deficienciesSearchHybrid",sMenuLabel:"hybrid_deficienciesListItem"}),a.onMenuItemSelected=function(a){c.go(a.sStateName)},a.onBack=function(){l.navigateBack({oState:c})},a.onChangeLanguage=function(){f.changeLanguage()},a.onLogOut=function(){b.aProjectsWithPhases=void 0,b.bPhaseWasSelected=void 0,b.aUnits=void 0,b.sUnitFilter=void 0,b.aFilteredUnits=void 0,b.bUnitWasSelected=void 0,b.aStatuses=void 0,b.bStatusWasSelected=void 0,b.aPriorities=void 0,b.bPriorityWasSelected=void 0,b.aUsers=void 0,b.bUserWasSelected=void 0,b.aDescriptionTags=void 0,b.aLocationTags=void 0,b.aContractors=void 0,b.sContractorsFilter=void 0,b.aFilteredContractors=void 0,b.bContractorWasSelected=void 0,b.oDeficiencyAttributes=void 0,b.oSearchCriterias=void 0,b.aDeficiencies=void 0,b.aSelectedDeficiencyStatuses=void 0,b.oSelectedDeficiency=void 0,f.logOut()},a.$on("$destroy",function(){l.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("deficienciesListView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","utilsProvider","historyProvider","$mdSidenav","$window","$filter","$cookieStore","rolesSettings","$timeout","CONSTANTS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){"app.unitDetailsWrapper.unitDetails"!==b.sCurrentStateName&&"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&(j.removeHistory(),b.oStateParams={},h.clearOtherViewsScrollPosition("deficienciesList")),a.toggleAdminPanelRightSideNav=function(){p(k("adminPanelRightSideNav").toggle,200)};var r=h.oUserProfile.sUserName,s=h.oUserProfile.sCurrentCompany,t=h.oUserProfile.sCurrentRole;a.bDisplayAddButton=o.getRolesSettingsForEntityAndOperation({sRole:t,sEntityName:"oDeficiency",sOperation:"bCreate"}),a.bDisplayEditButtons=o.getRolesSettingsForEntityAndOperation({sRole:t,sEntityName:"oDeficiency",sOperation:"bUpdate"}),b.sCurrentStateName=c.current.name;var u="";d.sUnitGuid&&(u=d.sUnitGuid);var v="";d.sContractorGuid&&(v=d.sContractorGuid),n.get("selectedDeficiencyStatuses"+r+s)&&n.get("selectedDeficiencyStatuses"+r+s).aSelectedStatuses&&(a.aSelectedStatuses=angular.copy(n.get("selectedDeficiencyStatuses"+r+s).aSelectedStatuses)),a.aDataForMassChanges=[];var w={aData:[]},x={aData:[{_statusesGuids:[]}]},y={_statusesGuids:[]},z=[],A=h.getTableStatusFromCache({sTableName:"deficienciesList",sStateName:b.sCurrentStateName}),B={sUnit:"asc",sStatusSortingSequence:"asc",_createdAt:"desc"};A&&!angular.equals(A.oSorting,{})&&(B=angular.copy(A.oSorting));var C={};A&&!angular.equals(A.oFilter,{})&&(C=angular.copy(A.oFilter));var D=[];A&&!angular.equals(A.aGroups,[])&&(D=angular.copy(A.aGroups)),a.tableParams=e.createNgTable({oInitialDataArrayWrapper:w,sDisplayedDataArrayName:"aDisplayedDeficiencies",oInitialSorting:B,oInitialFilter:C,aInitialGroupsSettings:D,sGroupBy:"sProjectPhase",sGroupsSortingAttribue:"_sortingSequence"});var E=function(b){for(var c=0;c<b.length;c++)b[c]._sortingSequence=b[c].GeneralAttributes.SortingSequence;b=m("orderBy")(b,["_sortingSequence"]),z=[];for(var c=0;c<b.length;c++)("Done by Contractor"==b[c].NameEN||"In Progress"==b[c].NameEN||"Non Conform"==b[c].NameEN||"contractor"!==h.oUserProfile.sCurrentRole)&&z.push(b[c]);if(y._statusesGuids=[],a.aSelectedStatuses)for(var c=0;c<a.aSelectedStatuses.length;c++)y._statusesGuids.push(a.aSelectedStatuses[c].Guid);x.aData[0]=angular.copy(y),e.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:x,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKeys:"_statusesGuids",sDependentIconKey:"AssociatedIconFileGuid",sTargetArrayNameInParent:"aDeficiencyStatuses"}),x.aData[0]&&(a.aDeficiencyStatuses=angular.copy(x.aData[0].aDeficiencyStatuses))},F=function(c){var d="",e="",g="",j="",k="",m=new Date,n="",o=!1,q=0,r="",s="",t="",u="",v="",x=0,y="",z=[],A="",B="";w.aData=[];for(var C=0;C<c.length;C++){if(d="",e="",n="",g="",j="",k="",r="",q=0,s="",sStatusIconGuid="",t="",u="",sPriorityDescriptionEN="",v="",x=0,z=[],A="",B="",o=!1,c[C].PhaseDetails){q=c[C].PhaseDetails.GeneralAttributes.SortingSequence;for(var D=0;D<h.oUserProfile.aGloballySelectedPhasesGuids.length;D++)if(c[C].PhaseDetails.Guid===h.oUserProfile.aGloballySelectedPhasesGuids[D]){o=!0;break}if(!o)continue;d="en"===f.use()?c[C].PhaseDetails.ProjectDetails.NameEN:c[C].PhaseDetails.ProjectDetails.NameFR,d||(d=c[C].PhaseDetails.ProjectDetails.NameEN),e="en"===f.use()?c[C].PhaseDetails.NameEN:c[C].PhaseDetails.NameFR,e||(e=c[C].PhaseDetails.NameEN),n=d+" - "+e}else n="Not Assigned";if(c[C].TaskStatusDetails&&(r=c[C].TaskStatusDetails.GeneralAttributes.SortingSequence,s=l.location.origin+l.location.pathname+"rest/file/v2/get/"+c[C].TaskStatusDetails.AssociatedIconFileGuid,u=c[C].TaskStatusDetails.NameEN,t="en"===f.use()?c[C].TaskStatusDetails.NameEN:c[C].TaskStatusDetails.NameFR,t||(t=c[C].TaskStatusDetails.NameEN),sStatusIconGuid=c[C].TaskStatusDetails.AssociatedIconFileGuid),c[C].TaskPriorityDetails&&(sPriorityDescriptionEN=c[C].TaskPriorityDetails.NameEN),c[C].AccountDetails)for(var E=0;E<c[C].AccountDetails.results.length;E++)v=v+c[C].AccountDetails.results[E].Name+"; ",B=B+c[C].AccountDetails.results[E].Guid+"; ";if(c[C].UnitDetails&&(c[C].sUnitName=c[C].UnitDetails.Name),c[C].FileMetadataSetDetails){if(y=c[C].FileMetadataSetDetails.LastModifiedAt,c[C].FileMetadataSetDetails.FileMetadataDetails)for(var E=0;E<c[C].FileMetadataSetDetails.FileMetadataDetails.results.length;E++)c[C].FileMetadataSetDetails.FileMetadataDetails.results[E].MediaType&&c[C].FileMetadataSetDetails.FileMetadataDetails.results[E].MediaType.indexOf("image")>-1&&c[C].FileMetadataSetDetails.FileMetadataDetails.results[E].GeneralAttributes.IsDeleted===!1&&z.push(c[C].FileMetadataSetDetails.FileMetadataDetails.results[E]);x=z.length}var F=0;if(c[C].CommentSetDetails&&c[C].CommentSetDetails.CommentDetails)for(var E=0;E<c[C].CommentSetDetails.CommentDetails.results.length;E++)c[C].CommentSetDetails.CommentDetails.results[E].GeneralAttributes.IsDeleted||F++;var G="",H="";if(c[C].DueDate&&"/Date(0)/"!=c[C].DueDate){k=i.dBDateToSting(c[C].DueDate),dDueDate=new Date(parseInt(c[C].DueDate.substring(6,c[C].DueDate.length-2)));var I=Math.abs(m.getTime()-dDueDate.getTime());G=Math.ceil(I/864e5)-1,H="en"===f.use()?"d":"j"}c[C].Description&&(A=i.removeTagsFromString(c[C].Description)),w.aData.push({_guid:c[C].Guid,_phaseGuid:c[C].PhaseGuid,sUnit:i.convertStringToInt(c[C].sUnitName),sCleanedUnit:i.replaceSpecialChars(c[C].sUnitName),sTags:null!==c[C].DescriptionTags&&void 0!==c[C].DescriptionTags?c[C].DescriptionTags:"",sCleanedTags:i.replaceSpecialChars(c[C].DescriptionTags),sLocationTags:null!==c[C].LocationTags&&void 0!==c[C].LocationTags?c[C].LocationTags:"",sDueIn:i.convertStringToInt(G),sDueInLetter:H,sProjectPhase:n,sContractors:v,sContractorsGuids:B,sCleanedContractors:i.replaceSpecialChars(v),sStatusSortingSequence:r,sStatuseIconUrl:s,sStatusIconGuid:sStatusIconGuid,sStatusDescription:t,sStatusDescriptionEN:u,sPriorityDescriptionEN:sPriorityDescriptionEN,sDescription:A,_unitGuid:c[C].UnitGuid,_sortingSequence:q,_fileMetadataSetGuid:c[C].FileMetadataSetGuid,_fileMetadataSetLastModifiedAt:y,iImagesNumber:x,iCommentsNumber:F,_createdAt:c[C].CreatedAt,_aImages:z})}a.tableParams.reload(),"app.unitDetailsWrapper.unitDetails"!==b.sCurrentStateName&&"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&p(function(){$(".cnpContentWrapper")[0]&&($(".cnpContentWrapper")[0].scrollTop=h.getListViewScrollPosition("deficienciesList"),h.putListViewScrollPosition("deficienciesList",0))},0)},G=function(){w.aData=[];var b="",c=" and (",d=")",e="";if("contractor"===h.oUserProfile.sCurrentRole&&(e=" and substringof('"+h.oUserProfile.oUserContact.AccountDetails.Guid+"', AccountGuids) eq true"),!(a.globalSelectedPhases.length>0))return w.aData=[],void F([]);b=c;for(var f=0;f<a.globalSelectedPhases.length;f++)b=b+"PhaseGuid eq '"+a.globalSelectedPhases[f]+"'",f<a.globalSelectedPhases.length-1&&(b+=" or ");if(b+=d,a.aSelectedStatuses&&a.aSelectedStatuses.length>0){b+=c;for(var f=0;f<a.aSelectedStatuses.length;f++)b=b+"TaskStatusGuid eq '"+a.aSelectedStatuses[f].Guid+"'",f<a.aSelectedStatuses.length-1&&(b+=" or ");b+=d,u&&(b+=c,b=b+"UnitGuid eq '"+u+"'",b+=d),v&&(b+=c,b=b+"substringof('"+v+"', AccountGuids) eq true",b+=d),g.getDeficiencies({sExpand:"PhaseDetails/ProjectDetails,TaskStatusDetails, TaskPriorityDetails,AccountDetails,UnitDetails,FileMetadataSetDetails/FileMetadataDetails,CommentSetDetails/CommentDetails",sFilter:"CompanyName eq '"+h.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false"+e+b,bShowSpinner:!0,onSuccess:F})}},H=function(){g.getDeficiencyStatuses({bShowSpinner:!1,onSuccess:E})};H(),G(),a.onDisplay=function(a,d){h.putListViewScrollPosition("deficienciesList",$(".cnpContentWrapper")[0].scrollTop),b.sFileMetadataSetGuid=a._fileMetadataSetGuid,b.sFileMetadataSetLastModifiedAt=a._fileMetadataSetLastModifiedAt,c.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"display",sDeficiencyGuid:a._guid})},a.onEdit=function(a){h.putListViewScrollPosition("deficienciesList",$(".cnpContentWrapper")[0].scrollTop),b.sFileMetadataSetGuid=a._fileMetadataSetGuid,b.sFileMetadataSetLastModifiedAt=a._fileMetadataSetLastModifiedAt,"contractor"===t&&"Done by Contractor"!=a.sStatusDescriptionEN&&"In Progress"!=a.sStatusDescriptionEN&&"Non Conform"!=a.sStatusDescriptionEN?c.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"display",sDeficiencyGuid:a._guid}):c.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"edit",sDeficiencyGuid:a._guid})},a.onAddNew=function(){c.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"create",sDeficiencyGuid:""})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.onCloseCheckSelectedStatusesLength=function(){n.put("selectedDeficiencyStatuses"+r+s,{aSelectedStatuses:a.aSelectedStatuses}),G()},a.onSelectedStatusesModified=function(){a.onCloseCheckSelectedStatusesLength()},a.onNavigateToUnitDetails=function(a){var b=a._unitGuid;c.go("app.unitDetailsWrapper.unitDetails",{sMode:"display",sUnitGuid:b})},a.$on("globalUserPhasesHaveBeenChanged",function(a){h.putListViewScrollPosition("deficienciesList",$(".cnpContentWrapper")[0].scrollTop),G()}),a.$on("deficienciesShouldBeRefreshed",function(a){h.putListViewScrollPosition("deficienciesList",$(".cnpContentWrapper")[0].scrollTop),G()}),a.onDisplayPhotoGallery=function(a,b){b.stopPropagation(),a._aImages.length&&e.setUpPhotoGallery(a._aImages)};var I=function(b){if(1===b.length){for(var c={tasks:[]},d=[],e=0;e<a.tableParams.data.length;e++)for(var f=0;f<a.tableParams.data[e].data.length;f++){d=[];for(var h=0;h<a.tableParams.data[e].data[f]._aImages.length;h++)d.push({guid:a.tableParams.data[e].data[f]._aImages[h].Guid});c.tasks.push({unit:null!=a.tableParams.data[e].data[f].sUnit&&void 0!=a.tableParams.data[e].data[f].sUnit?a.tableParams.data[e].data[f].sUnit:"",status:null!=a.tableParams.data[e].data[f].sStatusDescription&&void 0!=a.tableParams.data[e].data[f].sStatusDescription?a.tableParams.data[e].data[f].sStatusDescription:"",statusIconGuid:a.tableParams.data[e].data[f].sStatusIconGuid,contractors:null!=a.tableParams.data[e].data[f].sContractors&&void 0!=a.tableParams.data[e].data[f].sContractors?a.tableParams.data[e].data[f].sContractors:"",descriptionTags:a.tableParams.data[e].data[f].sTags,locationTags:a.tableParams.data[e].data[f].sLocationTags,dueIn:a.tableParams.data[e].data[f].sDueIn+a.tableParams.data[e].data[f].sDueInLetter,description:a.tableParams.data[e].data[f].sDescription,fls:d})}var i=JSON.stringify(c);g.generateReport({oReportParameters:{reportId:s+"-"+a.sReportName+"-"+Math.round(1e6*Math.random()),fileGuid:b[0].Guid,converter:"",processState:"generated",dispatch:"download",entryName:"",data:i}})}};a.onReports=function(){a.sReportName="en"===f.use()?"DeficienciesList":"ListeDeDeficiences",g.getFileMetadatas({sFilter:"CatalogId eq '"+h.oUserProfile.sCurrentCompany+"' and DescriptionEN eq '"+a.sReportName+"'",onSuccess:I})},a.onStatusChange=function(b){if(a.bDisplayEditButtons&&("Done by Contractor"==b.sStatusDescriptionEN||"Non Conform"==b.sStatusDescriptionEN||"In Progress"==b.sStatusDescriptionEN||"contractor"!==h.oUserProfile.sCurrentRole)){b.sStatuseIconUrl=l.location.origin+l.location.pathname+"rest/file/v2/get/"+z[b.sStatusSortingSequence%z.length].AssociatedIconFileGuid,a.sAccountValues="",a.sAccountGuids="",a.sAccountValues=b.sContractors,a.sAccountGuids=b.sContractorsGuids;for(var c=a.aDataForMassChanges.length-1;c>=0;c--)if(a.aDataForMassChanges[c].Guid===b._guid){a.aDataForMassChanges.splice(c,1);break}a.aDataForMassChanges.push({Guid:b._guid,TaskStatusGuid:z[b.sStatusSortingSequence%z.length].Guid,PhaseGuid:b._phaseGuid}),b.sStatusSortingSequence=(b.sStatusSortingSequence+1)%z.length}},a.onMassSave=function(){h.putListViewScrollPosition("deficienciesList",$(".cnpContentWrapper")[0].scrollTop);var b=function(){a.aDataForMassChanges=[],G()};g.updateDeficiencies({aData:a.aDataForMassChanges,bShowSpinner:!0,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:b})},a.$on("$destroy",function(){if("app.unitDetailsWrapper.unitDetails"!==b.sCurrentStateName&&"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName){if(j.getPreviousStateName()===b.sCurrentStateName)return;j.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams})}h.putTableStatusToCache({sTableName:"deficienciesList",sStateName:b.sCurrentStateName,aGroups:a.tableParams.settings().$scope.$groups,oFilter:a.tableParams.$params.filter,oSorting:a.tableParams.$params.sorting})})}]),viewControllers.controller("deficienciesListHybridWrapperView",["$rootScope","$scope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings","$timeout","$mdSidenav","$window","$cordovaCamera",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){a.sDeficienciesListView="deficienciesListSearch",b.$on("$destroy",function(){m.getPreviousStateName()!==a.sCurrentStateName&&m.addStateToHistory({sStateName:a.sCurrentStateName,oStateParams:angular.copy(a.oStateParams)})})}]),viewControllers.controller("deficienciesListItemsListsHybridView",["$rootScope","$scope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings","$timeout","$mdSidenav","$window","$cordovaCamera","$cordovaKeyboard",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){b.onClose=function(){switch(l.bIsHybridApplication&&"ios"===l.sMobileType&&s.close(),a.sCurrentSearhCriteria){case"phase":if(a.oSearchCriterias.oPhase.sSelectedItemGuid="",a.oSearchCriterias.oPhase.sValue="...",a.oSearchCriterias.bPhaseWasSelected){a.oSearchCriterias.oUnit.bIsSelectionUnabled=!0,a.oSearchCriterias.oContractor.bIsSelectionUnabled=!0,a.oSearchCriterias.oPhase.sValue="";for(var b=0;b<a.oSearchCriterias.aPhases.length;b++)for(var c=0;c<a.oSearchCriterias.aPhases[b].aPhases.length;c++)if(a.oSearchCriterias.aPhases[b].aPhases[c].bTicked){a.oSearchCriterias.oPhase.sValue=a.oSearchCriterias.oPhase.sValue+a.oSearchCriterias.aPhases[b].sProjectName+" - "+a.oSearchCriterias.aPhases[b].aPhases[c].sPhaseName,a.oSearchCriterias.oPhase.sSelectedItemGuid=a.oSearchCriterias.aPhases[b].aPhases[c].Guid;break}}break;case"unit":if(a.oSearchCriterias.oUnit.aSelectedItemsGuids=[],a.oSearchCriterias.oUnit.sValue="...",a.oSearchCriterias.bUnitWasSelected){a.oSearchCriterias.oUnit.sValue="";for(var b=0;b<a.oSearchCriterias.aUnits.length;b++)a.oSearchCriterias.aUnits[b].bTicked&&(a.oSearchCriterias.oUnit.sValue=a.oSearchCriterias.oUnit.sValue+a.oSearchCriterias.aUnits[b].sName+"; ",a.oSearchCriterias.oUnit.aSelectedItemsGuids.push(a.oSearchCriterias.aUnits[b].sGuid))}break;case"status":if(a.oSearchCriterias.oStatus.aSelectedItemsGuids=[],a.oSearchCriterias.oStatus.sValue="...",a.oSearchCriterias.bStatusWasSelected){a.oSearchCriterias.oStatus.sValue="";for(var b=0;b<a.oSearchCriterias.aStatuses.length;b++)a.oSearchCriterias.aStatuses[b].bTicked&&(a.oSearchCriterias.oStatus.sValue=a.oSearchCriterias.oStatus.sValue+a.oSearchCriterias.aStatuses[b].sName+"; ",a.oSearchCriterias.oStatus.aSelectedItemsGuids.push(a.oSearchCriterias.aStatuses[b].sGuid))}break;case"contractor":if(a.oSearchCriterias.oContractor.aSelectedItemsGuids=[],a.oSearchCriterias.oContractor.sValue="...",a.oSearchCriterias.bContractorWasSelected){a.oSearchCriterias.oContractor.sValue="";for(var b=0;b<a.oSearchCriterias.aContractors.length;b++)a.oSearchCriterias.aContractors[b].bTicked&&(a.oSearchCriterias.oContractor.sValue=a.oSearchCriterias.oContractor.sValue+a.oSearchCriterias.aContractors[b].sName+"; ",a.oSearchCriterias.oContractor.aSelectedItemsGuids.push(a.oSearchCriterias.aContractors[b].sGuid))}}switch(a.sSelectedDeficiencyAttribute){case"statuses":for(var b=0;b<a.aSelectedDeficiencyStatuses.length;b++)a.aSelectedDeficiencyStatuses[b].bTicked&&(a.oSelectedDeficiency.sStatusGuid=a.aSelectedDeficiencyStatuses[b].sGuid,a.oSelectedDeficiency.sStatusDescription=a.aSelectedDeficiencyStatuses[b].sName,a.oSelectedDeficiency.sStatuseIconUrl=a.aSelectedDeficiencyStatuses[b].sIconUrl)}a.sCurrentSearhCriteria?a.sDeficienciesListView="deficienciesListSearch":a.sSelectedDeficiencyAttribute?(a.sSelectedDeficiencyAttribute="",a.sDeficienciesListView="deficiencyDetails"):a.sDeficienciesListView="deficienciesList"},b.onSelectSearchCrireriaPhase=function(c){if(a.oSearchCriterias.bPhaseWasSelected=!0,!c.bTicked){for(var d=0;d<a.oSearchCriterias.aPhases.length;d++)for(var e=0;e<a.oSearchCriterias.aPhases[d].aPhases.length;e++)a.oSearchCriterias.aPhases[d].aPhases[e].bTicked=!1;c.bTicked=!0,a.oSearchCriterias.aUnits=[],a.oSearchCriterias.aFilteredUnits=[],a.oSearchCriterias.sUnitFilter="",a.oSearchCriterias.oUnit.sValue="...",a.oSearchCriterias.oUnit.aSelectedItemsGuids=[],a.oSearchCriterias.bUnitWasSelected=!1,a.oSearchCriterias.aContractors=[],a.oSearchCriterias.aFilteredContractors=[],a.oSearchCriterias.sContractorFilter="",a.oSearchCriterias.oContractor.sValue="...",a.oSearchCriterias.oContractor.aSelectedItemsGuids=[],a.oSearchCriterias.bContractorWasSelected=!1}b.onClose()},b.onSelectSearchCrireriaUnit=function(b){if(a.oSearchCriterias.bUnitWasSelected=!1,b.bTicked=!b.bTicked,b.bTicked)a.oSearchCriterias.bUnitWasSelected=!0;else for(var c=0;c<a.oSearchCriterias.aUnits.length;c++)if(a.oSearchCriterias.aUnits[c].bTicked){a.oSearchCriterias.bUnitWasSelected=!0;break}},b.onSelectSearchCrireriaContractor=function(b){if(a.oSearchCriterias.bContractorWasSelected=!1,b.bTicked=!b.bTicked,b.bTicked)a.oSearchCriterias.bContractorWasSelected=!0;else for(var c=0;c<a.oSearchCriterias.aContractors.length;c++)if(a.oSearchCriterias.aContractors[c].bTicked){a.oSearchCriterias.bContractorWasSelected=!0;break}},b.onSelectSearchCrireriaStatus=function(b){if(a.oSearchCriterias.bStatusWasSelected=!1,b.bTicked=!b.bTicked,b.bTicked)a.oSearchCriterias.bStatusWasSelected=!0;else for(var c=0;c<a.oSearchCriterias.aStatuses.length;c++)if(a.oSearchCriterias.aStatuses[c].bTicked){a.oSearchCriterias.bStatusWasSelected=!0;break}},b.onSelectDeficiencyAttributeStatus=function(b){if(a.oSelectedDeficiency.bDataHasBeenModified=!0,!b.bTicked){for(var c=0;c<a.aSelectedDeficiencyStatuses.length;c++)a.aSelectedDeficiencyStatuses[c].bTicked=!1;b.bTicked=!0}},b.onChangeSearchCriteriaUnitFilter=function(b){a.oSearchCriterias.sUnitFilter=i.replaceSpecialChars(b),a.oSearchCriterias.aFilteredUnits=j("filter")(a.oSearchCriterias.aUnits,{sCleanedName:a.oSearchCriterias.sUnitFilter})},b.onChangeSearchCriteriaContractorFilter=function(b){a.oSearchCriterias.sContractorFilter=i.replaceSpecialChars(b),a.oSearchCriterias.aFilteredContractors=j("filter")(a.oSearchCriterias.aContractors,{sCleanedName:a.oSearchCriterias.sContractorFilter})},b.onAddImage=function(c){var f={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:c,allowEdit:!0,encodingType:Camera.EncodingType.JPEG,targetWidth:500,targetHeight:500,popoverOptions:CameraPopoverOptions,saveToPhotoAlbum:!0};r.getPicture(f).then(function(c){var f=function(){b.$apply(function(){a.$emit("UNLOAD"),a.bIgnoreNavigation=!0,a.loadDeficiencies(),a.sSelectedDeficiencyAttribute="",a.sDeficienciesListView="deficiencyDetails"});var c=function(a){e.logEvents({aData:a})};e.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:l.newAttachmentEN,sOperationNameFR:l.newAttachmentEN,aData:[{Guid:a.oSelectedDeficiency._guid}],onSuccess:c})};c="data:image/jpeg;base64,"+c;for(var g=atob(c.split(",")[1]),h=new ArrayBuffer(g.length),i=new Uint8Array(h),j=0;j<g.length;j++)i[j]=g.charCodeAt(j);var k=new Blob([h],{type:"image/jpeg"}),m=new FormData;m.append("blob",k,"quickAddAttachment"),d.uploadAttachmentsForEntity({sPath:"Tasks",aFiles:[m],sParentEntityGuid:a.oSelectedDeficiency._guid,sParentEntityFileMetadataSetGuid:a.oSelectedDeficiency._fileMetadataSetGuid,onSuccess:f})},function(a){})},b.onSaveNewComment=function(){var b=function(){a.oNewComment.sText="",a.bIgnoreNavigation=!0,a.loadDeficiencies(),a.sSelectedDeficiencyAttribute="","ios"===l.sMobileType&&s.close(),a.sDeficienciesListView="deficiencyDetails";var b=function(a){e.logEvents({aData:a})};e.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:l.newCommentEN,sOperationNameFR:l.newCommentFR,aData:[{Guid:a.oSelectedDeficiency._guid}],onSuccess:b})},c={GeneralAttributes:{}};c.ContactGuid=h.oUserProfile.oUserContact.Guid,c.Text=a.oNewComment.sText,d.addCommentForEntity({sPath:"Tasks",oData:c,sParentEntityGuid:a.oSelectedDeficiency._guid,sParentEntityCommentSetGuid:a.oSelectedDeficiency._commentSetGuid,onSuccess:b})},b.onUseCamera=function(){b.onAddImage(Camera.PictureSourceType.CAMERA)},b.onUseLibrary=function(){b.onAddImage(Camera.PictureSourceType.SAVEDPHOTOALBUM)}}]),viewControllers.controller("deficienciesListMobileView",["$scope","$location","$q","CONSTANTS","$anchorScroll","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","utilsProvider","historyProvider","$mdSidenav","$window","$filter","$cookieStore","rolesSettings","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){n.removeHistory(),a.sDisplayedView="list",a.sDisplayMode="display",f.sCurrentStateName=g.current.name,f.oStateParams=angular.copy(h),a.bShowContractorInList=!0,"contractor"===a.oUserProfile.sCurrentRole&&(a.bShowContractorInList=!1);var u=1;a.aDeficiencies=[],a.aPhases=[],a.aStatuses=[];var v={};a.oContractors={},a.oContractors.aContractors=[],a.oContractors.aSelectedContractors=[],a.oUnits={},a.oUnits.aUnits=[],a.oUnits.aSelectedUnits=[],a.onSelectPhaseSearchCriteria=function(){var b=c.defer();a.aPhases=[],b.promise.then(function(){for(var b=[],c=i.constructUserProjectsPhases(),d=0;d<c.length;d++){b=[],c[d].NameFR&&"fr"===j.use()?c[d].sDescription=c[d].NameFR:c[d].sDescription=c[d].NameEN;for(var e=0;e<c[d].PhaseDetails.results.length;e++)c[d].PhaseDetails.results[e].NameFR&&"fr"===j.use()?c[d].PhaseDetails.results[e].sDescription=c[d].PhaseDetails.results[e].NameFR:c[d].PhaseDetails.results[e].sDescription=c[d].PhaseDetails.results[e].NameEN,a.aPhases.push({sProjectAndPhaseName:c[d].sDescription+" - "+c[d].PhaseDetails.results[e].sDescription,sPhaseName:c[d].PhaseDetails.results[e].sDescription,Guid:c[d].PhaseDetails.results[e].Guid,bTicked:!1})}}),b.resolve()},a.onSelectSearchCriteriaPhase=function(b){v=b,a.oContractors={},a.oContractors.aContractors=[],a.oContractors.aSelectedContractors=[],a.oUnits={},a.oUnits.aUnits=[],a.oUnits.aSelectedUnits=[],A()};var w=function(b){for(var c=[],e=0;e<b.results.length;e++){if(b.results[e].iImagesNumber=0,b.results[e].iCommentsNumber=0,b.results[e].bFadeImagesIcon=!0,b.results[e].bFadeCommentsIcon=!0,b.results[e].FileMetadataSetDetails){if(b.results[e].FileMetadataSetDetails.FileMetadataDetails)for(var f=0;f<b.results[e].FileMetadataSetDetails.FileMetadataDetails.results.length;f++)b.results[e].FileMetadataSetDetails.FileMetadataDetails.results[f].MediaType&&b.results[e].FileMetadataSetDetails.FileMetadataDetails.results[f].MediaType.indexOf("image")>-1&&b.results[e].FileMetadataSetDetails.FileMetadataDetails.results[f].GeneralAttributes.IsDeleted===!1&&c.push(b.results[e].FileMetadataSetDetails.FileMetadataDetails.results[f]);c.length&&(b.results[e].iImagesNumber=c.length,b.results[e].aImages=c,b.results[e].bFadeImagesIcon=!1)}b.results[e].CommentSetDetails&&(b.results[e].iCommentsNumber=b.results[e].CommentSetDetails.CommentDetails.results.length,b.results[e].bFadeCommentsIcon=!1),b.results[e].sIconUrl=d.sAppAbsolutePath+"rest/file/v2/get/"+b.results[e].TaskStatusDetails.AssociatedIconFileGuid,b.results[e].aDescriptionTags=m.tagsStringToTagsArrayForUiSelect(b.results[e].DescriptionTags),b.results[e].aLocationTags=m.tagsStringToTagsArrayForUiSelect(b.results[e].LocationTags),b.results[e].aContractorsTags=m.tagsStringToTagsArrayForUiSelect(b.results[e].AccountValues)}a.$evalAsync(function(){a.aDeficiencies=a.aDeficiencies.concat(b.results),a.iTotalDeficienciesNumber=b.__count})};a.onOpenPhasesSidenav=function(){t(o("phasesSidenav").open,200)},a.onClosePhasesSidenav=function(){t(o("phasesSidenav").close,200)},a.onShowMore=function(){u++,x(u)};var x=function(b){var c="",d="",e="",f="";if(v&&(c=" and PhaseGuid eq '"+v.Guid+"'"),"contractor"===a.oUserProfile.sCurrentRole&&(e=" and substringof('"+a.oUserProfile.oUserContact.AccountDetails.Guid+"', AccountGuids) eq true"),a.oUnits.aSelectedUnits.length){f=" and ( ";for(var g=a.oUnits.aSelectedUnits.length-1;g>=0;g--)f=f+"substringof('"+a.oUnits.aSelectedUnits[g].sGuid+"', UnitGuid) eq true",f+=0!==g?" or ":" )"}if(a.aStatuses.aSelectedStatuses&&a.aStatuses.aSelectedStatuses.length){d=" and ( ";for(var g=a.aStatuses.aSelectedStatuses.length-1;g>=0;g--)d=d+"TaskStatusGuid eq '"+a.aStatuses.aSelectedStatuses[g].Guid+"'",d+=0!==g?" or ":" )"}if(a.oContractors.aSelectedContractors.length){e=" and ( ";for(var g=a.oContractors.aSelectedContractors.length-1;g>=0;g--)e=e+"substringof('"+a.oContractors.aSelectedContractors[g].sGuid+"', AccountGuids) eq true",e+=0!==g?" or ":" )"}var h="$top=10&$orderby=CreatedAt desc&$inlinecount=allpages";b>1&&(h=h+"&$skip="+10*(b-1)),k.getMobileDeficiencies({sExpand:"PhaseDetails/ProjectDetails,TaskStatusDetails,TaskPriorityDetails,AccountDetails,UnitDetails,FileMetadataSetDetails/FileMetadataDetails,CommentSetDetails/CommentDetails/ContactDetails/UserDetails",sFilter:"CompanyName eq '"+a.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false"+c+f+e+d,sOtherUrlParams:h,bShowSpinner:!0,onSuccess:w,bNoCaching:!0})},y=function(b){for(var c=0;c<b.length;c++)b[c].NameFR&&"fr"===j.use()?b[c].sDescription=b[c].NameFR:b[c].sDescription=b[c].NameEN,b[c].sIconUrl=d.sAppAbsolutePath+"rest/file/v2/get/"+b[c].AssociatedIconFileGuid;a.aStatuses=b,a.aStatuses.aSelectedStatuses=b},z=function(b){b.AccountDetails.results=q("filter")(b.AccountDetails.results,function(a,b){return a.GeneralAttributes.IsDeleted||"Contractor"!==a.AccountTypeDetails.NameEN?!1:!0});for(var c=0;c<b.AccountDetails.results.length;c++)a.oContractors.aContractors.push({sGuid:b.AccountDetails.results[c].Guid,sName:b.AccountDetails.results[c].Name,sCleanedName:m.replaceSpecialChars(m.convertStringToInt(b.AccountDetails.results[c].Name)),bTicked:!1});b.UnitDetails.results=q("filter")(b.UnitDetails.results,function(a,b){return a.GeneralAttributes.IsDeleted?!1:!0});for(var c=0;c<b.UnitDetails.results.length;c++)a.oUnits.aUnits.push({sGuid:b.UnitDetails.results[c].Guid,sName:b.UnitDetails.results[c].Name,sCleanedName:m.replaceSpecialChars(m.convertStringToInt(b.UnitDetails.results[c].Name)),bTicked:!1})},A=function(){k.getPhase({sExpand:"AccountDetails/AccountTypeDetails, UnitDetails",sKey:v.Guid,onSuccess:z})},B=function(){k.getDeficiencyStatuses({onSuccess:y})};B(),a.onSelectDeficiency=function(b){a.sDisplayedView="details",a.oSelectedDeficiency=angular.copy(b)},a.onDone=function(){a.sDisplayedView="list"},a.onSearch=function(){u=1,a.aDeficiencies=[],x()},a.$on("$destroy",function(){n.getPreviousStateName()!==f.sCurrentStateName&&n.addStateToHistory({sStateName:f.sCurrentStateName,oStateParams:angular.copy(f.oStateParams)})})}]),viewControllers.controller("deficienciesSearchHybridView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","utilsProvider","historyProvider","$mdSidenav","$window","$filter","$cookieStore","rolesSettings","$timeout","CONSTANTS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){if(j.removeHistory(),a.sCurrentRole=h.oUserProfile.sCurrentRole,e.constructLogoUrl(),e.constructMenuIconUrl(),b.sCurrentStateName=c.current.name,b.oStateParams=angular.copy(d),
b.oSearchCriterias||(b.oSearchCriterias={oPhase:{sDescription:f.instant("deficiencyDetails_associatedProjectsAndPhases"),sValue:"...",bIsSelectionUnabled:!0,sSelectedItemGuid:""},aPhases:[],bPhaseWasSelected:!1,oUnit:{sDescription:f.instant("deficiencyDetails_unit"),sValue:"...",bIsSelectionUnabled:!1,aSelectedItemsGuids:[]},aUnits:[],bUnitWasSelected:!1,oStatus:{sDescription:f.instant("deficiencyDetails_status"),sValue:"...",sIconUrl:"",bIsSelectionUnabled:!0,aSelectedItemsGuids:[]},aStatuses:[],bStatusWasSelected:!1,oContractor:{sDescription:f.instant("deficiencyDetails_contractor"),sValue:"...",bIsSelectionUnabled:!1,aSelectedItemsGuids:[]},aContractors:[],bContractorWasSelected:!1}),!b.oSearchCriterias.aPhases.length){b.oSearchCriterias.aPhases=[],b.oSearchCriterias.bPhaseWasSelected=!1;for(var r=[],s=e.constructUserProjectsPhases(),t=0;t<s.length;t++){var r=[];s[t].NameFR&&"fr"===f.use()?s[t].sDescription=s[t].NameFR:s[t].sDescription=s[t].NameEN;for(var u=0;u<s[t].PhaseDetails.results.length;u++)s[t].PhaseDetails.results[u].NameFR&&"fr"===f.use()?s[t].PhaseDetails.results[u].sDescription=s[t].PhaseDetails.results[u].NameFR:s[t].PhaseDetails.results[u].sDescription=s[t].PhaseDetails.results[u].NameEN,r.push({sPhaseName:s[t].PhaseDetails.results[u].sDescription,Guid:s[t].PhaseDetails.results[u].Guid,bTicked:!1});b.oSearchCriterias.aPhases.push({sProjectName:s[t].sDescription,aPhases:r})}}var v=function(a){b.oSearchCriterias.aUnits=[],a.UnitDetails.results=m("filter")(a.UnitDetails.results,function(a,b){return!a.GeneralAttributes.IsDeleted});for(var c=0;c<a.UnitDetails.results.length;c++)b.oSearchCriterias.aUnits.push({sGuid:a.UnitDetails.results[c].Guid,sName:i.convertStringToInt(a.UnitDetails.results[c].Name),sCleanedName:i.replaceSpecialChars(i.convertStringToInt(a.UnitDetails.results[c].Name)),bTicked:!1});b.oSearchCriterias.aUnits=m("orderBy")(b.oSearchCriterias.aUnits,["sName"]),b.oSearchCriterias.aFilteredUnits=m("filter")(b.oSearchCriterias.aUnits,{sName:b.oSearchCriterias.sUnitFilter})},w=function(a){b.oSearchCriterias.aContractors=[],a.AccountDetails.results=m("filter")(a.AccountDetails.results,function(a,b){return a.GeneralAttributes.IsDeleted||"Contractor"!==a.AccountTypeDetails.NameEN?!1:!0});for(var c=0;c<a.AccountDetails.results.length;c++)b.oSearchCriterias.aContractors.push({sGuid:a.AccountDetails.results[c].Guid,sName:a.AccountDetails.results[c].Name,sCleanedName:i.replaceSpecialChars(i.convertStringToInt(a.AccountDetails.results[c].Name)),bTicked:!1});b.oSearchCriterias.aContractors=m("orderBy")(b.oSearchCriterias.aContractors,["sName"]),b.oSearchCriterias.aFilteredContractors=m("filter")(b.oSearchCriterias.aContractors,{sName:b.oSearchCriterias.sContractorFilter})},x=function(b){for(var c="",d=0;d<b.length;d++)b[d]._sortingSequence=b[d].GeneralAttributes.SortingSequence;b=m("orderBy")(b,["_sortingSequence"]);for(var d=0;d<b.length;d++)c="",c=b[d].NameFR&&"fr"===f.use()?b[d].NameFR:b[d].NameEN,a.oSearchCriterias.aStatuses.push({sGuid:b[d].Guid,sName:c,bTicked:!1,sIconUrl:q.sAppAbsolutePath+"rest/file/v2/get/"+b[d].AssociatedIconFileGuid})};b.oSearchCriterias.aStatuses.length||(b.oSearchCriterias.aStatuses=[],b.oSearchCriterias.bStatusWasSelected=!1,g.getDeficiencyStatuses({onSuccess:x})),b.aDeficiencies=[],b.onDeficienciesLoaded=function(a){var c="",d="",e="",g="",h="",j=new Date,k="",l=0,n="",o="",r="",s="",t="",u="",v=0,w=0,x="",y=[],z={},A="",B="",C="",D="";if(b.oSearchCriterias.oStatus.aSelectedItemsGuids.length)for(var E=0;E<b.oSearchCriterias.oStatus.aSelectedItemsGuids.length;E++)C=C+b.oSearchCriterias.oStatus.aSelectedItemsGuids[E]+",";if(b.oSearchCriterias.oUnit.aSelectedItemsGuids.length)for(var E=0;E<b.oSearchCriterias.oUnit.aSelectedItemsGuids.length;E++)B=B+b.oSearchCriterias.oUnit.aSelectedItemsGuids[E]+",";for(var F=[],E=0;E<a.length;E++)if(c="",d="",k="",e="",g="",h="",n="",l=0,o="",sStatusIconGuid="",r="",s="",t="",u="",v=0,w=0,y=[],z={},A="",D="",!(B&&B.indexOf(a[E].UnitGuid)<0||C&&C.indexOf(a[E].TaskStatusGuid)<0)){if(a[E].PhaseDetails?(l=a[E].PhaseDetails.GeneralAttributes.SortingSequence,c="en"===f.use()?a[E].PhaseDetails.ProjectDetails.NameEN:a[E].PhaseDetails.ProjectDetails.NameFR,c||(c=a[E].PhaseDetails.ProjectDetails.NameEN),d="en"===f.use()?a[E].PhaseDetails.NameEN:a[E].PhaseDetails.NameFR,d||(d=a[E].PhaseDetails.NameEN),k=c+" - "+d):k="Not Assigned",a[E].TaskStatusDetails&&(D=a[E].TaskStatusDetails.Guid,n=a[E].TaskStatusDetails.GeneralAttributes.SortingSequence,o=q.sAppAbsolutePath+"rest/file/v2/get/"+a[E].TaskStatusDetails.AssociatedIconFileGuid,r="en"===f.use()?a[E].TaskStatusDetails.NameEN:a[E].TaskStatusDetails.NameFR,r||(r=a[E].TaskStatusDetails.NameEN),sStatusIconGuid=a[E].TaskStatusDetails.AssociatedIconFileGuid,s=a[E].TaskStatusDetails.NameEN),a[E].TaskPriorityDetails&&(t="en"===f.use()?a[E].TaskPriorityDetails.NameEN:a[E].TaskPriorityDetails.NameFR,t||(t=a[E].TaskPriorityDetails.NameEN)),a[E].AccountDetails)for(var G=0;G<a[E].AccountDetails.results.length;G++)u=u+a[E].AccountDetails.results[G].Name+"; ";if(a[E].UnitDetails&&(a[E].sUnitName=a[E].UnitDetails.Name),a[E].FileMetadataSetDetails){if(x=a[E].FileMetadataSetDetails.LastModifiedAt,a[E].FileMetadataSetDetails.FileMetadataDetails)for(var G=0;G<a[E].FileMetadataSetDetails.FileMetadataDetails.results.length;G++)a[E].FileMetadataSetDetails.FileMetadataDetails.results[G].MediaType&&a[E].FileMetadataSetDetails.FileMetadataDetails.results[G].MediaType.indexOf("image")>-1&&a[E].FileMetadataSetDetails.FileMetadataDetails.results[G].GeneralAttributes.IsDeleted===!1&&y.push(a[E].FileMetadataSetDetails.FileMetadataDetails.results[G]);v=y.length}if(a[E].CommentSetDetails&&(z=angular.copy(a[E].CommentSetDetails),a[E].CommentSetDetails.CommentDetails&&a[E].CommentSetDetails.CommentDetails.results&&a[E].CommentSetDetails.CommentDetails.results.length))for(var G=a[E].CommentSetDetails.CommentDetails.results.length-1;G>=0;G--)a[E].CommentSetDetails.CommentDetails.results[G].GeneralAttributes.IsDeleted||w++;var H="",I="";if(a[E].DueDate&&"/Date(0)/"!=a[E].DueDate){h=i.dBDateToSting(a[E].DueDate),dDueDate=new Date(parseInt(a[E].DueDate.substring(6,a[E].DueDate.length-2)));var J=Math.abs(j.getTime()-dDueDate.getTime());H=Math.ceil(J/864e5)-1,I="en"===f.use()?"d":"j"}a[E].Description&&(A=i.removeTagsFromString(a[E].Description)),F.push({_guid:a[E].Guid,_phaseGuid:a[E].PhaseGuid,sUnit:i.convertStringToInt(a[E].sUnitName),sCleanedUnit:i.replaceSpecialChars(a[E].sUnitName),sTags:null!==a[E].DescriptionTags&&void 0!==a[E].DescriptionTags?a[E].DescriptionTags:"",sCleanedTags:i.replaceSpecialChars(a[E].DescriptionTags),sLocationTags:null!==a[E].LocationTags&&void 0!==a[E].LocationTags?a[E].LocationTags:"",sDueIn:i.convertStringToInt(H),sDueInLetter:I,sProjectPhase:k,sContractors:u,sCleanedContractors:i.replaceSpecialChars(u),sStatusSortingSequence:n,sStatuseIconUrl:o,sStatusIconGuid:sStatusIconGuid,sStatusDescription:r,sStatusDescriptionEN:s,sPriorityDescription:t,sDescription:A,_unitGuid:a[E].UnitGuid,_sortingSequence:l,_fileMetadataSetGuid:a[E].FileMetadataSetGuid,_commentSetGuid:a[E].CommentSetGuid,_fileMetadataSetLastModifiedAt:x,iImagesNumber:v,iCommentsNumber:w,_aImages:y,_oComments:z,_lastModifiedAt:a[E].LastModifiedAt,_createdAt:a[E].CreatedAt,sAssignedUserName:a[E].UserName,sStatusGuid:D})}if(F=m("orderBy")(F,["sUnit","sStatusSortingSequence","-_createdAt"]),b.aDeficiencies=angular.copy(F),b.oSelectedDeficiency)for(var E=0;E<b.aDeficiencies.length;E++)if(b.oSelectedDeficiency._guid===b.aDeficiencies[E]._guid){var o=b.oSelectedDeficiency.sStatuseIconUrl,r=b.oSelectedDeficiency.sStatusDescription;b.oSelectedDeficiency=angular.copy(b.aDeficiencies[E]),b.oSelectedDeficiency.sStatuseIconUrl=o,b.oSelectedDeficiency.sStatusDescription=r}b.bIgnoreNavigation||p(function(){b.sDeficienciesListView="deficienciesList"},1e3)},b.loadDeficiencies=function(){b.aDeficiencies=[];var a="",c="",d="";if(b.oSearchCriterias.oPhase.sSelectedItemGuid&&(c=" and PhaseGuid eq '"+b.oSearchCriterias.oPhase.sSelectedItemGuid+"'"),"contractor"===h.oUserProfile.sCurrentRole&&(a=" and substringof('"+h.oUserProfile.oUserContact.AccountDetails.Guid+"', AccountGuids) eq true"),b.oSearchCriterias.oContractor.aSelectedItemsGuids.length){d=" and ( ";for(var e=b.oSearchCriterias.oContractor.aSelectedItemsGuids.length-1;e>=0;e--)d=d+"substringof('"+b.oSearchCriterias.oContractor.aSelectedItemsGuids[e]+"', AccountGuids) eq true",d+=0!==e?" or ":" )"}g.getDeficiencies({sExpand:"PhaseDetails/ProjectDetails,TaskStatusDetails,TaskPriorityDetails,AccountDetails,UnitDetails,FileMetadataSetDetails/FileMetadataDetails,CommentSetDetails/CommentDetails/ContactDetails/UserDetails",sFilter:"CompanyName eq '"+h.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false"+c+a+d,bShowSpinner:!0,onSuccess:b.onDeficienciesLoaded,bNoCaching:!0})},a.onSearch=function(){var a=!0;return b.oSearchCriterias.oPhase.sSelectedItemGuid||(a=!1),a?(b.bIgnoreNavigation=!1,void b.loadDeficiencies()):void i.displayMessage({sText:f.instant("global_projectAndPhaseMandatory"),sType:"error"})},a.onSelectPhaseSearchCriteria=function(){b.sCurrentSearhCriteria="phase",b.sDeficienciesListView="deficienciesListItemsLists"},a.onSelectUnitSearchCriteria=function(){b.oSearchCriterias.oUnit.bIsSelectionUnabled&&(b.sCurrentSearhCriteria="unit",b.oSearchCriterias.aUnits.length||g.getPhase({sExpand:"UnitDetails",sKey:b.oSearchCriterias.oPhase.sSelectedItemGuid,onSuccess:v}),b.sDeficienciesListView="deficienciesListItemsLists")},a.onSelectStatusSearchCriteria=function(){b.sCurrentSearhCriteria="status",b.sDeficienciesListView="deficienciesListItemsLists"},a.onSelectContractorSearchCriteria=function(){b.oSearchCriterias.oContractor.bIsSelectionUnabled&&(b.sCurrentSearhCriteria="contractor",b.oSearchCriterias.aContractors.length||g.getPhase({sExpand:"AccountDetails/AccountTypeDetails",sKey:b.oSearchCriterias.oPhase.sSelectedItemGuid,onSuccess:w}),b.sDeficienciesListView="deficienciesListItemsLists")},a.$on("$destroy",function(){j.getPreviousStateName()!==b.sCurrentStateName&&j.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("deficiencyDetailsView",["$scope","$location","$anchorScroll","$rootScope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){b.hash("top"),c();var r=i.sDeficiencyGuid;a.oForms={},a.sTaskTypeGuid="",a.sTaskType="",a.sTaskPriority="",a.sTaskPriorityGuid="",a.sCurrentRole=j.oUserProfile.sCurrentRole,d.sCurrentStateName=e.current.name,d.oStateParams=angular.copy(i),a.bDisplayEditButton=p.getRolesSettingsForEntityAndOperation({sRole:a.sCurrentRole,sEntityName:"oDeficiency",sOperation:"bUpdate"}),a.bDisplayDeleteButton=p.getRolesSettingsForEntityAndOperation({sRole:a.sCurrentRole,sEntityName:"oDeficiency",sOperation:"bDelete"}),a.aUnits=[],a.bShowBackButton=o.aHistoryStates.length>0?!0:!1;var s={};"app.deficiencyDetailsWrapper.deficiencyDetails"===d.sCurrentStateName&&(a.sTaskType="Deficiency"),d.sMode=i.sMode,"create"===d.sMode&&(d.sFileMetadataSetGuid="",d.sFileMetadataSetLastModifiedAt="",d.sCommentSetGuid="",d.sCommentSetLastModifiedAt="",d.bUiSelectDisabled=!1),a.oDeficiency={},a.oContractors={},a.oContractors.aContractors=[],a.oContractors.aSelectedContractors=[];var t={aData:[{_contractorsGuids:[]}]},u=function(b){for(var c=0;c<b.length;c++)b[c].Name=k.convertStringToInt(b[c].Name);b=l("orderBy")(b,["Name"]),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:t,sNameEN:"Name",sNameFR:"Name",sDependentKey:"Guid",sParentKey:"_unitGuid",sTargetArrayNameInParent:"aUnits"}),t.aData[0]&&(a.aUnits=angular.copy(t.aData[0].aUnits))},v=function(a){g.getUnits({sFilter:"CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and PhaseGuid eq '"+a+"'",bShowSpinner:!1,onSuccess:u})},w=function(b){a.aUserProjectsPhasesForMultiselect=f.constructUserProjectsPhasesForMultiSelect({aSelectedPhases:b}),a.oDeficiency._phaseGuid&&v(a.oDeficiency._phaseGuid)},x=function(b){d.sCurrentEntityPhaseGuid=b.PhaseGuid,a.oDeficiency._guid=b.Guid,a.oDeficiency._lastModifiedAt=b.LastModifiedAt;var c="",e="";d.sFileMetadataSetGuid=b.FileMetadataSetGuid,b.FileMetadataSetDetails&&(d.sFileMetadataSetLastModifiedAt=b.FileMetadataSetDetails.LastModifiedAt),d.$broadcast("FileAttachemntsCanBeLoaded"),d.sCommentSetGuid=b.CommentSetGuid,b.CommentSetDetails&&(d.sCommentSetLastModifiedAt=b.CommentSetDetails.LastModifiedAt),d.$broadcast("CommentsCanBeLoaded"),b.UnitDetails&&b.UnitDetails.Name&&(a.oDeficiency._unitName=b.UnitDetails.Name),b.PhaseDetails&&b.PhaseDetails.ProjectDetails&&(e=b.PhaseDetails.NameFR&&"fr"===h.use()?b.PhaseDetails.NameFR:b.PhaseDetails.NameEN,c=b.PhaseDetails.ProjectDetails.NameFR&&"fr"===h.use()?b.PhaseDetails.ProjectDetails.NameFR:b.PhaseDetails.ProjectDetails.NameEN),a.oDeficiency._ProjectAndPhaseName=c+" - "+e,b.TaskPriorityDetails&&(b.TaskPriorityDetails.NameFR&&"fr"===h.use()?(a.oDeficiency._deficiencyPriority=b.TaskPriorityDetails.NameFR,a.oDeficiency._deficiencyPriorityEN=b.TaskPriorityDetails.NameEN):(a.oDeficiency._deficiencyPriority=b.TaskPriorityDetails.NameEN,a.oDeficiency._deficiencyPriorityEN=b.TaskPriorityDetails.NameEN)),b.DueDate&&"/Date(0)/"!=b.DueDate&&(a.oDeficiency.sDueDate=k.dBDateToSting(b.DueDate),a.oDeficiency.dDueDate=new Date(parseInt(b.DueDate.substring(6,b.DueDate.length-2)))),a.oDeficiency.sCreatedAt=k.dBDateToSting(b.CreatedAt),a.oDeficiency.sLastModifiedAt=k.dBDateToSting(b.LastModifiedAt),a.oDeficiency.aDescriptionTags=k.tagsStringToTagsArray(b.DescriptionTags),a.oDeficiency.aLocationTags=k.tagsStringToTagsArray(b.LocationTags),a.oDeficiency.sDescription=b.Description,a.oDeficiency._phaseGuid=b.PhaseGuid,a.oDeficiency._deficiencyStatusGuid=b.TaskStatusGuid,a.oDeficiency._taskTypeGuid=b.TaskTypeGuid,a.oDeficiency._taskPriorityGuid=b.TaskPriorityGuid,a.oDeficiency._assignedUserName=b.UserName,a.oDeficiency._unitGuid=b.UnitGuid;var f=[],g=0;if(b.FileMetadataSetDetails){if(b.FileMetadataSetDetails.FileMetadataDetails)for(var i=0;i<b.FileMetadataSetDetails.FileMetadataDetails.results.length;i++)b.FileMetadataSetDetails.FileMetadataDetails.results[i].MediaType&&b.FileMetadataSetDetails.FileMetadataDetails.results[i].MediaType.indexOf("image")>-1&&b.FileMetadataSetDetails.FileMetadataDetails.results[i].GeneralAttributes.IsDeleted===!1&&f.push(b.FileMetadataSetDetails.FileMetadataDetails.results[i]);g=f.length}var j=0;if(b.CommentSetDetails&&b.CommentSetDetails.CommentDetails)for(var i=0;i<b.CommentSetDetails.CommentDetails.results.length;i++)b.CommentSetDetails.CommentDetails.results[i].GeneralAttributes.IsDeleted||j++;if(d._aImages=angular.copy(f),d.iImagesNumber=g,d.iCommentsNumber=j,a.oContractors.aSelectedContractors=[],b.AccountDetails)for(var l=0;l<b.AccountDetails.results.length;l++)a.oContractors.aSelectedContractors.push({sName:b.AccountDetails.results[l].Name,sCleanedName:k.replaceSpecialChars(b.AccountDetails.results[l].Name),sGuid:b.AccountDetails.results[l].Guid});t.aData[0]=angular.copy(a.oDeficiency),w([a.oDeficiency._phaseGuid])},y="CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false";y+="PhaseDetails/ProjectDetails,TaskStatusDetails,TaskPriorityDetails,AccountDetails,UnitDetails,FileMetadataSetDetails/FileMetadataDetails,CommentSetDetails/CommentDetails";var z=j.getEntityDetails({sCacheProviderAttribute:"oDeficiencyEntity",sRequestSettings:y,sKeyName:"Guid",sKeyValue:r}),A=function(b){for(var c=0;c<b.length;c++)if(b[c].NameEN===a.sTaskType){a.sTaskTypeGuid=b[c].Guid;break}},B=function(b){for(var c=0;c<b.length;c++)b[c]._sortingSequence=b[c].GeneralAttributes.SortingSequence;b=l("orderBy")(b,["_sortingSequence"]),"create"===d.sMode&&b.length&&(t.aData[0]._taskPriorityGuid=b[0].Guid),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:t,sNameEN:"NameEN",sNameFR:"NameFR",sSelected:"selected",sDependentKey:"Guid",sParentKey:"_taskPriorityGuid",sTargetArrayNameInParent:"aTaskPriorities"}),t.aData[0]&&(a.aTaskPriorities=angular.copy(t.aData[0].aTaskPriorities))},C=function(b){for(var c=0;c<b.length;c++)b[c]._sortingSequence=b[c].GeneralAttributes.SortingSequence;b=l("orderBy")(b,["_sortingSequence"]);for(var e=[],c=0;c<b.length;c++)("Done by Contractor"==b[c].NameEN||"In Progress"==b[c].NameEN||"Non Conform"==b[c].NameEN||"contractor"!==j.oUserProfile.sCurrentRole)&&e.push(b[c]);"create"===d.sMode&&e.length&&(t.aData[0]._deficiencyStatusGuid=e[0].Guid),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:e},oParentArrayWrapper:t,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_deficiencyStatusGuid",sDependentIconKey:"AssociatedIconFileGuid",sTargetArrayNameInParent:"aDeficiencyStatuses"}),t.aData[0]&&(a.aDeficiencyStatuses=angular.copy(t.aData[0].aDeficiencyStatuses))},D=function(a){x(a),g.getDeficiencyStatuses({bShowSpinner:!1,onSuccess:C}),g.getContractors({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",bShowSpinner:!1,onSuccess:F}),g.getTaskTypes({bShowSpinner:!1,onSuccess:A}),g.getDeficiencyPriorities({bShowSpinner:!1,onSuccess:B}),g.getUsers({sExpand:"CompanyDetails",bShowSpinner:!1,onSuccess:G})},E=function(){g.getDeficiency({sExpand:"PhaseDetails/ProjectDetails,TaskStatusDetails,TaskPriorityDetails,AccountDetails,UnitDetails,FileMetadataSetDetails/FileMetadataDetails,CommentSetDetails/CommentDetails",sKey:r,bShowSpinner:!0,onSuccess:D})},F=function(b){b=l("orderBy")(b,["Name"]),"create"===d.sMode||"edit"===d.sMode?d.bUiSelectDisabled=!1:"display"===d.sMode&&(d.bUiSelectDisabled=!0),a.oContractors.aContractors=[];for(var c=0;c<b.length;c++)a.oContractors.aContractors.push({sName:b[c].Name,sCleanedName:k.replaceSpecialChars(b[c].Name),sGuid:b[c].Guid})},G=function(b){for(var c=[],e=!1,g=0;g<b.length;g++){for(var h=0;h<b[g].CompanyDetails.results.length;h++)if(b[g].CompanyDetails.results[h].CompanyName===j.oUserProfile.sCurrentCompany){e=!0,e&&c.push(b[g]);break}}b=[{}],b=c,b=l("orderBy")(b,["UserName"]),"create"===d.sMode&&(t.aData[0]._assignedUserName=j.oUserProfile.sUserName),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:t,sNameEN:"UserName",sNameFR:"UserName",sDependentKey:"UserName",sParentKey:"_assignedUserName",sTargetArrayNameInParent:"aUsers"}),t.aData[0]&&(a.aUsers=angular.copy(t.aData[0].aUsers))};"create"!==d.sMode?angular.equals(z,{})?E():(x(z),g.getDeficiencyStatuses({bShowSpinner:!1,onSuccess:C}),g.getContractors({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",bShowSpinner:!1,onSuccess:F}),"Deficiency"===a.sTaskType&&g.getDeficiencyTaskType({bShowSpinner:!1,onSuccess:A}),"Health and Safety"===a.sTaskType&&g.getHealthAndSafetyTaskType({bShowSpinner:!1,onSuccess:A}),g.getDeficiencyPriorities({bShowSpinner:!1,onSuccess:B}),g.getUsers({sExpand:"CompanyDetails",bShowSpinner:!1,onSuccess:G})):(d._aImages=[],d.iImagesNumber=0,d.iCommentsNumber=0,w({aSelectedPhases:[]}),g.getDeficiencyStatuses({bShowSpinner:!1,onSuccess:C}),g.getContractors({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",bShowSpinner:!1,onSuccess:F}),g.getDeficiencyPriorities({bShowSpinner:!1,onSuccess:B}),g.getUsers({sExpand:"CompanyDetails",bShowSpinner:!1,onSuccess:G}),"Deficiency"===a.sTaskType&&g.getDeficiencyTaskType({bShowSpinner:!1,onSuccess:A}),"Health and Safety"===a.sTaskType&&g.getHealthAndSafetyTaskType({bShowSpinner:!1,onSuccess:A})),a.onEdit=function(){d.bUiSelectDisabled=!1,e.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"edit",sDeficiencyGuid:a.oDeficiency._guid})},a.onNavigateToUnitDetails=function(){"contractor"!=a.sCurrentRole&&e.go("app.unitDetailsWrapper.unitDetails",{sMode:"display",sUnitGuid:a.oDeficiency._unitGuid})};var H=function(){var b={GeneralAttributes:{IsDeleted:!0}},c=function(){o.navigateBack({oState:e})};b.Guid=a.oDeficiency._guid,b.LastModifiedAt=a.oDeficiency._lastModifiedAt,g.updateDeficiency({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})};a.onDelete=function(a){f.showConfirmationPopup({sHeader:h.instant("deficiencyDetails_deletionConfirmationHeader"),sContent:h.instant("deficiencyDetails_deletionConfirmationContent"),sOk:h.instant("global_ok"),sCancel:h.instant("global_cancel"),onOk:H,event:a})};var I=function(){var b=[],c=[],d="";if(a.oContractors.aSelectedContractors&&a.oContractors.aSelectedContractors.length)for(var e=0;e<a.oContractors.aSelectedContractors.length;e++)d="Accounts('"+a.oContractors.aSelectedContractors[e].sGuid+"')",c.push(d),a.sAccountValues=a.sAccountValues+a.oContractors.aSelectedContractors[e].sName+"; ",a.sAccountGuids=a.sAccountGuids+a.oContractors.aSelectedContractors[e].sGuid+"; ";return b.push({sRelationName:"AccountDetails",bKeepCompanyDependentLinks:!0,aUri:c}),b};a.onCloseCheckSelectedTaskPrioritiesLength=function(){0==a.aSelectedTaskPriorities.length&&a.onSelectedTaskPrioritiesModified()},a.onSelectedContractorsModified=function(){a.onDataModified()},a.onDescriptionChanged=function(){a.onDataModified()},a.onDueDateChanged=function(){a.onDataModified()},a.onSelectedTaskPrioritiesModified=function(){a.onDataModified(),a.oForms.deficiencyDetailsForm.selectedTaskPriorities.$setDirty()},a.onCloseCheckSelectedPhasesLength=function(){0==a.aSelectedPhases.length&&a.onSelectedPhasesModified()},a.onSelectedPhasesModified=function(){a.onDataModified(),a.oForms.deficiencyDetailsForm.selectedPhases.$setDirty(),a.aSelectedPhases[0]&&v(a.aSelectedPhases[0].Guid)},a.onCloseCheckSelectedStatusesLength=function(){0==a.aSelectedStatuses.length&&a.onSelectedStatusesModified()},a.onSelectedStatusesModified=function(){a.onDataModified(),a.oForms.deficiencyDetailsForm.selectedStatuses.$setDirty()},a.onDataModified=function(){d.bDataHasBeenModified=!0},a.onSave=function(b,c){if(a.oForms.deficiencyDetailsForm.selectedTaskTypes&&a.oForms.deficiencyDetailsForm.selectedTaskTypes.$setDirty(),a.oForms.deficiencyDetailsForm.selectedTaskPriorities&&a.oForms.deficiencyDetailsForm.selectedTaskPriorities.$setDirty(),a.oForms.deficiencyDetailsForm.selectedPhases&&a.oForms.deficiencyDetailsForm.selectedPhases.$setDirty(),a.oForms.deficiencyDetailsForm.selectedStatuses&&a.oForms.deficiencyDetailsForm.selectedStatuses.$setDirty(),a.oForms.deficiencyDetailsForm.selectedUser&&a.oForms.deficiencyDetailsForm.selectedUser.$setDirty(),a.oForms.deficiencyDetailsForm.selectedUnits&&a.oForms.deficiencyDetailsForm.selectedUnits.$setDirty(),a.oForms.deficiencyDetailsForm.$valid){var f={GeneralAttributes:{}},h=[];f.Guid=a.oDeficiency._guid;var i=function(f){if(d.bDataHasBeenModified=!1,c)return void e.go(c.toState,c.toParams);b?(a.oDeficiency.aDescriptionTags=[],a.oDeficiency.aLocationTags=[],a.oDeficiency.sDescription="",a.oDeficiency.dDueDate="/Date(0)/"):(e.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"display",sDeficiencyGuid:f.Guid}),a.oDeficiency._lastModifiedAt=f.LastModifiedAt,a.oDeficiency.sLastModifiedAt=k.dBDateToSting(f.LastModifiedAt),a.oDeficiency.sCreatedAt=k.dBDateToSting(f.CreatedAt),f.DueDate&&(a.oDeficiency.sDueDate=k.dBDateToSting(f.DueDate)),a.oDeficiency._guid=f.Guid);var h=function(a){g.logEvents({aData:a})};g.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:"notificationsList_newDeficiency",sOperationNameFR:"",aData:[{Guid:f.Guid}],onSuccess:h})},j=function(b){if(d.bDataHasBeenModified=!1,c)return void e.go(c.toState,c.toParams);a.oDeficiency._lastModifiedAt=b.LastModifiedAt,a.oDeficiency.sLastModifiedAt=k.dBDateToSting(b.LastModifiedAt),e.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"display",sDeficiencyGuid:b.Guid});var f=function(a){g.logEvents({aData:a})};g.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:"notificationsList_updatedDeficiency",sOperationNameFR:"",aData:[{Guid:b.Guid}],onSuccess:f})};switch(f.DescriptionTags=k.tagsArrayToTagsString(a.oDeficiency.aDescriptionTags),f.LocationTags=k.tagsArrayToTagsString(a.oDeficiency.aLocationTags),f.Description=a.oDeficiency.sDescription,a.oDeficiency.dDueDate&&"/Date(0)/"!=a.oDeficiency.dDueDate?f.DueDate="/Date("+a.oDeficiency.dDueDate.getTime()+")/":f.DueDate="/Date(0)/",f.TaskTypeGuid=a.sTaskTypeGuid,a.aSelectedTaskPriorities.length&&(f.TaskPriorityGuid=a.aSelectedTaskPriorities[0].Guid),a.aSelectedPhases.length&&(f.PhaseGuid=a.aSelectedPhases[0].Guid),a.aSelectedStatuses.length&&(f.TaskStatusGuid=a.aSelectedStatuses[0].Guid),a.aSelectedUser.length&&(f.UserName=a.aSelectedUser[0].UserName),a.aSelectedUnits.length&&(f.UnitGuid=a.aSelectedUnits[0].Guid),a.sAccountValues="",a.sAccountGuids="",h=I(),f.AccountValues=a.sAccountValues,f.AccountGuids=a.sAccountGuids,f.LastModifiedAt=a.oDeficiency._lastModifiedAt,d.sMode){case"edit":g.updateDeficiency({bShowSpinner:!0,sKey:f.Guid,aLinks:h,oData:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:j});break;case"create":d.sFileMetadataSetGuid&&(f.FileMetadataSetGuid=d.sFileMetadataSetGuid),d.sCommentSetGuid&&(f.CommentSetGuid=d.sCommentSetGuid),g.createDeficiency({bShowSpinner:!0,aLinks:h,oData:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:i})}}},a.onDisplayPhotoGallery=function(a){a.stopPropagation(),d._aImages.length&&f.setUpPhotoGallery(d._aImages)},a.onBack=function(){o.navigateBack({oState:e})},a.onSaveAndNew=function(){a.onSave(!0)};var J=function(){a.onSave(!1,s)},K=function(){d.bDataHasBeenModified=!1,e.go(s.toState,s.toParams)};a.$on("$stateChangeStart",function(a,b,c,e,g){d.bDataHasBeenModified&&(a.preventDefault(),s={toState:b,toParams:c},f.showConfirmationPopup({sHeader:h.instant("global_changesSaveConfirmationHeader"),sContent:h.instant("global_changesSaveConfirmationContent"),sOk:h.instant("global_yes"),sCancel:h.instant("global_no"),onOk:J,onCancel:K,event:a}))})}]),viewControllers.controller("deficiencyDetailsHybridView",["$scope","$location","$anchorScroll","$rootScope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){a.onClose=function(){d.sDeficienciesListView="deficienciesList",q(function(){$("#body")[0]&&($("#body")[0].scrollTop=j.getListViewScrollPosition("deficienciesList"),j.putListViewScrollPosition("deficienciesList",0))},0)};var r=function(a){for(var b="",c=0;c<a.length;c++)a[c]._sortingSequence=a[c].GeneralAttributes.SortingSequence;a=l("orderBy")(a,["_sortingSequence"]);for(var c=0;c<a.length;c++)b="",b=a[c].NameFR&&"fr"===h.use()?a[c].NameFR:a[c].NameEN,("Done by Contractor"==a[c].NameEN||"In Progress"==a[c].NameEN||"Non Conform"==a[c].NameEN||"contractor"!==j.oUserProfile.sCurrentRole)&&d.aSelectedDeficiencyStatuses.push({sGuid:a[c].Guid,sName:b,bTicked:!1,sIconUrl:n.sAppAbsolutePath+"rest/file/v2/get/"+a[c].AssociatedIconFileGuid})};d.aSelectedDeficiencyStatuses&&d.aSelectedDeficiencyStatuses.length||(d.aSelectedDeficiencyStatuses=[],g.getDeficiencyStatuses({onSuccess:r})),a.onSave=function(){var a={},b=function(a){d.oSelectedDeficiency._lastModifiedAt=a.LastModifiedAt;for(var b=0;b<d.aDeficiencies.length;b++)if(d.aDeficiencies[b]._guid===d.oSelectedDeficiency._guid){d.aDeficiencies[b]._lastModifiedAt=a.LastModifiedAt,d.aDeficiencies[b].sStatusDescription=d.oSelectedDeficiency.sStatusDescription,d.aDeficiencies[b].sStatuseIconUrl=d.oSelectedDeficiency.sStatuseIconUrl,d.aDeficiencies[b].sStatusGuid=d.oSelectedDeficiency.sStatusGuid;break}var c=function(a){g.logEvents({aData:a})};g.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:n.updatedDeficiencyEN,sOperationNameFR:n.updatedDeficiencyEN,aData:[{Guid:a.Guid}],onSuccess:c})};a.Guid=d.oSelectedDeficiency._guid,a.TaskStatusGuid=d.oSelectedDeficiency.sStatusGuid,a.LastModifiedAt=d.oSelectedDeficiency._lastModifiedAt,g.updateDeficiency({bShowSpinner:!0,sKey:a.Guid,oData:a,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:b})},a.onMainMenu=function(){e.go("mainMenuHybrid")},a.onImagesAttribute=function(){d.aSelectedDeficiencyImages=angular.copy(d.oSelectedDeficiency._aImages);for(var a=0;a<d.aSelectedDeficiencyImages.length;a++)d.aSelectedDeficiencyImages[a].sImgUrl=f.constructImageUrl(d.aSelectedDeficiencyImages[a].Guid);d.sCurrentSearhCriteria="",d.sSelectedDeficiencyAttribute="images",d.sDeficienciesListView="deficienciesListItemsLists"},a.onCommentsAttribute=function(){d.aSelectedDeficiencyComments=angular.copy(f.processListOfComments({oData:d.oSelectedDeficiency._oComments})),d.aSelectedDeficiencyComments=l("orderBy")(d.aSelectedDeficiencyComments,["_createdAt"]),d.sCurrentSearhCriteria="",d.sSelectedDeficiencyAttribute="comments",d.sDeficienciesListView="deficienciesListItemsLists"},a.onStatusAttribute=function(){("Done by Contractor"==d.oSelectedDeficiency.sStatusDescriptionEN||"In Progress"==d.oSelectedDeficiency.sStatusDescriptionEN||"Non Conform"==d.oSelectedDeficiency.sStatusDescriptionEN||"contractor"!==j.oUserProfile.sCurrentRole)&&(d.sCurrentSearhCriteria="",d.sSelectedDeficiencyAttribute="statuses",d.sDeficienciesListView="deficienciesListItemsLists")}}]),viewControllers.controller("deficiencyDetailsWrapperView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i){b.bDataHasBeenModified=!1,a.bDisplayAttachmentsList=!1,a.bDisplayCommentsList=!1,a.onDisplayAttachmentsList=function(){a.bDisplayAttachmentsList=!a.bDisplayAttachmentsList},a.onDisplayCommentsList=function(){a.bDisplayCommentsList=!a.bDisplayCommentsList},a.$on("$destroy",function(){i.getPreviousStateName()!==b.sCurrentStateName&&i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("deficiencyQuickAddView",["$rootScope","$scope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings","$timeout","$mdSidenav","$window","$cordovaCamera",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){m.removeHistory(),d.constructLogoUrl(),d.constructMenuIconUrl();var s=h.oUserProfile.sCurrentRole,t=n.getRolesSettingsForEntityAndOperation({sRole:s,sEntityName:"oDeficiency",sOperation:"bCreate"});t||(d.logOut(),i.displayMessage({sText:f.instant("global_noRightToCreateDeficiencies"),sType:"error"})),a.sCurrentStateName=c.current.name,a.oStateParams=angular.copy(g),b.onMainMenu=function(){c.go("mainMenuHybrid")},a.aUnits||(a.aUnits=[]),a.sUnitFilter||(a.sUnitFilter=""),a.aFilteredUnits||(a.aFilteredUnits=[]),a.bUnitWasSelected||(a.bUnitWasSelected=!1),a.aDescriptionTags||(a.aDescriptionTags=[]),a.aLocationTags||(a.aLocationTags=[]),a.aContractors||(a.aContractors=[]),a.sContractorsFilter||(a.sContractorsFilter=""),a.aFilteredContractors||(a.aFilteredContractors=[]),a.bContractorWasSelected||(a.bContractorWasSelected=!1),a.oDeficiencyAttributes||(a.oDeficiencyAttributes={oPhase:{sDescription:f.instant("deficiencyDetails_associatedProjectsAndPhases"),sValue:"...",bIsSelectionUnabled:!0},oUnit:{sDescription:f.instant("deficiencyDetails_unit"),sValue:"...",bIsSelectionUnabled:!1},oStatus:{sDescription:f.instant("deficiencyDetails_status"),sValue:"...",sIconUrl:"",bIsSelectionUnabled:!0},oPriority:{sDescription:f.instant("deficiencyDetails_deficiencyPriority"),sValue:"...",bIsSelectionUnabled:!0},oUser:{sDescription:f.instant("deficiencyDetails_assignedUser"),sValue:"...",bIsSelectionUnabled:!0},oDescriptionTags:{sDescription:f.instant("deficiencyDetails_descriptionTags"),sValue:"...",bIsSelectionUnabled:!0},oLocationTags:{sDescription:f.instant("deficiencyDetails_locationTags"),sValue:"...",bIsSelectionUnabled:!0},oContractors:{sDescription:f.instant("deficiencyDetails_contractors"),
sValue:"...",bIsSelectionUnabled:!1},oImages:{sDescription:f.instant("global_imagesMobile"),iValue:0,bIsSelectionUnabled:!0}});var u=function(b){for(var c=0;c<b.length;c++)if("Deficiency"===b[c].NameEN){a.sTaskTypeGuid=b[c].Guid;break}};if(a.sTaskTypeGuid||e.getTaskTypes({bShowSpinner:!1,onSuccess:u}),!a.aProjectsWithPhases){a.aProjectsWithPhases=[],a.bPhaseWasSelected=!1;var v=[];if(!a.aProjectsWithPhases.length)for(var w=d.constructUserProjectsPhases(),x=0;x<w.length;x++){var v=[];w[x].NameFR&&"fr"===f.use()?w[x].sDescription=w[x].NameFR:w[x].sDescription=w[x].NameEN;for(var y=0;y<w[x].PhaseDetails.results.length;y++)w[x].PhaseDetails.results[y].NameFR&&"fr"===f.use()?w[x].PhaseDetails.results[y].sDescription=w[x].PhaseDetails.results[y].NameFR:w[x].PhaseDetails.results[y].sDescription=w[x].PhaseDetails.results[y].NameEN,v.push({sPhaseName:w[x].PhaseDetails.results[y].sDescription,Guid:w[x].PhaseDetails.results[y].Guid,bTicked:!1});a.aProjectsWithPhases.push({sProjectName:w[x].sDescription,aPhases:v})}}var z=function(b){b.UnitDetails.results=j("filter")(b.UnitDetails.results,function(a,b){return!a.GeneralAttributes.IsDeleted});for(var c=0;c<b.UnitDetails.results.length;c++)a.aUnits.push({sGuid:b.UnitDetails.results[c].Guid,sName:i.convertStringToInt(b.UnitDetails.results[c].Name),sCleanedName:i.replaceSpecialChars(i.convertStringToInt(b.UnitDetails.results[c].Name)),bTicked:!1});a.aUnits=j("orderBy")(a.aUnits,["sName"]),a.aFilteredUnits=j("filter")(a.aUnits,{sName:a.sUnitFilter})},A=function(b){b.AccountDetails.results=j("filter")(b.AccountDetails.results,function(a,b){return!a.GeneralAttributes.IsDeleted&&"Contractor"===a.AccountTypeDetails.NameEN}),b.AccountDetails.results=j("orderBy")(b.AccountDetails.results,["Name"]);for(var c=0;c<b.AccountDetails.results.length;c++)a.aContractors.push({sGuid:b.AccountDetails.results[c].Guid,sName:b.AccountDetails.results[c].Name,sCleanedName:i.replaceSpecialChars(b.AccountDetails.results[c].Name),bTicked:!1});a.aFilteredContractors=j("filter")(a.aContractors,{sName:a.sContractorsFilter})},B=function(c){for(var d="",e=0;e<c.length;e++)c[e]._sortingSequence=c[e].GeneralAttributes.SortingSequence;c=j("orderBy")(c,["_sortingSequence"]);for(var e=0;e<c.length;e++)d="",d=c[e].NameFR&&"fr"===f.use()?c[e].NameFR:c[e].NameEN,b.aStatuses.push({sGuid:c[e].Guid,sName:d,bTicked:!1,sIconUrl:l.sAppAbsolutePath+"rest/file/v2/get/"+c[e].AssociatedIconFileGuid});a.aStatuses[0].bTicked=!0,a.oDeficiencyAttributes.oStatus.sValue=a.aStatuses[0].sName,a.oDeficiencyAttributes.oStatus.sSelectedItemGuid=a.aStatuses[0].sGuid,a.oDeficiencyAttributes.oStatus.sIconUrl=a.aStatuses[0].sIconUrl,a.bStatusWasSelected=!0};a.aStatuses||(a.aStatuses=[],a.bStatusWasSelected=!1,e.getDeficiencyStatuses({onSuccess:B}));var C=function(b){for(var c="",d=0;d<b.length;d++)b[d]._sortingSequence=b[d].GeneralAttributes.SortingSequence;b=j("orderBy")(b,["_sortingSequence"]);for(var d=0;d<b.length;d++)c="",c=b[d].NameFR&&"fr"===f.use()?b[d].NameFR:b[d].NameEN,a.aPriorities.push({sGuid:b[d].Guid,sName:c,bTicked:!1});a.aPriorities[0].bTicked=!0,a.oDeficiencyAttributes.oPriority.sValue=a.aPriorities[0].sName,a.oDeficiencyAttributes.oPriority.sSelectedItemGuid=a.aPriorities[0].sGuid,a.bPriorityWasSelected=!0};a.aPriorities||(a.aPriorities=[],a.bPriorityWasSelected=!1,e.getDeficiencyPriorities({onSuccess:C}));var D=function(b){var c=!1;b=j("filter")(b,function(a,b){for(var c=!1,d=0;d<a.CompanyDetails.results.length;d++)if(a.CompanyDetails.results[d].CompanyName===h.oUserProfile.sCurrentCompany){c=!0;break}return c}),b=j("orderBy")(b,["UserName"]);for(var d=0;d<b.length;d++)c=!1,b[d].UserName===h.oUserProfile.sUserName&&(c=!0,a.oDeficiencyAttributes.oUser.sValue=b[d].UserName,a.oDeficiencyAttributes.oUser.sSelectedItemGuid=b[d].UserName,a.bUserWasSelected=!0),a.aUsers.push({sGuid:b[d].UserName,sName:b[d].UserName,bTicked:c});a.bUserWasSelected=!0};a.aUsers||(a.aUsers=[],a.bUserWasSelected=!1,e.getUsers({sExpand:"CompanyDetails",onSuccess:D})),b.onPhaseAttribute=function(){a.sSideNavHeader=a.oDeficiencyAttributes.oPhase.sDescription,a.bIsItemsListsOpen=!0},b.onUnitAttribute=function(){a.oDeficiencyAttributes.oUnit.bIsSelectionUnabled&&(a.sSideNavHeader=a.oDeficiencyAttributes.oUnit.sDescription,a.aUnits.length||e.getPhase({sExpand:"UnitDetails",sKey:a.oDeficiencyAttributes.oPhase.sSelectedItemGuid,onSuccess:z}),a.bIsItemsListsOpen=!0)},b.onStatusAttribute=function(){a.sSideNavHeader=a.oDeficiencyAttributes.oStatus.sDescription,a.bIsItemsListsOpen=!0},b.onPriorityAttribute=function(){a.sSideNavHeader=a.oDeficiencyAttributes.oPriority.sDescription,a.bIsItemsListsOpen=!0},b.onUserAttribute=function(){a.sSideNavHeader=a.oDeficiencyAttributes.oUser.sDescription,a.bIsItemsListsOpen=!0},b.onDescriptionTagsAttribute=function(){a.sSideNavHeader=a.oDeficiencyAttributes.oDescriptionTags.sDescription,a.bIsItemsListsOpen=!0},b.onLocationTagsAttribute=function(){a.sSideNavHeader=a.oDeficiencyAttributes.oLocationTags.sDescription,a.bIsItemsListsOpen=!0},b.onContractorsAttribute=function(){a.oDeficiencyAttributes.oContractors.bIsSelectionUnabled&&(a.sSideNavHeader=a.oDeficiencyAttributes.oContractors.sDescription,a.aContractors.length||e.getPhase({sKey:b.oDeficiencyAttributes.oPhase.sSelectedItemGuid,sExpand:"AccountDetails/AccountTypeDetails",onSuccess:A}),a.bIsItemsListsOpen=!0)},b.onImagesAttribute=function(){a.sSideNavHeader=a.oDeficiencyAttributes.oImages.sDescription,a.bIsItemsListsOpen=!0};var E=function(){var c=[],d=[],e="";if(a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids&&a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids.length){b.sAccountValues=a.oDeficiencyAttributes.oContractors.sValue;for(var f=0;f<a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids.length;f++)e="Accounts('"+a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids[f]+"')",d.push(e),b.sAccountGuids=b.sAccountGuids+a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids[f]+"; "}return c.push({sRelationName:"AccountDetails",bKeepCompanyDependentLinks:!0,aUri:d}),c};b.onSave=function(){var c=function(b){a.sFileMetadataSetGuid="",a.oDeficiencyAttributes.oDescriptionTags.sValue="...",a.aDescriptionTags=[],a.oDeficiencyAttributes.oLocationTags.sValue="...",a.aLocationTags=[],a.oDeficiencyAttributes.oContractors.sValue="...",a.aContractors=[],a.oDeficiencyAttributes.oImages.iValue=0,a.sContractorsFilter="";var c=function(a){e.logEvents({aData:a})};e.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:l.newDeficiencyEN,sOperationNameFR:l.newDeficiencyFR,aData:[{Guid:b.Guid}],onSuccess:c})},d={},g=!0;if(a.oDeficiencyAttributes.oPhase.sSelectedItemGuid?d.PhaseGuid=a.oDeficiencyAttributes.oPhase.sSelectedItemGuid:g=!1,a.oDeficiencyAttributes.oUnit.sSelectedItemGuid?d.UnitGuid=a.oDeficiencyAttributes.oUnit.sSelectedItemGuid:g=!1,!g)return void i.displayMessage({sText:f.instant("global_projectAndUnitMandatory"),sType:"error"});a.sTaskTypeGuid&&(d.TaskTypeGuid=a.sTaskTypeGuid),a.oDeficiencyAttributes.oStatus.sSelectedItemGuid&&(d.TaskStatusGuid=a.oDeficiencyAttributes.oStatus.sSelectedItemGuid),a.oDeficiencyAttributes.oPriority.sSelectedItemGuid&&(d.TaskPriorityGuid=a.oDeficiencyAttributes.oPriority.sSelectedItemGuid),a.oDeficiencyAttributes.oUser.sSelectedItemGuid&&(d.UserName=a.oDeficiencyAttributes.oUser.sSelectedItemGuid),"..."!==a.oDeficiencyAttributes.oDescriptionTags.sValue&&(d.DescriptionTags=a.oDeficiencyAttributes.oDescriptionTags.sValue),"..."!==a.oDeficiencyAttributes.oLocationTags.sValue&&(d.LocationTags=a.oDeficiencyAttributes.oLocationTags.sValue),d.FileMetadataSetGuid=a.sFileMetadataSetGuid,b.sAccountValues="",b.sAccountGuids="";var h=E();d.AccountValues=b.sAccountValues,d.AccountGuids=b.sAccountGuids,e.createDeficiency({bShowSpinner:!0,aLinks:h,oData:d,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("deficiencyQuickAddItemsListsView",["$rootScope","$scope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings","$timeout","$mdSidenav","$window","$cordovaCamera","$cordovaKeyboard",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){b.onClose=function(){switch(l.bIsHybridApplication&&"ios"===l.sMobileType&&s.close(),a.sSideNavHeader){case a.oDeficiencyAttributes.oPhase.sDescription:if(a.bPhaseWasSelected){a.oDeficiencyAttributes.oUnit.bIsSelectionUnabled=!0,a.oDeficiencyAttributes.oContractors.bIsSelectionUnabled=!0,a.oDeficiencyAttributes.oPhase.sValue="";for(var b=0;b<a.aProjectsWithPhases.length;b++)for(var c=0;c<a.aProjectsWithPhases[b].aPhases.length;c++)if(a.aProjectsWithPhases[b].aPhases[c].bTicked){a.oDeficiencyAttributes.oPhase.sValue=a.oDeficiencyAttributes.oPhase.sValue+a.aProjectsWithPhases[b].sProjectName+" - "+a.aProjectsWithPhases[b].aPhases[c].sPhaseName,a.oDeficiencyAttributes.oPhase.sSelectedItemGuid=a.aProjectsWithPhases[b].aPhases[c].Guid;break}}break;case a.oDeficiencyAttributes.oUnit.sDescription:if(a.bUnitWasSelected){a.oDeficiencyAttributes.oUnit.sValue="";for(var b=0;b<a.aUnits.length;b++)if(a.aUnits[b].bTicked){a.oDeficiencyAttributes.oUnit.sValue=a.aUnits[b].sName,a.oDeficiencyAttributes.oUnit.sSelectedItemGuid=a.aUnits[b].sGuid;break}}break;case a.oDeficiencyAttributes.oStatus.sDescription:if(a.bStatusWasSelected){a.oDeficiencyAttributes.oStatus.sValue="";for(var b=0;b<a.aStatuses.length;b++)if(a.aStatuses[b].bTicked){a.oDeficiencyAttributes.oStatus.sValue=a.aStatuses[b].sName,a.oDeficiencyAttributes.oStatus.sSelectedItemGuid=a.aStatuses[b].sGuid,a.oDeficiencyAttributes.oStatus.sIconUrl=a.aStatuses[b].sIconUrl;break}}break;case a.oDeficiencyAttributes.oPriority.sDescription:if(a.bPriorityWasSelected){a.oDeficiencyAttributes.oPriority.sValue="";for(var b=0;b<a.aPriorities.length;b++)if(a.aPriorities[b].bTicked){a.oDeficiencyAttributes.oPriority.sValue=a.aPriorities[b].sName,a.oDeficiencyAttributes.oPriority.sSelectedItemGuid=a.aPriorities[b].sGuid;break}}break;case a.oDeficiencyAttributes.oUser.sDescription:if(a.bUserWasSelected){a.oDeficiencyAttributes.oUser.sValue="";for(var b=0;b<a.aUsers.length;b++)if(a.aUsers[b].bTicked){a.oDeficiencyAttributes.oUser.sValue=a.aUsers[b].sName,a.oDeficiencyAttributes.oUser.sSelectedItemGuid=a.aUsers[b].sGuid;break}}break;case a.oDeficiencyAttributes.oDescriptionTags.sDescription:a.aDescriptionTags.length?a.oDeficiencyAttributes.oDescriptionTags.sValue=i.tagsArrayToTagsString(a.aDescriptionTags):a.oDeficiencyAttributes.oDescriptionTags.sValue="...";break;case a.oDeficiencyAttributes.oLocationTags.sDescription:a.aLocationTags.length?a.oDeficiencyAttributes.oLocationTags.sValue=i.tagsArrayToTagsString(a.aLocationTags):a.oDeficiencyAttributes.oLocationTags.sValue="...";break;case a.oDeficiencyAttributes.oContractors.sDescription:if(a.bContractorWasSelected){a.oDeficiencyAttributes.oContractors.sValue="",a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids=[];for(var b=0;b<a.aContractors.length;b++)a.aContractors[b].bTicked&&(a.oDeficiencyAttributes.oContractors.sValue=a.oDeficiencyAttributes.oContractors.sValue+a.aContractors[b].sName+"; ",a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids.push(a.aContractors[b].sGuid))}else a.oDeficiencyAttributes.oContractors.sValue="...",a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids=[]}a.bIsItemsListsOpen=!1},b.onSelectPhase=function(c){if(a.bPhaseWasSelected=!0,!c.bTicked){for(var d=0;d<a.aProjectsWithPhases.length;d++)for(var e=0;e<a.aProjectsWithPhases[d].aPhases.length;e++)a.aProjectsWithPhases[d].aPhases[e].bTicked=!1;c.bTicked=!0,a.aUnits=[],a.aFilteredUnits=[],a.sUnitFilter="",a.aContractors=[],a.aFilteredContractors=[],a.sContractorsFilter="",a.oDeficiencyAttributes.oUnit.sValue="...",a.oDeficiencyAttributes.oUnit.sSelectedItemGuid="",a.bUnitWasSelected=!1,a.oDeficiencyAttributes.oContractors.sValue="...",a.oDeficiencyAttributes.oContractors.aSelectedItemsGuids=[],a.bContractorWasSelected=!1}o(b.onClose,300)},b.onSelectUnit=function(c){if(a.bUnitWasSelected=!0,!c.bTicked){for(var d=0;d<a.aUnits.length;d++)a.aUnits[d].bTicked=!1;c.bTicked=!0}o(b.onClose,300)},b.onSelectStatus=function(c){if(a.bStatusWasSelected=!0,!c.bTicked){for(var d=0;d<a.aStatuses.length;d++)a.aStatuses[d].bTicked=!1;c.bTicked=!0}o(b.onClose,300)},b.onSelectPriority=function(c){if(a.bPriorityWasSelected=!0,!c.bTicked){for(var d=0;d<a.aPriorities.length;d++)a.aPriorities[d].bTicked=!1;c.bTicked=!0}o(b.onClose,300)},b.onSelectUser=function(c){if(a.bUserWasSelected=!0,!c.bTicked){for(var d=0;d<a.aUsers.length;d++)a.aUsers[d].bTicked=!1;c.bTicked=!0}o(b.onClose,300)},b.onSelectContractor=function(b){if(a.bContractorWasSelected=!1,b.bTicked=!b.bTicked,b.bTicked)a.bContractorWasSelected=!0;else for(var c=0;c<a.aContractors.length;c++)if(a.aContractors[c].bTicked){a.bContractorWasSelected=!0;break}},b.onChangeUnitFilter=function(b){a.sUnitFilter=i.replaceSpecialChars(b),a.aFilteredUnits=j("filter")(a.aUnits,{sCleanedName:a.sUnitFilter})},b.onChangeContractorsFilter=function(b){a.sContractorsFilter=i.replaceSpecialChars(b),a.aFilteredContractors=j("filter")(a.aContractors,{sCleanedName:a.sContractorsFilter})},b.onAddImage=function(c){a.bIsItemsListsOpen=!1;var e={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:c,allowEdit:!0,encodingType:Camera.EncodingType.JPEG,targetWidth:500,targetHeight:500,popoverOptions:CameraPopoverOptions,saveToPhotoAlbum:!0};r.getPicture(e).then(function(c){var e=function(){b.$apply(function(){a.$emit("UNLOAD"),a.oDeficiencyAttributes.oImages.iValue++})};c="data:image/jpeg;base64,"+c;for(var f=atob(c.split(",")[1]),g=new ArrayBuffer(f.length),h=new Uint8Array(g),i=0;i<f.length;i++)h[i]=f.charCodeAt(i);var j=new Blob([g],{type:"image/jpeg"}),k=new FormData;k.append("blob",j,"quickAddAttachment"),d.uploadAttachmentsForEntity({sPath:"Tasks",aFiles:[k],sParentEntityGuid:"",sParentEntityFileMetadataSetGuid:a.sFileMetadataSetGuid,onSuccess:e})},function(a){})},b.onUseCamera=function(){b.onAddImage(Camera.PictureSourceType.CAMERA)},b.onUseLibrary=function(){b.onAddImage(Camera.PictureSourceType.SAVEDPHOTOALBUM)}}]),viewControllers.controller("deficiencyQuickAddWrapperView",["$rootScope","$scope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings","$timeout","$mdSidenav","$window","$cordovaCamera",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){a.bIsItemsListsOpen=!1,b.$on("$destroy",function(){m.getPreviousStateName()!==a.sCurrentStateName&&m.addStateToHistory({sStateName:a.sCurrentStateName,oStateParams:angular.copy(a.oStateParams)})})}]),viewControllers.controller("unitDetailsView",["$scope","$location","$anchorScroll","$rootScope","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){b.hash("top"),c();var q=i.sUnitGuid;a.oForms={},a.bShowClients=!0,d.sCurrentStateName=e.current.name,d.oStateParams=angular.copy(i);var r=j.oUserProfile.sCurrentRole;a.bDisplayEditButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oUnit",sOperation:"bUpdate"}),a.bDisplayDeleteButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oUnit",sOperation:"bDelete"}),a.bShowBackButton=o.aHistoryStates.length>0?!0:!1;var s={};d.sMode=i.sMode,"create"===d.sMode&&(d.sFileMetadataSetGuid="",d.sFileMetadataSetLastModifiedAt=""),a.oUnit={aDescriptionTags:[]};var t={aData:[{_clientsGuids:[]}]};a.aUnitOptionsArrays=[];var u=function(b){a.aUnitOptionsArrays=[];for(var c=0;c<b.UnitOptionSetDetails.results.length;c++){b.UnitOptionSetDetails.results[c]._sortingSequence=b.UnitOptionSetDetails.results[c].GeneralAttributes.SortingSequence;for(var d=0;d<b.UnitOptionSetDetails.results[c].UnitOptionDetails.results.length;d++)b.UnitOptionSetDetails.results[c].UnitOptionDetails.results[d]._sortingSequence=b.UnitOptionSetDetails.results[c].UnitOptionDetails.results[d].GeneralAttributes.SortingSequence;b.UnitOptionSetDetails.results[c].UnitOptionDetails.results=l("orderBy")(b.UnitOptionSetDetails.results[c].UnitOptionDetails.results,["_sortingSequence"])}b.UnitOptionSetDetails.results=l("orderBy")(b.UnitOptionSetDetails.results,["_sortingSequence"]);for(var c=0;c<b.UnitOptionSetDetails.results.length;c++){a.oUnit._unitOptionGuid="";for(var d=0;d<b.UnitOptionSetDetails.results[c].UnitOptionDetails.results.length;d++)if(a.oUnit._unitOptions)for(var e=0;e<a.oUnit._unitOptions.length;e++)if(b.UnitOptionSetDetails.results[c].UnitOptionDetails.results[d].Guid===a.oUnit._unitOptions[e].Guid){a.oUnit._unitOptionGuid=a.oUnit._unitOptions[e].Guid;break}t.aData[0]=angular.copy(a.oUnit),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b.UnitOptionSetDetails.results[c].UnitOptionDetails.results},oParentArrayWrapper:t,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_unitOptionGuid",sTargetArrayNameInParent:"aUnitOptions"}),t.aData[0]&&a.aUnitOptionsArrays.push({sOptionSetName:"en"===h.use()?b.UnitOptionSetDetails.results[c].NameEN:b.UnitOptionSetDetails.results[c].NameFR,aOptions:t.aData[0].aUnitOptions})}},v=function(a){g.getPhase({sExpand:"UnitOptionSetDetails/UnitOptionDetails",sKey:a,bShowSpinner:!1,onSuccess:u})},w=function(b){a.aUserProjectsPhasesForMultiselect=f.constructUserProjectsPhasesForMultiSelect({aSelectedPhases:b}),b.length&&b[0]&&v(b[0])},x=function(b){a.oUnit._guid=b.Guid;var c="",e="";if(d.sFileMetadataSetGuid=b.FileMetadataSetGuid,b.FileMetadataSetDetails&&(d.sFileMetadataSetLastModifiedAt=b.FileMetadataSetDetails.LastModifiedAt),d.$broadcast("FileAttachemntsCanBeLoaded"),a.oUnit._lastModifiedAt=b.LastModifiedAt,a.oUnit.sName=b.Name,b.PhaseDetails&&b.PhaseDetails.ProjectDetails&&(e=b.PhaseDetails.NameFR&&"fr"===h.use()?b.PhaseDetails.NameFR:b.PhaseDetails.NameEN,c=b.PhaseDetails.ProjectDetails.NameFR&&"fr"===h.use()?b.PhaseDetails.ProjectDetails.NameFR:b.PhaseDetails.ProjectDetails.NameEN),a.oUnit._ProjectAndPhaseName=c+" - "+e,a.oUnit._clientsGuids=[],b.AccountDetails)for(var f=0;f<b.AccountDetails.results.length;f++)a.oUnit._clientsGuids.push(b.AccountDetails.results[f].Guid);a.oUnit.aDescriptionTags=k.tagsStringToTagsArray(b.DescriptionTags),a.oUnit._unitOptions=angular.copy(b.UnitOptionDetails.results),t.aData[0]=angular.copy(a.oUnit),w([b.PhaseGuid])},y="CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq falsePhaseDetails/ProjectDetails,UnitOptionDetails";y+="FileMetadataSetDetails/FileMetadataDetails";var z=j.getEntityDetails({sCacheProviderAttribute:"oUnitEntity",sRequestSettings:y,sKeyName:"Guid",sKeyValue:q}),A=function(a){x(a),g.getClients({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",bShowSpinner:!1,onSuccess:C})},B=function(){g.getUnit({sKey:q,sExpand:"PhaseDetails/ProjectDetails,UnitOptionDetails,AccountDetails,FileMetadataSetDetails",bShowSpinner:!0,onSuccess:A})},C=function(b){b=l("orderBy")(b,["Name"]),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:t,sNameEN:"Name",sNameFR:"Name",sDependentKey:"Guid",sParentKeys:"_clientsGuids",sTargetArrayNameInParent:"aClients"}),t.aData[0]&&(a.aClients=angular.copy(t.aData[0].aClients))};"create"!==d.sMode?angular.equals(z,{})?B():(x(z),g.getClients({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",bShowSpinner:!1,onSuccess:C})):(w({aSelectedPhases:[]}),g.getClients({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",bShowSpinner:!1,onSuccess:C})),a.onEdit=function(){e.go("app.unitDetailsWrapper.unitDetails",{sMode:"edit",sUnitGuid:a.oUnit._guid})};var D=function(){var b={GeneralAttributes:{IsDeleted:!0}},c=function(){o.navigateBack({oState:e})};b.Guid=a.oUnit._guid,b.LastModifiedAt=a.oUnit._lastModifiedAt,g.updateUnit({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})};a.onDelete=function(a){f.showConfirmationPopup({sHeader:h.instant("unitDetails_deletionConfirmationHeader"),sContent:h.instant("unitDetails_deletionConfirmationContent"),sOk:h.instant("global_ok"),sCancel:h.instant("global_cancel"),onOk:D,event:a})};var E=function(){for(var b=[],c=[],d="",e=0;e<a.aUnitOptionsArrays.length;e++)a.aUnitOptionsArrays[e].aSelectedOption.length&&(d="UnitOptions('"+a.aUnitOptionsArrays[e].aSelectedOption[0].Guid+"')",c.push(d));c.length&&b.push({sRelationName:"UnitOptionDetails",bKeepCompanyDependentLinks:!0,aUri:c});var c=[];if(a.aSelectedClients&&a.aSelectedClients.length)for(var e=0;e<a.aSelectedClients.length;e++)d="Accounts('"+a.aSelectedClients[e].Guid+"')",c.push(d);return b.push({sRelationName:"AccountDetails",bKeepCompanyDependentLinks:!0,aUri:c}),b};a.onCloseCheckSelectedPhasesLength=function(){0==a.aSelectedPhases.length&&a.onSelectedPhasesModified()},a.onSelectedPhasesModified=function(){a.onDataModified(),a.oForms.unitDetailsForm.selectedPhases.$setDirty()},a.onSelectedClientsModified=function(){a.onDataModified()},a.onDataModified=function(){d.bDataHasBeenModified=!0},a.onSave=function(b,c){if(a.oForms.unitDetailsForm.selectedPhases&&a.oForms.unitDetailsForm.selectedPhases.$setDirty(),a.oForms.unitDetailsForm.unitName&&a.oForms.unitDetailsForm.unitName.$setDirty(),a.oForms.unitDetailsForm.$valid){var f={GeneralAttributes:{}},h=[];f.Guid=a.oUnit._guid;var i=function(f){return d.bDataHasBeenModified=!1,c?void e.go(c.toState,c.toParams):void(b?a.oUnit.aDescriptionTags=[]:(e.go("app.unitDetailsWrapper.unitDetails",{sMode:"display",sUnitGuid:f.Guid}),a.oUnit._lastModifiedAt=f.LastModifiedAt,a.oUnit.sLastModifiedAt=k.dBDateToSting(f.LastModifiedAt),a.oUnit.sCreatedAt=k.dBDateToSting(f.CreatedAt),a.oUnit._guid=f.Guid))},j=function(b){return d.bDataHasBeenModified=!1,c?void e.go(c.toState,c.toParams):(a.oUnit._lastModifiedAt=b.LastModifiedAt,a.oUnit.sLastModifiedAt=k.dBDateToSting(b.LastModifiedAt),void e.go("app.unitDetailsWrapper.unitDetails",{sMode:"display",sUnitGuid:b.Guid}))};switch(f.DescriptionTags=k.tagsArrayToTagsString(a.oUnit.aDescriptionTags),a.aSelectedPhases.length&&(f.PhaseGuid=a.aSelectedPhases[0].Guid),f.Name=a.oUnit.sName,h=E(),f.LastModifiedAt=a.oUnit._lastModifiedAt,d.sMode){case"edit":g.updateUnit({bShowSpinner:!0,sKey:f.Guid,aLinks:h,oData:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:j});break;case"create":d.sFileMetadataSetGuid&&(f.FileMetadataSetGuid=d.sFileMetadataSetGuid),g.createUnit({bShowSpinner:!0,aLinks:h,oData:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:i})}}},a.onBack=function(){o.navigateBack({oState:e})},a.onSaveAndNew=function(){a.onSave(!0)};var F=function(){a.onSave(!1,s)},G=function(){d.bDataHasBeenModified=!1,e.go(s.toState,s.toParams)};a.$on("$stateChangeStart",function(a,b,c,e,g){d.bDataHasBeenModified&&(a.preventDefault(),s={toState:b,toParams:c},f.showConfirmationPopup({sHeader:h.instant("global_changesSaveConfirmationHeader"),sContent:h.instant("global_changesSaveConfirmationContent"),sOk:h.instant("global_yes"),sCancel:h.instant("global_no"),onOk:F,onCancel:G,event:a}))})}]),viewControllers.controller("unitDetailsWrapperView",["$scope","$location","$anchorScroll","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l){a.bDisplayAttachmentsList=!1,a.bDisplayDeficienciesList=!1,a.bDisplayActivitiesList=!1,d.bDataHasBeenModified=!1,a.scrollTo=function(){b.hash(a.sHtmlId),c()},a.onDisplayDeficienciesList=function(){a.bDisplayDeficienciesList===!1?a.bDisplayDeficienciesList=!0:a.bDisplayDeficienciesList=!1},a.onDisplayActivitiesList=function(){a.bDisplayActivitiesList===!1?a.bDisplayActivitiesList=!0:a.bDisplayActivitiesList=!1},a.onDisplayAttachmentsList=function(){a.bDisplayAttachmentsList===!1?a.bDisplayAttachmentsList=!0:a.bDisplayAttachmentsList=!1},a.$on("$destroy",function(){k.getPreviousStateName()!==d.sCurrentStateName&&k.addStateToHistory({sStateName:d.sCurrentStateName,oStateParams:angular.copy(d.oStateParams)})})}]),viewControllers.controller("unitsListView",["$scope","$rootScope","$state","servicesProvider","$translate","apiProvider","cacheProvider","utilsProvider","historyProvider","$mdSidenav","$window","$filter","rolesSettings","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){i.removeHistory(),g.clearOtherViewsScrollPosition("unitsList");var o=g.oUserProfile.sCurrentRole;a.bDisplayAddButton=m.getRolesSettingsForEntityAndOperation({sRole:o,sEntityName:"oUnit",sOperation:"bCreate"}),a.bDisplayEditButtons=m.getRolesSettingsForEntityAndOperation({sRole:o,sEntityName:"oUnit",sOperation:"bUpdate"}),b.sCurrentStateName=c.current.name,b.oStateParams={};var p={aData:[]},q=g.getTableStatusFromCache({sTableName:"unitsList",sStateName:b.sCurrentStateName}),r={sUnitName:"asc"};q&&!angular.equals(q.oSorting,{})&&(r=angular.copy(q.oSorting));var s={};q&&!angular.equals(q.oFilter,{})&&(s=angular.copy(q.oFilter));var t=[];q&&!angular.equals(q.aGroups,[])&&(t=angular.copy(q.aGroups)),a.tableParams=d.createNgTable({oInitialDataArrayWrapper:p,sDisplayedDataArrayName:"aDisplayedUnits",oInitialSorting:r,oInitialFilter:s,aInitialGroupsSettings:t,sGroupBy:"sProjectPhase",sGroupsSortingAttribue:"_sortingSequence"});var u=function(b){for(var c="",d="",f=!1,i=0,j="",k="",l=0,m="",o=[],q=0;q<b.length;q++){if(c="",d="",f=!1,i=0,j="",k="",l=0,o=[],b[q].PhaseDetails){i=b[q].PhaseDetails.GeneralAttributes.SortingSequence;for(var r=0;r<g.oUserProfile.aGloballySelectedPhasesGuids.length;r++)if(b[q].PhaseDetails.Guid===g.oUserProfile.aGloballySelectedPhasesGuids[r]){f=!0;break}if(!f)continue;c="en"===e.use()?b[q].PhaseDetails.ProjectDetails.NameEN:b[q].PhaseDetails.ProjectDetails.NameFR,c||(c=b[q].PhaseDetails.ProjectDetails.NameEN),d="en"===e.use()?b[q].PhaseDetails.NameEN:b[q].PhaseDetails.NameFR,d||(d=b[q].PhaseDetails.NameEN),k=c+" - "+d}else k="Not Assigned";if(b[q].FileMetadataSetDetails&&(b[q].FileMetadataSetDetails.AttachmentsNumber&&(l=b[q].FileMetadataSetDetails.AttachmentsNumber),m=b[q].FileMetadataSetDetails.LastModifiedAt,b[q].FileMetadataSetDetails.FileMetadataDetails))for(var s=0;s<b[q].FileMetadataSetDetails.FileMetadataDetails.results.length;s++)b[q].FileMetadataSetDetails.FileMetadataDetails.results[s].MediaType.indexOf("image")>-1&&b[q].FileMetadataSetDetails.FileMetadataDetails.results[s].GeneralAttributes.IsDeleted===!1&&o.push(b[q].FileMetadataSetDetails.FileMetadataDetails.results[s]);if(b[q].AccountDetails)for(var s=0;s<b[q].AccountDetails.results.length;s++)j=j+b[q].AccountDetails.results[s].Name+"; ";p.aData.push({sUnitName:h.convertStringToInt(b[q].Name),sCleanedUnitName:h.replaceSpecialChars(b[q].Name),_guid:b[q].Guid,sTags:b[q].DescriptionTags,sCleanedTags:h.replaceSpecialChars(b[q].DescriptionTags),sProjectPhase:c+" - "+d,sClients:j,sCleanedClients:h.replaceSpecialChars(j),_sortingSequence:i,_fileMetadataSetGuid:b[q].FileMetadataSetGuid,_fileMetadataSetLastModifiedAt:m,iImagesNumber:l,_aImages:o})}a.tableParams.reload(),n(function(){$(".cnpContentWrapper")[0]&&($(".cnpContentWrapper")[0].scrollTop=g.getListViewScrollPosition("unitsList"),g.putListViewScrollPosition("unitsList",0))},0)},v=function(){p.aData=[];var b="",c=" and (",d=")";if(!(a.globalSelectedPhases.length>0))return p.aData=[],void u([]);b=c;for(var e=0;e<a.globalSelectedPhases.length;e++)b=b+"PhaseGuid eq '"+a.globalSelectedPhases[e]+"'",e<a.globalSelectedPhases.length-1&&(b+=" or ");b+=d,f.getUnits({sExpand:"PhaseDetails/ProjectDetails,UnitOptionDetails,AccountDetails,FileMetadataSetDetails/FileMetadataDetails",sFilter:"CompanyName eq '"+g.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false"+b,bShowSpinner:!0,onSuccess:u})};v(),a.onDisplay=function(a){g.putListViewScrollPosition("unitsList",$(".cnpContentWrapper")[0].scrollTop),b.sFileMetadataSetGuid=a._fileMetadataSetGuid,b.sFileMetadataSetLastModifiedAt=a._fileMetadataSetLastModifiedAt,c.go("app.unitDetailsWrapper.unitDetails",{sMode:"display",sUnitGuid:a._guid})},a.onEdit=function(a){g.putListViewScrollPosition("unitsList",$(".cnpContentWrapper")[0].scrollTop),b.sFileMetadataSetGuid=a._fileMetadataSetGuid,b.sFileMetadataSetLastModifiedAt=a._fileMetadataSetLastModifiedAt,c.go("app.unitDetailsWrapper.unitDetails",{sMode:"edit",sUnitGuid:a._guid})},a.onAddNew=function(){c.go("app.unitDetailsWrapper.unitDetails",{sMode:"create",sUnitGuid:""})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.$on("globalUserPhasesHaveBeenChanged",function(a){g.putListViewScrollPosition("unitsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.$on("accountsShouldBeRefreshed",function(a){g.putListViewScrollPosition("unitsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.onDisplayPhotoGallery=function(a,b){b.stopPropagation(),a._aImages.length&&d.setUpPhotoGallery(a._aImages)},a.$on("$destroy",function(){i.getPreviousStateName()!==b.sCurrentStateName&&(i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams}),g.putTableStatusToCache({sTableName:"unitsList",sStateName:b.sCurrentStateName,aGroups:a.tableParams.settings().$scope.$groups,oFilter:a.tableParams.$params.filter,oSorting:a.tableParams.$params.sorting}))})}]),viewControllers.controller("contractorDetailsView",["$rootScope","$scope","$location","$anchorScroll","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){c.hash("top"),d(),b.oForms={};var q=i.sContractorGuid;b.sAccountType="",b.sMode=i.sMode,a.sCurrentStateName=e.current.name,a.oStateParams=angular.copy(i);var r=j.oUserProfile.sCurrentRole;b.bDisplayEditButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oContractor",sOperation:"bUpdate"}),b.bDisplayDeleteButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oContractor",sOperation:"bDelete"}),b.bShowBackButton=o.aHistoryStates.length>0?!0:!1,"app.contractorDetailsWrapper.contractorDetails"===a.sCurrentStateName&&(b.sAccountType="Contractor"),b.sAccountTypeGuid="";var s=!1,t={};b.oContractor={_aPhases:[]};var u={aData:[{}]},v=[];b.aBillingCountries=[],b.aBillingProvinces=[],b.aShippingCountries=[],b.aShippingProvinces=[];var w=function(a){b.aUserProjectsPhasesForMultiselect=f.constructUserProjectsPhasesForMultiSelect({aSelectedPhases:a})},x=function(a){var c=[];b.oContractor._guid=a.Guid,b.oContractor._lastModifiedAt=a.LastModifiedAt,b.oContractor.sName=a.Name,b.oContractor.sPhone=a.MainPhone,b.oContractor.sPhoneExtension=a.MainPhoneExtension,b.oContractor.sSecondaryPhone=a.SecondaryPhone,b.oContractor.sSecondaryPhoneExtension=a.SecondaryPhoneExtension,b.oContractor.sWebsite=a.Website,b.oContractor.sEmail=a.Email,b.oContractor.sFax=a.Fax,b.oContractor.aTags=k.tagsStringToTagsArray(a.DescriptionTags),a.BillingAddress&&(b.oContractor.sBillingStreet=a.BillingAddress.BillingStreet,b.oContractor.sBillingCity=a.BillingAddress.BillingCity,b.oContractor.sBillingPostalCode=a.BillingAddress.BillingPostalCode,b.oContractor._billingCountryCode=a.BillingAddress.BillingCountry,b.oContractor._billingProvinceCode=a.BillingAddress.BillingProvince),a.ShippingAddress&&(b.oContractor.sShippingStreet=a.ShippingAddress.ShippingStreet,b.oContractor.sShippingCity=a.ShippingAddress.ShippingCity,b.oContractor.sShippingPostalCode=a.ShippingAddress.ShippingPostalCode,b.oContractor._shippingCountryCode=a.ShippingAddress.ShippingCountry,b.oContractor._shippingProvinceCode=a.ShippingAddress.ShippingProvince),b.oContractor.sCreatedAt=k.dBDateToSting(a.CreatedAt),b.oContractor.sLastModifiedAt=k.dBDateToSting(a.LastModifiedAt),a.PhaseDetails&&(b.oContractor._aPhases=angular.copy(a.PhaseDetails.results));for(var d=0;d<b.oContractor._aPhases.length;d++)c.push(b.oContractor._aPhases[d].Guid);w(c),u.aData[0]=angular.copy(b.oContractor)},y=j.getEntityDetails({
sCacheProviderAttribute:"oAccountEntity",sRequestSettings:"CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq falsePhaseDetails/ProjectDetails,AccountTypeDetails",sKeyName:"Guid",sKeyValue:i.sContractorGuid}),z=function(a){var c=a.sParentKey,d="",e="";"billingAddress"===a.sProvincesFor?(d="aBillingProvinces",e="aBillingCountries"):(d="aShippingProvinces",e="aShippingCountries");for(var g=0;g<b[e].length;g++)if(b[e][g].ticked){for(var h=0;h<v.length;h++)if(b[e][g].CountryCode===v[h].CountryCode){f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:v[h].ProvinceDetails.results},oParentArrayWrapper:u,sNameEN:"Name",sNameFR:"Name",sDependentKey:"ProvinceCode",sParentKey:c,sTargetArrayNameInParent:d}),u.aData[0]&&(b[d]=angular.copy(u.aData[0][d]));break}break}},A=function(a){v=angular.copy(a),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:u,sNameEN:"Name",sNameFR:"Name",sDependentKey:"CountryCode",sParentKey:"_billingCountryCode",sTargetArrayNameInParent:"aBillingCountries"}),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:u,sNameEN:"Name",sNameFR:"Name",sDependentKey:"CountryCode",sParentKey:"_shippingCountryCode",sTargetArrayNameInParent:"aShippingCountries"}),u.aData[0]&&(b.aBillingCountries=angular.copy(u.aData[0].aBillingCountries),b.aShippingCountries=angular.copy(u.aData[0].aShippingCountries)),b.oContractor._billingCountryCode&&z({sParentKey:"_billingProvinceCode",sProvincesFor:"billingAddress"}),b.oContractor._shippingCountryCode&&z({sParentKey:"_shippingProvinceCode",sProvincesFor:"shippingAddress"})},B=function(a){x(a),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:A})},C=function(){g.getAccount({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",sKey:q,bShowSpinner:!0,onSuccess:B})},D=function(a){b.sAccountTypeGuid=a[0].Guid};"create"!==b.sMode?angular.equals(y,{})?C():(x(y),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:A})):(w({aSelectedPhases:[]}),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:A}),"Contractor"===b.sAccountType&&g.getContractorAccountType({bShowSpinner:!1,onSuccess:D}),"Client"===b.sAccountType&&g.getClientAccountType({bShowSpinner:!1,onSuccess:D})),b.onEdit=function(){e.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"edit",sContractorGuid:b.oContractor._guid})};var E=function(){var a={GeneralAttributes:{IsDeleted:!0}},c=function(){o.navigateBack({oState:e})};a.Guid=b.oContractor._guid,a.LastModifiedAt=b.oContractor._lastModifiedAt,g.updateAccount({bShowSpinner:!0,sKey:a.Guid,oData:a,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})};b.onDelete=function(a){f.showConfirmationPopup({sHeader:h.instant("contractorDetails_deletionConfirmationHeader"),sContent:h.instant("contractorDetails_deletionConfirmationContent"),sOk:h.instant("global_ok"),sCancel:h.instant("global_cancel"),onOk:E,event:a})};var F=function(){var a=[],c=[],d="";if(b.aSelectedPhases&&b.aSelectedPhases.length)for(var e=0;e<b.aSelectedPhases.length;e++)d="Phases('"+b.aSelectedPhases[e].Guid+"')",c.push(d);return a.push({sRelationName:"PhaseDetails",bKeepCompanyDependentLinks:!0,aUri:c}),a};b.onDataModified=function(){s=!0},b.onBillingCountryChanged=function(){b.onDataModified(),z({sParentKey:"",sProvincesFor:"billingAddress"})},b.onShippingCountryChanged=function(){b.onDataModified(),z({sParentKey:"",sProvincesFor:"shippingAddress"})},b.onBack=function(){o.navigateBack({oState:e})},b.onSave=function(a,c){if(b.oForms.contractorDetailsForm.contractorName&&b.oForms.contractorDetailsForm.contractorName.$setDirty(),b.oForms.contractorDetailsForm.$valid){var d={GeneralAttributes:{}},f=[],h=function(f){return s=!1,c?void e.go(c.toState,c.toParams):void(a?(b.oContractor.sName="",b.oContractor.sPhone="",b.oContractor.sPhoneExtension="",b.oContractor.sSecondaryPhone="",b.oContractor.sSecondaryPhoneExtension="",b.oContractor.sWebsite="",b.oContractor.sEmail="",b.oContractor.sFax="",b.oContractor.aTags=[],b.oContractor.sBillingStreet="",b.oContractor.sBillingCity="",b.oContractor.sBillingPostalCode="",b.oContractor.sShippingStreet="",b.oContractor.sShippingCity="",b.oContractor.sShippingPostalCode="",b.oForms.contractorDetailsForm.contractorName.$setPristine(),d.BillingAddress={},d.ShippingAddress={},b.oContractor._aPhases=[]):(b.oContractor._lastModifiedAt=f.LastModifiedAt,b.oContractor.sLastModifiedAt=k.dBDateToSting(f.LastModifiedAt),b.oContractor.sCreatedAt=k.dBDateToSting(f.CreatedAt),b.oContractor._guid=f.Guid,e.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"display",sContractorGuid:f.Guid})))},i=function(a){return s=!1,b.oContractor._lastModifiedAt=a.LastModifiedAt,b.oContractor.sLastModifiedAt=k.dBDateToSting(a.LastModifiedAt),c?void e.go(c.toState,c.toParams):void e.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"display",sContractorGuid:a.Guid})};d.Guid=b.oContractor._guid,d.Name=b.oContractor.sName,b.oContractor.sPhone?d.MainPhone=b.oContractor.sPhone.replace(/\D/g,""):d.MainPhone="",b.oContractor.sSecondaryPhone?d.SecondaryPhone=b.oContractor.sSecondaryPhone.replace(/\D/g,""):d.SecondaryPhone="",b.oContractor.sFax?d.Fax=b.oContractor.sFax.replace(/\D/g,""):d.Fax="",d.Website=b.oContractor.sWebsite,d.Email=b.oContractor.sEmail,d.MainPhoneExtension=b.oContractor.sPhoneExtension,d.SecondaryPhoneExtension=b.oContractor.sSecondaryPhoneExtension,d.DescriptionTags=k.tagsArrayToTagsString(b.oContractor.aTags),d.BillingAddress={},d.BillingAddress.BillingStreet=b.oContractor.sBillingStreet,d.BillingAddress.BillingCity=b.oContractor.sBillingCity,d.BillingAddress.BillingPostalCode=b.oContractor.sBillingPostalCode,d.ShippingAddress={},d.ShippingAddress.ShippingStreet=b.oContractor.sShippingStreet,d.ShippingAddress.ShippingCity=b.oContractor.sShippingCity,d.ShippingAddress.ShippingPostalCode=b.oContractor.sShippingPostalCode;for(var j=0;j<b.aBillingCountries.length;j++)if(b.aBillingCountries[j].ticked){d.BillingAddress.BillingCountry=b.aBillingCountries[j].CountryCode;break}for(var j=0;j<b.aBillingProvinces.length;j++)if(b.aBillingProvinces[j].ticked){d.BillingAddress.BillingProvince=b.aBillingProvinces[j].ProvinceCode;break}for(var j=0;j<b.aShippingCountries.length;j++)if(b.aShippingCountries[j].ticked){d.ShippingAddress.ShippingCountry=b.aShippingCountries[j].CountryCode;break}for(var j=0;j<b.aShippingProvinces.length;j++)if(b.aShippingProvinces[j].ticked){d.ShippingAddress.ShippingProvince=b.aShippingProvinces[j].ProvinceCode;break}switch(d.LastModifiedAt=b.oContractor._lastModifiedAt,f=F(),b.sMode){case"edit":g.updateAccount({bShowSpinner:!0,sKey:d.Guid,oData:d,aLinks:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:i});break;case"create":d.AccountTypeGuid=b.sAccountTypeGuid,g.createAccount({bShowSpinner:!0,oData:d,aLinks:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:h})}}},b.onSaveAndNew=function(){b.onSave(!0)};var G=function(){b.onSave(!1,t)},H=function(){s=!1,e.go(t.toState,t.toParams)};b.$on("$stateChangeStart",function(a,b,c,d,e){s&&(a.preventDefault(),t={toState:b,toParams:c},f.showConfirmationPopup({sHeader:h.instant("global_changesSaveConfirmationHeader"),sContent:h.instant("global_changesSaveConfirmationContent"),sOk:h.instant("global_yes"),sCancel:h.instant("global_no"),onOk:G,onCancel:H,event:a}))}),b.$on("$destroy",function(){a.aAccountPhasesGuids=[];for(var c=0;c<b.aSelectedPhases.length;c++)a.aAccountPhasesGuids.push(b.aSelectedPhases[c].Guid)})}]),viewControllers.controller("contractorDetailsWrapperView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i){a.bDisplayContactsList=!1,a.bDisplayDeficienciesList=!1,a.bDisplayActivitiesList=!1,a.onDisplayDeficienciesList=function(){a.bDisplayDeficienciesList===!1?a.bDisplayDeficienciesList=!0:a.bDisplayDeficienciesList=!1},a.onDisplayContactsList=function(){a.bDisplayContactsList===!1?a.bDisplayContactsList=!0:a.bDisplayContactsList=!1},a.onDisplayActivitiesList=function(){a.bDisplayActivitiesList===!1?a.bDisplayActivitiesList=!0:a.bDisplayActivitiesList=!1},a.$on("$destroy",function(){i.getPreviousStateName()!==b.sCurrentStateName&&i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("contractorsListView",["$scope","$rootScope","$state","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider","$mdSidenav","$window","$filter","rolesSettings","utilsProvider","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){h.removeHistory(),g.clearOtherViewsScrollPosition("contractorsList");var o=g.oUserProfile.sCurrentRole;a.bDisplayAddButton=l.getRolesSettingsForEntityAndOperation({sRole:o,sEntityName:"oContractor",sOperation:"bCreate"}),a.bDisplayEditButtons=l.getRolesSettingsForEntityAndOperation({sRole:o,sEntityName:"oContractor",sOperation:"bUpdate"}),b.sCurrentStateName=c.current.name,b.oStateParams={};var p={aData:[]},q=g.getTableStatusFromCache({sTableName:"contractorsList",sStateName:b.sCurrentStateName}),r={sContractorName:"asc"};a.oListSettings={bGroupListByProjectAndPhase:q.oListSettings.bGroupListByProjectAndPhase},q&&!angular.equals(q.oSorting,{})&&(r=angular.copy(q.oSorting));var s={};q&&!angular.equals(q.oFilter,{})&&(s=angular.copy(q.oFilter));var t=[];q&&!angular.equals(q.aGroups,[])&&(t=angular.copy(q.aGroups)),a.tableParams=d.createNgTable({oInitialDataArrayWrapper:p,sDisplayedDataArrayName:"aDisplayedContractors",oInitialSorting:r,oInitialFilter:s,aInitialGroupsSettings:t,sGroupBy:"sProjectPhase",sGroupsSortingAttribue:"_sortingSequence"});var u=function(b){var c="",d="",f=!1;if(a.oListSettings.bGroupListByProjectAndPhase){for(var h=0;h<b.length;h++)if(b[h].PhaseDetails.results.length){for(var i=0;i<b[h].PhaseDetails.results.length;i++)b[h].PhaseDetails.results[i]._sortingSequence=b[h].PhaseDetails.results[i].GeneralAttributes.SortingSequence;b[h].PhaseDetails.results=k("orderBy")(b[h].PhaseDetails.results,["_sortingSequence"]);for(var i=0;i<b[h].PhaseDetails.results.length;i++){f=!1;for(var j=0;j<g.oUserProfile.aGloballySelectedPhasesGuids.length;j++)if(b[h].PhaseDetails.results[i].Guid===g.oUserProfile.aGloballySelectedPhasesGuids[j]){f=!0;break}f&&(c="en"===e.use()?b[h].PhaseDetails.results[i].ProjectDetails.NameEN:b[h].PhaseDetails.results[i].ProjectDetails.NameFR,c||(c=b[h].PhaseDetails.results[i].ProjectDetails.NameEN),d="en"===e.use()?b[h].PhaseDetails.results[i].NameEN:b[h].PhaseDetails.results[i].NameFR,d||(d=b[h].PhaseDetails.results[i].NameEN),p.aData.push({sContractorName:b[h].Name,sCleanedContractorName:m.replaceSpecialChars(b[h].Name),sPhone:b[h].MainPhone,sEmail:b[h].Email,_guid:b[h].Guid,sTags:b[h].DescriptionTags,sProjectPhase:c+" - "+d,_sortingSequence:b[h].PhaseDetails.results[i]._sortingSequence}))}}}else for(var h=0;h<b.length;h++)p.aData.push({sContractorName:b[h].Name,sCleanedContractorName:m.replaceSpecialChars(b[h].Name),sPhone:b[h].MainPhone,sEmail:b[h].Email,_guid:b[h].Guid,sTags:b[h].DescriptionTags,sProjectPhase:e.instant("contractorsList_groupAll"),_sortingSequence:-1});a.tableParams.reload(),n(function(){$(".cnpContentWrapper")[0]&&($(".cnpContentWrapper")[0].scrollTop=g.getListViewScrollPosition("contractorsList"),g.putListViewScrollPosition("contractorsList",0))},0)},v=function(){return p.aData=[],a.globalSelectedPhases.length>0?void f.getContractors({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",bShowSpinner:!0,onSuccess:u}):(p.aData=[],void u([]))};v(),a.onDisplay=function(a){g.putListViewScrollPosition("contractorsList",$(".cnpContentWrapper")[0].scrollTop),c.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"display",sContractorGuid:a._guid})},a.onGroupingChange=function(){v()},a.onEdit=function(a){g.putListViewScrollPosition("contractorsList",$(".cnpContentWrapper")[0].scrollTop),c.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"edit",sContractorGuid:a._guid})},a.onAddNew=function(){c.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"create",sContractorGuid:""})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.onGenerateReport=function(){f.generateReport({})},a.$on("globalUserPhasesHaveBeenChanged",function(a){g.putListViewScrollPosition("contractorsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.$on("accountsShouldBeRefreshed",function(a){g.putListViewScrollPosition("contractorsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.$on("$destroy",function(){h.getPreviousStateName()!==b.sCurrentStateName&&(h.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams}),g.putTableStatusToCache({sTableName:"contractorsList",sStateName:b.sCurrentStateName,aGroups:a.tableParams.settings().$scope.$groups,oFilter:a.tableParams.$params.filter,oSorting:a.tableParams.$params.sorting,oListSettings:a.oListSettings}))})}]),viewControllers.controller("contactDetailsView",["$rootScope","$scope","$location","$anchorScroll","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){c.hash("top"),d(),b.bShowParentAccountAndContactType=!0,b.bShowDescriptionTags=!0,b.bIsChangePhasesAssignmentAllowed=!0,b.oForms={};var q=i.sAccountGuid,r=i.sContactGuid;b.sMode=i.sMode,a.sCurrentStateName=e.current.name,a.oStateParams=angular.copy(i);var s=j.oUserProfile.sCurrentRole;b.bDisplayEditButton=p.getRolesSettingsForEntityAndOperation({sRole:s,sEntityName:"oContact",sOperation:"bUpdate"}),b.bDisplayDeleteButton=p.getRolesSettingsForEntityAndOperation({sRole:s,sEntityName:"oContact",sOperation:"bDelete"}),b.bShowBackButton=o.aHistoryStates.length>0?!0:!1,"app.contactDetailsWrapper.contactDetails"===a.sCurrentStateName,"app.profileSettings.contactDetails"===a.sCurrentStateName&&(b.bDisplayDeleteButton=!1,b.bShowParentAccountAndContactType=!1,b.bShowDescriptionTags=!1,b.bIsChangePhasesAssignmentAllowed=!1);var t=!1,u={};b.oContact={_aPhases:[]};var v={aData:[{_accountGuid:q}]};b.aContactTypes=[];var w=[];b.aBillingCountries=[],b.aBillingProvinces=[],b.aShippingCountries=[],b.aShippingProvinces=[];var x=function(a){b.aUserProjectsPhasesForMultiselect=f.constructUserProjectsPhasesForMultiSelect({aSelectedPhases:a})},y=function(a){var c=[];b.oContact._guid=a.Guid,b.oContact._accountGuid=a.AccountGuid,b.oContact._lastModifiedAt=a.LastModifiedAt,b.oContact.sFirstName=a.FirstName,b.oContact.sLastName=a.LastName,b.oContact.sEmail=a.Email,b.oContact.sHomePhone=a.HomePhone,b.oContact.sHomePhoneExtension=a.HomePhoneExtension,b.oContact.sWorkPhone=a.WorkPhone,b.oContact.sWorkPhoneExtension=a.WorkPhoneExtension,b.oContact.sMobilePhone=a.MobilePhone,b.oContact.sFax=a.Fax,b.oContact.sTitle=a.Title,b.oContact.aTags=k.tagsStringToTagsArray(a.DescriptionTags),b.oContact._contactTypeGuid=a.ContactTypeGuid,a.BillingAddress&&(b.oContact.sBillingStreet=a.BillingAddress.BillingStreet,b.oContact.sBillingCity=a.BillingAddress.BillingCity,b.oContact.sBillingPostalCode=a.BillingAddress.BillingPostalCode,b.oContact._billingCountryCode=a.BillingAddress.BillingCountry,b.oContact._billingProvinceCode=a.BillingAddress.BillingProvince),a.ShippingAddress&&(b.oContact.sShippingStreet=a.ShippingAddress.ShippingStreet,b.oContact.sShippingCity=a.ShippingAddress.ShippingCity,b.oContact.sShippingPostalCode=a.ShippingAddress.ShippingPostalCode,b.oContact._shippingCountryCode=a.ShippingAddress.ShippingCountry,b.oContact._shippingProvinceCode=a.ShippingAddress.ShippingProvince),a.AccountDetails&&a.AccountDetails.AccountTypeDetails&&(b.oContact._sAccountName=a.AccountDetails.Name,b.oContact._accountTypeName=a.AccountDetails.AccountTypeDetails.NameEN),a.ContactTypeDetails&&(b.oContact._sContactType="en"===h.use()?a.ContactTypeDetails.NameEN:a.ContactTypeDetails.NameFR,b.oContact._sContactType||(b.oContact._sContactType=a.ContactTypeDetails.NameEN)),b.oContact.sCreatedAt=k.dBDateToSting(a.CreatedAt),b.oContact.sLastModifiedAt=k.dBDateToSting(a.LastModifiedAt),b.oContact._aPhases=angular.copy(a.PhaseDetails.results);for(var d=0;d<b.oContact._aPhases.length;d++)c.push(b.oContact._aPhases[d].Guid);x(c),v.aData[0]=angular.copy(b.oContact)},z="";z="app.contactsList"===o.getPreviousStateName()?"CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false":"CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and AccountGuid eq '"+q+"'",z+="UserDetails,ContactTypeDetails,AccountDetails/AccountTypeDetails,PhaseDetails/ProjectDetails";var A=j.getEntityDetails({sCacheProviderAttribute:"oContactEntity",sRequestSettings:z,sKeyName:"Guid",sKeyValue:r}),B=function(a){var c=a.sParentKey,d="",e="";"billingAddress"===a.sProvincesFor?(d="aBillingProvinces",e="aBillingCountries"):(d="aShippingProvinces",e="aShippingCountries");for(var g=0;g<b[e].length;g++)if(b[e][g].ticked){for(var h=0;h<w.length;h++)if(b[e][g].CountryCode===w[h].CountryCode){f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:w[h].ProvinceDetails.results},oParentArrayWrapper:v,sNameEN:"Name",sNameFR:"Name",sDependentKey:"ProvinceCode",sParentKey:c,sTargetArrayNameInParent:d}),v.aData[0]&&(b[d]=angular.copy(v.aData[0][d]));break}break}},C=function(a){w=angular.copy(a),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:v,sNameEN:"Name",sNameFR:"Name",sDependentKey:"CountryCode",sParentKey:"_billingCountryCode",sTargetArrayNameInParent:"aBillingCountries"}),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:v,sNameEN:"Name",sNameFR:"Name",sDependentKey:"CountryCode",sParentKey:"_shippingCountryCode",sTargetArrayNameInParent:"aShippingCountries"}),v.aData[0]&&(b.aBillingCountries=angular.copy(v.aData[0].aBillingCountries),b.aShippingCountries=angular.copy(v.aData[0].aShippingCountries)),b.oContact._billingCountryCode&&B({sParentKey:"_billingProvinceCode",sProvincesFor:"billingAddress"}),b.oContact._shippingCountryCode&&B({sParentKey:"_shippingProvinceCode",sProvincesFor:"shippingAddress"})},D=function(a){for(var c=0;c<a.length;c++)a[c]._sortingSequence=a[c].GeneralAttributes.SortingSequence;a=l("orderBy")(a,["_sortingSequence"]),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:v,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_contactTypeGuid",sTargetArrayNameInParent:"aContactTypes"}),v.aData[0]&&(b.aContactTypes=angular.copy(v.aData[0].aContactTypes))},E=function(a){y(a),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:C}),g.getContactTypes({bShowSpinner:!1,onSuccess:D}),g.getAccountTypesWithAccounts({bShowSpinner:!1,onSuccess:G})},F=function(){g.getContact({sKey:r,bShowSpinner:!0,onSuccess:E})},G=function(a){for(var c=0;c<a.length;c++)a[c]._sortingSequence=a[c].GeneralAttributes.SortingSequence,a[c].AccountDetails.results=l("orderBy")(a[c].AccountDetails.results,["Name"]);a=l("orderBy")(a,["_sortingSequence"]),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},sSecondLevelAttribute:"AccountDetails",sSecondLevelNameEN:"Name",sSecondLevelNameFR:"Name",oParentArrayWrapper:v,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_accountGuid",sTargetArrayNameInParent:"aAccounts"}),v.aData[0]&&(b.aAccounts=angular.copy(v.aData[0].aAccounts))};if("create"!==b.sMode)angular.equals(A,{})?F():(y(A),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:C}),g.getContactTypes({bShowSpinner:!1,onSuccess:D}),g.getAccountTypesWithAccounts({bShowSpinner:!1,onSuccess:G}));else{var H=[];("app.contractorDetailsWrapper.contractorDetails"===o.getPreviousStateName()||"app.clientDetailsWrapper.clientDetails"===o.getPreviousStateName())&&(H=angular.copy(a.aAccountPhasesGuids)),x(H),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:C}),g.getContactTypes({bShowSpinner:!1,onSuccess:D}),g.getAccountTypesWithAccounts({bShowSpinner:!1,onSuccess:G})}b.onEdit=function(){"app.contactDetailsWrapper.contactDetails"===a.sCurrentStateName?e.go("app.contactDetailsWrapper.contactDetails",{sMode:"edit",sAccountGuid:q,sContactGuid:b.oContact._guid}):e.go("app.profileSettings.contactDetails",{sMode:"edit",sAccountGuid:q,sContactGuid:b.oContact._guid})};var I=function(){var a={GeneralAttributes:{IsDeleted:!0}},c=function(){o.navigateBack({oState:e})};a.Guid=b.oContact._guid,a.LastModifiedAt=b.oContact._lastModifiedAt,g.updateContact({bShowSpinner:!0,sKey:a.Guid,oData:a,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})};b.onDelete=function(a){f.showConfirmationPopup({sHeader:h.instant("contactDetails_deletionConfirmationHeader"),sContent:h.instant("contactDetails_deletionConfirmationContent"),sOk:h.instant("global_ok"),sCancel:h.instant("global_cancel"),onOk:I,event:a})};var J=function(){var a=[],c=[],d="";if(b.aSelectedPhases&&b.aSelectedPhases.length)for(var e=0;e<b.aSelectedPhases.length;e++)d="Phases('"+b.aSelectedPhases[e].Guid+"')",c.push(d);return a.push({sRelationName:"PhaseDetails",bKeepCompanyDependentLinks:!0,aUri:c}),a};b.onParentAccountModified=function(){b.onDataModified(),b.oForms.contactDetailsForm.selectedParentAccount.$setDirty()},b.onDataModified=function(){t=!0},b.onBillingCountryChanged=function(){b.onDataModified(),B({sParentKey:"",sProvincesFor:"billingAddress"})},b.onShippingCountryChanged=function(){b.onDataModified(),B({sParentKey:"",sProvincesFor:"shippingAddress"})},b.onSave=function(c,d){b.oForms.contactDetailsForm.selectedParentAccount&&b.oForms.contactDetailsForm.selectedParentAccount.$setDirty(),b.oForms.contactDetailsForm.firstName&&b.oForms.contactDetailsForm.firstName.$setDirty(),aLinks=J();var f={GeneralAttributes:{}};f.Guid=b.oContact._guid;for(var h=0;h<b.aAccounts.length;h++)if(b.aAccounts[h].ticked&&void 0===b.aAccounts[h].multiSelectGroup){f.AccountGuid=b.aAccounts[h].Guid;break}if(b.oForms.contactDetailsForm.$valid){for(var i=function(g){return t=!1,d?void e.go(d.toState,d.toParams):void(c?(b.oContact.sFirstName="",b.oContact.sLastName="",b.oContact.sEmail="",b.oContact.sHomePhone="",b.oContact.sHomePhoneExtension="",b.oContact.sWorkPhone="",b.oContact.sWorkPhoneExtension="",b.oContact.sMobilePhone="",b.oContact.sFax="",b.oContact.sTitle="",b.oContact.aTags=[],b.oContact.sBillingStreet="",b.oContact.sBillingCity="",b.oContact.sBillingPostalCode="",b.oContact.sShippingStreet="",b.oContact.sShippingCity="",b.oContact.sShippingPostalCode="",b.oForms.contactDetailsForm.lastName.$setPristine(),b.oForms.contactDetailsForm.firstName.$setPristine(),f.BillingAddress={},f.ShippingAddress={}):("app.contactDetailsWrapper.contactDetails"===a.sCurrentStateName?e.go("app.contactDetailsWrapper.contactDetails",{sMode:"display",sAccountGuid:q,sContactGuid:g.Guid}):e.go("app.profileSettings.contactDetails",{sMode:"display",sAccountGuid:q,sContactGuid:g.Guid}),b.oContact._lastModifiedAt=g.LastModifiedAt,b.oContact.sLastModifiedAt=k.dBDateToSting(g.LastModifiedAt),b.oContact.sCreatedAt=k.dBDateToSting(g.CreatedAt),b.oContact._guid=g.Guid))},j=function(c){return t=!1,d?void e.go(d.toState,d.toParams):(b.oContact._lastModifiedAt=c.LastModifiedAt,b.oContact.sLastModifiedAt=k.dBDateToSting(c.LastModifiedAt),void("app.contactDetailsWrapper.contactDetails"===a.sCurrentStateName?e.go("app.contactDetailsWrapper.contactDetails",{sMode:"display",sAccountGuid:q,sContactGuid:c.Guid}):e.go("app.profileSettings.contactDetails",{sMode:"display",sAccountGuid:q,sContactGuid:c.Guid})))},h=0;h<b.aContactTypes.length;h++)if(b.aContactTypes[h].ticked){f.ContactTypeGuid=b.aContactTypes[h].Guid;break}f.FirstName=b.oContact.sFirstName,f.LastName=b.oContact.sLastName,b.oContact.sHomePhone?f.HomePhone=b.oContact.sHomePhone.replace(/\D/g,""):f.HomePhone="",b.oContact.sWorkPhone?f.WorkPhone=b.oContact.sWorkPhone.replace(/\D/g,""):f.WorkPhone="",b.oContact.sMobilePhone?f.MobilePhone=b.oContact.sMobilePhone.replace(/\D/g,""):f.MobilePhone="",f.Email=b.oContact.sEmail,f.Fax=b.oContact.sFax,f.Title=b.oContact.sTitle,f.HomePhoneExtension=b.oContact.sHomePhoneExtension,f.WorkPhoneExtension=b.oContact.sWorkPhoneExtension,f.DescriptionTags=k.tagsArrayToTagsString(b.oContact.aTags),f.BillingAddress={},f.BillingAddress.BillingStreet=b.oContact.sBillingStreet,f.BillingAddress.BillingCity=b.oContact.sBillingCity,f.BillingAddress.BillingPostalCode=b.oContact.sBillingPostalCode,f.ShippingAddress={},f.ShippingAddress.ShippingStreet=b.oContact.sShippingStreet,f.ShippingAddress.ShippingCity=b.oContact.sShippingCity,f.ShippingAddress.ShippingPostalCode=b.oContact.sShippingPostalCode;for(var h=0;h<b.aBillingCountries.length;h++)if(b.aBillingCountries[h].ticked){f.BillingAddress.BillingCountry=b.aBillingCountries[h].CountryCode;break}for(var h=0;h<b.aBillingProvinces.length;h++)if(b.aBillingProvinces[h].ticked){f.BillingAddress.BillingProvince=b.aBillingProvinces[h].ProvinceCode;break}for(var h=0;h<b.aShippingCountries.length;h++)if(b.aShippingCountries[h].ticked){f.ShippingAddress.ShippingCountry=b.aShippingCountries[h].CountryCode;break}for(var h=0;h<b.aShippingProvinces.length;h++)if(b.aShippingProvinces[h].ticked){f.ShippingAddress.ShippingProvince=b.aShippingProvinces[h].ProvinceCode;break}switch(f.LastModifiedAt=b.oContact._lastModifiedAt,b.sMode){case"edit":g.updateContact({bShowSpinner:!0,sKey:f.Guid,aLinks:aLinks,oData:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:j});break;case"create":g.createContact({bShowSpinner:!0,aLinks:aLinks,oData:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:i})}}},b.onBack=function(){o.navigateBack({oState:e})},b.onNavigateToAccountDetails=function(){var a=b.oContact._accountTypeName;switch(a){case"Contractor":e.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"display",sContractorGuid:b.oContact._accountGuid});break;case"Client":e.go("app.clientDetailsWrapper.clientDetails",{sMode:"display",sClientGuid:b.oContact._accountGuid})}},b.onSaveAndNew=function(){b.onSave(!0)};var K=function(){b.onSave(!1,u)},L=function(){t=!1,e.go(u.toState,u.toParams)};b.$on("$stateChangeStart",function(a,b,c,d,e){t&&(a.preventDefault(),u={toState:b,toParams:c},f.showConfirmationPopup({sHeader:h.instant("global_changesSaveConfirmationHeader"),sContent:h.instant("global_changesSaveConfirmationContent"),sOk:h.instant("global_yes"),sCancel:h.instant("global_no"),onOk:K,onCancel:L,event:a}))})}]),viewControllers.controller("contactDetailsWrapperView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i){a.bDisplayActivitiesList=!1,a.onDisplayActivitiesList=function(){a.bDisplayActivitiesList===!1?a.bDisplayActivitiesList=!0:a.bDisplayActivitiesList=!1},a.$on("$destroy",function(){i.getPreviousStateName()!==b.sCurrentStateName&&i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("contactsListView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider","$filter","rolesSettings","utilsProvider","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m){"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&"app.clientDetailsWrapper.clientDetails"!==b.sCurrentStateName&&(i.removeHistory(),h.clearOtherViewsScrollPosition("contactsList"));var n=h.oUserProfile.sCurrentRole;a.bDisplayAddButton=k.getRolesSettingsForEntityAndOperation({sRole:n,sEntityName:"oContact",sOperation:"bCreate"}),a.bDisplayEditButtons=k.getRolesSettingsForEntityAndOperation({sRole:n,sEntityName:"oContact",sOperation:"bUpdate"}),a.bDisplayAccountColumn="app.contactsList"===c.current.name?!0:!1,b.sCurrentStateName=c.current.name,b.oStateParams=angular.copy(d);var o="";d.sContractorGuid&&(o=d.sContractorGuid),d.sClientGuid&&(o=d.sClientGuid);var p={aData:[]},q=h.getTableStatusFromCache({sTableName:"contactsList",sStateName:b.sCurrentStateName});"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&"app.clientDetailsWrapper.clientDetails"!==b.sCurrentStateName?a.oListSettings={bGroupListByProjectAndPhase:q.oListSettings.bGroupListByProjectAndPhase}:a.oListSettings={bGroupListByProjectAndPhase:!1};var r={sName:"asc"};q&&!angular.equals(q.oSorting,{})&&(r=angular.copy(q.oSorting));var s={};q&&!angular.equals(q.oFilter,{})&&(s=angular.copy(q.oFilter));var t=[];q&&!angular.equals(q.aGroups,[])&&(t=angular.copy(q.aGroups)),a.tableParams=e.createNgTable({oInitialDataArrayWrapper:p,sDisplayedDataArrayName:"aDisplayedContacts",oInitialSorting:r,oInitialFilter:s,aInitialGroupsSettings:t,sGroupBy:"sProjectPhase",sGroupsSortingAttribue:"_sortingSequence"});var u=function(c){var d="",e="",g="",i=!1;if(a.oListSettings.bGroupListByProjectAndPhase)for(var k=0;k<c.length;k++){for(var n=0;n<c[k].PhaseDetails.results.length;n++)c[k].PhaseDetails.results[n]._sortingSequence=c[k].PhaseDetails.results[n].GeneralAttributes.SortingSequence;if(c[k].PhaseDetails.results=j("orderBy")(c[k].PhaseDetails.results,["_sortingSequence"]),d="",c[k].FirstName&&(d=c[k].FirstName),c[k].LastName&&(c[k].FirstName&&(d+=" "),d+=c[k].LastName),c[k].PhaseDetails.results.length)for(var n=0;n<c[k].PhaseDetails.results.length;n++){i=!1;for(var o=0;o<h.oUserProfile.aGloballySelectedPhasesGuids.length;o++)if(c[k].PhaseDetails.results[n].Guid===h.oUserProfile.aGloballySelectedPhasesGuids[o]){i=!0;break}i&&(e="en"===f.use()?c[k].PhaseDetails.results[n].ProjectDetails.NameEN:c[k].PhaseDetails.results[n].ProjectDetails.NameFR,e||(e=c[k].PhaseDetails.results[n].ProjectDetails.NameEN),g="en"===f.use()?c[k].PhaseDetails.results[n].NameEN:c[k].PhaseDetails.results[n].NameFR,g||(g=c[k].PhaseDetails.results[n].NameEN),p.aData.push({sName:d,sCleanedName:l.replaceSpecialChars(d),sTitle:c[k].Title,sPhone:c[k].MobilePhone,sEmail:c[k].Email,_guid:c[k].Guid,sProjectPhase:e+" - "+g,_accountGuid:c[k].AccountGuid,_accountTypeName:c[k].AccountDetails.AccountTypeDetails.NameEN,sAccountName:c[k].AccountDetails.Name,sCleanedAccountName:l.replaceSpecialChars(c[k].AccountDetails.Name),_sortingSequence:c[k].PhaseDetails.results[n]._sortingSequence}))}}else for(var k=0;k<c.length;k++)d="",c[k].FirstName&&(d=c[k].FirstName),c[k].LastName&&(c[k].FirstName&&(d+=" "),d+=c[k].LastName),p.aData.push({sName:d,sCleanedName:l.replaceSpecialChars(d),sTitle:c[k].Title,sPhone:c[k].MobilePhone,sEmail:c[k].Email,_guid:c[k].Guid,sProjectPhase:f.instant("contactsList_groupAll"),_accountGuid:c[k].AccountGuid,_accountTypeName:c[k].AccountDetails.AccountTypeDetails.NameEN,sAccountName:c[k].AccountDetails.Name,sCleanedAccountName:l.replaceSpecialChars(c[k].AccountDetails.Name),_sortingSequence:-1});a.tableParams.reload(),"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&"app.clientDetailsWrapper.clientDetails"!==b.sCurrentStateName&&m(function(){$(".cnpContentWrapper")[0]&&($(".cnpContentWrapper")[0].scrollTop=h.getListViewScrollPosition("contactsList"),h.putListViewScrollPosition("contactsList",0))},0)},v=function(){if(o)p.aData=[],g.getContactsForAccount({bShowSpinner:!0,onSuccess:u,sAccountGuid:o});else{if(!(a.globalSelectedPhases.length>0))return p.aData=[],void u([]);p.aData=[],g.getContacts({sExpand:"UserDetails,AccountDetails/AccountTypeDetails,PhaseDetails/ProjectDetails",bShowSpinner:!0,onSuccess:u})}};v(),a.onDisplay=function(a){h.putListViewScrollPosition("contactsList",$(".cnpContentWrapper")[0].scrollTop),o||(o=a._accountGuid),c.go("app.contactDetailsWrapper.contactDetails",{sMode:"display",sAccountGuid:o,sContactGuid:a._guid})},a.onGroupingChange=function(){v()},a.onEdit=function(a){h.putListViewScrollPosition("contactsList",$(".cnpContentWrapper")[0].scrollTop),o||(o=a._accountGuid),c.go("app.contactDetailsWrapper.contactDetails",{sMode:"edit",sAccountGuid:o,sContactGuid:a._guid})},a.onAddNew=function(){c.go("app.contactDetailsWrapper.contactDetails",{
sMode:"create",sAccountGuid:o,sContactGuid:""})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.onNavigateToAccountDetails=function(a){var b=a._accountGuid,d=a._accountTypeName;switch(d){case"Contractor":c.go("app.contractorDetailsWrapper.contractorDetails",{sMode:"display",sContractorGuid:b});break;case"Client":c.go("app.clientDetailsWrapper.clientDetails",{sMode:"display",sClientGuid:b})}},a.$on("globalUserPhasesHaveBeenChanged",function(a){h.putListViewScrollPosition("contactsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.$on("contactsShouldBeRefreshed",function(a){h.putListViewScrollPosition("contactsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.$on("$destroy",function(){if("app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&"app.clientDetailsWrapper.clientDetails"!==b.sCurrentStateName){if(i.getPreviousStateName()===b.sCurrentStateName)return;i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams})}h.putTableStatusToCache({sTableName:"contactsList",sStateName:b.sCurrentStateName,aGroups:a.tableParams.settings().$scope.$groups,oFilter:a.tableParams.$params.filter,oSorting:a.tableParams.$params.sorting,oListSettings:a.oListSettings})})}]),viewControllers.controller("clientDetailsView",["$rootScope","$scope","$location","$anchorScroll","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){c.hash("top"),d(),b.oForms={};var q=i.sClientGuid;b.sMode=i.sMode,a.sCurrentStateName=e.current.name,a.oStateParams=angular.copy(i);var r=j.oUserProfile.sCurrentRole;b.bDisplayEditButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oClient",sOperation:"bUpdate"}),b.bDisplayDeleteButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oClient",sOperation:"bDelete"}),b.sAccountType="",b.bShowBackButton=o.aHistoryStates.length>0?!0:!1,"app.clientDetailsWrapper.clientDetails"===a.sCurrentStateName&&(b.sAccountType="Client"),b.sAccountTypeGuid="";var s=!1,t={};b.oClient={_aPhases:[],bIsProspect:!0};var u={aData:[{}]},v=[];b.aBillingCountries=[],b.aBillingProvinces=[],b.aShippingCountries=[],b.aShippingProvinces=[];var w=function(a){b.aUserProjectsPhasesForMultiselect=f.constructUserProjectsPhasesForMultiSelect({aSelectedPhases:a})},x=function(a){var c=[];b.oClient._guid=a.Guid,b.oClient._lastModifiedAt=a.LastModifiedAt,b.oClient.sName=a.Name,b.oClient.sPhone=a.MainPhone,b.oClient.sPhoneExtension=a.MainPhoneExtension,b.oClient.sSecondaryPhone=a.SecondaryPhone,b.oClient.sSecondaryPhoneExtension=a.SecondaryPhoneExtension,b.oClient.sWebsite=a.Website,b.oClient.sEmail=a.Email,b.oClient.sFax=a.Fax,b.oClient.bIsProspect=a.IsProspect,b.oClient.aTags=k.tagsStringToTagsArray(a.DescriptionTags),a.BillingAddress&&(b.oClient.sBillingStreet=a.BillingAddress.BillingStreet,b.oClient.sBillingCity=a.BillingAddress.BillingCity,b.oClient.sBillingPostalCode=a.BillingAddress.BillingPostalCode,b.oClient._billingCountryCode=a.BillingAddress.BillingCountry,b.oClient._billingProvinceCode=a.BillingAddress.BillingProvince),a.ShippingAddress&&(b.oClient.sShippingStreet=a.ShippingAddress.ShippingStreet,b.oClient.sShippingCity=a.ShippingAddress.ShippingCity,b.oClient.sShippingPostalCode=a.ShippingAddress.ShippingPostalCode,b.oClient._shippingCountryCode=a.ShippingAddress.ShippingCountry,b.oClient._shippingProvinceCode=a.ShippingAddress.ShippingProvince),b.oClient.sCreatedAt=k.dBDateToSting(a.CreatedAt),b.oClient.sLastModifiedAt=k.dBDateToSting(a.LastModifiedAt),a.PhaseDetails&&(b.oClient._aPhases=angular.copy(a.PhaseDetails.results));for(var d=0;d<b.oClient._aPhases.length;d++)c.push(b.oClient._aPhases[d].Guid);w(c),u.aData[0]=angular.copy(b.oClient)},y=j.getEntityDetails({sCacheProviderAttribute:"oAccountEntity",sRequestSettings:"CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq falsePhaseDetails/ProjectDetails,AccountTypeDetails",sKeyName:"Guid",sKeyValue:i.sClientGuid}),z=function(a){var c=a.sParentKey,d="",e="";"billingAddress"===a.sProvincesFor?(d="aBillingProvinces",e="aBillingCountries"):(d="aShippingProvinces",e="aShippingCountries");for(var g=0;g<b[e].length;g++)if(b[e][g].ticked){for(var h=0;h<v.length;h++)if(b[e][g].CountryCode===v[h].CountryCode){f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:v[h].ProvinceDetails.results},oParentArrayWrapper:u,sNameEN:"Name",sNameFR:"Name",sDependentKey:"ProvinceCode",sParentKey:c,sTargetArrayNameInParent:d}),u.aData[0]&&(b[d]=angular.copy(u.aData[0][d]));break}break}},A=function(a){v=angular.copy(a),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:u,sNameEN:"Name",sNameFR:"Name",sDependentKey:"CountryCode",sParentKey:"_billingCountryCode",sTargetArrayNameInParent:"aBillingCountries"}),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:u,sNameEN:"Name",sNameFR:"Name",sDependentKey:"CountryCode",sParentKey:"_shippingCountryCode",sTargetArrayNameInParent:"aShippingCountries"}),u.aData[0]&&(b.aBillingCountries=angular.copy(u.aData[0].aBillingCountries),b.aShippingCountries=angular.copy(u.aData[0].aShippingCountries)),b.oClient._billingCountryCode&&z({sParentKey:"_billingProvinceCode",sProvincesFor:"billingAddress"}),b.oClient._shippingCountryCode&&z({sParentKey:"_shippingProvinceCode",sProvincesFor:"shippingAddress"})},B=function(a){x(a),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:A})},C=function(){g.getAccount({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",sKey:q,bShowSpinner:!0,onSuccess:B})},D=function(a){b.sAccountTypeGuid=a[0].Guid};"create"!==b.sMode?angular.equals(y,{})?C():(x(y),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:A})):(w({aSelectedPhases:[]}),g.getCountriesWithProvinces({bShowSpinner:!1,onSuccess:A}),"Client"===b.sAccountType&&g.getClientAccountType({bShowSpinner:!1,onSuccess:D})),b.onEdit=function(){e.go("app.clientDetailsWrapper.clientDetails",{sMode:"edit",sClientGuid:b.oClient._guid})};var E=function(){var a={GeneralAttributes:{IsDeleted:!0}},c=function(){o.navigateBack({oState:e})};a.Guid=b.oClient._guid,a.LastModifiedAt=b.oClient._lastModifiedAt,g.updateAccount({bShowSpinner:!0,sKey:a.Guid,oData:a,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})};b.onDelete=function(a){f.showConfirmationPopup({sHeader:h.instant("clientDetails_deletionConfirmationHeader"),sContent:h.instant("clientDetails_deletionConfirmationContent"),sOk:h.instant("global_ok"),sCancel:h.instant("global_cancel"),onOk:E,event:a})};var F=function(){var a=[],c=[],d="";if(b.aSelectedPhases&&b.aSelectedPhases.length)for(var e=0;e<b.aSelectedPhases.length;e++)d="Phases('"+b.aSelectedPhases[e].Guid+"')",c.push(d);return a.push({sRelationName:"PhaseDetails",bKeepCompanyDependentLinks:!0,aUri:c}),a};b.onDataModified=function(){s=!0},b.onBillingCountryChanged=function(){b.onDataModified(),z({sParentKey:"",sProvincesFor:"billingAddress"})},b.onShippingCountryChanged=function(){b.onDataModified(),z({sParentKey:"",sProvincesFor:"shippingAddress"})},b.onBack=function(){o.navigateBack({oState:e})},b.onSave=function(a,c){if(b.oForms.clientDetailsForm.clientName&&b.oForms.clientDetailsForm.clientName.$setDirty(),b.oForms.clientDetailsForm.$valid){var d={GeneralAttributes:{}},f=[],h=function(f){return s=!1,c?void e.go(c.toState,c.toParams):void(a?(b.oClient.sName="",b.oClient.sPhone="",b.oClient.sPhoneExtension="",b.oClient.sSecondaryPhone="",b.oClient.sSecondaryPhoneExtension="",b.oClient.sWebsite="",b.oClient.sEmail="",b.oClient.sFax="",b.oClient.aTags=[],b.oClient.sBillingStreet="",b.oClient.sBillingCity="",b.oClient.sBillingPostalCode="",b.oClient.sShippingStreet="",b.oClient.sShippingCity="",b.oClient.sShippingPostalCode="",b.oForms.clientDetailsForm.clientName.$setPristine(),d.BillingAddress={},d.ShippingAddress={},b.oClient._aPhases=[]):(b.oClient._lastModifiedAt=f.LastModifiedAt,b.oClient.sLastModifiedAt=k.dBDateToSting(f.LastModifiedAt),b.oClient.sCreatedAt=k.dBDateToSting(f.CreatedAt),b.oClient._guid=f.Guid,e.go("app.clientDetailsWrapper.clientDetails",{sMode:"display",sClientGuid:f.Guid})))},i=function(a){return s=!1,b.oClient._lastModifiedAt=a.LastModifiedAt,b.oClient.sLastModifiedAt=k.dBDateToSting(a.LastModifiedAt),c?void e.go(c.toState,c.toParams):void e.go("app.clientDetailsWrapper.clientDetails",{sMode:"display",sClientGuid:a.Guid})};d.Guid=b.oClient._guid,d.Name=b.oClient.sName,b.oClient.sPhone?d.MainPhone=b.oClient.sPhone.replace(/\D/g,""):d.MainPhone="",b.oClient.sSecondaryPhone?d.SecondaryPhone=b.oClient.sSecondaryPhone.replace(/\D/g,""):d.SecondaryPhone="",b.oClient.sFax?d.Fax=b.oClient.sFax.replace(/\D/g,""):d.Fax="",d.IsProspect=b.oClient.bIsProspect,d.Website=b.oClient.sWebsite,d.Email=b.oClient.sEmail,d.MainPhoneExtension=b.oClient.sPhoneExtension,d.SecondaryPhoneExtension=b.oClient.sSecondaryPhoneExtension,d.DescriptionTags=k.tagsArrayToTagsString(b.oClient.aTags),d.BillingAddress={},d.BillingAddress.BillingStreet=b.oClient.sBillingStreet,d.BillingAddress.BillingCity=b.oClient.sBillingCity,d.BillingAddress.BillingPostalCode=b.oClient.sBillingPostalCode,d.ShippingAddress={},d.ShippingAddress.ShippingStreet=b.oClient.sShippingStreet,d.ShippingAddress.ShippingCity=b.oClient.sShippingCity,d.ShippingAddress.ShippingPostalCode=b.oClient.sShippingPostalCode;for(var j=0;j<b.aBillingCountries.length;j++)if(b.aBillingCountries[j].ticked){d.BillingAddress.BillingCountry=b.aBillingCountries[j].CountryCode;break}for(var j=0;j<b.aBillingProvinces.length;j++)if(b.aBillingProvinces[j].ticked){d.BillingAddress.BillingProvince=b.aBillingProvinces[j].ProvinceCode;break}for(var j=0;j<b.aShippingCountries.length;j++)if(b.aShippingCountries[j].ticked){d.ShippingAddress.ShippingCountry=b.aShippingCountries[j].CountryCode;break}for(var j=0;j<b.aShippingProvinces.length;j++)if(b.aShippingProvinces[j].ticked){d.ShippingAddress.ShippingProvince=b.aShippingProvinces[j].ProvinceCode;break}switch(d.LastModifiedAt=b.oClient._lastModifiedAt,f=F(),b.sMode){case"edit":g.updateAccount({bShowSpinner:!0,sKey:d.Guid,oData:d,aLinks:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:i});break;case"create":d.AccountTypeGuid=b.sAccountTypeGuid,g.createAccount({bShowSpinner:!0,oData:d,aLinks:f,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:h})}}},b.onSaveAndNew=function(){b.onSave(!0)};var G=function(){b.onSave(!1,t)},H=function(){s=!1,e.go(t.toState,t.toParams)};b.$on("$stateChangeStart",function(a,b,c,d,e){s&&(a.preventDefault(),t={toState:b,toParams:c},f.showConfirmationPopup({sHeader:h.instant("global_changesSaveConfirmationHeader"),sContent:h.instant("global_changesSaveConfirmationContent"),sOk:h.instant("global_yes"),sCancel:h.instant("global_no"),onOk:G,onCancel:H,event:a}))}),b.$on("$destroy",function(){a.aAccountPhasesGuids=[];for(var c=0;c<b.aSelectedPhases.length;c++)a.aAccountPhasesGuids.push(b.aSelectedPhases[c].Guid)})}]),viewControllers.controller("clientDetailsWrapperView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i){a.bDisplayContactsList=!1,a.bDisplayActivitiesList=!1,a.onDisplayContactsList=function(){a.bDisplayContactsList===!1?a.bDisplayContactsList=!0:a.bDisplayContactsList=!1},a.onDisplayActivitiesList=function(){a.bDisplayActivitiesList===!1?a.bDisplayActivitiesList=!0:a.bDisplayActivitiesList=!1},a.$on("$destroy",function(){i.getPreviousStateName()!==b.sCurrentStateName&&i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("clientsListView",["$scope","$rootScope","$state","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider","$mdSidenav","$window","$filter","rolesSettings","utilsProvider","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){h.removeHistory(),g.clearOtherViewsScrollPosition("clientsList");var o=g.oUserProfile.sCurrentRole;a.bDisplayAddButton=l.getRolesSettingsForEntityAndOperation({sRole:o,sEntityName:"oClient",sOperation:"bCreate"}),a.bDisplayEditButtons=l.getRolesSettingsForEntityAndOperation({sRole:o,sEntityName:"oClient",sOperation:"bUpdate"}),b.sCurrentStateName=c.current.name,b.oStateParams={};var p={aData:[]},q=g.getTableStatusFromCache({sTableName:"clientsList",sStateName:b.sCurrentStateName});a.oListSettings={bGroupListByProjectAndPhase:q.oListSettings.bGroupListByProjectAndPhase,bIsProspect:q.oListSettings.bIsProspect};var r={sClientName:"asc"};q&&!angular.equals(q.oSorting,{})&&(r=angular.copy(q.oSorting));var s={};q&&!angular.equals(q.oFilter,{})&&(s=angular.copy(q.oFilter));var t=[];q&&!angular.equals(q.aGroups,[])&&(t=angular.copy(q.aGroups)),a.tableParams=d.createNgTable({oInitialDataArrayWrapper:p,sDisplayedDataArrayName:"aDisplayedClients",oInitialSorting:r,oInitialFilter:s,aInitialGroupsSettings:t,sGroupBy:"sProjectPhase",sGroupsSortingAttribue:"_sortingSequence"});var u=function(b){var c="",d="",f=!1;if(a.oListSettings.bGroupListByProjectAndPhase){for(var h=0;h<b.length;h++)if(b[h].PhaseDetails.results.length){for(var i=0;i<b[h].PhaseDetails.results.length;i++)b[h].PhaseDetails.results[i]._sortingSequence=b[h].PhaseDetails.results[i].GeneralAttributes.SortingSequence;b[h].PhaseDetails.results=k("orderBy")(b[h].PhaseDetails.results,["_sortingSequence"]);for(var i=0;i<b[h].PhaseDetails.results.length;i++){f=!1;for(var j=0;j<g.oUserProfile.aGloballySelectedPhasesGuids.length;j++)if(b[h].PhaseDetails.results[i].Guid===g.oUserProfile.aGloballySelectedPhasesGuids[j]){f=!0;break}f&&(c="en"===e.use()?b[h].PhaseDetails.results[i].ProjectDetails.NameEN:b[h].PhaseDetails.results[i].ProjectDetails.NameFR,c||(c=b[h].PhaseDetails.results[i].ProjectDetails.NameEN),d="en"===e.use()?b[h].PhaseDetails.results[i].NameEN:b[h].PhaseDetails.results[i].NameFR,d||(d=b[h].PhaseDetails.results[i].NameEN),p.aData.push({sClientName:b[h].Name,sCleanedClientName:m.replaceSpecialChars(b[h].Name),sPhone:b[h].MainPhone,sEmail:b[h].Email,_guid:b[h].Guid,sTags:b[h].DescriptionTags,sProjectPhase:c+" - "+d,_sortingSequence:b[h].PhaseDetails.results[i]._sortingSequence}))}}}else for(var h=0;h<b.length;h++)p.aData.push({sClientName:b[h].Name,sCleanedClientName:m.replaceSpecialChars(b[h].Name),sPhone:b[h].MainPhone,sEmail:b[h].Email,_guid:b[h].Guid,sTags:b[h].DescriptionTags,sProjectPhase:e.instant("clientsList_groupAll"),_sortingSequence:-1});a.tableParams.reload(),n(function(){$(".cnpContentWrapper")[0]&&($(".cnpContentWrapper")[0].scrollTop=g.getListViewScrollPosition("clientsList"),g.putListViewScrollPosition("clientsList",0))},0)},v=function(){var b="CompanyName eq '"+g.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false";return b+=a.oListSettings.bIsProspect?" and IsProspect eq true":" and IsProspect eq false",p.aData=[],a.globalSelectedPhases.length>0?void f.getClients({sExpand:"PhaseDetails/ProjectDetails,AccountTypeDetails",sFilter:b,bShowSpinner:!0,onSuccess:u}):(p.aData=[],void u([]))};v(),a.onDisplay=function(a){g.putListViewScrollPosition("clientsList",$(".cnpContentWrapper")[0].scrollTop),c.go("app.clientDetailsWrapper.clientDetails",{sMode:"display",sClientGuid:a._guid})},a.onGroupingChange=function(){v()},a.onIsProspectChange=function(){v()},a.onEdit=function(a){g.putListViewScrollPosition("clientsList",$(".cnpContentWrapper")[0].scrollTop),c.go("app.clientDetailsWrapper.clientDetails",{sMode:"edit",sClientGuid:a._guid})},a.onAddNew=function(){c.go("app.clientDetailsWrapper.clientDetails",{sMode:"create",sClientGuid:""})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.$on("globalUserPhasesHaveBeenChanged",function(a){g.putListViewScrollPosition("clientsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.$on("accountsShouldBeRefreshed",function(a){g.putListViewScrollPosition("clientsList",$(".cnpContentWrapper")[0].scrollTop),v()}),a.$on("$destroy",function(){h.getPreviousStateName()!==b.sCurrentStateName&&(h.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams}),g.putTableStatusToCache({sTableName:"clientsList",sStateName:b.sCurrentStateName,aGroups:a.tableParams.settings().$scope.$groups,oFilter:a.tableParams.$params.filter,oSorting:a.tableParams.$params.sorting,oListSettings:a.oListSettings}))})}]),viewControllers.controller("activitiesListView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider","$mdSidenav","$window","$filter","$cookieStore","rolesSettings","utilsProvider","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&"app.unitDetailsWrapper.unitDetails"!==b.sCurrentStateName&&"app.contactDetailsWrapper.contactDetails"!==b.sCurrentStateName&&"app.clientDetailsWrapper.clientDetails"!==b.sCurrentStateName&&(i.removeHistory(),b.oStateParams={},h.clearOtherViewsScrollPosition("activitiesList"));var q=h.oUserProfile.sUserName,r=h.oUserProfile.sCurrentCompany,s=h.oUserProfile.sCurrentRole;a.bDisplayAddButton=n.getRolesSettingsForEntityAndOperation({sRole:s,sEntityName:"oActivity",sOperation:"bCreate"}),a.bDisplayEditButtons=n.getRolesSettingsForEntityAndOperation({sRole:s,sEntityName:"oActivity",sOperation:"bUpdate"}),b.sCurrentStateName=c.current.name;var t="";d.sUnitGuid&&(t=d.sUnitGuid);var u="";d.sContractorGuid&&(u=d.sContractorGuid);var v="";d.sClientGuid&&(v=d.sClientGuid);var w="";d.sContactGuid&&(w=d.sContactGuid),m.get("selectedActivityTypes"+q+r)&&m.get("selectedActivityTypes"+q+r).aSelectedActivityType&&(a.aSelectedActivityType=angular.copy(m.get("selectedActivityTypes"+q+r).aSelectedActivityType));var x={aData:[]},y={aData:[{_typesGuids:[]}]},z={_typesGuids:[]},A=h.getTableStatusFromCache({sTableName:"activitiesList",sStateName:b.sCurrentStateName}),B={sDbCreatedAt:"dsc"};A&&!angular.equals(A.oSorting,{})&&(B=angular.copy(A.oSorting));var C={};A&&!angular.equals(A.oFilter,{})&&(C=angular.copy(A.oFilter));var D=[];A&&!angular.equals(A.aGroups,[])&&(D=angular.copy(A.aGroups)),a.tableParams=e.createNgTable({oInitialDataArrayWrapper:x,sDisplayedDataArrayName:"aDisplayedActivities",oInitialSorting:B,oInitialFilter:C,aInitialGroupsSettings:D,sGroupBy:"sProjectPhase",sGroupsSortingAttribue:"_sortingSequence"});var E=function(b){for(var c=0;c<b.length;c++)b[c]._sortingSequence=b[c].GeneralAttributes.SortingSequence;if(b=l("orderBy")(b,["_sortingSequence"]),z._typesGuids=[],a.aSelectedActivityType)for(var c=0;c<a.aSelectedActivityType.length;c++)z._typesGuids.push(a.aSelectedActivityType[c].Guid);y.aData[0]=angular.copy(z),e.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:y,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKeys:"_typesGuids",sDependentIconKey:"AssociatedIconFileGuid",sTargetArrayNameInParent:"aActivityTypes"}),y.aData[0]&&(a.aActivityTypes=angular.copy(y.aData[0].aActivityTypes))},F=function(c){for(var d="",e="",g="",i="",j="",m="",n="",q="",r="",s="",s="",t=!1,u="",v=0;v<c.length;v++)if(q="",s="",m="",n="",i=[],u="",r=c[v].CreatedAt,q=o.dBDateToSting(c[v].CreatedAt),sDbModifiedAt=c[v].LastModifiedAt,s=o.dBDateToSting(c[v].LastModifiedAt),sActivityType="en"===f.use()?c[v].ActivityTypeDetails.NameEN:c[v].ActivityTypeDetails.NameFR,c[v].PhaseDetails.results.length){g="",j="";for(var w=0;w<c[v].PhaseDetails.results.length;w++)c[v].PhaseDetails.results[w]._sortingSequence=c[v].PhaseDetails.results[w].GeneralAttributes.SortingSequence;if(c[v].PhaseDetails.results=l("orderBy")(c[v].PhaseDetails.results,["_sortingSequence"]),0==c[v].AccountDetails.results.length);else for(var w=0;w<c[v].AccountDetails.results.length;w++)c[v].AccountDetails.results[w].GeneralAttributes.IsDeleted||(g=g+c[v].AccountDetails.results[w].Name+", ",i.push(c[v].AccountDetails.results[w].Name));var y=[];if(c[v].FileMetadataSetDetails&&c[v].FileMetadataSetDetails.FileMetadataDetails)for(var w=0;w<c[v].FileMetadataSetDetails.FileMetadataDetails.results.length;w++)c[v].FileMetadataSetDetails.FileMetadataDetails.results[w].MediaType&&c[v].FileMetadataSetDetails.FileMetadataDetails.results[w].MediaType.indexOf("image")>-1&&c[v].FileMetadataSetDetails.FileMetadataDetails.results[w].GeneralAttributes.IsDeleted===!1&&y.push(c[v].FileMetadataSetDetails.FileMetadataDetails.results[w]);if(0==c[v].ContactDetails.results.length);else for(var w=0;w<c[v].ContactDetails.results.length;w++)c[v].ContactDetails.results[w].GeneralAttributes.IsDeleted||(j=c[v].ContactDetails.results[w].LastName?j+c[v].ContactDetails.results[w].FirstName+" "+c[v].ContactDetails.results[w].LastName+", ":j+c[v].ContactDetails.results[w].FirstName+", ");c[v].ActivityTypeDetails&&(n=k.location.origin+k.location.pathname+"rest/file/v2/get/"+c[v].ActivityTypeDetails.AssociatedIconFileGuid,m=c[v].ActivityTypeDetails.GeneralAttributes.SortingSequence);for(var w=0;w<c[v].PhaseDetails.results.length;w++){t=!1;for(var z=0;z<h.oUserProfile.aGloballySelectedPhasesGuids.length;z++)if(c[v].PhaseDetails.results[w].Guid===h.oUserProfile.aGloballySelectedPhasesGuids[z]){t=!0;break}t&&(d="en"===f.use()?c[v].PhaseDetails.results[w].ProjectDetails.NameEN:c[v].PhaseDetails.results[w].ProjectDetails.NameFR,d||(d=c[v].PhaseDetails.results[w].ProjectDetails.NameEN),e="en"===f.use()?c[v].PhaseDetails.results[w].NameEN:c[v].PhaseDetails.results[w].NameFR,e||(e=c[v].PhaseDetails.results[w].NameEN),c[v].Description&&(u=o.removeTagsFromString(c[v].Description)),x.aData.push({sActivityType:sActivityType,sCleanedActivityType:o.replaceSpecialChars(sActivityType),sObject:c[v].Object,sCleanedObject:o.replaceSpecialChars(c[v].Object),sAccounts:g,aAccountsNames:i,sCleanedAccounts:o.replaceSpecialChars(g),sContacts:j,sCleanedContacts:o.replaceSpecialChars(j),sDbCreatedAt:r,sCreatedAt:q,sDbModifiedAt:sDbModifiedAt,sLastModifiedAt:s,_guid:c[v].Guid,sProjectPhase:d+" - "+e,sProjectName:d,_sortingSequence:c[v].PhaseDetails.results[w]._sortingSequence,sTypeSortingSequence:m,sTypeIconUrl:n,_aImages:y,sDescription:u}))}}a.tableParams.reload(),"app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&"app.unitDetailsWrapper.unitDetails"!==b.sCurrentStateName&&"app.contactDetailsWrapper.contactDetails"!==b.sCurrentStateName&&"app.clientDetailsWrapper.clientDetails"!==b.sCurrentStateName&&p(function(){$(".cnpContentWrapper")[0]&&($(".cnpContentWrapper")[0].scrollTop=h.getListViewScrollPosition("activitiesList"),h.putListViewScrollPosition("activitiesList",0))},0)},G=function(){x.aData=[];var b="",c=" and (",d=")";if(!(a.globalSelectedPhases.length>0))return x.aData=[],void F([]);if(a.aSelectedActivityType&&a.aSelectedActivityType.length>0){b+=c;for(var e=0;e<a.aSelectedActivityType.length;e++)b=b+"ActivityTypeGuid eq '"+a.aSelectedActivityType[e].Guid+"'",e<a.aSelectedActivityType.length-1&&(b+=" or ");b+=d,t&&(b+=c,b=b+"substringof('"+t+"', UnitGuids) eq true",b+=d),u&&(b+=c,b=b+"substringof('"+u+"', AccountGuids) eq true",b+=d),v&&(b+=c,b=b+"substringof('"+v+"', AccountGuids) eq true",b+=d),w&&(b+=c,b=b+"substringof('"+w+"', ContactGuids) eq true",b+=d),g.getActivities({sExpand:"AccountDetails/AccountTypeDetails, ActivityTypeDetails, ContactDetails, PhaseDetails/ProjectDetails,FileMetadataSetDetails/FileMetadataDetails,CommentSetDetails/CommentDetails",sFilter:"CompanyName eq '"+h.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false"+b,bShowSpinner:!0,onSuccess:F})}},H=function(){g.getActivityTypes({bShowSpinner:!1,onSuccess:E})};H(),G(),a.onDisplay=function(a){h.putListViewScrollPosition("activitiesList",$(".cnpContentWrapper")[0].scrollTop),c.go("app.activityDetailsWrapper.activityDetails",{sMode:"display",sActivityGuid:a._guid})},a.onEdit=function(a){h.putListViewScrollPosition("activitiesList",$(".cnpContentWrapper")[0].scrollTop),c.go("app.activityDetailsWrapper.activityDetails",{sMode:"edit",sActivityGuid:a._guid})},a.onAddNew=function(){c.go("app.activityDetailsWrapper.activityDetails",{sMode:"create",sActivityGuid:""})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.onCloseCheckSelectedTypesLength=function(){m.put("selectedActivityTypes"+q+r,{aSelectedActivityType:a.aSelectedActivityType}),a.aSelectedActivityType&&0===a.aSelectedActivityType.length,G()},a.onSelectedTypesModified=function(){a.onCloseCheckSelectedTypesLength()},a.$on("globalUserPhasesHaveBeenChanged",function(a){h.putListViewScrollPosition("activitiesList",$(".cnpContentWrapper")[0].scrollTop),G()}),a.$on("activitiesShouldBeRefreshed",function(a){h.putListViewScrollPosition("activitiesList",$(".cnpContentWrapper")[0].scrollTop),G()});var I=function(b){if(1===b.length){for(var c={logBookEntries:[]},d=[],e=0;e<a.tableParams.data.length;e++)for(var f=0;f<a.tableParams.data[e].data.length;f++){d=[];for(var h=0;h<a.tableParams.data[e].data[f]._aImages.length;h++)d.push({guid:a.tableParams.data[e].data[f]._aImages[h].Guid});c.logBookEntries.push({creationDate:a.tableParams.data[e].data[f].sCreatedAt,projectName:a.tableParams.data[e].data[f].sProjectName,accountsNames:a.tableParams.data[e].data[f].aAccountsNames,description:a.tableParams.data[e].data[f].sDescription,fls:d})}var i=JSON.stringify(c);g.generateReport({oReportParameters:{reportId:r+"-"+a.sReportName+"-"+Math.round(1e6*Math.random()),fileGuid:b[0].Guid,converter:"",processState:"generated",dispatch:"download",entryName:"",data:i}})}};a.onReports=function(){a.sReportName=("en"===f.use(),"AvancementJournalierDesTravaux"),g.getFileMetadatas({sFilter:"CatalogId eq '"+h.oUserProfile.sCurrentCompany+"' and DescriptionEN eq '"+a.sReportName+"'",onSuccess:I})},a.$on("$destroy",function(){if("app.contractorDetailsWrapper.contractorDetails"!==b.sCurrentStateName&&"app.unitDetailsWrapper.unitDetails"!==b.sCurrentStateName&&"app.contactDetailsWrapper.contactDetails"!==b.sCurrentStateName&&"app.clientDetailsWrapper.clientDetails"!==b.sCurrentStateName){if(i.getPreviousStateName()===b.sCurrentStateName)return;i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams})}h.putTableStatusToCache({sTableName:"activitiesList",sStateName:b.sCurrentStateName,aGroups:a.tableParams.settings().$scope.$groups,oFilter:a.tableParams.$params.filter,oSorting:a.tableParams.$params.sorting})})}]),viewControllers.controller("activityDetailsView",["$rootScope","$scope","$location","$anchorScroll","$state","servicesProvider","apiProvider","$translate","$stateParams","cacheProvider","utilsProvider","$filter","dataProvider","CONSTANTS","historyProvider","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){c.hash("top"),d(),b.oForms={};var q=i.sActivityGuid;a.sMode=i.sMode,a.sCurrentStateName=e.current.name,a.oStateParams=angular.copy(i);var r=j.oUserProfile.sCurrentRole;b.bDisplayEditButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oActivity",sOperation:"bUpdate"}),b.bDisplayDeleteButton=p.getRolesSettingsForEntityAndOperation({sRole:r,sEntityName:"oActivity",sOperation:"bDelete"}),b.bShowBackButton=o.aHistoryStates.length>0?!0:!1;var s={};a.sMode=i.sMode,"create"===a.sMode&&(a.sCommentSetGuid="",a.sFileMetadataSetGuid="",a.sFileMetadataSetLastModifiedAt=""),b.oActivity={_aPhases:[]};var t={aData:[{_accountsGuids:[],_contactsGuids:[],_unitsGuids:[],_aPhases:[]}]},u=function(a){for(var c=0;c<a.length;c++){a[c]._sortingSequenceProject=a[c].ProjectDetails.GeneralAttributes.SortingSequence,a[c]._sortingSequencePhase=a[c].GeneralAttributes.SortingSequence;for(var d=0;d<a[c].UnitDetails.results.length;d++)a[c].UnitDetails.results[d].Name=k.convertStringToInt(a[c].UnitDetails.results[d].Name);a[c].UnitDetails.results=l("filter")(a[c].UnitDetails.results,function(a,b){return!a.GeneralAttributes.IsDeleted}),a[c].UnitDetails.results=l("orderBy")(a[c].UnitDetails.results,["Name"])}a=l("orderBy")(a,["_sortingSequenceProject","_sortingSequencePhase"]);for(var e=[],c=0;c<a.length;c++)e[c]=[],e[c]=a[c].ProjectDetails.NameEN+" - "+a[c].NameEN,a[c]._NameEN=e[c];f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},sSecondLevelAttribute:"UnitDetails",sSecondLevelNameEN:"Name",sSecondLevelNameFR:"Name",oParentArrayWrapper:t,sNameEN:"_NameEN",sNameFR:"_NameEN",sDependentKey:"Guid",sParentKeys:"_unitsGuids",sTargetArrayNameInParent:"aUnits"}),t.aData[0]&&(b.aUnits=angular.copy(t.aData[0].aUnits))},v=function(a){if(0===a.length)return void u([]);for(var b="",c=0;c<a.length;c++)b=b+"Guid eq '"+a[c].Guid+"'",c<a.length-1&&(b+=" or ");g.getPhases({sFilter:"CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and ("+b+")",sExpand:"UnitDetails,ProjectDetails",bShowSpinner:!1,onSuccess:u})},w=function(a){b.aUserProjectsPhasesForMultiselect=f.constructUserProjectsPhasesForMultiSelect({aSelectedPhases:a}),b.aSelectedPhases&&v(b.aSelectedPhases)},x=function(c){a.sCurrentEntityPhaseGuid=c.PhaseGuid;var d=[];a.sFileMetadataSetGuid=c.FileMetadataSetGuid,c.FileMetadataSetDetails&&(a.sFileMetadataSetLastModifiedAt=c.FileMetadataSetDetails.LastModifiedAt),a.$broadcast("FileAttachemntsCanBeLoaded"),a.sCommentSetGuid=c.CommentSetGuid,c.CommentSetDetails&&(a.sCommentSetLastModifiedAt=c.CommentSetDetails.LastModifiedAt),a.$broadcast("CommentsCanBeLoaded"),b.oActivity._guid=c.Guid,b.oActivity.sObject=c.Object,b.oActivity._lastModifiedAt=c.LastModifiedAt,b.oActivity.sCreatedAt=k.dBDateToSting(c.CreatedAt),b.oActivity.sLastModifiedAt=k.dBDateToSting(c.LastModifiedAt),c.DueDate&&"/Date(0)/"!=c.DueDate&&(b.oActivity.sDueDate=k.dBDateToSting(c.DueDate),b.oActivity.dDueDate=new Date(parseInt(c.DueDate.substring(6,c.DueDate.length-2)))),b.oActivity._aPhases=angular.copy(c.PhaseDetails.results);for(var e=0;e<b.oActivity._aPhases.length;e++)d.push(b.oActivity._aPhases[e].Guid);w(d);var f=[],g=0;if(c.FileMetadataSetDetails){if(c.FileMetadataSetDetails.FileMetadataDetails)for(var h=0;h<c.FileMetadataSetDetails.FileMetadataDetails.results.length;h++)c.FileMetadataSetDetails.FileMetadataDetails.results[h].MediaType&&c.FileMetadataSetDetails.FileMetadataDetails.results[h].MediaType.indexOf("image")>-1&&c.FileMetadataSetDetails.FileMetadataDetails.results[h].GeneralAttributes.IsDeleted===!1&&f.push(c.FileMetadataSetDetails.FileMetadataDetails.results[h]);g=f.length}var i=0;if(c.CommentSetDetails&&c.CommentSetDetails.CommentDetails)for(var h=0;h<c.CommentSetDetails.CommentDetails.results.length;h++)c.CommentSetDetails.CommentDetails.results[h].GeneralAttributes.IsDeleted||i++;if(a.iImagesNumber=g,a._aImages=angular.copy(f),a.iCommentsNumber=i,b.oActivity._unitsGuids=[],c.UnitDetails)for(var e=0;e<c.UnitDetails.results.length;e++)b.oActivity._unitsGuids.push(c.UnitDetails.results[e].Guid);if(b.oActivity._activityTypeGuid=c.ActivityTypeGuid,b.oActivity._assignedUserName=c.AssignedUser,b.oActivity._accountsGuids=[],c.AccountDetails)for(var e=0;e<c.AccountDetails.results.length;e++)b.oActivity._accountsGuids.push(c.AccountDetails.results[e].Guid);if(b.oActivity._contactsGuids=[],c.ContactDetails)for(var e=0;e<c.ContactDetails.results.length;e++)b.oActivity._contactsGuids.push(c.ContactDetails.results[e].Guid);b.oActivity.sDescription=c.Description,t.aData[0]=angular.copy(b.oActivity),v(b.oActivity._aPhases)},y=j.getEntityDetails({sCacheProviderAttribute:"oActivityEntity",sRequestSettings:"CompanyName eq '"+j.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq falsePhaseDetails/ProjectDetails,ActivityTypeDetails,FileMetadataSetDetails/FileMetadataDetails",sKeyName:"Guid",sKeyValue:i.sActivityGuid}),z=function(a){x(a),g.getActivityTypes({bShowSpinner:!1,onSuccess:C}),g.getUsers({sExpand:"CompanyDetails",bShowSpinner:!1,onSuccess:D}),g.getAccounts({sExpand:"AccountTypeDetails",bShowSpinner:!1,onSuccess:A}),g.getContacts({sExpand:"AccountDetails/AccountTypeDetails",bShowSpinner:!1,onSuccess:B})},A=function(a){a=l("orderBy")(a,["Name"]),
f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:t,sNameEN:"Name",sNameFR:"Name",sDependentKey:"Guid",sParentKeys:"_accountsGuids",sTargetArrayNameInParent:"aAccounts"}),t.aData[0]&&(b.aAccounts=angular.copy(t.aData[0].aAccounts))},B=function(a){a=l("orderBy")(a,["FirstName"]);for(var c=0;c<a.length;c++)a[c].LastName?a[c].sFullName=a[c].FirstName+" "+a[c].LastName+",  "+a[c].AccountDetails.Name:a[c].sFullName=a[c].FirstName+",  "+a[c].AccountDetails.Name;f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:t,sNameEN:"sFullName",sNameFR:"sFullName",sDependentKey:"Guid",sParentKeys:"_contactsGuids",sTargetArrayNameInParent:"aContacts"}),t.aData[0]&&(b.aContacts=angular.copy(t.aData[0].aContacts))},C=function(a){for(var c=0;c<a.length;c++)a[c]._sortingSequence=a[c].GeneralAttributes.SortingSequence;a=l("orderBy")(a,["_sortingSequence"]),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:t,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_activityTypeGuid",sDependentIconKey:"AssociatedIconFileGuid",sTargetArrayNameInParent:"aActivityTypes"}),t.aData[0]&&(b.aActivityTypes=angular.copy(t.aData[0].aActivityTypes))},D=function(c){for(var d=[],e=0,g=!1,h=0;h<c.length;h++){for(var i=0;i<c[h].CompanyDetails.results.length;i++)if(c[h].CompanyDetails.results[i].CompanyName===j.oUserProfile.sCurrentCompany){g=!0,g&&(d[e]=c[h],e+=1),"create"===a.sMode&&(t.aData[0]._assignedUserName=b.sCurrentUser);break}}c=[{}],c=d,c=l("orderBy")(c,["UserName"]),f.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:c},oParentArrayWrapper:t,sNameEN:"UserName",sNameFR:"UserName",sDependentKey:"UserName",sParentKey:"_assignedUserName",sTargetArrayNameInParent:"aUsers"}),t.aData[0]&&(b.aUsers=angular.copy(t.aData[0].aUsers))},E=function(){g.getActivity({sKey:q,sExpand:"AccountDetails/AccountTypeDetails,ActivityTypeDetails,ContactDetails,PhaseDetails/ProjectDetails,UnitDetails/PhaseDetails,UserDetails,FileMetadataSetDetails/FileMetadataDetails,CommentSetDetails/CommentDetails",bShowSpinner:!0,onSuccess:z})};"create"!==a.sMode?angular.equals(y,{})?E():(x(y),g.getActivityTypes({bShowSpinner:!1,onSuccess:C}),g.getUsers({sExpand:"CompanyDetails",bShowSpinner:!1,onSuccess:D}),g.getAccounts({sExpand:"AccountTypeDetails",bShowSpinner:!1,onSuccess:A}),g.getContacts({sExpand:"AccountDetails/AccountTypeDetails",bShowSpinner:!1,onSuccess:B})):(a._aImages=[],a.iImagesNumber=0,a.iCommentsNumber=0,w({aSelectedPhases:[]}),v([]),g.getActivityTypes({bShowSpinner:!1,onSuccess:C}),g.getUsers({sExpand:"CompanyDetails",bShowSpinner:!1,onSuccess:D}),g.getAccounts({sExpand:"AccountTypeDetails",bShowSpinner:!1,onSuccess:A}),g.getContacts({sExpand:"AccountDetails/AccountTypeDetails",bShowSpinner:!1,onSuccess:B})),b.onEdit=function(){e.go("app.activityDetailsWrapper.activityDetails",{sMode:"edit",sActivityGuid:b.oActivity._guid})};var F=function(){var a={GeneralAttributes:{IsDeleted:!0}},c=function(){o.navigateBack({oState:e})};a.Guid=b.oActivity._guid,a.LastModifiedAt=b.oActivity._lastModifiedAt,g.updateActivity({bShowSpinner:!0,sKey:a.Guid,oData:a,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})};b.onDelete=function(a){f.showConfirmationPopup({sHeader:h.instant("activityDetails_deletionConfirmationHeader"),sContent:h.instant("activityDetails_deletionConfirmationContent"),sOk:h.instant("global_ok"),sCancel:h.instant("global_cancel"),onOk:F,event:a})};var G=function(){for(var a=[],c=[],d="",e=0;e<b.aUserProjectsPhasesForMultiselect.length;e++)b.aUserProjectsPhasesForMultiselect[e].ticked&&(d="Phases('"+b.aUserProjectsPhasesForMultiselect[e].Guid+"')",c.push(d));c.length&&a.push({sRelationName:"PhaseDetails",bKeepCompanyDependentLinks:!0,aUri:c});var c=[];if(b.aSelectedAccounts&&b.aSelectedAccounts.length)for(var e=0;e<b.aSelectedAccounts.length;e++)d="Accounts('"+b.aSelectedAccounts[e].Guid+"')",c.push(d),b.sAccountValues=b.sAccountValues+b.aSelectedAccounts[e].name+"; ",b.sAccountGuids=b.sAccountGuids+b.aSelectedAccounts[e].Guid+"; ";a.push({sRelationName:"AccountDetails",bKeepCompanyDependentLinks:!0,aUri:c});var c=[];if(b.aSelectedContacts&&b.aSelectedContacts.length)for(var e=0;e<b.aSelectedContacts.length;e++)d="Contacts('"+b.aSelectedContacts[e].Guid+"')",c.push(d),b.sContactValues=b.sContactValues+b.aSelectedContacts[e].name+"; ",b.sContactGuids=b.sContactGuids+b.aSelectedContacts[e].Guid+"; ";a.push({sRelationName:"ContactDetails",bKeepCompanyDependentLinks:!0,aUri:c});var c=[];if(b.aSelectedUnits&&b.aSelectedUnits.length)for(var e=0;e<b.aSelectedUnits.length;e++)d="Units('"+b.aSelectedUnits[e].Guid+"')",c.push(d),b.sUnitValues=b.sUnitValues+b.aSelectedUnits[e].name+"; ",b.sUnitGuids=b.sUnitGuids+b.aSelectedUnits[e].Guid+"; ";return a.push({sRelationName:"UnitDetails",bKeepCompanyDependentLinks:!0,aUri:c}),a};b.onCloseCheckSelectedPhasesLength=function(){0!=b.aSelectedPhases.length&&"display"!==a.sMode&&b.onSelectedPhasesModified()},b.onSelectedPhasesModified=function(){b.onDataModified(),b.oForms.activityDetailsForm.selectedPhases.$setDirty(),b.aSelectedPhases&&v(b.aSelectedPhases)},b.onCloseCheckSelectedTypesLength=function(){0==b.aSelectedActivityType.length&&b.onSelectedTypesModified()},b.onSelectedTypesModified=function(){b.onDataModified(),b.oForms.activityDetailsForm.selectedActivityType.$setDirty()},b.onDataModified=function(){a.bDataHasBeenModified=!0},b.onBack=function(){o.navigateBack({oState:e})},b.onSave=function(c,d){if(b.oForms.activityDetailsForm.selectedPhases&&b.oForms.activityDetailsForm.selectedPhases.$setDirty(),b.oForms.activityDetailsForm.activityObject&&b.oForms.activityDetailsForm.selectedActivityType.$setDirty(),b.oForms.activityDetailsForm.selectedUser&&b.oForms.activityDetailsForm.selectedUser.$setDirty(),b.oForms.activityDetailsForm.activityObject&&b.oForms.activityDetailsForm.activityObject.$setDirty(),b.oForms.activityDetailsForm.$valid){var f={GeneralAttributes:{}},h=[];f.Guid=b.oActivity._guid;var i=function(f){return a.bDataHasBeenModified=!1,d?void e.go(d.toState,d.toParams):void(c?(b.oActivity.sObject="",b.oForms.activityDetailsForm.activityObject.$setPristine(),b.oActivity.sDescription="",b.oActivity.dDueDate="/Date(0)/"):(e.go("app.activityDetailsWrapper.activityDetails",{sMode:"display",sActivityGuid:f.Guid}),b.oActivity._lastModifiedAt=f.LastModifiedAt,b.oActivity.sLastModifiedAt=k.dBDateToSting(f.LastModifiedAt),b.oActivity.sCreatedAt=k.dBDateToSting(f.CreatedAt),f.DueDate&&(b.oActivity.sDueDate=k.dBDateToSting(f.DueDate)),b.oActivity._guid=f.Guid))},j=function(c){return a.bDataHasBeenModified=!1,d?void e.go(d.toState,d.toParams):(b.oActivity._lastModifiedAt=c.LastModifiedAt,b.oActivity.sLastModifiedAt=k.dBDateToSting(c.LastModifiedAt),void e.go("app.activityDetailsWrapper.activityDetails",{sMode:"display",sActivityGuid:c.Guid}))};switch(f.Object=b.oActivity.sObject,f.Description=b.oActivity.sDescription,b.aSelectedActivityType.length&&(f.ActivityTypeGuid=b.aSelectedActivityType[0].Guid),b.aSelectedUser.length&&(f.AssignedUser=b.aSelectedUser[0].UserName),b.oActivity.dDueDate&&"/Date(0)/"!=b.oActivity.dDueDate?f.DueDate="/Date("+b.oActivity.dDueDate.getTime()+")/":f.DueDate="/Date(0)/",b.sAccountValues="",b.sAccountGuids="",b.sContactValues="",b.sContactGuids="",b.sUnitValues="",b.sUnitGuids="",h=G(),f.AccountValues=b.sAccountValues,f.AccountGuids=b.sAccountGuids,f.ContactValues=b.sContactValues,f.ContactGuids=b.sContactGuids,f.UnitValues=b.sUnitValues,f.UnitGuids=b.sUnitGuids,f.LastModifiedAt=b.oActivity._lastModifiedAt,a.sMode){case"edit":g.updateActivity({bShowSpinner:!0,sKey:f.Guid,oData:f,aLinks:h,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:j});break;case"create":a.sFileMetadataSetGuid&&(f.FileMetadataSetGuid=a.sFileMetadataSetGuid),g.createActivity({bShowSpinner:!0,oData:f,aLinks:h,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:i})}}},b.onSaveAndNew=function(){b.onSave(!0)};var H=function(){b.onSave(!1,s)},I=function(){a.bDataHasBeenModified=!1,e.go(s.toState,s.toParams)};b.onDisplayPhotoGallery=function(b){b.stopPropagation(),a._aImages.length&&f.setUpPhotoGallery(a._aImages)},b.$on("$stateChangeStart",function(b,c,d,e,g){a.bDataHasBeenModified&&(b.preventDefault(),s={toState:c,toParams:d},f.showConfirmationPopup({sHeader:h.instant("global_changesSaveConfirmationHeader"),sContent:h.instant("global_changesSaveConfirmationContent"),sOk:h.instant("global_yes"),sCancel:h.instant("global_no"),onOk:H,onCancel:I,event:b}))})}]),viewControllers.controller("activityDetailsWrapperView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i){b.bDataHasBeenModified=!1,a.bDisplayAttachmentsList=!1,a.bDisplayCommentsList=!1,a.onDisplayAttachmentsList=function(){a.bDisplayAttachmentsList=!a.bDisplayAttachmentsList},a.onDisplayCommentsList=function(){a.bDisplayCommentsList=!a.bDisplayCommentsList},a.$on("$destroy",function(){i.getPreviousStateName()!==b.sCurrentStateName&&i.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("changePasswordView",["$scope","$rootScope","$state","$translate","utilsProvider","dataProvider","cacheProvider","$filter","rolesSettings","servicesProvider","apiProvider",function(a,b,c,d,e,f,g,h,i,j,k){a.oForms={};var l=!1,m={};a.oUser={},b.sCurrentStateName=c.current.name,b.oStateParams={},a.onSave=function(){a.oForms.profileSettingsPasswordResetForm.password.$setDirty(),a.oForms.profileSettingsPasswordResetForm.passwordConfirmation.$setDirty();var b=new Hashes.SHA512,c={GeneralAttributes:{}};if(!a.oUser.sPassword||!a.oUser.sPasswordConfirmation)return void e.displayMessage({sText:d.instant("global_emptyFields"),sType:"error"});if(a.oUser.sPassword!==a.oUser.sPasswordConfirmation)return void e.displayMessage({sText:d.instant("global_passwordsDontMatch"),sType:"error"});var f=function(b){l=!1,a.oUser.sPassword="",a.oUser.sPasswordConfirmation="",g.oUserProfile.sLastModifiedAt=b.LastModifiedAt};c.UserName=g.oUserProfile.sUserName,c.LastModifiedAt=g.oUserProfile.sLastModifiedAt,c.Password=k.hashPassword(b.hex(a.oUser.sPassword)),k.updateUser({bShowSpinner:!0,sKey:c.UserName,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:f})},a.onDataModified=function(){l=!0};var n=function(){a.onSave(m)},o=function(){l=!1,c.go(m.toState,m.toParams)};a.$on("$stateChangeStart",function(a,b,c,e,f){l&&(a.preventDefault(),m={toState:b,toParams:c},j.showConfirmationPopup({sHeader:d.instant("global_changesSaveConfirmationHeader"),sContent:d.instant("global_changesSaveConfirmationContent"),sOk:d.instant("global_yes"),sCancel:d.instant("global_no"),onOk:n,onCancel:o,event:a}))})}]),viewControllers.controller("profileDetailsView",["$scope","$rootScope","$state","$translate","utilsProvider","dataProvider","cacheProvider","$filter","rolesSettings","servicesProvider","apiProvider","$cookieStore","$window","$upload","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,i){var o=g.oUserProfile.sUserName,p=g.oUserProfile.sCurrentCompany,q=!1,r={};a.oUser={},a.sMode="display",a.oUserProfile=g.oUserProfile,b.sCurrentStateName=c.current.name,b.oStateParams={};var s={aData:[{}]};a.aLanguages=[];var t=function(){var b=[];b.push({languageCode:"en",descriptionEN:"English",descriptionFR:"Anglais"}),b.push({languageCode:"fr",descriptionEN:"French",descriptionFR:"Français"}),j.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:s,sNameEN:"descriptionEN",sNameFR:"descriptionFR",sDependentKey:"languageCode",sParentKey:"_sLanguage",sTargetArrayNameInParent:"aLanguages"}),s.aData[0]&&(a.aLanguages=angular.copy(s.aData[0].aLanguages))},u=function(b){var c="",f="";a.oUser.sUserName=b.UserName,a.oUser.sEmail=b.EMail,a.oUser._lastModifiedAt=b.LastModifiedAt,a.oUser.sCreatedAt=e.dBDateToSting(b.CreatedAt),a.oUser.sLastModifiedAt=e.dBDateToSting(b.LastModifiedAt),a.oUser._aCompanies=[],a.oUser.sCompanies="";for(var g=0;g<b.CompanyDetails.results.length;g++)b.CompanyDetails.results[g].GeneralAttributes.IsDeleted||(a.oUser._aCompanies.push(b.CompanyDetails.results[g]),a.oUser.sCompanies=a.oUser.sCompanies+b.CompanyDetails.results[g].CompanyName+", ");a.oUser.sRoles="";for(var g=0;g<b.RoleDetails.results.length;g++)b.RoleDetails.results[g].GeneralAttributes.IsDeleted||b.RoleDetails.results[g].CompanyName!==p||(a.oUser.sRoles=a.oUser.sRoles+b.RoleDetails.results[g].RoleName+", ");a.oUser.sPhases="";for(var g=0;g<b.PhaseDetails.results.length;g++)b.PhaseDetails.results[g].GeneralAttributes.IsDeleted||b.PhaseDetails.results[g].CompanyName!==p||(c="en"===d.use()?b.PhaseDetails.results[g].ProjectDetails.NameEN:b.PhaseDetails.results[g].ProjectDetails.NameFR,c||(c=b.PhaseDetails.results[g].ProjectDetails.NameEN),a.oUser.sPhases=a.oUser.sPhases+c+" - ",f="en"===d.use()?b.PhaseDetails.results[g].NameEN:b.PhaseDetails.results[g].NameFR,f||(f=b.PhaseDetails.results[g].NameEN),a.oUser.sPhases=a.oUser.sPhases+f+", ");if(b.AvatarFileGuid)a.oUser.sAvatarUrl=m.location.origin+m.location.pathname+"rest/file/v2/get/"+b.AvatarFileGuid;else{var h=new Hashes.MD5,i=h.hex(a.oUser.sEmail);a.oUser.sAvatarUrl="http://www.gravatar.com/avatar/"+i+".png?d=identicon&s=200"}a.oUser._sLanguage=b.Language,s.aData[0]=angular.copy(a.oUser),t()},v=function(){k.getUserWithCompaniesPhasesAndRoles({sKey:o,bShowSpinner:!0,onSuccess:u})};v(),a.onDataModified=function(){q=!0},a.onEdit=function(){a.sMode="edit"},a.onSave=function(b){var d={GeneralAttributes:{}},f=function(d){g.cleanEntitiesCache("oUserEntity"),g.oUserProfile.sLastModifiedAt=d.LastModifiedAt,q=!1,b&&c.go(b.toState,b.toParams),a.oUser._lastModifiedAt=d.LastModifiedAt,a.oUser.sLastModifiedAt=e.dBDateToSting(d.LastModifiedAt),a.sMode="display"};d.UserName=a.oUser.sUserName,d.EMail=a.oUser.sEmail,d.LastModifiedAt=a.oUser._lastModifiedAt,d.AvatarFileGuid=a.oUser._avatarFileGuid;for(var h=0;h<a.aLanguages.length;h++)if(a.aLanguages[h].ticked){d.Language=a.aLanguages[h].languageCode;break}k.updateUser({bShowSpinner:!0,sKey:d.UserName,oData:d,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:f})};var w=function(b,c,d){for(var e=0;e<b.length;e++){var f=b[e],c=j.costructUploadUrl({sPath:c});a.upload=n.upload({url:c,file:f}),a.upload.success(function(b){a.oUser.sAvatarUrl=m.location.origin+m.location.pathname+"rest/file/v2/get/"+b,a.oUser._avatarFileGuid=b})}};a.onAvatarSelected=function(b,c){a.onDataModified(),w(b,"rest/file/v1/createUploadUrl/users/users/_avatar_",c)};var x=function(){a.onSave(r)},y=function(){q=!1,c.go(r.toState,r.toParams)};a.$on("$stateChangeStart",function(a,b,c,e,f){q&&(a.preventDefault(),r={toState:b,toParams:c},j.showConfirmationPopup({sHeader:d.instant("global_changesSaveConfirmationHeader"),sContent:d.instant("global_changesSaveConfirmationContent"),sOk:d.instant("global_yes"),sCancel:d.instant("global_no"),onOk:x,onCancel:y,event:a}))})}]),viewControllers.controller("profileSettingsView",["$scope","$state","servicesProvider","$cookieStore","cacheProvider","$window","$mdSidenav","historyProvider","$translate","$timeout","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k){h.removeHistory(),e.clearOtherViewsScrollPosition("");var l=e.oUserProfile.sCurrentRole;a.toggleProfileSettingsRightSideNav=function(){j(g("profileSettingsRightSideNav").toggle,200)};var m=function(a,c){c?b.go(a,c):b.go(a),j(g("profileSettingsRightSideNav").close,350)};a.onMenuItemSelected=function(a){m(a.sStateName,a.oStateParams)},a.aMenuItems=[];var n="",o="";e.oUserProfile.oUserContact&&e.oUserProfile.oUserContact.AccountDetails&&(n=e.oUserProfile.oUserContact.AccountDetails.Guid,o=e.oUserProfile.oUserContact.Guid),a.aMenuItems.push({bShouldBeDisplayed:k.getRolesProfileMenuItemSettings({sRole:l,sMenuItem:"bShowContactDetails"}),sStateName:"app.profileSettings.contactDetails",sMenuLabel:"profileSettings_contactDetails",oStateParams:{sMode:"display",sAccountGuid:n,sContactGuid:o}}),a.aMenuItems.push({bShouldBeDisplayed:k.getRolesProfileMenuItemSettings({sRole:l,sMenuItem:"bShowProfileDetails"}),sStateName:"app.profileSettings.profileDetails",sMenuLabel:"profileSettings_profileDetails"}),a.aMenuItems.push({bShouldBeDisplayed:k.getRolesProfileMenuItemSettings({sRole:l,sMenuItem:"bShowChangePassword"}),sStateName:"app.profileSettings.changePassword",sMenuLabel:"profileSettings_changePassword"});var p=angular.element(f);p.bind("resize",function(){g("left")&&g("left").close()}),a.$on("$destroy",function(){p.unbind()})}]),viewControllers.controller("accountTypesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","historyProvider",function(a,b,c,d,e,f,g,h,i){i.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var j=0,k={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:k,sDisplayedDataArrayName:"aDisplayedAccountTypes",oInitialSorting:{sortingSequence:"asc"}});var l=function(b){for(var c=0;c<b.length;c++)k.aData.push({_editMode:!1,_guid:b[c].Guid,_lastModifiedAt:b[c].LastModifiedAt,nameEN:b[c].NameEN,nameFR:b[c].NameFR,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload()};g.getAccountTypes({bShowSpinner:!0,onSuccess:l}),a.onAddNew=function(){k.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:j}),j++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<k.aData.length;c++)if(k.aData[c]._guid===b._guid){k.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateAccountType({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<k.aData.length;e++)if(k.aData[e]._counter===b._counter){k.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt,a._guid?(b.Guid=a._guid,g.updateAccountType({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createAccountType({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("activityTypesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","cacheProvider","historyProvider","$window",function(a,b,c,d,e,f,g,h,i,j,k){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var l={aData:[]},m=0,n={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:n,sDisplayedDataArrayName:"aDisplayedActivityTypes",oInitialSorting:{sortingSequence:"asc"}});var o=function(a){d.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:n,oNewParentItemArrayWrapper:l,sDependentKey:"guid",sParentKey:"_associatedIconFileGuid",sDependentIconKey:"guid",sTargetArrayNameInParent:"aTypeIcons"})},p=function(b){for(var c=0;c<b.length;c++)n.aData.push({_editMode:!1,_guid:b[c].Guid,_lastModifiedAt:b[c].LastModifiedAt,_associatedIconFileGuid:b[c].AssociatedIconFileGuid,sUrl:k.location.origin+k.location.pathname+"rest/file/v2/get/"+b[c].AssociatedIconFileGuid,nameEN:b[c].NameEN,nameFR:b[c].NameFR,associatedColor:b[c].AssociatedColor,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload(),g.getAttachments({sPath:"rest/file/v1/list/companyDependentSettings/"+i.oUserProfile.sCurrentCompany+"/_activityTypes_",onSuccess:o})};g.getActivityTypes({bShowSpinner:!0,onSuccess:p}),a.onAddNew=function(){n.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:m,aTypeIcons:angular.copy(l.aData)}),m++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<n.aData.length;c++)if(n.aData[c]._guid===b._guid){n.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateActivityType({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<n.aData.length;e++)if(n.aData[e]._counter===b._counter){n.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1,a._associatedIconFileGuid=b.AssociatedIconFileGuid,a.sUrl=k.location.origin+k.location.pathname+"rest/file/v2/get/"+b.AssociatedIconFileGuid},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt,a._associatedIconFileGuid=b.AssociatedIconFileGuid,a.sUrl=k.location.origin+k.location.pathname+"rest/file/v2/get/"+b.AssociatedIconFileGuid};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.AssociatedColor=a.associatedColor,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt;for(var e=0;e<a.aTypeIcons.length;e++)if(a.aTypeIcons[e].ticked){b.AssociatedIconFileGuid=a.aTypeIcons[e].guid;break}a._guid?(b.Guid=a._guid,g.updateActivityType({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createActivityType({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("additionalAttributesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","cacheProvider","historyProvider","utilsProvider",function(a,b,c,d,e,f,g,h,i,j,k){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={},a.oNewNode={sTextEN:"",sTextFR:""},a.oUpdatedNode={sTextEN:"",sTextFR:""},a.oNodesData={aData:[]},a.aTreeData=[];var l=0;a.oTreeConfig={core:{multiple:!1,animation:!0,error:function(a){$log.error("treeCtrl: error from js tree - "+angular.toJson(a))},check_callback:!0,worker:!0},plugins:[],version:1},a.onAddNewNode=function(){for(var b="",c=a.oNodesData.aData.length-1;c>=0;c--)if(a.oNodesData.aData[c].ticked===!0){b=a.oNodesData.aData[c].id;break}for(var d="#",c=a.aTreeData.length-1;c>=0;c--)if(a.aTreeData[c].id===b){d=a.aTreeData[c].id;break}a.aTreeData.push({id:"node"+l++,parent:d,textEN:a.oNewNode.sTextEN,textFR:a.oNewNode.sTextFR,text:"ID: node"+l+"; NameEN: "+a.oNewNode.sTextEN+"; NameFR: "+a.oNewNode.sTextFR,state:{open:!1}})},a.onUpdateNode=function(){for(var b="",c=a.oNodesData.aData.length-1;c>=0;c--)if(a.oNodesData.aData[c].ticked===!0){b=a.oNodesData.aData[c].id;break}for(var c=a.aTreeData.length-1;c>=0;c--)if(a.aTreeData[c].id===b){a.aTreeData[c].text="ID: "+a.aTreeData[c].id+"; NameEN: "+a.oUpdatedNode.sTextEN+"; NameFR: "+a.oUpdatedNode.sTextFR;break}m(),a.oTreeConfig.version++},a.createCB=function(){m()};var m=function(){d.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a.aTreeData},oParentArrayWrapper:{aData:[]},oNewParentItemArrayWrapper:a.oNodesData,sNameEN:"text",sNameFR:"text",sDependentKey:"id",sParentKey:"",sTargetArrayNameInParent:"aNodes"})};a.applyModelChanges=function(){return!0}}]),viewControllers.controller("adminPanelView",["$scope","$state","servicesProvider","$window","CONSTANTS","cacheProvider","$mdSidenav","$window","historyProvider","rolesSettings","$translate","$timeout",function(a,b,c,d,e,f,g,d,h,i,j,k){h.removeHistory(),f.clearOtherViewsScrollPosition("");var l=f.oUserProfile.sCurrentRole;a.toggleAdminPanelRightSideNav=function(){k(g("adminPanelRightSideNav").toggle,200)};var m=function(a){b.go(a),k(g("adminPanelRightSideNav").close,350)};a.onMenuItemSelected=function(a){m(a.sStateName)},a.aMenuItems=[],a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowCompaniesManagement"}),sStateName:"app.adminPanel.companiesList",sMenuLabel:"adminPanel_companies"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowUsersManagement"}),sStateName:"app.adminPanel.usersList",sMenuLabel:"adminPanel_userManagement"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowRolesManagement"}),sStateName:"app.adminPanel.rolesList",sMenuLabel:"adminPanel_roles"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowProjectsManagement"}),sStateName:"app.adminPanel.projectsList",sMenuLabel:"adminPanel_projects"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowPhasesManagement"}),sStateName:"app.adminPanel.phasesList",sMenuLabel:"adminPanel_phases"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowDeficiencyStatusesManagement"}),sStateName:"app.adminPanel.deficiencyStatusesList",sMenuLabel:"adminPanel_deficiencyStatuses"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowDeficiencyPrioritiesManagement"}),sStateName:"app.adminPanel.deficiencyPrioritiesList",sMenuLabel:"adminPanel_deficiencyPriorities"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowSystemFilesManagement"}),sStateName:"app.adminPanel.systemFiles",sMenuLabel:"adminPanel_systemFiles"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowAccountTypesManagement"}),sStateName:"app.adminPanel.accountTypesList",sMenuLabel:"adminPanel_accountTypes"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowContactTypesManagement"}),sStateName:"app.adminPanel.contactTypesList",sMenuLabel:"adminPanel_contactTypes"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowUnitOptionSetManagement"}),sStateName:"app.adminPanel.unitOptionSetList",sMenuLabel:"adminPanel_unitOptionSet"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowUnitOptionValueManagement"}),sStateName:"app.adminPanel.unitOptionValueList",sMenuLabel:"adminPanel_unitOptionValue"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowTaskTypeManagement"}),sStateName:"app.adminPanel.taskTypeList",sMenuLabel:"adminPanel_taskType"}),a.aMenuItems.push({bShouldBeDisplayed:i.getRolesAdminPanelMenuItemSettings({sRole:l,sMenuItem:"bShowActivityTypesManagement"}),sStateName:"app.adminPanel.activityTypesList",sMenuLabel:"adminPanel_activityTypes"}),a.aMenuItems.push({bShouldBeDisplayed:!0,sStateName:"app.adminPanel.additionalAttributesList",sMenuLabel:"adminPanel_additionalAttributes"})}]),viewControllers.controller("companiesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","CONSTANTS","cacheProvider","dataProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j,k,l){l.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var m={aData:[]},n=0;a.tableParams=d.createNgTable({oInitialDataArrayWrapper:m,sDisplayedDataArrayName:"aDisplayedCompanies",oInitialSorting:{sortingSequence:"asc"}});var o=function(b){for(var c=0;c<b.length;c++)m.aData.push({_editMode:!1,_companyName:b[c].CompanyName,_lastModifiedAt:b[c].LastModifiedAt,companyName:b[c].CompanyName,descriptionEN:b[c].DescriptionEN,descriptionFR:b[c].DescriptionFR,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload()};g.getCompanies({bShowSpinner:!0,onSuccess:o}),a.onAddNew=function(){m.aData.push({_createMode:!0,_editMode:!0,sortingSequence:0,descriptionEN:"",descriptionFR:"",_counter:n}),n++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b,c){var d={GeneralAttributes:{IsDeleted:!0}},e=function(){for(var c=0;c<m.aData.length;c++)if(m.aData[c]._companyName===b._companyName){m.aData.splice(c,1);break}a.tableParams.reload()};if(b._companyName)d.CompanyName=b._companyName,d.LastModifiedAt=b._lastModifiedAt,g.updateCompany({bShowSpinner:!0,sKey:d.CompanyName,oData:d,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:e});else for(var f=0;f<m.aData.length;f++)if(m.aData[f]._counter===b._counter){m.aData.splice(f,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._companyName=b[0].__changeResponses[0].data.CompanyName,a._lastModifiedAt=b[0].__changeResponses[0].data.LastModifiedAt,a._editMode=!1,a._createMode=!1,d.refreshUserProfile()},e=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt,d.refreshUserProfile()};b.DescriptionEN=a.descriptionEN,b.DescriptionFR=a.descriptionFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt,a._companyName?(b.CompanyName=a._companyName,g.updateCompany({bShowSpinner:!0,sKey:b.CompanyName,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:e})):(b.CompanyName=a.companyName,g.createCompany({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c}))}}]),viewControllers.controller("contactTypesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","historyProvider",function(a,b,c,d,e,f,g,h,i){i.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var j=0,k={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:k,sDisplayedDataArrayName:"aDisplayedContactTypes",oInitialSorting:{sortingSequence:"asc"}});var l=function(b){for(var c=0;c<b.length;c++)k.aData.push({_editMode:!1,_guid:b[c].Guid,_lastModifiedAt:b[c].LastModifiedAt,nameEN:b[c].NameEN,nameFR:b[c].NameFR,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload()};g.getContactTypes({bShowSpinner:!0,onSuccess:l}),a.onAddNew=function(){k.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:j}),j++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<k.aData.length;c++)if(k.aData[c]._guid===b._guid){k.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateContactType({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<k.aData.length;e++)if(k.aData[e]._counter===b._counter){k.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt,a._guid?(b.Guid=a._guid,g.updateContactType({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createContactType({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("deficiencyPrioritiesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","$window","historyProvider",function(a,b,c,d,e,f,g,h,i,j){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var k=0,l={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:l,sDisplayedDataArrayName:"aDisplayedDeficiencyPriorities",oInitialSorting:{sortingSequence:"asc"}});var m=function(b){for(var c=0;c<b.length;c++)l.aData.push({_editMode:!1,_guid:b[c].Guid,_lastModifiedAt:b[c].LastModifiedAt,nameEN:b[c].NameEN,nameFR:b[c].NameFR,associatedColor:b[c].AssociatedColor,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload();

};g.getDeficiencyPriorities({bShowSpinner:!0,onSuccess:m}),a.onAddNew=function(){l.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",associatedColor:"",_counter:k}),k++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<l.aData.length;c++)if(l.aData[c]._guid===b._guid){l.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateDeficiencyPriority({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<l.aData.length;e++)if(l.aData[e]._counter===b._counter){l.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.AssociatedColor=a.associatedColor,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt,a._guid?(b.Guid=a._guid,g.updateDeficiencyPriority({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createDeficiencyPriority({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("deficiencyStatusesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","$window","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j,k){k.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var l={aData:[]},m=0,n={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:n,sDisplayedDataArrayName:"aDisplayedDeficiencyStatuses",oInitialSorting:{sortingSequence:"asc"}});var o=function(a){d.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:n,oNewParentItemArrayWrapper:l,sDependentKey:"guid",sParentKey:"_associatedIconFileGuid",sDependentIconKey:"guid",sTargetArrayNameInParent:"aStatusIcons"})},p=function(b){for(var c=0;c<b.length;c++)n.aData.push({_editMode:!1,_guid:b[c].Guid,_lastModifiedAt:b[c].LastModifiedAt,_associatedIconFileGuid:b[c].AssociatedIconFileGuid,sUrl:i.location.origin+i.location.pathname+"rest/file/v2/get/"+b[c].AssociatedIconFileGuid,nameEN:b[c].NameEN,nameFR:b[c].NameFR,associatedColor:b[c].AssociatedColor,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload(),g.getAttachments({sPath:"rest/file/v1/list/companyDependentSettings/"+j.oUserProfile.sCurrentCompany+"/_deficiencyStatuses_",onSuccess:o})};g.getDeficiencyStatuses({bShowSpinner:!0,onSuccess:p}),a.onAddNew=function(){n.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:m,aStatusIcons:angular.copy(l.aData)}),m++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<n.aData.length;c++)if(n.aData[c]._guid===b._guid){n.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateDeficiencyStatus({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<n.aData.length;e++)if(n.aData[e]._counter===b._counter){n.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1,a._associatedIconFileGuid=b.AssociatedIconFileGuid,a.sUrl=i.location.origin+i.location.pathname+"rest/file/v2/get/"+b.AssociatedIconFileGuid},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt,a._associatedIconFileGuid=b.AssociatedIconFileGuid,a.sUrl=i.location.origin+i.location.pathname+"rest/file/v2/get/"+b.AssociatedIconFileGuid};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.AssociatedColor=a.associatedColor,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt;for(var e=0;e<a.aStatusIcons.length;e++)if(a.aStatusIcons[e].ticked){b.AssociatedIconFileGuid=a.aStatusIcons[e].guid;break}a._guid?(b.Guid=a._guid,g.updateDeficiencyStatus({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createDeficiencyStatus({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("phasesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var k={aData:[]},l=0,m={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:m,sDisplayedDataArrayName:"aDisplayedPhases",oInitialSorting:{sortingSequence:"asc"}});var n=function(a){for(var b=0;b<a.length;b++)a[b]._sortingSequence=a[b].GeneralAttributes.SortingSequence;a=f("orderBy")(a,["_sortingSequence"]),d.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:m,oNewParentItemArrayWrapper:k,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_projectGuid",sTargetArrayNameInParent:"aProjects"})},o=function(b){for(var c=0;c<b.length;c++){var d={};d._editMode=!1,d._guid=b[c].Guid,d._lastModifiedAt=b[c].LastModifiedAt,d.nameEN=b[c].NameEN,d.nameFR=b[c].NameFR,d.sortingSequence=b[c].GeneralAttributes.SortingSequence,b[c].ProjectDetails&&(d._projectGuid=b[c].ProjectDetails.Guid,d.projectName="en"===h.use()?b[c].ProjectDetails.NameEN:b[c].ProjectDetails.NameFR,d.projectName||(d.projectName=b[c].ProjectDetails.NameEN)),m.aData.push(d)}a.tableParams.reload(),g.getProjects({bShowSpinner:!1,onSuccess:n})};g.getPhases({sFilter:"CompanyName eq '"+i.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:"ProjectDetails",bShowSpinner:!0,onSuccess:o}),a.onAddNew=function(){m.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:l,aProjects:angular.copy(k.aData)}),l++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<m.aData.length;c++)if(m.aData[c]._guid===b._guid){m.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updatePhase({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<m.aData.length;e++)if(m.aData[e]._counter===b._counter){m.aData.splice(e,1),a.tableParams.reload();break}};var p="";a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1,a.projectName=p,p="",i.cleanEntitiesCache("oProjectEntity")},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt,a.projectName=p,p="",i.cleanEntitiesCache("oProjectEntity")};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt;for(var e=0;e<a.aProjects.length;e++)if(a.aProjects[e].ticked){b.ProjectGuid=a.aProjects[e].Guid,p=a.aProjects[e].name;break}a._guid?(b.Guid=a._guid,g.updatePhase({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createPhase({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("projectsListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","historyProvider",function(a,b,c,d,e,f,g,h,i){i.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var j=0,k={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:k,sDisplayedDataArrayName:"aDisplayedProjects",oInitialSorting:{sortingSequence:"asc"}});var l=function(b){for(var c=0;c<b.length;c++)k.aData.push({_editMode:!1,_guid:b[c].Guid,_lastModifiedAt:b[c].LastModifiedAt,nameEN:b[c].NameEN,nameFR:b[c].NameFR,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload()};g.getProjects({bShowSpinner:!0,onSuccess:l}),a.onAddNew=function(){k.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:j}),j++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<k.aData.length;c++)if(k.aData[c]._guid===b._guid){k.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateProject({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<k.aData.length;e++)if(k.aData[e]._counter===b._counter){k.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt,a._guid?(b.Guid=a._guid,g.updateProject({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createProject({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("rolesListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","historyProvider",function(a,b,c,d,e,f,g,h,i){i.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var j={aData:[]},k=0;a.tableParams=d.createNgTable({oInitialDataArrayWrapper:j,sDisplayedDataArrayName:"aDisplayedRoles",oInitialSorting:{sortingSequence:"asc"}});var l=function(b){for(var c=0;c<b.length;c++)j.aData.push({_editMode:!1,_guid:b[c].Guid,_roleName:b[c].RoleName,_lastModifiedAt:b[c].LastModifiedAt,roleName:b[c].RoleName,descriptionEN:b[c].DescriptionEN,descriptionFR:b[c].DescriptionFR,sortingSequence:b[c].GeneralAttributes.SortingSequence});a.tableParams.reload()};g.getRoles({bShowSpinner:!0,onSuccess:l}),a.onAddNew=function(){j.aData.push({_createMode:!0,_editMode:!0,sortingSequence:0,descriptionEN:"",descriptionFR:"",_counter:k}),k++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b,c){var d={GeneralAttributes:{IsDeleted:!0}},e=function(){for(var c=0;c<j.aData.length;c++)if(j.aData[c]._guid===b._guid){j.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)d.Guid=b._guid,d.LastModifiedAt=b._lastModifiedAt,g.updateRole({bShowSpinner:!0,sKey:d.Guid,oData:d,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:e});else for(var f=0;f<j.aData.length;f++)if(j.aData[f]._counter===b._counter){j.aData.splice(f,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1,a._createMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.DescriptionEN=a.descriptionEN,b.DescriptionFR=a.descriptionFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt,b.RoleName=a.roleName,a._guid?(b.Guid=a._guid,g.updateRole({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createRole({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("systemFilesView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","$upload","$window","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j,k,l){l.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var m={aData:[]},n={aData:[]},o={aData:[]},p={aData:[]};a.logosTableParams=d.createNgTable({oInitialDataArrayWrapper:m,sDisplayedDataArrayName:"aDisplayedLogos"}),a.deficiencyStatusesTableParams=d.createNgTable({oInitialDataArrayWrapper:n,sDisplayedDataArrayName:"aDisplayedDeficiencyStatuses"}),a.activityTypesTableParams=d.createNgTable({oInitialDataArrayWrapper:o,sDisplayedDataArrayName:"aDisplayedActivityTypes"}),a.reportsTemplatesTableParams=d.createNgTable({oInitialDataArrayWrapper:p,sDisplayedDataArrayName:"aDisplayedReportsTemplates"});var q=function(a,b,c){for(var d=0;d<a.length;d++){var e={};e.sUrl=j.location.origin+j.location.pathname+"rest/file/v2/get/"+a[d].guid,e.sDescriptionEN=a[d].descriptionEN,e.sDescriptionFR=a[d].descriptionFR,e._createMode=!1,e._editMode=!1,e._guid=a[d].guid,b.push(e)}c.reload()},r=function(a,b){var c={};c._createMode=!0,c._editMode=!1,a.push(c),b.reload()};a.onEdit=function(a){a._editMode=!0};var s=function(a,b,c,e){c._guid&&d.deleteFileAttachment(c._guid),a.splice(e,1),b.reload()},t=function(a,b,c,d){c._guid||s(a,b,c,d),c._editMode=!1,c._createMode=!1},u=function(b,c,e,f,g){for(var h=0;h<b.length;h++){var k=b[h],c=d.costructUploadUrl({sPath:c});a.upload=i.upload({url:c,file:k}),a.upload.success(function(a){e[g]._createMode=!1,e[g]._editMode=!1,e[g].sUrl=j.location.origin+j.location.pathname+"rest/file/v2/get/"+a,e[g]._guid=a})}};onLogoImgsLoaded=function(b){q(b,m.aData,a.logosTableParams)},onDeficienciesStatusesImgsLoaded=function(b){q(b,n.aData,a.deficiencyStatusesTableParams)},onActivitiesTypesImgsLoaded=function(b){q(b,o.aData,a.activityTypesTableParams)},onReportsTemplatesLoaded=function(b){q(b,p.aData,a.reportsTemplatesTableParams)},g.getAttachments({sPath:"rest/file/v1/list/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_logo_",onSuccess:onLogoImgsLoaded}),g.getAttachments({sPath:"rest/file/v1/list/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_deficiencyStatuses_",onSuccess:onDeficienciesStatusesImgsLoaded}),g.getAttachments({sPath:"rest/file/v1/list/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_activityTypes_",onSuccess:onActivitiesTypesImgsLoaded}),g.getAttachments({sPath:"rest/file/v1/list/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_reportsTemplates_",onSuccess:onReportsTemplatesLoaded}),a.onAddNewLogo=function(){r(m.aData,a.logosTableParams)},a.onDeleteLogo=function(b,c){s(m.aData,a.logosTableParams,b,c)},a.onSaveLogo=function(b,c){t(m.aData,a.logosTableParams,b,c)},a.onLogoSelected=function(a,b,c){u(a,"rest/file/v1/createUploadUrl/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_logo_",m.aData,b,c)},a.onAddNewDeficiencyStatus=function(){r(n.aData,a.deficiencyStatusesTableParams)},a.onDeleteDeficiencyStatus=function(b,c){s(n.aData,a.deficiencyStatusesTableParams,b,c)},a.onSaveDeficiencyStatus=function(b,c){t(n.aData,a.deficiencyStatusesTableParams,b,c)},a.onDeficiencyStatusSelected=function(a,b,c){u(a,"rest/file/v1/createUploadUrl/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_deficiencyStatuses_",n.aData,b,c)},a.onAddNewActivityType=function(){r(o.aData,a.activityTypesTableParams)},a.onDeleteActivityType=function(b,c){s(o.aData,a.activityTypesTableParams,b,c)},a.onSaveActivityType=function(b,c){t(o.aData,a.activityTypesTableParams,b,c)},a.onActivityTypeSelected=function(a,b,c){u(a,"rest/file/v1/createUploadUrl/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_activityTypes_",o.aData,b,c)},a.onAddNewReportTemplate=function(){r(p.aData,a.reportsTemplatesTableParams)},a.onDeleteReportTemplate=function(b,c){s(p.aData,a.reportsTemplatesTableParams,b,c)},a.onSaveReportTemplate=function(b,c){t(p.aData,a.reportsTemplatesTableParams,b,c),b._guid&&g.updateFileMetadata({sKey:b._guid,oData:{Guid:b._guid,DescriptionEN:b.sDescriptionEN,DescriptionFR:b.sDescriptionFR},bShowSpinner:!0,bShowSuccessMessage:!0,bShowErrorMessage:!0})},a.onReportTemplateSelected=function(a,b,c){u(a,"rest/file/v1/createUploadUrl/companyDependentSettings/"+k.oUserProfile.sCurrentCompany+"/_reportsTemplates_",p.aData,b,c)}}]),viewControllers.controller("taskTypeListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var k={aData:[]},l=0,m={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:m,sDisplayedDataArrayName:"aDisplayedTaskTypes",oInitialSorting:{sortingSequence:"asc"}});var n=function(a){for(var b=0;b<a.length;b++)a[b]._sortingSequence=a[b].GeneralAttributes.SortingSequence;a=f("orderBy")(a,["_sortingSequence"]),d.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:m,oNewParentItemArrayWrapper:k,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_unitOptionSetGuid",sTargetArrayNameInParent:"aUnitOptionSets"})},o=function(b){for(var c=0;c<b.length;c++){var d={};d._editMode=!1,d._guid=b[c].Guid,d._lastModifiedAt=b[c].LastModifiedAt,d.nameEN=b[c].NameEN,d.nameFR=b[c].NameFR,d.sortingSequence=b[c].GeneralAttributes.SortingSequence,b[c].UnitOptionSetDetails&&(d._unitOptionSetGuid=b[c].UnitOptionSetDetails.Guid),m.aData.push(d)}a.tableParams.reload(),g.getUnitOptionSets({bShowSpinner:!1,onSuccess:n})};g.getTaskTypes({bShowSpinner:!0,onSuccess:o}),a.onAddNew=function(){m.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:l,aUnitOptionSets:angular.copy(k.aData)}),l++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<m.aData.length;c++)if(m.aData[c]._guid===b._guid){m.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateTaskType({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<m.aData.length;e++)if(m.aData[e]._counter===b._counter){m.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt;for(var e=0;e<a.aUnitOptionSets.length;e++)if(a.aUnitOptionSets[e].ticked){b.UnitOptionSetGuid=a.aUnitOptionSets[e].Guid;break}a._guid?(b.Guid=a._guid,g.updateTaskType({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createTaskType({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("unitOptionSetListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var k={aData:[]},l=0,m={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:m,sDisplayedDataArrayName:"aDisplayedUnitOptionSets",oInitialSorting:{sortingSequence:"asc"}});var n=function(a){for(var b=0;b<a.length;b++){a[b]._sortingSequence=a[b].GeneralAttributes.SortingSequence;for(var c=0;c<a[b].PhaseDetails.results.length;c++){if(a[b].PhaseDetails.results[c].GeneralAttributes.IsDeleted){a[b].PhaseDetails.results.splice(c,1);break}a[b].PhaseDetails.results[c]._sortingSequence=a[b].PhaseDetails.results[c].GeneralAttributes.SortingSequence}a[b].PhaseDetails.results=f("orderBy")(a[b].PhaseDetails.results,["_sortingSequence"])}a=f("orderBy")(a,["_sortingSequence"]),d.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:m,oNewParentItemArrayWrapper:k,sSecondLevelAttribute:"PhaseDetails",sSecondLevelNameEN:"NameEN",sSecondLevelNameFR:"NameFR",sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKeys:"_unitOptionSetGuids",sTargetArrayNameInParent:"aPhases"})},o=function(b){for(var c=0;c<b.length;c++){var d={};if(d._editMode=!1,d._guid=b[c].Guid,d._lastModifiedAt=b[c].LastModifiedAt,d.nameEN=b[c].NameEN,d.nameFR=b[c].NameFR,d.sortingSequence=b[c].GeneralAttributes.SortingSequence,d._unitOptionSetGuids=[],b[c].PhaseDetails&&b[c].PhaseDetails.results)for(var e=0;e<b[c].PhaseDetails.results.length;e++)d._unitOptionSetGuids.push(b[c].PhaseDetails.results[e].Guid);m.aData.push(d)}a.tableParams.reload(),g.getProjectsWithPhases({bShowSpinner:!1,onSuccess:n})};g.getUnitOptionSets({bShowSpinner:!0,onSuccess:o}),a.onAddNew=function(){m.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:l,aPhases:angular.copy(k.aData)}),l++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<m.aData.length;c++)if(m.aData[c]._guid===b._guid){m.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateUnitOptionSet({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<m.aData.length;e++)if(m.aData[e]._counter===b._counter){m.aData.splice(e,1),a.tableParams.reload();break}};var p=function(a){for(var b=[],c=[],d="",e=0;e<a.aPhases.length;e++)a.aPhases[e].ticked&&(d="Phases('"+a.aPhases[e].Guid+"')",c.push(d));return c.length&&b.push({sRelationName:"PhaseDetails",aUri:c}),b};a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt;var e=p(a);a._guid?(b.Guid=a._guid,g.updateUnitOptionSet({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d,aLinks:e})):g.createUnitOptionSet({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c,aLinks:e})}}]),viewControllers.controller("unitOptionValueListView",["$scope","$rootScope","$state","servicesProvider","ngTableParams","$filter","apiProvider","$translate","cacheProvider","historyProvider",function(a,b,c,d,e,f,g,h,i,j){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={};var k={aData:[]},l=0,m={aData:[]};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:m,sDisplayedDataArrayName:"aDisplayedUnitOptionValues",oInitialSorting:{sortingSequence:"asc"}});var n=function(a){for(var b=0;b<a.length;b++)a[b]._sortingSequence=a[b].GeneralAttributes.SortingSequence;a=f("orderBy")(a,["_sortingSequence"]),d.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:a},oParentArrayWrapper:m,oNewParentItemArrayWrapper:k,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",sParentKey:"_unitOptionSetGuid",sTargetArrayNameInParent:"aUnitOptionSets"})},o=function(b){for(var c=0;c<b.length;c++){var d={};d._editMode=!1,d._guid=b[c].Guid,d._lastModifiedAt=b[c].LastModifiedAt,d.nameEN=b[c].NameEN,d.nameFR=b[c].NameFR,d.sortingSequence=b[c].GeneralAttributes.SortingSequence,b[c].UnitOptionSetDetails&&(d._unitOptionSetGuid=b[c].UnitOptionSetDetails.Guid),m.aData.push(d)}a.tableParams.reload(),g.getUnitOptionSets({bShowSpinner:!1,onSuccess:n})};g.getUnitOptionValues({bShowSpinner:!0,onSuccess:o}),a.onAddNew=function(){m.aData.push({_editMode:!0,sortingSequence:0,nameEN:"",nameFR:"",_counter:l,aUnitOptionSets:angular.copy(k.aData)}),l++,a.tableParams.reload()},a.onEdit=function(a){a._editMode=!0},a.onDelete=function(b){var c={GeneralAttributes:{IsDeleted:!0}},d=function(){for(var c=0;c<m.aData.length;c++)if(m.aData[c]._guid===b._guid){m.aData.splice(c,1);break}a.tableParams.reload()};if(b._guid)c.Guid=b._guid,c.LastModifiedAt=b._lastModifiedAt,g.updateUnitOptionValue({bShowSpinner:!0,sKey:c.Guid,oData:c,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d});else for(var e=0;e<m.aData.length;e++)if(m.aData[e]._counter===b._counter){m.aData.splice(e,1),a.tableParams.reload();break}},a.onSave=function(a){var b={GeneralAttributes:{}},c=function(b){a._guid=b.Guid,a._lastModifiedAt=b.LastModifiedAt,a._editMode=!1},d=function(b){a._editMode=!1,a._lastModifiedAt=b.LastModifiedAt};b.NameEN=a.nameEN,b.NameFR=a.nameFR,b.GeneralAttributes.SortingSequence=a.sortingSequence,b.LastModifiedAt=a._lastModifiedAt;for(var e=0;e<a.aUnitOptionSets.length;e++)if(a.aUnitOptionSets[e].ticked){b.UnitOptionSetGuid=a.aUnitOptionSets[e].Guid;break}a._guid?(b.Guid=a._guid,g.updateUnitOptionValue({bShowSpinner:!0,sKey:b.Guid,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})):g.createUnitOptionValue({bShowSpinner:!0,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:c})}}]),viewControllers.controller("userDetailsView",["$scope","$rootScope","$state","$stateParams","servicesProvider","apiProvider","$translate","cacheProvider","utilsProvider","$filter","dataProvider","$window","$upload","CONSTANTS","historyProvider","rolesSettings",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){a.oForms={};var q=d.sUserName,r=!1,s={};a.bShowBackButton=o.aHistoryStates.length>0?!0:!1;var t=h.oUserProfile.sCurrentRole;a.oUserProfile=h.oUserProfile,a.bIsGlobalUserAdministrator=p[t].bIsGlobalUserAdministrator,a.bDisplayEditButton=p.getRolesSettingsForEntityAndOperation({sRole:t,sEntityName:"oUser",sOperation:"bUpdate"}),a.bDisplayDeleteButton=p.getRolesSettingsForEntityAndOperation({sRole:t,sEntityName:"oUser",sOperation:"bDelete"}),b.sCurrentStateName=c.current.name,b.oStateParams=angular.copy(d),a.sMode=d.sMode,a.oUser={_aCompanies:[],_aPhases:[],_aRoles:[]};var u={aData:[{}]};a.aCompanies=[],a.aRoles=[],a.aPhases=[],a.aContacts=[],a.aLanguages=[];var v=function(){var b=[];b.push({languageCode:"en",descriptionEN:"English",descriptionFR:"Anglais"}),b.push({languageCode:"fr",descriptionEN:"French",descriptionFR:"Français"}),e.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:u,sNameEN:"descriptionEN",sNameFR:"descriptionFR",sDependentKey:"languageCode",sParentKey:"_sLanguage",sTargetArrayNameInParent:"aLanguages"}),u.aData[0]&&(a.aLanguages=angular.copy(u.aData[0].aLanguages))},w=function(b){if(a.oUser.sUserName=b.UserName,a.oUser.sEmail=b.EMail,a.oUser._lastModifiedAt=b.LastModifiedAt,a.oUser.sCreatedAt=i.dBDateToSting(b.CreatedAt),a.oUser.sLastModifiedAt=i.dBDateToSting(b.LastModifiedAt),a.oUser._aCompanies=angular.copy(b.CompanyDetails.results),a.oUser._aPhases=angular.copy(b.PhaseDetails.results),a.oUser._aRoles=angular.copy(b.RoleDetails.results),b.ContactDetails&&b.ContactDetails.results&&b.ContactDetails.results.length)for(var c=0;c<b.ContactDetails.results.length;c++)if(b.ContactDetails.results[c].CompanyName===h.oUserProfile.sCurrentCompany){a.oUser._contactGuid=b.ContactDetails.results[c].Guid;break}a.oUser._sLanguage=b.Language,u.aData[0]=angular.copy(a.oUser)},x=h.getEntityDetails({sCacheProviderAttribute:"oUserEntity",sRequestSettings:"GeneralAttributes/IsDeleted eq falseCompanyDetails,PhaseDetails,RoleDetails",sKeyName:"UserName",sKeyValue:d.sUserName}),y=function(b){for(var c=0;c<b.length;c++)b[c]._sortingSequence=b[c].GeneralAttributes.SortingSequence;b=j("orderBy")(b,["_sortingSequence"]);for(var d=[],c=0;c<a.oUser._aCompanies.length;c++)d.push(a.oUser._aCompanies[c].CompanyName);e.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:u,sNameEN:"CompanyName",sNameFR:"CompanyName",sDependentKey:"CompanyName",aParentKeys:d,sTargetArrayNameInParent:"aCompanies"}),u.aData[0]&&(a.aCompanies=angular.copy(u.aData[0].aCompanies))},z=function(b){for(var c=0;c<b.length;c++)b[c]._sortingSequence=b[c].GeneralAttributes.SortingSequence;b=j("orderBy")(b,["_sortingSequence"]);for(var d=[],c=0;c<a.oUser._aRoles.length;c++)d.push(a.oUser._aRoles[c].Guid);e.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:u,sNameEN:"RoleName",sNameFR:"RoleName",sDependentKey:"Guid",aParentKeys:d,sTargetArrayNameInParent:"aRoles"}),u.aData[0]&&(a.aRoles=angular.copy(u.aData[0].aRoles))},A=function(b){for(var c=0;c<b.length;c++){b[c]._sortingSequence=b[c].GeneralAttributes.SortingSequence;for(var d=0;d<b[c].PhaseDetails.results.length;d++){if(b[c].PhaseDetails.results[d].GeneralAttributes.IsDeleted){b[c].PhaseDetails.results.splice(d,1);break}b[c].PhaseDetails.results[d]._sortingSequence=b[c].PhaseDetails.results[d].GeneralAttributes.SortingSequence}b[c].PhaseDetails.results=j("orderBy")(b[c].PhaseDetails.results,["_sortingSequence"])}b=j("orderBy")(b,["_sortingSequence"]);for(var f=[],c=0;c<a.oUser._aPhases.length;c++)f.push(a.oUser._aPhases[c].Guid);e.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},sSecondLevelAttribute:"PhaseDetails",sSecondLevelNameEN:"NameEN",sSecondLevelNameFR:"NameFR",oParentArrayWrapper:u,sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",aParentKeys:f,sTargetArrayNameInParent:"aPhases"}),u.aData[0]&&(a.aPhases=angular.copy(u.aData[0].aPhases))},B=function(b){b=j("orderBy")(b,["FirstName"]);for(var c=0;c<b.length;c++)b[c].LastName?b[c].sFullName=b[c].FirstName+" "+b[c].LastName+",  "+b[c].AccountDetails.Name:b[c].sFullName=b[c].FirstName+",  "+b[c].AccountDetails.Name;e.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:b},oParentArrayWrapper:u,sNameEN:"sFullName",sNameFR:"sFullName",sDependentKey:"Guid",sParentKey:"_contactGuid",sTargetArrayNameInParent:"aContacts"}),u.aData[0]&&(a.aContacts=angular.copy(u.aData[0].aContacts))},C=function(a){w(a),f.getCompanies({bShowSpinner:!1,onSuccess:y}),f.getProjectsWithPhases({bShowSpinner:!1,onSuccess:A}),f.getRoles({bShowSpinner:!1,onSuccess:z}),f.getContacts({sExpand:"AccountDetails",bShowSpinner:!0,onSuccess:B}),v()},D=function(){f.getUserWithCompaniesPhasesAndRoles({sKey:q,bShowSpinner:!0,onSuccess:C})};"create"!==a.sMode?angular.equals(x,{})?D():(w(x),f.getCompanies({bShowSpinner:!1,onSuccess:y}),f.getProjectsWithPhases({bShowSpinner:!1,onSuccess:A}),f.getRoles({bShowSpinner:!1,onSuccess:z}),f.getContacts({sExpand:"AccountDetails",bShowSpinner:!0,onSuccess:B}),v()):(a.oUser.sAvatarUrl=l.location.origin+l.location.pathname+"img/noAvatar.jpg",f.getCompanies({bShowSpinner:!1,onSuccess:y}),f.getProjectsWithPhases({bShowSpinner:!1,onSuccess:A}),f.getRoles({bShowSpinner:!1,onSuccess:z}),f.getContacts({sExpand:"AccountDetails",bShowSpinner:!0,onSuccess:B}),v()),a.onBack=function(){o.navigateBack({oState:c})},a.onEdit=function(){c.go("app.adminPanel.userDetails",{sMode:"edit",sUserName:a.oUser.sUserName})};var E=function(){var b={GeneralAttributes:{IsDeleted:!0}},d=function(){o.navigateBack({oState:c})};b.UserName=a.oUser.sUserName,b.LastModifiedAt=a.oUser._lastModifiedAt,f.updateUser({bShowSpinner:!0,sKey:b.UserName,oData:b,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:d})};a.onDelete=function(a){e.showConfirmationPopup({sHeader:g.instant("userDetails_deletionConfirmationHeader"),sContent:g.instant("userDetails_deletionConfirmationContent"),sOk:g.instant("global_ok"),sCancel:g.instant("global_cancel"),onOk:E,event:a})};var F=function(){var b=[],c=[],d="";if(a.aSelectedCompanies&&a.aSelectedCompanies.length)for(var e=0;e<a.aSelectedCompanies.length;e++)d="Companys('"+a.aSelectedCompanies[e].CompanyName+"')",c.push(d);if(b.push({sRelationName:"CompanyDetails",bKeepCompanyDependentLinks:!1,aUri:c}),c=[],a.aSelectedRoles&&a.aSelectedRoles.length)for(var e=0;e<a.aSelectedRoles.length;e++)d="Roles('"+a.aSelectedRoles[e].Guid+"')",c.push(d);if(b.push({sRelationName:"RoleDetails",bKeepCompanyDependentLinks:!0,aUri:c}),c=[],a.aSelectedPhases&&a.aSelectedPhases.length)for(var e=0;e<a.aSelectedPhases.length;e++)d="Phases('"+a.aSelectedPhases[e].Guid+"')",c.push(d);if(b.push({sRelationName:"PhaseDetails",bKeepCompanyDependentLinks:!0,aUri:c}),c=[],a.aSelectedContacts&&a.aSelectedContacts.length)for(var e=0;e<a.aSelectedContacts.length;e++)d="Contacts('"+a.aSelectedContacts[e].Guid+"')",c.push(d);return b.push({sRelationName:"ContactDetails",bKeepCompanyDependentLinks:!0,aUri:c}),c=[],b};

a.onDataModified=function(){r=!0},a.onSave=function(b,d){if(a.oForms.userDetailsForm.username&&a.oForms.userDetailsForm.username.$setDirty(),a.oForms.userDetailsForm.email&&a.oForms.userDetailsForm.email.$setDirty(),a.oForms.userDetailsForm.password&&a.oForms.userDetailsForm.password.$setDirty(),a.oForms.userDetailsForm.passwordConfirmation&&a.oForms.userDetailsForm.passwordConfirmation.$setDirty(),a.oForms.userDetailsForm.$valid){var j=new Hashes.SHA512,k={GeneralAttributes:{}},m=[],n=function(e){return r=!1,d?void c.go(d.toState,d.toParams):void(b?(a.oUser.sUserName="",a.oUser.sEmail="",a.oUser._aCompanies=[],a.oUser._aPhases=[],a.oUser._aRoles=[],a.oUser.sPassword="",a.oUser.sPasswordConfirmation="",a.oUser.sAvatarUrl=l.location.origin+l.location.pathname+"img/noAvatar.jpg"):(c.go("app.adminPanel.userDetails",{sMode:"display",sUserName:e.UserName}),a.oUser._lastModifiedAt=e.LastModifiedAt,a.oUser.sLastModifiedAt=i.dBDateToSting(e.LastModifiedAt),a.oUser.sCreatedAt=i.dBDateToSting(e.CreatedAt),a.oUser.sPassword="",a.oUser.sPasswordConfirmation=""))},o=function(b){return b.UserName===h.oUserProfile.sUserName&&e.refreshUserProfile(),r=!1,d?void c.go(d.toState,d.toParams):(a.oUser._lastModifiedAt=b.LastModifiedAt,a.oUser.sLastModifiedAt=i.dBDateToSting(b.LastModifiedAt),a.oUser.sPassword="",a.oUser.sPasswordConfirmation="",void c.go("app.adminPanel.userDetails",{sMode:"display",sUserName:b.UserName}))};if(k.UserName=a.oUser.sUserName,k.EMail=a.oUser.sEmail,k.LastModifiedAt=a.oUser._lastModifiedAt,k.AvatarFileGuid=a.oUser._avatarFileGuid,a.oUser.sPassword&&a.oUser.sPassword===a.oUser.sPasswordConfirmation&&(k.Password=f.hashPassword(j.hex(a.oUser.sPassword)),k.IsPasswordInitial=!0),a.oUser.sPassword!==a.oUser.sPasswordConfirmation)return void i.displayMessage({sText:g.instant("global_passwordsDontMatch"),sType:"error"});for(var p=0;p<a.aLanguages.length;p++)if(a.aLanguages[p].ticked){k.Language=a.aLanguages[p].languageCode;break}switch(m=F(),a.sMode){case"edit":f.updateUser({bShowSpinner:!0,sKey:k.UserName,oData:k,aLinks:m,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:o});break;case"create":if(!k.Password)return void i.displayMessage({sText:g.instant("global_noInitialPasswordProvided"),sType:"error"});f.createUser({bShowSpinner:!0,oData:k,aLinks:m,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:n})}}},a.onSaveAndNew=function(){a.onSave(!0)};var G=function(b,c,d){for(var f=0;f<b.length;f++){var g=b[f],c=e.costructUploadUrl({sPath:c});a.upload=m.upload({url:c,file:g}),a.upload.success(function(b){a.oUser.sAvatarUrl=l.location.origin+l.location.pathname+"rest/file/v2/get/"+b,a.oUser._avatarFileGuid=b})}};a.onAvatarSelected=function(b,c){a.onDataModified(),G(b,"rest/file/v1/createUploadUrl/users/users/_avatar_",c)};var H=function(){a.onSave(!1,s)},I=function(){r=!1,c.go(s.toState,s.toParams)};a.$on("$stateChangeStart",function(a,b,c,d,f){r&&(a.preventDefault(),s={toState:b,toParams:c},e.showConfirmationPopup({sHeader:g.instant("global_changesSaveConfirmationHeader"),sContent:g.instant("global_changesSaveConfirmationContent"),sOk:g.instant("global_yes"),sCancel:g.instant("global_no"),onOk:H,onCancel:I,event:a}))}),a.$on("$destroy",function(){o.getPreviousStateName()!==b.sCurrentStateName&&o.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:angular.copy(b.oStateParams)})})}]),viewControllers.controller("usersListView",["$scope","$rootScope","$state","servicesProvider","apiProvider","$translate","$window","cacheProvider","CONSTANTS","historyProvider","rolesSettings","$filter",function(a,b,c,d,e,f,g,h,i,j,k,l){j.removeHistory(),b.sCurrentStateName=c.current.name,b.oStateParams={},a.sCurrentRole=h.oUserProfile.sCurrentRole,a.bIsGlobalUserAdministrator=k[a.sCurrentRole].bIsGlobalUserAdministrator,a.bDisplayAddButton=k.getRolesSettingsForEntityAndOperation({sRole:a.sCurrentRole,sEntityName:"oUser",sOperation:"bCreate"}),a.bDisplayEditButtons=k.getRolesSettingsForEntityAndOperation({sRole:a.sCurrentRole,sEntityName:"oUser",sOperation:"bUpdate"});var m={aData:[]},n={};a.tableParams=d.createNgTable({oInitialDataArrayWrapper:m,sDisplayedDataArrayName:"aDisplayedUsers",sGroupBy:"sCompany",sGroupsSortingAttribue:"_sortingSequence",oInitialFilter:n,oInitialSorting:{userName:"asc"}});var o=function(a){for(var b=0;b<m.aData.length;b++){m.aData[b].sRoles="";for(var c=0;c<m.aData[b]._roleDetails.results.length;c++)for(var d=0;d<a.length;d++)if(m.aData[b]._roleDetails.results[c].Guid===a[d].Guid){m.aData[b].sRoles=m.aData[b].sRoles+a[d].RoleName+"; ";break}}},p=function(b){for(var c=[],d=[],g=[],i=!1,j=0;j<b.length;j++){i=!1,bIsUserAssignedToCurrentCompany=!1,d=[],g=[];for(var n=0;n<b[j].RoleDetails.results.length;n++)if(k[b[j].RoleDetails.results[n].RoleName]&&k[b[j].RoleDetails.results[n].RoleName].bIsGlobalUserAdministrator&&b[j].UserName!==h.oUserProfile.sUserName){i=!0;break}for(var n=0;n<b[j].CompanyDetails.results.length;n++){if(b[j]._sortingSequence=b[j].CompanyDetails.results[n].GeneralAttributes.SortingSequence,b[j].sCompany="en"===f.use()?b[j].CompanyDetails.results[n].DescriptionEN:b[j].CompanyDetails.results[n].DescriptionFR,b[j].sCompany||(b[j].sCompany=b[j].CompanyDetails.results[n].DescriptionEN),b[j].CompanyDetails.results[n].CompanyName===h.oUserProfile.sCurrentCompany&&g.push(angular.copy(b[j])),b[j].ContactDetails.results){b[j].sAssociatedContact="";for(var p=0;p<b[j].ContactDetails.results.length;p++)"Conspector"===h.oUserProfile.sCurrentCompany?b[j].ContactDetails.results[p].FirstName&&b[j].ContactDetails.results[p].LastName?b[j].sAssociatedContact=b[j].sAssociatedContact+b[j].ContactDetails.results[p].FirstName+" "+b[j].ContactDetails.results[p].LastName+" ":b[j].sAssociatedContact=b[j].sAssociatedContact+b[j].ContactDetails.results[p].FirstName+" ":b[j].ContactDetails.results[p].FirstName&&b[j].ContactDetails.results[p].LastName&&b[j].ContactDetails.results[p].CompanyName===h.oUserProfile.sCurrentCompany?b[j].sAssociatedContact=b[j].sAssociatedContact+b[j].ContactDetails.results[p].FirstName+" "+b[j].ContactDetails.results[p].LastName+" ":b[j].ContactDetails.results[p].FirstName&&b[j].ContactDetails.results[p].CompanyName===h.oUserProfile.sCurrentCompany&&(b[j].sAssociatedContact=b[j].sAssociatedContact+b[j].ContactDetails.results[p].FirstName+" ")}d.push(angular.copy(b[j]))}if(!k[h.oUserProfile.sCurrentRole].bIsGlobalUserAdministrator&&!i)for(var n=0;n<g.length;n++)c.push(angular.copy(g[n]));if(k[h.oUserProfile.sCurrentRole].bIsGlobalUserAdministrator)for(var n=0;n<d.length;n++)c.push(angular.copy(d[n]))}c=l("orderBy")(c,["_sortingSequence"]);for(var j=0;j<c.length;j++)m.aData.push({userName:c[j].UserName,email:c[j].EMail,_roleDetails:c[j].RoleDetails,_companyDetails:c[j].CompanyDetails,_lastModifiedAt:c[j].LastModifiedAt,roles:"",sAssociatedContact:c[j].sAssociatedContact,sCompany:c[j].sCompany,_sortingSequence:c[j]._sortingSequence});a.tableParams.reload(),e.getRoles({bShowSpinner:!1,onSuccess:o})};e.getUsers({sExpand:"CompanyDetails,PhaseDetails,RoleDetails,ContactDetails",bShowSpinner:!0,onSuccess:p}),a.onDisplay=function(a){c.go("app.adminPanel.userDetails",{sMode:"display",sUserName:a.userName})},a.onEdit=function(a){c.go("app.adminPanel.userDetails",{sMode:"edit",sUserName:a.userName})},a.onAddNew=function(){c.go("app.adminPanel.userDetails",{sMode:"create",sUserName:""})},a.$on("$destroy",function(){j.getPreviousStateName()!==b.sCurrentStateName&&j.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams})})}]),viewControllers.controller("attachmentsListView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider","$mdSidenav","$window","$filter","rolesSettings","$upload","utilsProvider","CONSTANTS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){b.sCurrentStateName=c.current.name,a.sCurrentRole=h.oUserProfile.sCurrentRole;var q="",r="",s="";switch(b.sCurrentStateName){case"app.deficiencyDetailsWrapper.deficiencyDetails":q="Deficiency",r="Tasks",s="oDeficiencyEntity";break;case"app.activityDetailsWrapper.activityDetails":q="Activity",r="Activitys",s="oActivityEntity";break;case"app.unitDetailsWrapper.unitDetails":q="Unit",r="Units",s="oUnitEntity"}var t={aData:[]},u="";a.clickUploadButton=function(){angular.element("#uploadFilesToDeficiency").trigger("click")},d.sDeficiencyGuid&&(u=d.sDeficiencyGuid),d.sActivityGuid&&(u=d.sActivityGuid),d.sUnitGuid&&(u=d.sUnitGuid),a.tableParams=e.createNgTable({oInitialDataArrayWrapper:t,sDisplayedDataArrayName:"aDisplayedAttachments",oInitialSorting:{_createdAt:"desc"},oInitialFilter:{},aInitialGroupsSettings:{},sGroupBy:"sMediaType",sGroupsSortingAttribue:"_sortingSequence"});var v=function(c){for(var d="",e=0,f=0,g=[],h=0;h<c.FileMetadataDetails.results.length;h++)d="",f=0,c.FileMetadataDetails.results[h].MediaType&&(c.FileMetadataDetails.results[h].MediaType.indexOf("image")>-1&&(d="Image",e++,f=1,g.push(c.FileMetadataDetails.results[h])),c.FileMetadataDetails.results[h].MediaType.indexOf("pdf")>-1&&(d="PDF",f=2)),d||(d="Other",f=3),t.aData.push({_guid:c.FileMetadataDetails.results[h].Guid,sMediaType:d,sOriginalFileName:c.FileMetadataDetails.results[h].OriginalFileName,_lastModifiedAt:c.FileMetadataDetails.results[h].LastModifiedAt,_sortingSequence:f,_createdAt:c.FileMetadataDetails.results[h].CreatedAt,sCreatedAt:o.dBDateToSting(c.FileMetadataDetails.results[h].CreatedAt),sCreatedBy:c.FileMetadataDetails.results[h].NewFileName});b.iImagesNumber=e,b._aImages=angular.copy(g),a.tableParams.reload()},w=function(){b.sFileMetadataSetGuid&&(t.aData=[],g.getEntityAttachments({sKey:b.sFileMetadataSetGuid,sExpand:"FileMetadataDetails",bShowSpinner:!0,onSuccess:v}))};w(),a.onFilesSelected=function(a,c){var d=function(a){},f=function(){h.cleanEntitiesCache(s),"create"===b.sMode&&(b.bDataHasBeenModified=!0),w();var a="";if("oDeficiencyEntity"===s){var c=function(a){g.logEvents({aData:a})};if(u){switch(s){case"oDeficiencyEntity":a="deficiency";break;case"oActivityEntity":a="activity"}g.getInterestedUsers({sEntityName:a,sOperationNameEN:"notificationsList_newAttachment",sOperationNameFR:"",aData:[{Guid:u}],onSuccess:c})}}};e.uploadAttachmentsForEntity({sPath:r,aFiles:a,sParentEntityGuid:u,sParentEntityFileMetadataSetGuid:b.sFileMetadataSetGuid,onSuccess:f,onProgress:d})},a.onDisplay=function(a,b){return"Other"===a.sMediaType?void b.target.nextElementSibling.click():void k.open("rest/file/v2/get/"+a._guid)},a.onDelete=function(a){var b={GeneralAttributes:{IsDeleted:!0}},c=function(){h.cleanEntitiesCache(s),w()};a._guid&&(b.Guid=a._guid,b.LastModifiedAt=a._lastModifiedAt,g.updateEntityAttachment({sKey:a._guid,oData:b,bShowSpinner:!0,onSuccess:c}))}}]),viewControllers.controller("commentsListView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","historyProvider","$mdSidenav","$window","$filter","rolesSettings","$upload","utilsProvider","CONSTANTS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){b.sCurrentStateName=c.current.name;var q="",r="",s="";switch(b.sCurrentStateName){case"app.deficiencyDetailsWrapper.deficiencyDetails":q="Deficiency",r="Tasks",s="oDeficiencyEntity";break;case"app.activityDetailsWrapper.activityDetails":q="Activity",r="Activitys",s="oActivityEntity";break;case"app.unitDetailsWrapper.unitDetails":q="Unit",r="Units",s="oUnitEntity"}a.oComment={};var t={aData:[]},u="";d.sDeficiencyGuid&&(u=d.sDeficiencyGuid),d.sActivityGuid&&(u=d.sActivityGuid),a.tableParams=e.createNgTable({oInitialDataArrayWrapper:t,sDisplayedDataArrayName:"aDisplayedComments",oInitialSorting:{_createdAt:"asc"},oInitialFilter:{},aInitialGroupsSettings:{}});var v=function(b){t.aData=angular.copy(e.processListOfComments({oData:b})),a.tableParams.reload()},w=function(){b.sCommentSetGuid&&(t.aData=[],g.getEntityComments({sKey:b.sCommentSetGuid,sExpand:"CommentDetails/ContactDetails/UserDetails",bShowSpinner:!0,onSuccess:v}))};w(),a.onEdit=function(a){return a._userName!==h.oUserProfile.sUserName?void o.displayMessage({sText:f.instant("global_onlyOwnCommetsCanBeModified"),sType:"error"}):void(a._editMode=!0)},a.onDelete=function(a){var b={GeneralAttributes:{IsDeleted:!0}},c=function(){h.cleanEntitiesCache(s),w()};b.LastModifiedAt=a._lastModifiedAt,g.updateComment({bShowSpinner:!0,sKey:a._guid,oData:b,bShowErrorMessage:!0,onSuccess:c})},a.onSaveUpdate=function(a){var b={},c=function(){a._editMode=!1};b.LastModifiedAt=a._lastModifiedAt,b.Text=a.sText,g.updateComment({bShowSpinner:!0,sKey:a._guid,oData:b,bShowErrorMessage:!0,onSuccess:c})},a.onSave=function(){var c=function(){a.oComment.sText="",h.cleanEntitiesCache(s),w();var b="";if("oDeficiencyEntity"===s){var c=function(a){g.logEvents({aData:a})};if(u){switch(s){case"oDeficiencyEntity":b="deficiency";break;case"oActivityEntity":b="activity"}g.getInterestedUsers({sEntityName:b,sOperationNameEN:"notificationsList_newComment",sOperationNameFR:"",aData:[{Guid:u}],onSuccess:c})}}},d={GeneralAttributes:{}};d.ContactGuid=h.oUserProfile.oUserContact.Guid,d.Text=a.oComment.sText,e.addCommentForEntity({sPath:r,oData:d,sParentEntityGuid:u,sParentEntityCommentSetGuid:b.sCommentSetGuid,onSuccess:c})}}]),viewControllers.controller("notificationsListView",["$scope","$rootScope","$state","$stateParams","servicesProvider","$translate","apiProvider","cacheProvider","utilsProvider","historyProvider","$mdSidenav","$window","$filter","$cookieStore","rolesSettings","$timeout","CONSTANTS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){h.oUserProfile.sUserName,h.oUserProfile.sCurrentCompany,h.oUserProfile.sCurrentRole;b.sCurrentStateName=c.current.name,b.oStateParams={},a.aDataForMassChanges=[];var r={aData:[]},s=h.getTableStatusFromCache({sTableName:"notificationsList",sStateName:b.sCurrentStateName}),t={_createdAt:"desc"};s&&!angular.equals(s.oSorting,{})&&(t=angular.copy(s.oSorting));var u={};s&&!angular.equals(s.oFilter,{})&&(u=angular.copy(s.oFilter));var v=[];s&&!angular.equals(s.aGroups,[])&&(v=angular.copy(s.aGroups)),a.tableParams=e.createNgTable({oInitialDataArrayWrapper:r,sDisplayedDataArrayName:"aDisplayedNotification",oInitialSorting:t,oInitialFilter:u,aInitialGroupsSettings:v,sGroupBy:"sProjectPhase",sGroupsSortingAttribue:"_sortingSequence"});var w=function(b){var c="",d="",e=(new Date,""),g=!1,j=0,k="",l="";r.aData=[];for(var m=0;m<b.length;m++){switch(c="",d="",e="",j=0,sStatus="",k="",l="",g=!1,b[m].PhaseDetails?(j=b[m].PhaseDetails.GeneralAttributes.SortingSequence,c="en"===f.use()?b[m].PhaseDetails.ProjectDetails.NameEN:b[m].PhaseDetails.ProjectDetails.NameFR,c||(c=b[m].PhaseDetails.ProjectDetails.NameEN),d="en"===f.use()?b[m].PhaseDetails.NameEN:b[m].PhaseDetails.NameFR,d||(d=b[m].PhaseDetails.NameEN),e=c+" - "+d):e="Not Assigned",b[m].OperationNameFR){case"Une nouvelle d??ficience a ??t?? ajout??e":b[m].OperationNameFR=q.newDeficiencyFR;break;case"Une d??ficience a ??t?? modifi??e":b[m].OperationNameFR=q.updatedDeficiencyFR;break;case"Un commentaire a ??t?? ajout??":b[m].OperationNameFR=q.newCommentFR;break;case"Un ficher a ??t?? ajout??":b[m].OperationNameFR=q.newAttachmentFR;break;case"Une nouvelle d??ficience a ??t?? ajout??e (mobile)":b[m].OperationNameFR=q.newDeficiencyFR+" (mobile)";break;case"Une d??ficience a ??t?? modifi??e (mobile)":b[m].OperationNameFR=q.updatedDeficiencyFR+" (mobile)";break;case"Un commentaire a ??t?? ajout?? (mobile)":b[m].OperationNameFR=q.newCommentFR+" (mobile)";break;case"Un ficher a ??t?? ajout?? (mobile)":b[m].OperationNameFR=q.newAttachmentFR+" (mobile)"}sOperationName="en"===f.use()?b[m].OperationNameEN:b[m].OperationNameFR,b[m].ContactDetails&&(b[m].ContactDetails.FirstName&&(k=b[m].ContactDetails.FirstName+" "),b[m].ContactDetails.LastName&&(k+=b[m].ContactDetails.LastName));var n=new Hashes.MD5;if(b[m].ContactDetails&&b[m].ContactDetails.UserDetails&&b[m].ContactDetails.UserDetails.results[0])var o=n.hex(b[m].ContactDetails.UserDetails.results[0].EMail);else var o=n.hex("deficien@cyDetails.com");l="http://www.gravatar.com/avatar/"+o+".png?d=identicon&s=60",r.aData.push({_guid:b[m].Guid,sProjectPhase:e,sStatus:b[m].Status,sEntityName:b[m].EntityName,_entityGuid:b[m].EntityGuid,sOperationName:sOperationName,_sortingSequence:j,_createdAt:b[m].CreatedAt,sCreatedAt:i.dBDateToSting(b[m].CreatedAt),sCreatedBy:b[m].GeneralAttributes.CreatedBy,sAuthor:k,sAvatarUrl:l})}a.tableParams.reload(),p(function(){$(".cnpAppView")[0]&&($(".cnpAppView")[0].scrollTop=h.getListViewScrollPosition("notificationsList"),h.putListViewScrollPosition("notificationsList",0))},0)},x=function(){r.aData=[],g.getOperationLogs({sExpand:"PhaseDetails/ProjectDetails,ContactDetails/UserDetails",sFilter:"CompanyName eq '"+h.oUserProfile.sCurrentCompany+"' and UserName eq '"+h.oUserProfile.sUserName+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:!0,onSuccess:w})};x(),a.onDisplay=function(a,b){switch(h.putListViewScrollPosition("notificationsList",$(".cnpAppView")[0].scrollTop),a.sEntityName){case"deficiency":c.go("app.deficiencyDetailsWrapper.deficiencyDetails",{sMode:"display",sDeficiencyGuid:a._entityGuid})}g.updateOperationLog({sKey:a._guid,oData:{Status:"read"}})},a.onClearFiltering=function(){a.tableParams.$params.filter={},a.tableParams.reload()},a.$on("notificationsShouldBeRefreshed",function(a){h.putListViewScrollPosition("notificationsList",$(".cnpAppView")[0].scrollTop),x()}),a.onStatusChange=function(b){a.bDisplayEditButtons&&(b.sStatuseIconUrl=l.location.origin+l.location.pathname+"rest/file/v2/get/"+aTaskStatuses[(b.sStatusSortingSequence+1)%aTaskStatuses.length].AssociatedIconFileGuid,a.aDataForMassChanges.push({Guid:b._guid,TaskStatusGuid:aTaskStatuses[(b.sStatusSortingSequence+1)%aTaskStatuses.length].Guid}),b.sStatusSortingSequence=(b.sStatusSortingSequence+1)%aTaskStatuses.length,b._guid="!!!")},a.onMassSave=function(){h.putListViewScrollPosition("notificationsList",$(".cnpAppView")[0].scrollTop);var b=function(){a.aDataForMassChanges=[],x()};g.updateNotifications({aData:a.aDataForMassChanges,bShowSpinner:!0,bShowSuccessMessage:!0,bShowErrorMessage:!0,onSuccess:b})},a.onMarkAllAsRead=function(){for(var b=function(){x()},c=[],d=0;d<a.tableParams.data.length;d++)for(var e=0;e<a.tableParams.data[d].data.length;e++)"not read"===a.tableParams.data[d].data[e].sStatus&&c.push({Guid:a.tableParams.data[d].data[e]._guid,Status:"read"});c.length&&g.updateOperationLogs({aData:c,onSuccess:b})},a.onDismissAll=function(){for(var b=function(){x()},c=[],d=0;d<a.tableParams.data.length;d++)for(var e=0;e<a.tableParams.data[d].data.length;e++)c.push({Guid:a.tableParams.data[d].data[e]._guid});c.length&&g.deleteOperationLogs({aData:c,onSuccess:b})},a.$on("$destroy",function(){j.getPreviousStateName()!==b.sCurrentStateName&&j.addStateToHistory({sStateName:b.sCurrentStateName,oStateParams:b.oStateParams})})}]),angular.module("conspector").directive("drAvatar",["$window","CONSTANTS",function(a,b){return{restrict:"EA",scope:{user:"=",size:"@"},template:'<img ng-src="{{ ::url }}" style="height: {{ ::sizeInPx }}px; width: {{ ::sizeInPx }}px;"/>',link:function(a,c,d){if(a.url="","small"===a.size&&(a.sizeInPx="30"),"medium"===a.size&&(a.sizeInPx="40"),"large"===a.size&&(a.sizeInPx="200"),a.user.sAvatarFileGuid)a.url=b.sAppAbsolutePath+"rest/file/v2/get/"+a.user.sAvatarFileGuid;else{""===a.user.EMail&&(a.user.EMail="deficien@cyDetails.com");var e=new Hashes.MD5;a.url="http://www.gravatar.com/avatar/"+e.hex(a.user.EMail)+".png?d=identicon&s="+a.sizeInPx}}}}]),angular.module("conspector").directive("drDate",["$translate","$filter",function(a,b){return{restrict:"EA",scope:{drRawDate:"@",drFormat:"@"},template:"<span>{{ formattedDate }}</span>",link:function(a,c,d){a.formattedDate=a.drRawDate.replace(/[^0-9]/g,""),a.formattedDate=b("date")(a.formattedDate,a.drFormat)}}}]);
//# sourceMappingURL=conspector.min.js.map