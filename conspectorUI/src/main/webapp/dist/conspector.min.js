/*! conspector 05-04-2015 */

app.factory("cacheProvider",["TYPES",function(a){return{oEntitiesCache:{oDeficiencyEntity:angular.copy(a.oEntityCacheStructure),oAccountEntity:angular.copy(a.oEntityCacheStructure),oUnitEntity:angular.copy(a.oEntityCacheStructure),oCompanyEntity:angular.copy(a.oEntityCacheStructure),oUserEntity:angular.copy(a.oEntityCacheStructure),oRoleEntity:angular.copy(a.oEntityCacheStructure),oProjectEntity:angular.copy(a.oEntityCacheStructure),oPhaseEntity:angular.copy(a.oEntityCacheStructure),oRoleEntity:angular.copy(a.oEntityCacheStructure),oOperationLogEntity:angular.copy(a.oEntityCacheStructure),oTaskStatusEntity:angular.copy(a.oEntityCacheStructure),oTaskPriorityEntity:angular.copy(a.oEntityCacheStructure),oPriorityEntity:angular.copy(a.oEntityCacheStructure),oAccountTypeEntity:angular.copy(a.oEntityCacheStructure),oContactTypeEntity:angular.copy(a.oEntityCacheStructure),oActivityTypeEntity:angular.copy(a.oEntityCacheStructure),oCountryEntity:angular.copy(a.oEntityCacheStructure),oContactEntity:angular.copy(a.oEntityCacheStructure),oActivityEntity:angular.copy(a.oEntityCacheStructure),oUnitOptionSetEntity:angular.copy(a.oEntityCacheStructure),oUnitOptionValueEntity:angular.copy(a.oEntityCacheStructure),oTaskTypeEntity:angular.copy(a.oEntityCacheStructure),oFileMetadataEntity:angular.copy(a.oEntityCacheStructure)},oUserProfile:{},oListViewScrollPosition:{deficienciesList:0,contactsList:0,unitsList:0,clientsList:0,contractorsList:0,activitiesList:0},putListViewScrollPosition:function(a,b){this.oListViewScrollPosition[a]=b},getListViewScrollPosition:function(a){return this.oListViewScrollPosition[a]},clearOtherViewsScrollPosition:function(a){for(var b in this.oListViewScrollPosition)this.oListViewScrollPosition.hasOwnProperty(b)&&b!==a&&(this.oListViewScrollPosition[b]=0)},oTableStatus:{deficienciesList:[{sStateName:"app.deficienciesList",aGroups:[],oFilter:{},oSorting:{}}],notificationsList:[{sStateName:"app.notificationsList",aGroups:[],oFilter:{},oSorting:{}}],contactsList:[{sStateName:"app.contactsList",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}},{sStateName:"app.clientDetailsWrapper.clientDetails",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}},{sStateName:"app.contractorDetailsWrapper.contractorDetails",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}}],clientsList:[{sStateName:"app.clientsList",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0,bIsProspect:!0}}],contractorsList:[{sStateName:"app.contractorsList",aGroups:[],oFilter:{},oSorting:{},oListSettings:{bGroupListByProjectAndPhase:!0}}],activitiesList:[{sStateName:"app.activitiesList",aGroups:[],oFilter:{},oSorting:{}}],unitsList:[{sStateName:"app.unitsList",aGroups:[],oFilter:{},oSorting:{}}]},getTableStatusFromCache:function(a){for(var b=0;b<this.oTableStatus[a.sTableName].length;b++)if(this.oTableStatus[a.sTableName][b].sStateName===a.sStateName)return{aGroups:angular.copy(this.oTableStatus[a.sTableName][b].aGroups),oSorting:angular.copy(this.oTableStatus[a.sTableName][b].oSorting),oFilter:angular.copy(this.oTableStatus[a.sTableName][b].oFilter),oListSettings:angular.copy(this.oTableStatus[a.sTableName][b].oListSettings)}},putTableStatusToCache:function(a){for(var b={},c=0;c<this.oTableStatus[a.sTableName].length;c++)if(this.oTableStatus[a.sTableName][c].sStateName===a.sStateName){this.oTableStatus[a.sTableName][c].oFilter=angular.copy(a.oFilter),this.oTableStatus[a.sTableName][c].oSorting=angular.copy(a.oSorting),this.oTableStatus[a.sTableName][c].oListSettings=angular.copy(a.oListSettings),this.oTableStatus[a.sTableName][c].aGroups=angular.copy([]);for(var d=0;d<a.aGroups.length;d++)b=angular.copy({}),b.value=a.aGroups[d].value,a.aGroups[d].$hideRows&&(b.$hideRows=!0),this.oTableStatus[a.sTableName][c].aGroups.push(b)}},getFromCache:function(a,b){for(var c=0;c<this.oEntitiesCache[a].aCachedRequests.length;c++)if(this.oEntitiesCache[a].aCachedRequests[c].sRequestSettings===b)return this.oEntitiesCache[a].aCachedRequests[c].aEntitiesArray;return[]},putToCache:function(a,b,c){this.oEntitiesCache[a].aCachedRequests.push({sRequestSettings:b,aEntitiesArray:c})},cleanEntitiesCache:function(b,c){if(b&&!c)return void(this.oEntitiesCache[b]=angular.copy(a.oEntityCacheStructure));if(b&&c){for(var d=0;d<this.oEntitiesCache[b].aCachedRequests.length;d++)if(this.oEntitiesCache[b].aCachedRequests[d].sRequestSettings===c){this.oEntitiesCache[b].aCachedRequests.splice(d,1);break}}else for(var e in this.oEntitiesCache)this.oEntitiesCache[e]=angular.copy(a.oEntityCacheStructure)},cleanProfileCache:function(){this.oUserProfile={}},cleanAllCache:function(){this.cleanEntitiesCache(),this.cleanProfileCache(),this.clearOtherViewsScrollPosition("")},getEntityDetails:function(a){for(var b={},c=0;c<this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests.length;c++)if(this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].sRequestSettings===a.sRequestSettings){for(var d=0;d<this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].aEntitiesArray.length;d++)if(this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].aEntitiesArray[d][a.sKeyName]===a.sKeyValue){b=angular.copy(this.oEntitiesCache[a.sCacheProviderAttribute].aCachedRequests[c].aEntitiesArray[d]),console.log("Entitiy: "+a.sCacheProviderAttribute+" retrieved from cache...");break}break}return b}}}]),app.factory("genericODataFactory",["$resource","CONSTANTS",function(a,b){var c=b.sServicePath;return a("",{},{getEntitySetWithFilterAndExpand:{method:"GET",url:c+":path?$filter=:filter&$expand=:expand&$format=json"},getEntitySetWithFilter:{method:"GET",url:c+":path?$filter=:filter&$format=json"},getEntitySetWithExpand:{method:"GET",url:c+":path?$expand=:expand&$format=json"},getEntitySet:{method:"GET",url:c+":path?$format=json"},getLinks:{method:"GET",url:c+":sParentEntityWithKey/$links/:sRelationName"},post:{method:"POST",url:c+":path"},put:{method:"PUT",params:{key:"@key"},url:c+":path(':key')"},getEntity:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$format=json"},getEntityWithFilter:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$filter=:filter&$format=json"},getEntityWithExpand:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$expand=:expand&$format=json"},getEntityWithFilterAndExpand:{method:"GET",params:{key:"@key"},url:c+":path(':key')?$filter=:filter&$expand=:expand&$format=json"},"delete":{method:"DELETE",params:{key:"@key"},url:c+":path(':key')"}})}]),app.factory("dataProvider",["genericODataFactory","utilsProvider","$q","$rootScope","$http","$translate","cacheProvider","$window","CONSTANTS","$timeout",function(a,b,c,d,e,f,g,h,i,j){return{commonOnSuccess:function(a){a.bShowSpinner&&d.$emit("UNLOAD"),a.bShowSuccessMessage&&j(function(){b.displayMessage({sText:f.instant("global_successOperation"),sType:"success"})},1e3)},commonOnError:function(a,c,e){a.bShowSpinner&&d.$emit("UNLOAD"),a.bShowErrorMessage&&(e?j(function(){b.displayMessage({sText:f.instant(e),sType:"error"})},1e3):j(function(){b.displayMessage({sText:f.instant("global_errorOperation"),sType:"error"})},1e3)),c&&c.reject()},getEntitySet:function(b){var e={},f=c.defer(),g=[],h="";return b.sKey&&(h=b.sKey),b.sFilter&&(h+=b.sFilter),b.sExpand&&(h+=b.sExpand),h||(h=""),b.oCacheProvider&&b.sCacheProviderAttribute&&(g=b.oCacheProvider.getFromCache(b.sCacheProviderAttribute,h),g.length)?(console.log("Entities: "+b.sCacheProviderAttribute+" retrieved from cache..."),g):(b.bShowSpinner&&d.$emit("LOAD"),b.sFilter&&b.sExpand&&(e=(new a).$getEntitySetWithFilterAndExpand({path:b.sPath,expand:b.sExpand,filter:b.sFilter})),b.sFilter&&!b.sExpand&&(e=(new a).$getEntitySetWithFilter({path:b.sPath,filter:b.sFilter})),!b.sFilter&&b.sExpand&&(e=(new a).$getEntitySetWithExpand({path:b.sPath,expand:b.sExpand})),b.sFilter||b.sExpand||(e=(new a).$getEntitySet({path:b.sPath})),e.then($.proxy(function(a){b.oCacheProvider&&b.sCacheProviderAttribute&&a.d.results.length&&b.oCacheProvider.putToCache(b.sCacheProviderAttribute,h,a.d.results),this.commonOnSuccess(b),f.resolve(a.d.results)},this),$.proxy(function(){this.commonOnError(b,f)},this)),f.promise)},getEntity:function(b){var e={},f=c.defer();return b.bShowSpinner&&d.$emit("LOAD"),b.sFilter&&!b.sExpand&&(e=(new a).$getEntityWithFilter({path:b.sPath,key:b.sKey,filter:b.sFilter})),!b.sFilter&&b.sExpand&&(e=(new a).$getEntityWithExpand({path:b.sPath,key:b.sKey,expand:b.sExpand})),b.sFilter&&b.sExpand&&(e=(new a).$getEntityWithFilterAndExpand({path:b.sPath,filter:b.sFilter,key:b.sKey,expand:b.sExpand})),b.sFilter||b.sExpand||(e=(new a).$getEntity({path:b.sPath,key:b.sKey})),e.then($.proxy(function(a){this.commonOnSuccess(b),f.resolve(a.d)},this),$.proxy(function(){this.commonOnError(b,f)},this)),f.promise},getLinks:function(b){var d={},e=c.defer(),f="";return f=b.sParentEntity+"('"+b.sParentKey+"')",d=(new a).$getLinks({path:b.sParentEntity,sParentEntity:f,sRelationName:b.sRelationName}),d.then(function(a){e.resolve(a.d)}),e.promise},updateLinks:function(a){for(var b={__batchRequests:[]},c={},d={},e=[],f="",h="",j=!1,k=function(a){a.d.CompanyName===g.oUserProfile.sCurrentCompany&&g.oUserProfile.sCurrentCompany&&a.d.CompanyName||(j=!0)},l=0;l<a.aLinks.length;l++)c={},c.requestUri=a.sParentEntityWithKey+"/$links/"+a.aLinks[l].sRelationName,c.method="GET",b.__batchRequests.push(c);d=this.batchRequest({oRequestData:b,bShowSpinner:a.bShowSpinner}),d.then($.proxy(function(g){b={__batchRequests:[]};for(var l=0;l<g.length;l++){e=[];for(var m=0;m<g[l].data.results.length;m++)j=!1,c={},h=g[l].data.results[m].uri.substring(g[l].data.results[m].uri.indexOf("'")+1,g[l].data.results[m].uri.lastIndexOf("'")),a.aLinks[l].bKeepCompanyDependentLinks&&this.ajaxRequest({bAsync:!1,oData:{},sRequestType:"GET",sDataType:"json",sPath:i.sServicePath+a.aLinks[l].sRelationName.substring(0,a.aLinks[l].sRelationName.length-7)+"s('"+h+"')",oEventHandlers:{onSuccess:k}}),j||(f=a.aLinks[l].sRelationName+"('"+h+"')",c.requestUri=a.sParentEntityWithKey+"/$links/"+f,c.method="DELETE",e.push(c));e.length&&this.constructChangeBlockForBatch({oRequestData:b,aData:e})}b.__batchRequests.length?(d=this.batchRequest({oRequestData:b}),d.then($.proxy(function(){this.createLinks(a)},this))):this.createLinks(a)},this))},updateEntity:function(e){var f={},h={},i=c.defer();e.bShowSpinner&&d.$emit("LOAD");var h=this.getEntity({sKey:e.sKey,sPath:e.sPath});return h.then($.proxy(function(c){var d={};d=angular.copy(e.oData),e.bIgnoreLastModifiedAtValidation&&(d.LastModifiedAt=c.LastModifiedAt),c.LastModifiedAt===d.LastModifiedAt?(d.LastModifiedAt=b.dateToDBDate(new Date),d.GeneralAttributes||(d.GeneralAttributes=c.GeneralAttributes),d.GeneralAttributes.LastModifiedBy=g.oUserProfile.sUserName,d.GeneralAttributes.IsDeleted||(d.GeneralAttributes.IsDeleted=!1),d.GeneralAttributes.IsArchived||(d.GeneralAttributes.IsArchived=!1),d.GeneralAttributes.SortingSequence||(d.GeneralAttributes.SortingSequence=0),f=new a(d).$put({path:e.sPath,key:e.sKey}),f.then($.proxy(function(a){if(e.aLinks&&e.aLinks.length){var b=e.sPath+"('"+a[e.sKeyAttribute]+"')";this.updateLinks({aLinks:e.aLinks,bShowSpinner:e.bShowSpinner,sParentEntityWithKey:b,onSuccess:$.proxy(function(){this.commonOnSuccess(e),i.resolve(a)},this)})}else this.commonOnSuccess(e),i.resolve(a)},this),$.proxy(function(){this.commonOnError(e,i)},this))):this.commonOnError(e,i,"global_errorEntityWasUpdatedBefore")},this)),i.promise},createLinks:function(a){for(var b={__batchRequests:[]},c=[],d={},e={},f=0;f<a.aLinks.length;f++){c=[];for(var g=0;g<a.aLinks[f].aUri.length;g++)d={},d.requestUri=a.sParentEntityWithKey+"/$links/"+a.aLinks[f].sRelationName,d.method="POST",d.data={uri:a.aLinks[f].aUri[g]},c.push(d);c.length&&this.constructChangeBlockForBatch({oRequestData:b,aData:c})}e=this.batchRequest({oRequestData:b,bShowSpinner:a.bShowSpinner}),e.then(function(){a.onSuccess&&a.onSuccess()})},createEntity:function(e){var f={},h={},i=c.defer();return e.bShowSpinner&&d.$emit("LOAD"),h=angular.copy(e.oData),e.bGuidNeeded&&(h.Guid=b.generateGUID()),e.bCompanyNeeded&&!h.CompanyName&&(h.CompanyName=g.oUserProfile.sCurrentCompany),h.CreatedAt=b.dateToDBDate(new Date),h.LastModifiedAt=h.CreatedAt,h.GeneralAttributes||(h.GeneralAttributes={}),h.GeneralAttributes.CreatedBy=g.oUserProfile.sUserName,h.GeneralAttributes.LastModifiedBy=g.oUserProfile.sUserName,h.GeneralAttributes.IsDeleted=!1,h.GeneralAttributes.IsArchived=!1,h.GeneralAttributes.SortingSequence||(h.GeneralAttributes.SortingSequence=0),f=new a(h).$post({path:e.sPath}),f.then($.proxy(function(a){if(e.aLinks&&e.aLinks.length){var b=e.sPath+"('"+a.d[e.sKeyAttribute]+"')";this.createLinks({aLinks:e.aLinks,sParentEntityWithKey:b,sShowSpinner:e.bShowSpinner,onSuccess:$.proxy(function(){this.commonOnSuccess(e),i.resolve(a.d)},this)})}else this.commonOnSuccess(e),i.resolve(a.d)},this),$.proxy(function(){this.commonOnError(e,i)},this)),i.promise},deleteEntity:function(b){var e={},f=c.defer();return b.bShowSpinner&&d.$emit("LOAD"),e=(new a).$delete({path:b.sPath,key:b.sKey}),e.then($.proxy(function(){this.commonOnSuccess(b),f.resolve()},this),$.proxy(function(){this.commonOnError(b,f)},this)),f.promise},httpRequest:function(a){var b="",f="application/x-www-form-urlencoded",g=[],h={},i={};a.sRequestType||(a.sRequestType="GET");for(var j in a.oUrlParameters)g.push(j+"="+a.oUrlParameters[j]);for(var k=0;k<g.length;k++)b+=g[k],k!==g.length-1&&(b+="&");return h=c.defer(),a.bShowSpinner&&d.$emit("LOAD"),console.log(a.sPath),i=e({url:a.sPath,method:a.sRequestType,headers:{"Content-Type":f},data:b}),i.success($.proxy(function(b){this.commonOnSuccess(a),h.resolve(b)},this)),i.error($.proxy(function(){this.commonOnError(a,h)},this)),h.promise},constructChangeBlockForBatch:function(a){for(var b={__changeRequests:[]},c=0;c<a.aData.length;c++)b.__changeRequests.push(a.aData[c]);a.oRequestData.__batchRequests.push(b)},batchRequest:function(a){var b=c.defer();return a.oRequestData&&a.oRequestData.__batchRequests&&a.oRequestData.__batchRequests.length?(a.bShowSpinner&&d.$emit("LOAD"),OData.request({requestUri:i.sServicePath+"$batch",method:"POST",data:a.oRequestData},$.proxy(function(c){for(var d=0;d<c.__batchResponses.length;d++)if("HTTP request failed"===c.__batchResponses[d].message)return void this.commonOnError(a);this.commonOnSuccess(a),b.resolve(c.__batchResponses)},this),$.proxy(function(){this.commonOnError(a)},this),OData.batchHandler)):(this.commonOnSuccess(a),b.resolve([])),b.promise},ajaxRequest:function(a){a.sRequestType||(a.sRequestType="POST"),a.bShowSpinner&&d.$emit("LOAD"),$.ajax({type:a.sRequestType,async:a.bAsync,url:a.sPath,data:a.oData,dataType:a.sDataType,beforeSend:function(){},success:$.proxy(function(b){this.commonOnSuccess(a),a.oEventHandlers&&a.oEventHandlers.onSuccess&&a.oEventHandlers.onSuccess(b)},this),error:$.proxy(function(b){this.commonOnError(a),a.oEventHandlers&&a.oEventHandlers.onError&&a.oEventHandlers.onError(b)},this)})}}}]),app.factory("apiProvider",["$rootScope","dataProvider","CONSTANTS","$q","utilsProvider","cacheProvider","PubNub","$timeout",function(a,b,c,d,e,f,g,h){return{getUserProfile:function(a){var d=c.sServicePath+"Users('"+a+"')?$expand=CompanyDetails,RoleDetails,PhaseDetails/ProjectDetails,ContactDetails/AccountDetails&$format=json",e=[],f=[],g=[],h=[],i="",j=!1,k=function(a){j=a.d.IsPasswordInitial,i=a.d.LastModifiedAt;for(var b=0;b<a.d.CompanyDetails.results.length;b++)a.d.CompanyDetails.results[b].GeneralAttributes.IsDeleted||e.push(a.d.CompanyDetails.results[b]);for(var b=0;b<a.d.RoleDetails.results.length;b++)a.d.RoleDetails.results[b].GeneralAttributes.IsDeleted||f.push(a.d.RoleDetails.results[b]);for(var b=0;b<a.d.PhaseDetails.results.length;b++)a.d.PhaseDetails.results[b].GeneralAttributes.IsDeleted||(a.d.PhaseDetails.results[b]._sortingSequence=a.d.PhaseDetails.results[b].GeneralAttributes.SortingSequence,a.d.PhaseDetails.results[b].ProjectDetails._sortingSequence=a.d.PhaseDetails.results[b].ProjectDetails.GeneralAttributes.SortingSequence,g.push(a.d.PhaseDetails.results[b]));for(var b=0;b<a.d.ContactDetails.results.length;b++)a.d.ContactDetails.results[b].GeneralAttributes.IsDeleted||h.push(a.d.ContactDetails.results[b])};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:k}}),{sUserName:a,aUserRoles:f,aAllUserRoles:f,aUserPhases:g,aAllUserPhases:g,aUserCompanies:e,bIsInitialPassword:j,sLastModifiedAt:i,aGloballySelectedPhasesGuids:[],aAllUserContacts:h}},getCurrentUserName:function(){var a,d=c.sAppAbsolutePath+"rest/account/getCurrentUserName",e=function(b){a=b};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:e}}),a},getCurrentCompany:function(){var a,d=c.sAppAbsolutePath+"rest/account/getCurrentCompany",e=function(b){a=b};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:e}}),a},setCurrentCompany:function(a){b.ajaxRequest({sPath:c.sAppAbsolutePath+"rest/account/setCurrentCompany/"+a,bAsync:!1,sRequestType:"GET"})},getCurrentRole:function(){var a,d=c.sAppAbsolutePath+"rest/account/getCurrentRole",e=function(b){a=b};return b.ajaxRequest({sPath:d,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:e}}),a},setCurrentRole:function(a){b.ajaxRequest({sPath:c.sAppAbsolutePath+"rest/account/setCurrentRole/"+a,bAsync:!1,sRequestType:"GET"})},resetPasswordWithPRCode:function(a){var d=b.httpRequest({sPath:c.sAppAbsolutePath+"rest/account/passwordRecovery/PRCode/"+a.oData.passwordRecoveryCode+"/newPassword/"+a.oData.newPassword,sRequestType:"GET",bShowSpinner:!0});d.then(function(b){a.onSuccess(b)})},resetPassword:function(a){var d={},e="";e=a.oData.userName?c.sAppAbsolutePath+"rest/account/passwordRecovery/userName/"+a.oData.userName:c.sAppAbsolutePath+"rest/account/passwordRecovery/email/"+a.oData.email,d=b.httpRequest({sPath:e,sRequestType:"GET",bShowSpinner:!0}),d.then(function(b){a.onSuccess(b)})},hashPassword:function(a){var d="",e=c.sAppAbsolutePath+"rest/account/hashPassword/"+a,f=function(a){d=a};return b.ajaxRequest({sPath:e,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:f}}),d},getAttachments:function(a){var c=a.sPath,d=b.httpRequest({sPath:c});d.then(function(b){a.onSuccess(b)})},getUsers:function(a){var c=b.getEntitySet({sPath:"Users",sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUserEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getUserWithCompaniesPhasesAndRoles:function(a){var c=b.getEntity({sPath:"Users",sKey:a.sKey,sExpand:"CompanyDetails,PhaseDetails/ProjectDetails,RoleDetails,ContactDetails",sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},createUser:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUserEntity"),a.onSuccess&&a.onSuccess(b)},this),d=b.createEntity({sPath:"Users",sKeyAttribute:"UserName",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!1});d.then(c)},updateUser:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUserEntity"),a.onSuccess&&a.onSuccess(b)},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Users",sKeyAttribute:"UserName",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},initializePubNub:function(){a.sSessionGuid=e.generateGUID();var b="";g.init({publish_key:"pub-c-ca905ca3-be6e-4a5b-96cd-49dc2312a4e6",subscribe_key:"sub-c-8b324682-73df-11e3-9291-02ee2ddab7fe"}),b="conspectorPubNub"+f.oUserProfile.sCurrentCompany,g.ngSubscribe({channel:b}),a.$on(g.ngMsgEv(b),function(b,c){if(c.message.sSessionGuid!==a.sSessionGuid)switch(f.cleanEntitiesCache(c.message.sEntityName),"oAccountEntity"===c.message.sEntityName&&f.cleanEntitiesCache("oAccountTypeEntity"),c.message.sEntityName){case"oAccountEntity":a.$broadcast("accountsShouldBeRefreshed");break;case"oContactEntity":a.$broadcast("contactsShouldBeRefreshed");break;case"oDeficiencyEntity":a.$broadcast("deficienciesShouldBeRefreshed");break;case"oUnitEntity":a.$broadcast("unitsShouldBeRefreshed");break;case"oActivityEntity":a.$broadcast("activitiesShouldBeRefreshed");break;case"oOperationLogEntity":a.$broadcast("notificationsShouldBeRefreshed"),a.getNotificationsNumber()}})},pubNubMessage:function(b){g.ngPublish({channel:"conspectorPubNub"+f.oUserProfile.sCurrentCompany,message:{sEntityName:b.sEntityName,sText:b.sText,sUserName:f.oUserProfile.sUserName,sSessionGuid:a.sSessionGuid}})},logEvent:function(c){for(var d={},g={__batchRequests:[]},h=[],i={},j=0;j<c.aUsers.length;j++)i={requestUri:"OperationLogs",method:"POST",data:{Guid:e.generateGUID(),CompanyName:f.oUserProfile.sCurrentCompany,UserName:c.aUsers[j],Status:"not read",EntityName:c.sEntityName,EntityGuid:c.sEntityGuid,OperationNameEN:c.sOperationNameEN,OperationNameFR:c.sOperationNameFR,PhaseGuid:c.sPhaseGuid,CreatedAt:e.dateToDBDate(new Date),GeneralAttributes:{CreatedBy:f.oUserProfile.sUserName,IsDeleted:!1},ContactGuid:f.oUserProfile.oUserContact.Guid}},h.push(i);b.constructChangeBlockForBatch({oRequestData:g,aData:h}),d=b.batchRequest({oRequestData:g,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),this.pubNubMessage({sEntityName:"oOperationLogEntity",sText:"New Operation Log..."})},this))},logEvents:function(c){for(var d={},g={__batchRequests:[]},h=[],i={},j=0;j<c.aData.length;j++)for(var k=0;k<c.aData[j].aUsers.length;k++)i={requestUri:"OperationLogs",method:"POST",data:{Guid:e.generateGUID(),CompanyName:f.oUserProfile.sCurrentCompany,UserName:c.aData[j].aUsers[k],Status:"not read",EntityName:c.aData[j].sEntityName,EntityGuid:c.aData[j].sGuid,OperationNameEN:c.aData[j].sOperationNameEN,OperationNameFR:c.aData[j].sOperationNameFR,PhaseGuid:c.aData[j].sPhaseGuid,CreatedAt:e.dateToDBDate(new Date),GeneralAttributes:{CreatedBy:f.oUserProfile.sUserName,IsDeleted:!1},ContactGuid:f.oUserProfile.oUserContact.Guid}},h.push(i);b.constructChangeBlockForBatch({oRequestData:g,aData:h}),d=b.batchRequest({oRequestData:g,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),this.pubNubMessage({sEntityName:"oOperationLogEntity",sText:"New Operation Log..."})},this)),this.sendPushNotifications(c)},sendPushNotifications:function(a){for(var c={},d={__batchRequests:[]},e={},f=0;f<a.aData.length;f++)for(var g=0;g<a.aData[f].aUsers.length;g++)e={requestUri:"Users('"+a.aData[f].aUsers[g]+"')?$expand=UserDeviceDetails",method:"GET"},d.__batchRequests.push(e);c=b.batchRequest({oRequestData:d,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),c.then($.proxy(function(b){for(var c=[],d=b.length-1;d>=0;d--){for(var e=b[d].data.UserDeviceDetails.results.length-1;e>=0;e--)-1===$.inArray(b[d].data.UserDeviceDetails.results[e].DeviceToken,c)&&(c.push(b[d].data.UserDeviceDetails.results[e].DeviceToken),pubnub.mobile_gw_provision({device_id:b[d].data.UserDeviceDetails.results[e].DeviceToken,channel:"pushNotifications",op:"add",gw_type:"apns",error:function(a){console.log(a)}}));h(function(){for(var c=b.length-1;c>=0;c--)for(var d=b[c].data.UserDeviceDetails.results.length-1;d>=0;d--){var e=PNmessage();e.pubnub=pubnub;var f="en"===b[c].data.Language?a.aData[0].sOperationNameEN:a.aData[0].sOperationNameFR;e.channel="pushNotifications",e.apns={alert:f,badge:1,sound:"notification-beep.wav"},e.publish()}},1e3)}},this))},getOperationLogs:function(a){var b=c.sServicePath+"OperationLogs";a.bAddCountUrlParam&&(b+="/$count/"),a.sFilter&&(b=b+"?$filter="+a.sFilter),a.sExpand&&(b=a.sFilter?b+"&$expand="+a.sExpand:b+"?$expand="+a.sExpand),a.sOtherUrlParams&&(b=a.sFilter||a.sExpand?b+"&"+a.sOtherUrlParams:b+"?"+a.sOtherUrlParams),OData.request({requestUri:b,method:"GET"},$.proxy(function(b){b&&a.onSuccess(b)},this),$.proxy(function(){},this))},updateOperationLog:function(c){var d=function(b){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),c.onSuccess&&c.onSuccess(b)},e=b.updateEntity({bShowSpinner:c.bShowSpinner,sPath:"OperationLogs",sKey:c.sKey,oData:c.oData,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});e.then(d)},updateOperationLogs:function(c){for(var d={},e={__batchRequests:[]},g=[],h={},i=0;i<c.aData.length;i++)h={requestUri:"OperationLogs('"+c.aData[i].Guid+"')",method:"PUT",data:c.aData[i]},g.push(h);b.constructChangeBlockForBatch({oRequestData:e,aData:g}),d=b.batchRequest({oRequestData:e,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),c.onSuccess&&c.onSuccess(h)},this))},deleteOperationLogs:function(c){for(var d={},e={__batchRequests:[]},g=[],h={},i=0;i<c.aData.length;i++)h={requestUri:"OperationLogs('"+c.aData[i].Guid+"')",method:"DELETE"},g.push(h);b.constructChangeBlockForBatch({oRequestData:e,aData:g}),d=b.batchRequest({oRequestData:e,bShowSpinner:c.bShowSpinner,bShowSuccessMessage:c.bShowSuccessMessage,bShowErrorMessage:c.bShowErrorMessage}),d.then($.proxy(function(){f.cleanEntitiesCache("oOperationLogEntity"),a.getNotificationsNumber(),c.onSuccess&&c.onSuccess(h)},this))},getProjects:function(a){var c=b.getEntitySet({sPath:"Projects",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oProjectEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getProjectsWithPhases:function(a){var c=b.getEntitySet({sPath:"Projects",sExpand:"PhaseDetails",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oProjectEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createProject:function(a){var c=function(b){f.cleanEntitiesCache("oProjectEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"Projects",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateProject:function(a){var c=function(b){f.cleanEntitiesCache("oProjectEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Projects",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getPhases:function(a){var c=b.getEntitySet({sPath:"Phases",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oPhaseEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getPhase:function(a){var c=b.getEntity({sPath:"Phases",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},createPhase:function(a){var c=function(b){f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"Phases",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updatePhase:function(a){var c=function(b){f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Phases",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getCompany:function(a){var c=b.getEntity({sPath:"Companies",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},getCompanies:function(a){var c=b.getEntitySet({sPath:"Companys",sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oCompanyEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createCompany:function(a){var d={},g={__batchRequests:[]},h=[],i=angular.copy(a.oData),j={};i.GeneralAttributes||(i.GeneralAttributes={}),i.GeneralAttributes.CreatedBy=f.oUserProfile.sUserName,i.GeneralAttributes.LastModifiedBy=f.oUserProfile.sUserName,i.GeneralAttributes.IsDeleted=!1,i.GeneralAttributes.IsArchived=!1,i.GeneralAttributes.SortingSequence||(i.GeneralAttributes.SortingSequence=0),i.CreatedAt=e.dateToDBDate(new Date),i.LastModifiedAt=i.CreatedAt;var k={requestUri:"Companys",method:"POST",data:i};h.push(k),j.Guid=e.generateGUID(),j.RoleName=c.sDefaultRoleNameForNewCompany,j.CompanyName=a.oData.CompanyName,j.CreatedAt=i.CreatedAt,j.LastModifiedAt=i.LastModifiedAt,j.GeneralAttributes=angular.copy(i.GeneralAttributes),j.GeneralAttributes.SortingSequence=0,k={requestUri:"Roles",method:"POST",data:j},h.push(k),b.constructChangeBlockForBatch({oRequestData:g,aData:h}),h=[],k={requestUri:"Users('"+f.oUserProfile.sUserName+"')/$links/CompanyDetails",method:"POST",data:{uri:"Companys('"+a.oData.CompanyName+"')"}},h.push(k),k={requestUri:"Users('"+f.oUserProfile.sUserName+"')/$links/RoleDetails",method:"POST",data:{uri:"Roles('"+j.Guid+"')"}},h.push(k),b.constructChangeBlockForBatch({oRequestData:g,aData:h}),d=b.batchRequest({oRequestData:g,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),d.then(function(b){f.cleanEntitiesCache("oCompanyEntity"),a.onSuccess&&a.onSuccess(b)})},updateCompany:function(a){var c=function(b){f.cleanEntitiesCache("oCompanyEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Companys",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getRoles:function(a){var c=b.getEntitySet({sPath:"Roles",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oRoleEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createRole:function(a){var c=function(b){f.cleanEntitiesCache("oRoleEntity"),a.onSuccess(b)},d=b.createEntity({sPath:"Roles",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateRole:function(a){var c=function(b){f.cleanEntitiesCache("oRoleEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Roles",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getDeficiencyStatuses:function(a){var c=b.getEntitySet({sPath:"TaskStatuss",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskStatusEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createDeficiencyStatus:function(a){var c=function(b){f.cleanEntitiesCache("oTaskStatusEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"TaskStatuss",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateDeficiencyStatus:function(a){var c=function(b){f.cleanEntitiesCache("oTaskStatusEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"TaskStatuss",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});
d.then(c)},getDeficiencyTaskType:function(a){var c=b.getEntitySet({sPath:"TaskTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Deficiency'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getHealthAndSafetyTaskType:function(a){var c=b.getEntitySet({sPath:"TaskTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Health and Safety'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getContractorAccountType:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Contractor'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getClientAccountType:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false and NameEN eq 'Client'",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getAccountTypes:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getAccountTypesWithAccounts:function(a){var c=b.getEntitySet({sPath:"AccountTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:"AccountDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(function(b){for(var c=[],d=0;d<b.length;d++){c=[];for(var e=0;e<b[d].AccountDetails.results.length;e++)b[d].AccountDetails.results[e].GeneralAttributes.IsDeleted||c.push(b[d].AccountDetails.results[e]);b[d].AccountDetails.results=angular.copy(c)}a.onSuccess(b)})},createAccountType:function(a){var c=function(b){f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"AccountTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateAccountType:function(a){var c=function(b){f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"AccountTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getContactTypes:function(a){var c=b.getEntitySet({sPath:"ContactTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oContactTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createContactType:function(a){var c=function(b){f.cleanEntitiesCache("oContactTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"ContactTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateContactType:function(a){var c=function(b){f.cleanEntitiesCache("oContactTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"ContactTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getActivityTypes:function(a){var c=b.getEntitySet({sPath:"ActivityTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oActivityTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createActivityType:function(a){var c=function(b){f.cleanEntitiesCache("oActivityTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"ActivityTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateActivityType:function(a){var c=function(b){f.cleanEntitiesCache("oActivityTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"ActivityTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getDeficiencyPriorities:function(a){var c=b.getEntitySet({sPath:"TaskPrioritys",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskPriorityEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createDeficiencyPriority:function(a){var c=function(b){f.cleanEntitiesCache("oTaskPriorityEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"TaskPrioritys",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateDeficiencyPriority:function(a){var c=function(b){f.cleanEntitiesCache("oTaskPriorityEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"TaskPrioritys",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getContractors:function(a){var c=b.getEntitySet({sPath:"Accounts",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:a.sExpand,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountEntity"});if(c instanceof Array){for(var d=[],e=0;e<c.length;e++)"Contractor"===c[e].AccountTypeDetails.NameEN&&d.push(c[e]);a.onSuccess(d)}else c.then(function(b){for(var c=[],d=0;d<b.length;d++)"Contractor"===b[d].AccountTypeDetails.NameEN&&c.push(b[d]);a.onSuccess(c)})},getClients:function(a){var c=b.getEntitySet({sPath:"Accounts",sFilter:a.sFilter,sExpand:a.sExpand,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountEntity"});if(c instanceof Array){for(var d=[],e=0;e<c.length;e++)"Client"===c[e].AccountTypeDetails.NameEN&&d.push(c[e]);a.onSuccess(d)}else c.then(function(b){for(var c=[],d=0;d<b.length;d++)"Client"===b[d].AccountTypeDetails.NameEN&&c.push(b[d]);a.onSuccess(c)})},getAccount:function(a){var c=b.getEntity({sPath:"Accounts",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},getAccounts:function(a){var c=b.getEntitySet({sPath:"Accounts",sExpand:a.sExpand,sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oAccountEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createAccount:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oAccountEntity"),f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oAccountEntity",sText:"Account has been created..."})},this),d=b.createEntity({sPath:"Accounts",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateAccount:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oAccountEntity"),f.cleanEntitiesCache("oAccountTypeEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oAccountEntity",sText:"Account has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Accounts",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getCountriesWithProvinces:function(a){var c=b.getEntitySet({sPath:"Countrys",sFilter:"GeneralAttributes/IsDeleted eq false",sExpand:"ProvinceDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oCountryEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getContacts:function(a){var c=b.getEntitySet({sPath:"Contacts",sExpand:a.sExpand,sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oContactEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getContact:function(a){var c=b.getEntity({sPath:"Contacts",sKey:a.sKey,sExpand:"UserDetails,ContactTypeDetails,AccountDetails/AccountTypeDetails,PhaseDetails/ProjectDetails",sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},updateContact:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oContactEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oContactEntity",sText:"Contact has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Contacts",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});d.then(c)},createContact:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oContactEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oContactEntity",sText:"Contact has been created..."})},this),d=b.createEntity({sPath:"Contacts",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},getContactsForAccount:function(a){var c=b.getEntitySet({sPath:"Contacts",sFilter:"GeneralAttributes/IsDeleted eq false and AccountGuid eq '"+a.sAccountGuid+"'",sExpand:"UserDetails,ContactTypeDetails,AccountDetails,PhaseDetails/ProjectDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oContactEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getUnitOptionSets:function(a){var c=b.getEntitySet({sPath:"UnitOptionSets",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:"PhaseDetails/ProjectDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUnitOptionSetEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createUnitOptionSet:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionSetEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"UnitOptionSets",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0,aLinks:a.aLinks,sKeyAttribute:"Guid"});d.then(c)},updateUnitOptionSet:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionSetEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"UnitOptionSets",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,aLinks:a.aLinks,sKeyAttribute:"Guid"});d.then(c)},getUnitOptionValues:function(a){var c=b.getEntitySet({sPath:"UnitOptions",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",sExpand:"UnitOptionSetDetails",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUnitOptionValueEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createUnitOptionValue:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionValueEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"UnitOptions",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateUnitOptionValue:function(a){var c=function(b){f.cleanEntitiesCache("oUnitOptionValueEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"UnitOptions",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getTaskTypes:function(a){var c=b.getEntitySet({sPath:"TaskTypes",sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oTaskTypeEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createTaskType:function(a){var c=function(b){f.cleanEntitiesCache("oTaskTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"TaskTypes",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateTaskType:function(a){var c=function(b){f.cleanEntitiesCache("oTaskTypeEntity"),a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"TaskTypes",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getActivities:function(a){var c=b.getEntitySet({sPath:"Activitys",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oActivityEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getActivity:function(a){var c=b.getEntity({sPath:"Activitys",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},updateActivity:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oActivityEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oActivityEntity",sText:"Activity has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Activitys",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},createActivity:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oActivityEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oActivityEntity",sText:"Activity has been created..."})},this),d=b.createEntity({sPath:"Activitys",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},getDeficiencies:function(a){var c={};c=b.getEntitySet(a.bNoCaching?{sPath:"Tasks",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner}:{sPath:"Tasks",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oDeficiencyEntity"}),c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getDeficiency:function(a){var c=b.getEntity({sPath:"Tasks",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},onSuccessUpdateDeficiency:function(a,b){f.cleanEntitiesCache("oDeficiencyEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oDeficiencyEntity",sText:"Deficiency has been updated..."})},updateDeficiency:function(a){var c=$.proxy(function(b){this.onSuccessUpdateDeficiency(a,b)},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Tasks",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getInterestedUsers:function(a){for(var c={},d={__batchRequests:[]},e={},g=0;g<a.aData.length;g++)e={requestUri:"Tasks('"+a.aData[g].Guid+"')?$expand=AccountDetails/ContactDetails/UserDetails/PhaseDetails",method:"GET"},d.__batchRequests.push(e);c=b.batchRequest({oRequestData:d,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),c.then($.proxy(function(b){for(var c=[],d=[],e=!1,g=!1,h="",i=0;i<b.length;i++){d=[],h=b[i].data.PhaseGuid;for(var j=b[i].data.AccountDetails.results.length-1;j>=0;j--)for(var k=b[i].data.AccountDetails.results[j].ContactDetails.results.length-1;k>=0;k--)for(var l=b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results.length-1;l>=0;l--)if(b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName===b[i].data.UserName&&(e=!0),b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName!==f.oUserProfile.sUserName){b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName===b[i].data.GeneralAttributes.CreatedBy&&(g=!0);for(var m=b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].PhaseDetails.results.length-1;m>=0;m--)if(b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].PhaseDetails.results[m].Guid===h){d.push(b[i].data.AccountDetails.results[j].ContactDetails.results[k].UserDetails.results[l].UserName);break}}b[i].data.UserName==f.oUserProfile.sUserName||e||d.push(b[i].data.UserName),b[i].data.GeneralAttributes.CreatedBy==f.oUserProfile.sUserName||g||b[i].data.GeneralAttributes.CreatedBy==b[i].data.UserName||null!=b[i].data.GeneralAttributes.CreatedBy&&void 0!=b[i].data.GeneralAttributes.CreatedBy&&d.push(b[i].data.CreatedBy),d.push("GeneralAdmin");var n=[];$.each(d,function(a,b){-1===$.inArray(b,n)&&n.push(b)}),c.push({aUsers:n,sGuid:b[i].data.Guid,sPhaseGuid:h,sEntityName:a.sEntityName,sOperationNameEN:a.sOperationNameEN,sOperationNameFR:a.sOperationNameFR})}a.onSuccess(c)},this))},updateDeficiencies:function(a){for(var d={},e={__batchRequests:[]},f=[],g={},h=0;h<a.aData.length;h++)g={requestUri:"Tasks('"+a.aData[h].Guid+"')",method:"PUT",data:a.aData[h]},f.push(g);b.constructChangeBlockForBatch({oRequestData:e,aData:f}),d=b.batchRequest({oRequestData:e,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage}),d.then($.proxy(function(){this.onSuccessUpdateDeficiency(a);var b=$.proxy(function(a){this.logEvents({aData:a})},this);this.getInterestedUsers({sEntityName:"deficiency",sOperationNameEN:c.updatedDeficiencyEN,sOperationNameFR:c.updatedDeficiencyFR,aData:a.aData,onSuccess:b})},this))},createDeficiency:function(a){var c=$.proxy(function(b){this.onSuccessUpdateDeficiency(a,b)},this),d=b.createEntity({sPath:"Tasks",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},getUnits:function(a){var c=b.getEntitySet({sPath:"Units",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner,oCacheProvider:f,sCacheProviderAttribute:"oUnitEntity"});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},getUnit:function(a){var c=b.getEntity({sPath:"Units",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(a.onSuccess)},updateUnit:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUnitEntity"),f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oUnitEntity",sText:"Unit has been updated..."})},this),d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Units",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,aLinks:a.aLinks,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},createUnit:function(a){var c=$.proxy(function(b){f.cleanEntitiesCache("oUnitEntity"),f.cleanEntitiesCache("oPhaseEntity"),a.onSuccess&&a.onSuccess(b),this.pubNubMessage({sEntityName:"oUnitEntity",sText:"Unit has been created..."})},this),d=b.createEntity({sPath:"Units",sKeyAttribute:"Guid",oData:a.oData,aLinks:a.aLinks,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!0});d.then(c)},updateFileMetadataSet:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"FileMetadataSets",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},getFileMetadatas:function(a){var c=b.getEntitySet({sPath:"FileMetadatas",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},updateFileMetadata:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"FileMetadatas",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});d.then(c)},getEntityComments:function(a){var c=b.getEntity({sPath:"CommentSets",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(function(b){for(var c=[],d=0;d<b.CommentDetails.results.length;d++)b.CommentDetails.results[d].GeneralAttributes.IsDeleted||c.push(b.CommentDetails.results[d]);b.CommentDetails.results=angular.copy(c),a.onSuccess(b)})},getEntityAttachments:function(a){var c=b.getEntity({sPath:"FileMetadataSets",sKey:a.sKey,sExpand:a.sExpand,sFilter:"GeneralAttributes/IsDeleted eq false",bShowSpinner:a.bShowSpinner});c.then(function(b){for(var c=[],d=0;d<b.FileMetadataDetails.results.length;d++)b.FileMetadataDetails.results[d].GeneralAttributes.IsDeleted||c.push(b.FileMetadataDetails.results[d]);b.FileMetadataDetails.results=angular.copy(c),a.onSuccess(b)})},updateEntityAttachment:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"FileMetadatas",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage});d.then(c)},updateComment:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.updateEntity({bShowSpinner:a.bShowSpinner,sPath:"Comments",sKeyAttribute:"Guid",sKey:a.sKey,oData:a.oData,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bIgnoreLastModifiedAtValidation:!0});d.then(c)},createComment:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"Comments",sKeyAttribute:"Guid",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!1});d.then(c)},getUserDevices:function(a){var c=b.getEntitySet({sPath:"UserDevices",sExpand:a.sExpand,sFilter:a.sFilter,bShowSpinner:a.bShowSpinner});c instanceof Array?a.onSuccess(c):c.then(a.onSuccess)},createUserDevice:function(a){var c=function(b){a.onSuccess&&a.onSuccess(b)},d=b.createEntity({sPath:"UserDevices",sKeyAttribute:"Guid",oData:a.oData,bShowSpinner:a.bShowSpinner,bShowSuccessMessage:a.bShowSuccessMessage,bShowErrorMessage:a.bShowErrorMessage,bGuidNeeded:!0,bCompanyNeeded:!1});d.then(c)},generateReport:function(a){$.download("xdocReportsService",a.oReportParameters,"post")}}}]),app.factory("servicesProvider",["$rootScope","$state","ngTableParams","$translate","utilsProvider","cacheProvider","apiProvider","dataProvider","rolesSettings","$cookieStore","$window","$filter","$mdDialog","$upload","CONSTANTS","$cordovaKeyboard","$rootScope",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,a){return{changeLanguage:function(){var b=d.use();switch(b){case"en":d.use("fr");break;case"fr":d.use("en")}a.$emit("languageChanged")},logIn:function(a){var b={},c=new Hashes.SHA512,d=o.sAppAbsolutePath+"rest/account/login/"+a.oData.userName+"/"+c.hex(a.oData.password),e=$.proxy(function(b){var c=this.messagesHandler(b.messages);c&&(a.onSuccess&&a.onSuccess(),this.onLogInSuccessHandler(a.oData.userName))},this);b=h.httpRequest({sPath:d,bShowSpinner:!0,sRequestType:"GET"}),b.then(function(a){e(a)})},logOut:function(){var a=o.sAppAbsolutePath+"rest/system/initializeSessionVariables",c=$.proxy(function(){f.oUserProfile.sUserName&&this.logLogOut(),f.cleanAllCache(),b.go("signIn")},this);h.ajaxRequest({sPath:a,bAsync:!1,sRequestType:"GET",oEventHandlers:{onSuccess:c}})},logSuccessLogIn:function(){var a="Log In";o.bIsHybridApplication&&(a="Log In (mobile)"),g.logEvent({aUsers:["GeneralAdmin"],sEntityName:"",sEntityGuid:"",sOperationNameEN:a})},logLogOut:function(){var a="Log Out";o.bIsHybridApplication&&(a="Log Out (mobile)"),g.logEvent({aUsers:["GeneralAdmin"],sEntityName:"",sEntityGuid:"",sOperationNameEN:a})},onNoDefaultViewForTheRole:function(){this.logOut(),e.displayMessage({sText:d.instant("global_noDefaultViewForTheRole"),sType:"error"})},setUserPhasesForCurrentCompany:function(a){var b=[];f.oUserProfile.aUserPhases=angular.copy(f.oUserProfile.aAllUserPhases);for(var c=0;c<f.oUserProfile.aUserPhases.length;c++)f.oUserProfile.aUserPhases[c].ProjectDetails.CompanyName===a&&b.push(f.oUserProfile.aUserPhases[c]);f.oUserProfile.aAllUserPhases=angular.copy(f.oUserProfile.aUserPhases),f.oUserProfile.aUserPhases=angular.copy(b)},setUserContactForCurrentCompany:function(a){for(var b=[],c=0;c<f.oUserProfile.aAllUserContacts.length;c++)f.oUserProfile.aAllUserContacts[c].CompanyName===a&&(b=f.oUserProfile.aAllUserContacts[c]);f.oUserProfile.oUserContact=angular.copy(b)},checkUserRolesAssignment:function(c){var h=[],j=!1;f.oUserProfile.aUserRoles=angular.copy(f.oUserProfile.aAllUserRoles);for(var k=0;k<f.oUserProfile.aUserRoles.length;k++)f.oUserProfile.aUserRoles[k].CompanyName===c&&h.push(f.oUserProfile.aUserRoles[k]);return f.oUserProfile.aAllUserRoles=angular.copy(f.oUserProfile.aUserRoles),f.oUserProfile.aUserRoles=angular.copy(h),f.oUserProfile.aUserRoles.length?1===f.oUserProfile.aUserRoles.length?(sCurrentRole=f.oUserProfile.aUserRoles[0].RoleName,(j=i.setCurrentRole(sCurrentRole))?(this.logSuccessLogIn(),g.initializePubNub(),this.initializeGetNotificationsFunction(),a.getNotificationsNumber(),void b.go(i.getRolesInitialState(sCurrentRole))):void this.logOut()):void b.go("roleSelection"):(this.logOut(),void e.displayMessage({sText:d.instant("global_noRoleAssignment"),sType:"error"}))},onLogInSuccessHandler:function(a){var c="";if(o.bIsHybridApplication&&oDeviceInfo&&oDeviceInfo.sDeviceToken){var h=function(b){b.length?oDeviceInfo.sGuid=b[0].Guid:g.createUserDevice({oData:{UserName:a,DeviceToken:oDeviceInfo.sDeviceToken,BadgeNumber:0}})};g.getUserDevices({sFilter:"DeviceToken eq '"+oDeviceInfo.sDeviceToken+"' and UserName eq '"+a+"'",onSuccess:h})}return f.oUserProfile=g.getUserProfile(a),f.oUserProfile.bIsInitialPassword?void b.go("initialPasswordReset"):(f.oUserProfile.sPassword="",f.oUserProfile.aUserCompanies.length?1!==f.oUserProfile.aUserCompanies.length?void b.go("companySelection"):(c=f.oUserProfile.aUserCompanies[0].CompanyName,f.oUserProfile.sCurrentCompany=c,g.setCurrentCompany(c),this.setUserPhasesForCurrentCompany(c),this.setUserContactForCurrentCompany(c),this.checkUserRolesAssignment(c),void 0):(this.logOut(),void e.displayMessage({sText:d.instant("global_noCompanyAssignment"),sType:"error"})))},onF5WithCurrentUserHandler:function(c){var h="",j="";return f.oUserProfile=g.getUserProfile(c),f.oUserProfile.bIsInitialPassword?void b.go("signIn"):f.oUserProfile.aUserCompanies.length?(h=g.getCurrentCompany())?(f.oUserProfile.sCurrentCompany=h,this.setUserPhasesForCurrentCompany(h),this.setUserContactForCurrentCompany(h),(j=g.getCurrentRole())?(g.initializePubNub(),this.initializeGetNotificationsFunction(),a.getNotificationsNumber(),i.setCurrentRole(j),void 0):void b.go("roleSelection")):void b.go("companySelection"):(this.logOut(),void e.displayMessage({sText:d.instant("global_noCompanyAssignment"),sType:"error"}))},messagesHandler:function(a){var b=!0;o.bIsHybridApplication&&p.close();for(var c=0;c<a.length;c++){var f=a[c].messageCode.toString(),g=d.instant("m"+a[c].messageCode);switch(f[c].substring(0,1)){case"1":e.displayMessage({sText:g,sType:"success"});break;case"2":e.displayMessage({sText:g,sType:"error"}),b=!1;break;case"3":e.displayMessage({sText:g,sType:"warning"})}}return b},costructUploadUrl:function(a){var b="",c=function(a){b=a};return h.ajaxRequest({sPath:a.sPath,sRequestType:"GET",bAsync:!1,oData:{},oEventHandlers:{onSuccess:function(a){c(a)}}}),b},addCommentForEntity:function(b){var c={__batchRequests:[]},d=[],f={},i="",j={},k=function(a){onSuccess=function(){b.onSuccess()},g.createComment({oData:a,bShowSpinner:!0,bShowErrorMessage:!0,onSuccess:onSuccess})};if(b.sParentEntityCommentSetGuid)b.oData.CommentSetGuid=b.sParentEntityCommentSetGuid,k(b.oData);else{i=e.generateGUID(),f={requestUri:"CommentSets",method:"POST",data:{Guid:i,GeneralAttributes:{IsDeleted:!1},LastModifiedAt:e.dateToDBDate(new Date)}},d.push(f),b.sParentEntityGuid&&(f={requestUri:b.sPath+"('"+b.sParentEntityGuid+"')",method:"PUT",data:{CommentSetGuid:i}},d.push(f)),h.constructChangeBlockForBatch({oRequestData:c,aData:d}),j=h.batchRequest({oRequestData:c});var l=function(c){a.sCommentSetGuid=c.Guid,a.sCommentSetLastModifiedAt=c.LastModifiedAt,b.oData.CommentSetGuid=c.Guid,k(b.oData)};j.then(function(a){l(a[0].__changeResponses[0].data)})}},uploadAttachmentsForEntity:function(b){var c={__batchRequests:[]},d=[],f={},i="",j={},k="",l=$.proxy(function(c){var d=0;b.sParentEntityGuid||(b.sParentEntityGuid=o.bIsHybridApplication?"quickAddApp":"attachmentsBeforeSave");for(var e=0;e<b.aFiles.length;e++){var f=b.aFiles[e],h=this.costructUploadUrl({sPath:o.sAppAbsolutePath+"rest/file/v1v2/createUploadUrlWithFileMetadataSetGuid/Deficiency/"+b.sParentEntityGuid+"/_attachments_/"+c}),i={};o.bIsHybridApplication?(a.$emit("LOAD"),$.ajax({url:h,data:f,cache:!1,contentType:!1,processData:!1,type:"POST",success:$.proxy(function(){if(d++,d===b.aFiles.length){switch(b.onSuccess(),b.sPath){case"Tasks":k="oDeficiencyEntity"}g.pubNubMessage({sEntityName:k,sText:"New attachemnts added..."})}},this)})):(i=n.upload({url:h,file:f}),i.progress(function(a){b.onProgress&&b.onProgress(a)}),i.success($.proxy(function(){if(d++,d===b.aFiles.length){switch(b.onSuccess(),b.sPath){case"Tasks":k="oDeficiencyEntity"}g.pubNubMessage({sEntityName:k,sText:"New attachemnts added..."})}},this)))}},this);if(b.sParentEntityFileMetadataSetGuid)l(b.sParentEntityFileMetadataSetGuid);else{i=e.generateGUID(),f={requestUri:"FileMetadataSets",method:"POST",data:{Guid:i,GeneralAttributes:{IsDeleted:!1},LastModifiedAt:e.dateToDBDate(new Date)}},d.push(f),b.sParentEntityGuid&&(f={requestUri:b.sPath+"('"+b.sParentEntityGuid+"')",method:"PUT",data:{FileMetadataSetGuid:i}},d.push(f)),h.constructChangeBlockForBatch({oRequestData:c,aData:d}),j=h.batchRequest({oRequestData:c});var m=function(b){a.sFileMetadataSetGuid=b.Guid,a.sFileMetadataSetLastModifiedAt=b.LastModifiedAt,l(i)};j.then(function(a){m(a[0].__changeResponses[0].data)})}},deleteFileAttachment:function(a){var b="rest/file/v2/delete/"+a;h.ajaxRequest({sPath:b,sRequestType:"GET",bAsync:!1,oData:{},oEventHandlers:{onSuccess:function(){e.displayMessage({sText:d.instant("global_successOperation"),sType:"success"})}}})},getUserPhasesGuids:function(){for(var a=[],b=0;b<f.oUserProfile.aUserPhases.length;b++)a.push(f.oUserProfile.aUserPhases[b].Guid);return a},constructUserProjectsPhases:function(){for(var a=[],b=!1,c=0,d=angular.copy(f.oUserProfile.aUserPhases),e=0;e<d.length;e++){b=!1,c=0;for(var g=0;g<a.length;g++)if(a[g].Guid===d[e].ProjectDetails.Guid){b=!0,c=g;break}b?a[c].PhaseDetails.results.push(d[e]):(d[e].ProjectDetails.PhaseDetails={results:[]},d[e].ProjectDetails.PhaseDetails.results.push(d[e]),a.push(d[e].ProjectDetails))}a=l("orderBy")(a,["_sortingSequence"]);
for(var e=0;e<a.length;e++)a[e].PhaseDetails.results=l("orderBy")(a[e].PhaseDetails.results,["_sortingSequence"]);return a},constructUserProjectsPhasesForMultiSelect:function(a){var b=[];b=angular.copy(f.oUserProfile.aUserPhases);var c={aData:b,aPhases:[]},d=[];d=this.constructUserProjectsPhases();var e=a.aSelectedPhases;return this.constructDependentMultiSelectArray({oDependentArrayWrapper:{aData:d},sSecondLevelAttribute:"PhaseDetails",sSecondLevelNameEN:"NameEN",sSecondLevelNameFR:"NameFR",oParentArrayWrapper:c,oNewParentItemArrayWrapper:{aData:[]},sNameEN:"NameEN",sNameFR:"NameFR",sDependentKey:"Guid",aParentKeys:e,sTargetArrayNameInParent:"aPhases"}),c.aData[0]?c.aData[0].aPhases:[]},constructImageUrl:function(a){return o.sAppAbsolutePath+"rest/file/v2/get/"+a},constructLogoUrl:function(){var b=o.sAppAbsolutePath+"rest/file/v1/list/companyDependentSettings/"+f.oUserProfile.sCurrentCompany+"/_logo_",c=h.httpRequest({sPath:b});c.then(function(b){a.sLogoUrl=b[0]?o.sAppAbsolutePath+"rest/file/v2/get/"+b[0].guid:o.sAppAbsolutePath+"apps/conspector/img/logo_conspector.png"})},constructMenuIconUrl:function(){a.sMenuIconUrl=o.sAppAbsolutePath+"apps/conspector/img/mobileMenuIcon_tiny.svg"},processListOfComments:function(b){var c="",d="",g="",h=!1,i=[],j=angular.copy(b.oData);if(!j.CommentDetails)return[];for(var k=0;k<j.CommentDetails.results.length;k++)if(c="",d="",g="",!j.CommentDetails.results[k].GeneralAttributes.IsDeleted){j.CommentDetails.results[k].ContactDetails&&(j.CommentDetails.results[k].ContactDetails.FirstName&&(c=j.CommentDetails.results[k].ContactDetails.FirstName+" "),j.CommentDetails.results[k].ContactDetails.LastName&&(c+=j.CommentDetails.results[k].ContactDetails.LastName));var l=new Hashes.MD5;if(j.CommentDetails.results[k].ContactDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails.results[0])var m=l.hex(j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].EMail);else var m=l.hex("deficien@cyDetails.com");d="http://www.gravatar.com/avatar/"+m+".png?d=identicon&s=60",j.CommentDetails.results[k].ContactDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails&&j.CommentDetails.results[k].ContactDetails.UserDetails.results&&j.CommentDetails.results[k].ContactDetails.UserDetails.results.length&&(j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].AvatarFileGuid&&(d=this.constructImageUrl(j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].AvatarFileGuid)),g=j.CommentDetails.results[k].ContactDetails.UserDetails.results[0].UserName),h=g===f.oUserProfile.sUserName?!0:!1,i.push({_guid:j.CommentDetails.results[k].Guid,_lastModifiedAt:j.CommentDetails.results[k].LastModifiedAt,_createdAt:j.CommentDetails.results[k].CreatedAt,sCreatedAt:e.dBDateToSting(j.CommentDetails.results[k].CreatedAt),sText:j.CommentDetails.results[k].Text,sAuthor:c,sAvatarUrl:d,_editMode:!1,_allowEditMode:h,_userName:g})}return a.iCommentsNumber=i.length,i},getSeletedItemsKeysInMultiSelect:function(a){for(var b=[],c=0;c<a.aData.length;c++)a.aData[c].ticked===!0&&b.push(a.aData[c][a.sKey]);return b},constructDependentMultiSelectArray:function(a){for(var b=[],c={},e=0;e<a.oDependentArrayWrapper.aData.length;e++)if(a.sSecondLevelAttribute){c={},c.multiSelectGroup=!0;var f="";(a.oDependentArrayWrapper.aData[e][a.sNameEN]||a.oDependentArrayWrapper.aData[e][a.sNameFR])&&(f="en"===d.use()?a.oDependentArrayWrapper.aData[e][a.sNameEN]:a.oDependentArrayWrapper.aData[e][a.sNameFR],f||(f=a.oDependentArrayWrapper.aData[e][a.sNameEN])),c.name='<div class="cnpButtonLabelChild">'+f+"</div>",b.push(c);for(var g=0;g<a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results.length;g++)c={},(a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameEN]||a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameFR])&&(c.name="en"===d.use()?a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameEN]:a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameFR],c.name||(c.name=a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sSecondLevelNameEN]),c.fullName='<div class="cnpButtonLabelParent">'+f+'</div><div class="cnpButtonLabelSeparator">&nbsp;-&nbsp;</div><div class="cnpButtonLabelChild">'+c.name+"</div>"),c[a.sDependentKey]=a.oDependentArrayWrapper.aData[e][a.sSecondLevelAttribute].results[g][a.sDependentKey],b.push(c);c={},c.multiSelectGroup=!1,b.push(c)}else c={},(a.oDependentArrayWrapper.aData[e][a.sNameEN]||a.oDependentArrayWrapper.aData[e][a.sNameFR])&&(c.name="en"===d.use()?a.oDependentArrayWrapper.aData[e][a.sNameEN]:a.oDependentArrayWrapper.aData[e][a.sNameFR],c.name||(c.name=a.oDependentArrayWrapper.aData[e][a.sNameEN])),a.oDependentArrayWrapper.aData[e][a.sDependentIconKey]&&(c.icon="<img src='"+k.location.origin+k.location.pathname+"rest/file/v2/get/",c.icon=c.icon+a.oDependentArrayWrapper.aData[e][a.sDependentIconKey]+"' class='cnpMultiSelectIcon'/>"),c[a.sDependentKey]=a.oDependentArrayWrapper.aData[e][a.sDependentKey],b.push(c);a.oNewParentItemArrayWrapper&&(a.oNewParentItemArrayWrapper.aData=angular.copy(b));for(var e=0;e<a.oParentArrayWrapper.aData.length;e++){for(var h=[],i={},j=!1,g=0;g<b.length;g++){if(i={},angular.copy(b[g],i),void 0===i.multiSelectGroup&&(i.ticked=!1),a.sParentKey&&a.oParentArrayWrapper.aData[e][a.sParentKey]===b[g][a.sDependentKey]&&(i.ticked=!0,j=!0),a.sParentKeys)for(var l=0;l<a.oParentArrayWrapper.aData[e][a.sParentKeys].length;l++)b[g][a.sDependentKey]===a.oParentArrayWrapper.aData[e][a.sParentKeys][l]&&(i.ticked=!0,j=!0);if(a.aParentKeys)for(var l=0;l<a.aParentKeys.length;l++)b[g][a.sDependentKey]===a.aParentKeys[l]&&(i.ticked=!0,j=!0);h.push(i)}a.oParentArrayWrapper.aData[e][a.sTargetArrayNameInParent]=h}},initializeGetNotificationsFunction:function(){a.getNotificationsNumber=function(){var b=function(b){a.iNotificationsNumber=b};g.getOperationLogs({sFilter:"CompanyName eq '"+f.oUserProfile.sCurrentCompany+"' and UserName eq '"+f.oUserProfile.sUserName+"' and Status eq 'not read' and GeneralAttributes/IsDeleted eq false",bAddCountUrlParam:!0,onSuccess:b})}},createNgTable:function(a){var b=new c({page:1,count:1e4,filterDelay:10,sorting:a.oInitialSorting,filter:a.oInitialFilter,groupsSettings:a.aInitialGroupsSettings},{groupBy:a.sGroupBy,total:a.oInitialDataArrayWrapper.aData.length,sDisplayedDataArrayName:a.sDisplayedDataArrayName,getData:function(b,c){var d=a.oInitialDataArrayWrapper.aData,f=angular.copy(c.filter());for(var g in f)f.hasOwnProperty(g)&&(f[g]=e.replaceSpecialChars(f[g]));var h=f?l("filter")(d,f):d,i=[],j=angular.copy(c.orderBy());a.sGroupsSortingAttribue&&j.unshift(a.sGroupsSortingAttribue),i=void 0===j||angular.equals(j,{})?h:l("orderBy")(h,j),b.resolve(i.slice((c.page()-1)*c.count(),c.page()*c.count()))},counts:[]});return b},setUpPhotoGallery:function(b){a.sGalleryPhotosLocation=k.location.origin+k.location.pathname+"rest/file/v2/get/",a.aGalleryData=[];for(var c=0;c<b.length;c++)a.aGalleryData.push({sGuid:b[c].Guid});a.oSelectedPhoto=a.aGalleryData[0],a.aGalleryData[0]&&(a.sSelectedPhotoID=a.aGalleryData[0].sGuid),a.oGalleryListPosition={left:"0px"},a.bIsGalleryHidden=!1},showConfirmationPopup:function(a){var b=m.confirm().title(a.sHeader).content(a.sContent).ok(a.sOk).cancel(a.sCancel).targetEvent(a.event);m.show(b).then(function(){a.onOk()},function(){a.onCancel&&a.onCancel()})},refreshUserProfile:function(){var a=f.oUserProfile.sCurrentCompany,b=f.oUserProfile.sCurrentRole,c=angular.copy(f.oUserProfile.aGloballySelectedPhasesGuids);f.oUserProfile=g.getUserProfile(f.oUserProfile.sUserName),f.oUserProfile.sCurrentCompany=a,f.oUserProfile.sCurrentRole=b,f.oUserProfile.aGloballySelectedPhasesGuids=c,this.setUserPhasesForCurrentCompany(a),this.setUserContactForCurrentCompany(a),this.setUserContactForCurrentCompany(a)}}}]),app.factory("historyProvider",[function(){return{aHistoryStates:[],bBackNavigationFlag:!1,addStateToHistory:function(a){this.bBackNavigationFlag||this.aHistoryStates.push(a),this.bBackNavigationFlag=!1},navigateBack:function(a){this.bBackNavigationFlag=!0;var b=this.aHistoryStates[this.aHistoryStates.length-1];this.aHistoryStates.pop(),a.oState.go(b.sStateName,b.oStateParams)},removeHistory:function(){this.aHistoryStates=[]},getPreviousStateName:function(){var a="";return this.aHistoryStates.length&&this.aHistoryStates[this.aHistoryStates.length-1]&&(a=this.aHistoryStates[this.aHistoryStates.length-1].sStateName),a}}}]),angular.module("filtersProvider",[]).filter("phoneFormatter",function(){return function(a){if(!a)return"";var b=a.toString().trim().replace(/^\+/,"");if(b.match(/[^0-9]/))return a;var c,d,e;switch(b.length){case 10:c=0,d=b.slice(0,3),e=b.slice(3);break;case 11:c=1,d=b.slice(1,4),e=b.slice(4);break;default:return a}return 1==c&&(c="1"),0==c&&(c=""),e=e.slice(0,3)+"-"+e.slice(3),(c+" ("+d+") "+e).trim()}}).filter("searchInMultiSelect",function(){return function(a,b){for(var c=[],d=!1,e=0;e<a.length;e++)if(d=!1,-1!==a[e].sName.toString().toLowerCase().indexOf(b.sName.toString().toLowerCase())||-1!==a[e].sCleanedName.toString().toLowerCase().indexOf(b.sName.toString().toLowerCase())){for(var f=0;f<b.aSelectedItems.length;f++)a[e].sGuid===b.aSelectedItems[f].sGuid&&(d=!0);d||c.push(a[e])}return c}}),angular.module("controlsProvider",[]).directive("cnpPhotoGallery",[function(){return{restrict:"E",scope:!0,controller:["$scope","$rootScope",function(a,b){var c=400;a.stopPropagation=function(a){a.stopPropagation()},a.scrollTo=function(a,d){b.oGalleryListPosition={left:c*d*-1+"px"},b.sSelectedPhotoID=a.sGuid,b.oSelectedPhoto=a}}],templateUrl:"apps/conspector/js/templates/photoGallery.html"}}]),app.controller("mainController",["$scope","$rootScope","$state",function(){}]),viewControllers.controller("appView",["$scope","$rootScope","$state","$mdSidenav","$window","$translate","$filter","$timeout",function(a,b,c,d){c.go("app.landingPage"),a.toggleLeftSidenav=function(){d("globalLeft").toggle()}}]);
//# sourceMappingURL=conspector.min.js.map